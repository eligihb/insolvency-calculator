<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××—×©×‘×•×Ÿ ×¦×• ×©×™×§×•× â€“ ×¤×¨×™×¡×” ×©× ×ª×™×ª/×—×•×“×©×™×ª</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0B1D2A;--paper:#F6F7FB;--card:#fff;--ink:#0B2533;--ink2:#4b5b66;--accent:#0EA5E9;--green:#22C55E;--amber:#F59E0B;--red:#EF4444;--muted:#E7F1FF;--radius:16px;--shadow:0 8px 24px rgba(2,6,23,.08)}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:"Heebo",system-ui; background:var(--paper); color:var(--ink)}
    a{color:var(--accent)}
    .wrap{max-width:1280px;margin:auto;padding:18px 14px 110px}
    header{background:var(--bg);color:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:12px}
    header h1{margin:0 0 6px;font-weight:800;font-size:clamp(20px,3vw,28px)}
    header p{margin:0;opacity:.9}

    .grid{display:grid;gap:12px;grid-template-columns:360px 1fr}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 10px;font-size:18px}
    .row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin:8px 0}
    .row label{font-weight:600}
    input[type="number"], input[type="date"], select{width:100%;padding:10px;border-radius:12px;border:1px solid #d7dee6;background:#F3F7FE}
    input[type="number"]{direction:ltr;text-align:left}
    .hint{color:var(--ink2);font-size:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer;background:#f1f5f9}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.warn{background:var(--amber);color:#fff}
    .btn.success{background:var(--green);color:#fff}

    .events{display:flex;flex-direction:column;gap:8px}
    .event{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px;align-items:end}
    .badge{display:inline-block;background:#FFF6CC;color:#8a5a00;border-radius:999px;padding:3px 8px;font-size:11px;font-weight:800}

    /* ×œ×•×— ×©× ×ª×™: ×©×•×¨×” = ×©× ×”, ×¢××•×“×•×ª = 12 ×—×•×“×©×™× */
    .year-row{margin:10px 0;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:10px}
    .year-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .months{display:grid;grid-template-columns:repeat(12, minmax(90px,1fr));gap:8px}
    .month{background:#ffffff;border:1px solid #e8edf4;border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:4px;position:relative}
    .month.disabled{opacity:.35}
    .m-due{font-size:11px;color:#667785;display:flex;justify-content:space-between}
    .m-exp{font-weight:800}
    .m-paid{display:flex;gap:6px;align-items:center}
    .m-paid input{width:100%;padding:6px;border-radius:8px;border:1px solid #d7dee6;background:#fff}
    .m-status{font-size:11px}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
    .ok{color:var(--green)} .late{color:var(--red)} .pending{color:#64748B}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media(min-width:900px){.kpis{grid-template-columns:repeat(6,1fr)}}
    .kpi{background:#fff;padding:12px;border-radius:14px;box-shadow:var(--shadow)}
    .kpi .k{color:#6b7c88;font-size:12px}
    .kpi .v{font-size:20px;font-weight:900}

    .dock{position:fixed;inset-inline:0;bottom:0;background:#fff;border-top:1px solid #e6ebf2;box-shadow:0 -8px 24px rgba(2,6,23,.07);padding:10px 14px}
    .dock-inner{max-width:1280px;margin:auto;display:flex;gap:10px;align-items:center;justify-content:space-between}

    @media print{
      @page{size:A4 landscape;margin:10mm}
      body{background:#fff}
      .dock{display:none!important}
      .wrap{padding:0}
      .grid{grid-template-columns:320px 1fr}
      .card{box-shadow:none;border:1px solid #e9eef5}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>××—×©×‘×•×Ÿ ×¦×• ×©×™×§×•× â€“ ×¤×¨×™×¡×” ×©× ×ª×™×ª/×—×•×“×©×™×ª</h1>
      <p>×”×–× ×ª × ×ª×•× ×™ ×¦×• (××™×Ÿ ×—×™×©×•×‘ ×§×•×‘×¢), ×¤×¨×™×¡×” ××•×˜×•××˜×™×ª, ×ª×™×¢×•×“ ×ª×©×œ×•××™× ×‘×¤×•×¢×œ, ×¡×˜×˜×•×¡ ×•×¤×™×’×•×¨.</p>
    </header>

    <div class="grid">
      <!-- ×¦×“ ×™××™×Ÿ: ×¤×¨×˜×™ ×¦×• + ×¦×• ×ª×©×œ×•××™× + ××™×¨×•×¢×™ ×”×¤×—×ª×” -->
      <section class="card">
        <h2>×¤×¨×˜×™ ×¦×•</h2>
        <div class="row">
          <label>×ª××¨×™×š ××ª×Ÿ ×”×¦×•</label>
          <input type="date" id="orderDate" />
        </div>
        <div class="row">
          <label>×ª×—×•×œ×ª ×—×™×•×‘</label>
          <select id="startMode">
            <option value="next" selected>×—×•×“×© ×”×‘× (×‘×¨×™×¨×ª ××—×“×œ)</option>
            <option value="immediate">××™×™×“×™</option>
          </select>
        </div>
        <div class="row">
          <label>××¡' ×—×•×“×©×™ ×ª×•×›× ×™×ª</label>
          <input type="number" id="termMonths" min="1" step="1" placeholder="×œ×“×•×’××”: 60" />
        </div>

        <h2 style="margin-top:10px">×¦×• ×ª×©×œ×•××™×</h2>
        <div class="row">
          <label>××¦×‘</label>
          <select id="pricingMode">
            <option value="flat">×§×‘×•×¢</option>
            <option value="tiered">××“×•×¨×’</option>
            <option value="reduction">×”×¤×—×ª×ª ×ª×©×œ×•××™×</option>
          </select>
        </div>

        <!-- ×§×‘×•×¢ -->
        <div id="flatFields" class="card" style="padding:10px;margin-top:8px">
          <div class="row">
            <label>×¡×›×•× ×—×•×“×©×™ ×§×‘×•×¢</label>
            <input type="number" id="flatAmount" min="0" step="50" placeholder="â‚ª" />
          </div>
          <div class="hint">×‘×¨×™×¨×ª ××—×“×œ: ×¨×™×§ ×¢×“ ×œ×”×–× ×”.</div>
        </div>

        <!-- ××“×•×¨×’ (×©×ª×™ ××“×¨×’×•×ª) -->
        <div id="tierFields" class="card" style="padding:10px;margin-top:8px;display:none">
          <div class="row">
            <label>×—×•×“×©×™ ××“×¨×’×” 1</label>
            <input type="number" id="tier1Months" min="0" step="1" placeholder="×œ×“×•×’××”: 10" />
          </div>
          <div class="row">
            <label>×¡×›×•× ×—×•×“×©×™ â€“ ××“×¨×’×” 1</label>
            <input type="number" id="tier1Amount" min="0" step="50" placeholder="â‚ª" />
          </div>
          <div class="row">
            <label>×¡×›×•× ×—×•×“×©×™ â€“ ××“×¨×’×” 2</label>
            <input type="number" id="tier2Amount" min="0" step="50" placeholder="â‚ª" />
          </div>
          <div class="hint">××“×¨×’×” 2 ×ª×—×•×œ ××•×˜×•××˜×™×ª ×¢×œ ×™×ª×¨×ª ×”×—×•×“×©×™× (Term âˆ’ ×—×•×“×©×™ ××“×¨×’×” 1).</div>
        </div>

        <!-- ×”×¤×—×ª×•×ª -->
        <div id="reductionFields" class="card" style="padding:10px;margin-top:8px;display:none">
          <button class="btn" id="addEventBtn">â• ×”×¤×—×ª×ª ×ª×©×œ×•××™×</button>
          <div class="events" id="events" style="margin-top:8px"></div>
          <div class="hint">×›×œ ××™×¨×•×¢ ××’×“×™×¨ ×¡×›×•× ×—×•×“×©×™ ×—×“×© ×”×—×œ ××ª××¨×™×š ×”×ª×—×•×œ×” ×•×¢×“ ×¡×•×£ ×”×ª×§×•×¤×”, ××• ×¢×“ ×ª××¨×™×š ×©×ª×‘×—×¨. ××¤×©×¨ ×œ×¡××Ÿ "×—×–×•×¨ ×œ×¡×›×•× ×”××§×•×¨×™" ×‘×¡×™×•×.</div>
        </div>
      </section>

      <!-- ×¦×“ ×©×××œ: KPI + ×¤×¨×™×¡×” ×©× ×ª/×—×•×“×© + ××–×•×¨ ×¤×™×’×•×¨ ×™×•××™ -->
      <section class="card">
        <h2>××“×“×™ ×”×ª×§×“××•×ª</h2>
        <div class="kpis">
          <div class="kpi"><div class="k">×”×ª×—×œ×” â†’ ×¡×™×•×</div><div class="v" id="rangeKPI">â€”</div></div>
          <div class="kpi"><div class="k">××©×š (×©× ×™×/×—×•×“×³)</div><div class="v" id="durationKPI">â€”</div></div>
          <div class="kpi"><div class="k">×¢×‘×¨ / × ×•×ª×¨ (×—×•×“×³)</div><div class="v" id="elapsedLeftKPI">â€”</div></div>
          <div class="kpi"><div class="k">×¦×¤×•×™ ×¢×“ ×”×™×•× / ×©×•×œ× ×¢×“ ×”×™×•×</div><div class="v" id="expectedPaidKPI">â€”</div></div>
          <div class="kpi"><div class="k">×¤×™×’×•×¨ (â‚ª)</div><div class="v" id="arrearsKPI">â€”</div></div>
          <div class="kpi"><div class="k">×¡×š ×”×ª×•×›× ×™×ª</div><div class="v" id="totalKPI">â€”</div></div>
        </div>

        <h2 style="margin-top:12px">×¤×¨×™×¡×” ×©× ×ª×™×ª (×”×©× ×” ×”×¢×“×›× ×™×ª ×œ××¢×œ×”)</h2>
        <div id="yearsWrap"></div>

        <h2 style="margin-top:12px">×¤×™×’×•×¨ ×œ×¤×™ ×™××™×</h2>
        <div id="lateDaysWrap" class="card" style="padding:10px"></div>
      </section>
    </div>
  </div>

  <div class="dock">
    <div class="dock-inner">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="resetBtn">××™×¤×•×¡</button>
        <button class="btn warn" id="fillDemoBtn">× ×ª×•× ×™ ×“×•×’××”</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="printBtn">×”×“×¤×¡×” A4</button>
        <button class="btn success" id="exportBtn">×™×™×¦×•× JSON</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const els = {
      orderDate: document.getElementById('orderDate'),
      startMode: document.getElementById('startMode'),
      termMonths: document.getElementById('termMonths'),
      pricingMode: document.getElementById('pricingMode'),
      flatFields: document.getElementById('flatFields'),
      tierFields: document.getElementById('tierFields'),
      reductionFields: document.getElementById('reductionFields'),
      flatAmount: document.getElementById('flatAmount'),
      tier1Months: document.getElementById('tier1Months'),
      tier1Amount: document.getElementById('tier1Amount'),
      tier2Amount: document.getElementById('tier2Amount'),
      addEventBtn: document.getElementById('addEventBtn'),
      eventsWrap: document.getElementById('events'),
      yearsWrap: document.getElementById('yearsWrap'),
      lateDaysWrap: document.getElementById('lateDaysWrap'),
      rangeKPI: document.getElementById('rangeKPI'),
      durationKPI: document.getElementById('durationKPI'),
      elapsedLeftKPI: document.getElementById('elapsedLeftKPI'),
      expectedPaidKPI: document.getElementById('expectedPaidKPI'),
      arrearsKPI: document.getElementById('arrearsKPI'),
      totalKPI: document.getElementById('totalKPI'),
      printBtn: document.getElementById('printBtn'),
      exportBtn: document.getElementById('exportBtn'),
      resetBtn: document.getElementById('resetBtn'),
      fillDemoBtn: document.getElementById('fillDemoBtn')
    };
    const KEY_STATE = 'rehabOrder.v4.state';
    const KEY_PAID  = 'rehabOrder.v4.paid';
    const KEY_PAID_DATE = 'rehabOrder.v4.paidDate';

    function num(v){ return Number(String(v||'').replace(/[^\d.-]/g,'')||0); }
    function fmtN(n){ return new Intl.NumberFormat('he-IL').format(Math.round(n||0)); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function addMonths(d, n){ const dt=new Date(d.getTime()); dt.setMonth(dt.getMonth()+n); return dt; }

    function getStartDate(orderDate, mode){ if(!orderDate) return null; const d=new Date(orderDate); return (mode==='next')? addMonths(d,1): d; }

    // ===== Events (reductions) =====
    function readEvents(){
      const rows = Array.from(els.eventsWrap.querySelectorAll('.event'));
      const list = rows.map(r=>({
        effective: r.querySelector('[data-f=eff]').value,
        amount: num(r.querySelector('[data-f=amt]').value),
        dur: r.querySelector('[data-f=dur]').value, // end | until
        until: r.querySelector('[data-f=until]').value,
        revert: r.querySelector('[data-f=revert]').checked
      })).filter(e=>e.effective);
      return list.sort((a,b)=> new Date(a.effective)-new Date(b.effective));
    }

    function renderEventRow(eff='', amt='', dur='end', until='', revert=true){
      const row = document.createElement('div');
      row.className='event';
      row.innerHTML = `
        <div>
          <label>×ª×—×•×œ×”</label>
          <input type="date" data-f="eff" value="${eff}" />
        </div>
        <div>
          <label>×¡×›×•× ×—×“×©</label>
          <input type="number" data-f="amt" min="0" step="50" placeholder="â‚ª" value="${amt}" />
        </div>
        <div>
          <label>××©×š</label>
          <select data-f="dur">
            <option value="end" ${dur==='end'?'selected':''}>×¢×“ ×¡×•×£ ×”×ª×§×•×¤×”</option>
            <option value="until" ${dur==='until'?'selected':''}>×¢×“ ×ª××¨×™×šâ€¦</option>
          </select>
        </div>
        <div>
          <label>×ª××¨×™×š ×¡×™×•×</label>
          <input type="date" data-f="until" value="${until}" ${dur==='until'?'' : 'disabled'} />
        </div>
        <div>
          <label style="visibility:hidden">×—×–×•×¨</label>
          <div><input type="checkbox" data-f="revert" ${revert?'checked':''}/> ×—×–×•×¨ ×œ×¡×›×•× ×”××§×•×¨×™ ×‘×¡×™×•×</div>
        </div>`;
      row.querySelector('[data-f=dur]').addEventListener('change', e=>{
        const off = e.target.value!=='until';
        row.querySelector('[data-f=until]').disabled = off;
      });
      row.addEventListener('change', ()=> build());
      const del = document.createElement('button'); del.className='btn'; del.textContent='ğŸ—‘ï¸'; del.title='××—×§ ××™×¨×•×¢';
      del.addEventListener('click', ()=>{ row.remove(); build(); });
      row.appendChild(del);
      els.eventsWrap.appendChild(row);
    }

    els.addEventBtn?.addEventListener('click', ()=> renderEventRow());

    // ===== Paid storage =====
    function readPaid(){ try{ return JSON.parse(localStorage.getItem(KEY_PAID))||{} }catch{ return {} } }
    function writePaid(map){ localStorage.setItem(KEY_PAID, JSON.stringify(map)); }
    function readPaidDate(){ try{ return JSON.parse(localStorage.getItem(KEY_PAID_DATE))||{} }catch{ return {} } }
    function writePaidDate(map){ localStorage.setItem(KEY_PAID_DATE, JSON.stringify(map)); }

    // ===== State =====
    function saveState(){
      const state = {
        orderDate: els.orderDate.value,
        startMode: els.startMode.value,
        termMonths: num(els.termMonths.value),
        pricingMode: els.pricingMode.value,
        flatAmount: num(els.flatAmount.value),
        tier1Months: num(els.tier1Months.value),
        tier1Amount: num(els.tier1Amount.value),
        tier2Amount: num(els.tier2Amount.value),
        events: readEvents()
      };
      localStorage.setItem(KEY_STATE, JSON.stringify(state));
    }
    function loadState(){
      const raw = localStorage.getItem(KEY_STATE); if(!raw) return;
      try{
        const s = JSON.parse(raw);
        els.orderDate.value = s.orderDate||'';
        els.startMode.value = s.startMode||'next';
        els.termMonths.value = s.termMonths||'';
        els.pricingMode.value = s.pricingMode||'flat';
        els.flatAmount.value = s.flatAmount||'';
        els.tier1Months.value = s.tier1Months||'';
        els.tier1Amount.value = s.tier1Amount||'';
        els.tier2Amount.value = s.tier2Amount||'';
        togglePanels();
        els.eventsWrap.innerHTML='';
        (s.events||[]).forEach(ev=> renderEventRow(ev.effective, ev.amount, ev.dur, ev.until, ev.revert));
      }catch{}
    }

    function togglePanels(){
      const mode = els.pricingMode.value;
      els.flatFields.style.display = (mode==='flat' || mode==='reduction')? 'block':'none';
      els.tierFields.style.display = (mode==='tiered' || mode==='reduction')? 'block':'none';
      els.reductionFields.style.display = (mode==='reduction')? 'block':'none';
    }

    // ===== Core build =====
    function baseAmount(idx){
      const t1m = num(els.tier1Months.value);
      const a1  = num(els.tier1Amount.value);
      const a2  = num(els.tier2Amount.value);
      if(t1m>0 || a1>0 || a2>0){ return (idx < t1m) ? a1 : a2; }
      return num(els.flatAmount.value)||0;
    }

    function build(){
      saveState();
      const paidMap = readPaid();
      const paidDateMap = readPaidDate();

      const orderDate = els.orderDate.value ? new Date(els.orderDate.value) : null;
      const term = num(els.termMonths.value)||0;
      if(!orderDate || term<=0){ els.yearsWrap.innerHTML=''; els.lateDaysWrap.innerHTML=''; updateKPIs([],{},{}) ; return; }

      const startDate = getStartDate(orderDate, els.startMode.value);
      const events = readEvents();

      const months = [];
      for(let i=0;i<term;i++){
        const due = addMonths(startDate, i);
        let expected = baseAmount(i);
        for(const ev of events){
          const eff = new Date(ev.effective);
          const dueM = new Date(due.getFullYear(), due.getMonth(), 1);
          const effM = new Date(eff.getFullYear(), eff.getMonth(), 1);
          let inRange = effM <= dueM;
          if(ev.dur==='until' && ev.until){
            const until = new Date(ev.until);
            const untilM = new Date(until.getFullYear(), until.getMonth(), 1);
            inRange = inRange && (dueM <= untilM);
          }
          if(inRange){ expected = ev.amount; }
        }
        const key = `${due.getFullYear()}-${pad(due.getMonth()+1)}-01`;
        const paid = num(paidMap[key]);
        const paidDate = paidDateMap[key] || '';
        months.push({ idx:i, due, key, expected, paid, paidDate });
      }

      const groups = new Map();
      months.forEach(m=>{ const y = m.due.getFullYear(); if(!groups.has(y)) groups.set(y, []); groups.get(y).push(m); });
      const yearsDesc = Array.from(groups.keys()).sort((a,b)=> b-a);

      els.yearsWrap.innerHTML='';
      const todayM = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      yearsDesc.forEach(year=>{
        const row = document.createElement('div'); row.className='year-row';
        const list = groups.get(year); list.sort((a,b)=> a.due - b.due);
        const head = document.createElement('div'); head.className='year-head'; head.innerHTML = `<div><strong>${year}</strong></div>`; row.appendChild(head);
        const monthsWrap = document.createElement('div'); monthsWrap.className='months';
        for(let m=0;m<12;m++){
          const item = document.createElement('div'); item.className='month';
          const monthData = list.find(x=> x.due.getMonth()===m);
          if(!monthData){ item.classList.add('disabled'); item.innerHTML = `<div class="m-due"><span>${m+1}</span><span>â€”</span></div>`; monthsWrap.appendChild(item); continue; }
          const due = monthData.due;
          const dueM = new Date(due.getFullYear(), due.getMonth(), 1);
          const allUntil = months.filter(x=> new Date(x.due.getFullYear(), x.due.getMonth(),1) <= dueM);
          const cumExp = allUntil.reduce((s,x)=> s+x.expected, 0);
          const cumPaid = allUntil.reduce((s,x)=> s+x.paid, 0);
          const status = (dueM>todayM)?'pending': (cumPaid>=cumExp? 'ok':'late');
          const arrearsMonth = Math.max(0, cumExp - cumPaid);
          let lateDays = 0;
          if(monthData.paidDate){
            const payD = new Date(monthData.paidDate);
            const dueEnd = new Date(due.getFullYear(), due.getMonth()+1, 0);
            if(payD > dueEnd){
              const diffMs = payD - dueEnd; lateDays = Math.ceil(diffMs / (1000*60*60*24));
            }
          }
          item.innerHTML = `
            <div class="m-due"><span>${due.toLocaleDateString('he-IL',{month:'2-digit'})}/${String(year).slice(-2)}</span>
              <span class="m-exp">â‚ª ${fmtN(monthData.expected)}</span></div>
            <div class="m-paid">
              <input type="number" min="0" step="50" placeholder="×©×•×œ×" value="${monthData.paid||''}" />
              <button class="btn" title="×ª××¨×™×š ×ª×©×œ×•×">â±ï¸</button>
            </div>
            <div class="m-status ${status}">
              <span class="dot" style="background:${status==='ok'?'#22C55E':(status==='late'?'#EF4444':'#94A3B8')}"></span>
              ${status==='pending'?'×˜×¨× ×”×’×™×¢ ××•×¢×“':(status==='ok'?'×‘×–××Ÿ/×¢×•×“×£':`×¤×™×’×•×¨: â‚ª ${fmtN(arrearsMonth)}`)}
              ${lateDays>0?` Â· ××™×—×•×¨ ${lateDays} ×™××™×`:''}
            </div>
          `;
          const inp = item.querySelector('input');
          inp.addEventListener('change', ()=>{ const map = readPaid(); map[monthData.key]= num(inp.value); writePaid(map); build(); });
          const btn = item.querySelector('button');
          btn.addEventListener('click', ()=>{ const d = prompt('×”×–×Ÿ ×ª××¨×™×š ×ª×©×œ×•× ×‘×¤×•×¨××˜ YYYY-MM-DD', monthData.paidDate||''); if(d!==null){ const map=readPaidDate(); map[monthData.key]=d; writePaidDate(map); build(); } });
          monthsWrap.appendChild(item);
        }
        row.appendChild(monthsWrap);
        els.yearsWrap.appendChild(row);
      });

      const lateLines = months.map(m=>{
        if(!m.paidDate) return null;
        const dueEnd = new Date(m.due.getFullYear(), m.due.getMonth()+1, 0);
        const payD = new Date(m.paidDate);
        const diff = Math.ceil((payD-dueEnd)/(1000*60*60*24));
        return diff>0 ? `${m.due.getFullYear()}-${pad(m.due.getMonth()+1)}: ××™×—×•×¨ ×©×œ ${diff} ×™××™×` : null;
      }).filter(Boolean);
      els.lateDaysWrap.innerHTML = lateLines.length? lateLines.map(x=>`<div>â€¢ ${x}</div>`).join('') : '<div class="hint">××™×Ÿ ××™×—×•×¨×™× ×¢× ×ª××¨×™×š ×ª×©×œ×•× ×©× ×§×œ×˜.</div>';

      updateKPIs(months, readPaid(), readPaidDate());
    }

    function updateKPIs(months, paidMap, paidDateMap){
      if(!months.length){ els.rangeKPI.textContent='â€”'; els.durationKPI.textContent='â€”'; els.elapsedLeftKPI.textContent='â€”'; els.expectedPaidKPI.textContent='â€”'; els.arrearsKPI.textContent='â€”'; els.totalKPI.textContent='â€”'; return; }
      const start = months[0].due, end = months[months.length-1].due;
      els.rangeKPI.textContent = `${toISODate(start)} â†’ ${toISODate(end)}`;
      const totalMonths = months.length; const years = Math.floor(totalMonths/12), rem= totalMonths%12; els.durationKPI.textContent = `${years} ×©× ×™× ×•-${rem} ×—×•×“×©×™×`;
      const todayM = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      const elapsed = months.filter(r=> new Date(r.due.getFullYear(), r.due.getMonth(),1) <= todayM).length; const left = Math.max(0, totalMonths - elapsed);
      els.elapsedLeftKPI.textContent = `${elapsed} / ${left}`;
      const expectedToDate = months.filter(r=> new Date(r.due.getFullYear(), r.due.getMonth(),1) <= todayM).reduce((s,r)=> s+r.expected, 0);
      const paidToDate = months.filter(r=> new Date(r.due.getFullYear(), r.due.getMonth(),1) <= todayM).reduce((s,r)=> s+num(paidMap[r.key]), 0);
      els.expectedPaidKPI.textContent = `â‚ª ${fmtN(expectedToDate)} / â‚ª ${fmtN(paidToDate)}`;
      els.arrearsKPI.textContent = `â‚ª ${fmtN(Math.max(0, expectedToDate - paidToDate))}`;
      const total = months.reduce((s,r)=> s+r.expected, 0);
      els.totalKPI.textContent = `â‚ª ${fmtN(total)}`;
    }

    document.addEventListener('change', e=>{ if(e.target.matches('input, select')){ if(e.target.closest('.event')){ saveState(); } build(); } }, true);
    els.pricingMode.addEventListener('change', ()=>{ togglePanels(); build(); });

    els.printBtn.addEventListener('click', ()=> window.print());
    els.exportBtn.addEventListener('click', ()=>{
      const state = JSON.parse(localStorage.getItem(KEY_STATE)||'{}');
      const paid  = JSON.parse(localStorage.getItem(KEY_PAID)||'{}');
      const paidDates = JSON.parse(localStorage.getItem(KEY_PAID_DATE)||'{}');
      const blob = new Blob([JSON.stringify({state, paid, paidDates}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'rehab-order-snapshot.json'});
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });

    els.resetBtn.addEventListener('click', ()=>{ if(!confirm('×œ××¤×¡ ×”×›×œ?')) return; localStorage.removeItem(KEY_STATE); localStorage.removeItem(KEY_PAID); localStorage.removeItem(KEY_PAID_DATE); els.eventsWrap.innerHTML=''; build(); });

    els.fillDemoBtn.addEventListener('click', ()=>{
      els.orderDate.value = '2020-01-01'; els.startMode.value = 'next'; els.termMonths.value = '60';
      els.pricingMode.value = 'tiered'; togglePanels();
      els.tier1Months.value = '10'; els.tier1Amount.value = '1000'; els.tier2Amount.value = '4000';
      els.reductionFields.style.display='block'; els.eventsWrap.innerHTML='';
      renderEventRow('2022-07-01','2800','end','',true);
      build();
    });

    loadState();
    build();
  </script>
</body>
</html>
