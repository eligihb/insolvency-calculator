<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×¦×• ×©×™×§×•× ×›×œ×›×œ×™ â€“ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0B1D2A;--paper:#F5F7FB;--card:#fff;--ink:#0B2533;--muted:#6B7C88;--accent:#0EA5E9;--green:#22C55E;--amber:#F59E0B;--red:#EF4444;
      --radius:16px;--shadow:0 6px 22px rgba(2,6,23,.08)
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:'Heebo',system-ui;background:var(--paper);color:var(--ink)}
    .wrap{max-width:1440px;margin:0 auto;padding:18px 18px 120px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
    h1{margin:0 0 10px;font-size:26px}
    h2{margin:0 0 8px;font-size:18px}
    label{font-weight:700;display:block;margin:6px 0 4px}
    input,select,button{font-family:inherit}
    input[type="number"],input[type="date"],select,input[type="text"]{width:100%;max-width:420px;padding:10px;border:1px solid #d7dee6;border-radius:14px;background:#F3F7FE;text-align:left;direction:ltr}
    .row{display:grid;grid-template-columns:180px 1fr;gap:10px;align-items:center;margin:8px 0}
    .seg{display:flex;gap:6px;flex-wrap:wrap}
    .seg .pill{padding:9px 12px;border-radius:999px;background:#eef2f7;font-weight:800;cursor:pointer;border:1px solid #e3e8ef}
    .seg .pill.active{background:var(--accent);color:#fff;border-color:transparent}
    .quick{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .quick .chip{padding:8px 10px;border-radius:999px;background:#eef2f7;border:1px solid #e3e8ef;cursor:pointer;font-weight:700}
    .quick .chip.active{background:#cfefff;border-color:#90d9ff}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .kpi{background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:900}
    .bar{height:6px;background:#e8eef6;border-radius:999px;margin-top:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--accent);width:0}

    /* ×œ×•×— ×©× ×ª×™ ×œ×¨×•×—×‘ */
    .year{background:#fff;border-radius:14px;padding:10px;box-shadow:var(--shadow);margin-bottom:12px}
    .year-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .months{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
    .m{border:1px solid #e6ebf2;border-radius:12px;padding:8px;background:#fafcff;display:flex;flex-direction:column;gap:6px}
    .m.current{outline:2px solid var(--accent)}
    .m.past{opacity:.95}
    .m.future{opacity:.9}
    .m .line{display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .m .amt{font-weight:900}
    .m .paid-row{display:flex;gap:6px;align-items:center}
    .m input[type="number"]{background:#fff}
    .tiny{font-size:11px;color:var(--muted)}
    .status{font-size:12px;font-weight:800}
    .status.ok{color:var(--green)}
    .status.partial{color:#0ea5e9}
    .status.warn{color:var(--amber)}
    .status.late{color:#EF4444}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;font-weight:800;background:#eef2f7}
    .tag.now{background:#dbeafe}

    .legend{display:flex;gap:10px;align-items:center}
    .legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .bg-late{background:#ffe0e0}
    .bg-warn{background:#fff2cf}
    .bg-part{background:#e8f4ff}

    .events-grid{display:grid;gap:8px}
    .event-row{display:grid;grid-template-columns:1fr 1fr auto auto auto auto;gap:8px;align-items:end;background:#fafafa;border:1px solid #e6e6e6;border-radius:12px;padding:10px}
    .event-row input[type="number"]{background:#fff}
    .event-btn{padding:10px 12px;border-radius:10px;border:1px solid #e3e8ef;background:#eef2f7;font-weight:800;cursor:pointer}
    .event-btn.primary{background:var(--accent);color:#fff;border-color:transparent}

    @media (max-width: 1100px){.kpis{grid-template-columns:repeat(3,1fr)} .months{grid-template-columns:repeat(3,1fr)} }

    /* ×¡×¨×’×œ ×ª×—×ª×•×Ÿ */
    .footer{position:fixed;bottom:0;inset-inline:0;background:#0b1d2a;color:#fff;display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 16px;box-shadow:0 -8px 24px rgba(2,6,23,.25);font-weight:800;letter-spacing:.2px}
    .footer .dot{width:6px;height:6px;border-radius:999px;background:#0EA5E9}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h1>×¦×• ×©×™×§×•× ×›×œ×›×œ×™ â€“ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</h1>
      <div class="row">
        <label>×©× ×××œ× ×”×˜×•×¤×¡</label>
        <input type="text" id="fillerName" placeholder="×”×©× ×©×œ×š" />
      </div>
      <div class="row">
        <label>×ª××¨×™×š ××™×œ×•×™</label>
        <input type="text" id="fillDate" readonly />
      </div>
      <div class="row">
        <label>×ª××¨×™×š ××ª×Ÿ ×”×¦×•</label>
        <input type="date" id="orderDate" />
      </div>
      <div class="row">
        <label>×ª×—×•×œ×ª ×—×™×•×‘</label>
        <div class="seg" id="startSeg">
          <div class="pill active" data-v="next">×—×•×“×© ×”×‘×</div>
          <div class="pill" data-v="immediate">××™×™×“×™</div>
        </div>
      </div>
      <div class="row">
        <label>××¡' ×—×•×“×©×™ ×”×ª×•×›× ×™×ª</label>
        <div class="quick" id="termQuick">
          <div class="chip" data-v="36">36</div>
          <div class="chip" data-v="48">48</div>
          <div class="chip" data-v="60">60</div>
          <input type="number" id="termMonths" min="1" placeholder="×œ××©×œ 60" style="max-width:160px" />
        </div>
      </div>
      <div class="row">
        <label>×¦×• ×ª×©×œ×•××™×</label>
        <div class="seg" id="modeSeg">
          <div class="pill active" data-v="flat">×§×‘×•×¢</div>
          <div class="pill" data-v="tiered">×ª×©×œ×•× ××“×•×¨×’</div>
          <div class="pill" data-v="reduction">×”×¤×—×ª×ª ×ª×©×œ×•××™×</div>
        </div>
      </div>

      <div id="fields-flat" class="row">
        <label>×¡×›×•× ×—×•×“×©×™ ×§×‘×•×¢</label>
        <input type="number" id="flatAmount" placeholder="â‚ª" />
      </div>

      <div id="fields-tiered" class="card" style="display:none">
        <h2 style="margin-bottom:6px">×ª×©×œ×•× ××“×•×¨×’</h2>
        <div class="row"><label>×—×•×“×©×™ ××“×¨×’×” 1</label><input type="number" id="tier1Months" placeholder="×œ××©×œ 10" /></div>
        <div class="row"><label>×¡×›×•× ×—×•×“×©×™ â€“ ××“×¨×’×” 1</label><input type="number" id="tier1Amount" placeholder="â‚ª" /></div>
        <div class="row"><label>×¡×›×•× ×—×•×“×©×™ â€“ ××“×¨×’×” 2</label><input type="number" id="tier2Amount" placeholder="â‚ª" /></div>
      </div>

      <div id="fields-reduction" class="card" style="display:none">
        <h2 style="margin-bottom:6px">×”×¤×—×ª×ª ×ª×©×œ×•××™×</h2>
        <div class="events-grid" id="events"></div>
        <div class="quick" style="margin-top:8px">
          <button class="event-btn" id="addEvent">â• ×”×•×¡×£ ×”×¤×—×ª×”</button>
        </div>
        <div class="tiny">×œ×—×¥ "××©×¨" ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×”×”×—×œ×˜×” ×œ×¤×¨×™×¡×”. × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×¡×•×’ ×”×—×œ×˜×”: <b>×”×—×œ×˜×ª ×××•× ×”</b> ××• <b>×”×—×œ×˜×ª ×‘×™×ª ××©×¤×˜</b>.</div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><div class="k">×”×ª×—×œ×” â†’ ×¡×™×•×</div><div class="v" id="rangeKPI">â€”</div></div>
        <div class="kpi"><div class="k">××©×š ×”×ª×•×›× ×™×ª</div><div class="v" id="durationKPI">â€”</div></div>
        <div class="kpi"><div class="k">×¢×‘×¨ / × ×•×ª×¨</div><div class="v" id="elapsedLeftKPI">â€”</div><div class="bar"><span id="barElapsed"></span></div></div>
        <div class="kpi"><div class="k">×¦×¤×•×™ ×¢×“ ×”×™×•× / ×©×•×œ× ×¢×“ ×”×™×•×</div><div class="v" id="expectedPaidKPI">â€”</div><div class="bar"><span id="barPaid"></span></div></div>
        <div class="kpi"><div class="k">×¤×™×’×•×¨ (â‚ª) / ××¡' ×¤×™×’×•×¨×™×</div><div class="v" id="arrearsKPI">â€”</div></div>
        <div class="kpi"><div class="k">×¡×š ×”×ª×•×›× ×™×ª</div><div class="v" id="totalKPI">â€”</div></div>
      </div>

      <div class="quick" style="margin-top:10px; gap:8px">
        <button class="event-btn" id="exportCSV" disabled>×™×™×¦×•× ×œ-Google Sheets (CSV)</button>
        <button class="event-btn" id="copyTSV" disabled>×”×¢×ª×§×” ×œ×©×™×˜×¡ (×˜×‘×œ××™)</button>
        <button class="event-btn primary" id="sendToSheet" disabled>×©×œ×— × ×ª×•× ×™×</button>
      </div>
    </div>

    <div class="card">
      <div class="legend tiny">
        <span class="dot" style="background:#22C55E"></span> ×‘×–××Ÿ Â·
        <span class="dot" style="background:#EF4444"></span> ×¤×™×’×•×¨ Â·
        <span class="dot" style="background:#F59E0B"></span> ×ª×©×œ×•× ×¢×ª×™×“×™ ×œ×œ× ××™×©×•×¨ Â·
        <span class="dot" style="background:#0EA5E9"></span> ×ª×©×œ×•× ×—×œ×§×™ Â·
        <span class="tag now">×—×•×“×© × ×•×›×—×™</span>
      </div>
      <h2>×¤×¨×™×¡×” ×©× ×ª×™×ª (×©×•×¨×” = ×©× ×”, ×¢××•×“×•×ª = ×—×•×“×©×™×)</h2>
      <div id="years"></div>
    </div>

  </div>

  <div class="footer"><span class="dot"></span> × ×¢×¨×š ×¢×œ ×™×“×™ ××œ×™××‘ Â· ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª <span class="dot"></span></div>

  <script>
    const HEB_MONTHS = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

    // --- state keys
    const SKEY='rehab.v6.state', PKEY='rehab.v6.paid', DKEY='rehab.v6.paidDate', AKEY='rehab.v6.prepayApproval';

    // --- elements
    const orderDate = document.getElementById('orderDate');
    const fillerName = document.getElementById('fillerName');
    const fillDate = document.getElementById('fillDate');
    const startSeg = document.getElementById('startSeg');
    const termMonths = document.getElementById('termMonths');
    const termQuick = document.getElementById('termQuick');
    const modeSeg = document.getElementById('modeSeg');
    const flatAmount = document.getElementById('flatAmount');
    const t1m = document.getElementById('tier1Months');
    const t1a = document.getElementById('tier1Amount');
    const t2a = document.getElementById('tier2Amount');
    const fieldsFlat = document.getElementById('fields-flat');
    const fieldsTier = document.getElementById('fields-tiered');
    const fieldsRedu = document.getElementById('fields-reduction');
    const eventsWrap = document.getElementById('events');
    const exportCSVBtn = document.getElementById('exportCSV');
    const copyTSVBtn = document.getElementById('copyTSV');
    const sendBtn = document.getElementById('sendToSheet');
    const SHEET_NAME_KEY = 'rehab.v6.sheetName';
    const WEB_APP_KEY = 'rehab.v6.webAppUrl';

    // KPI els
    const rangeKPI=document.getElementById('rangeKPI'), durationKPI=document.getElementById('durationKPI'), elapsedLeftKPI=document.getElementById('elapsedLeftKPI'), expectedPaidKPI=document.getElementById('expectedPaidKPI'), arrearsKPI=document.getElementById('arrearsKPI'), totalKPI=document.getElementById('totalKPI');
    const barElapsed=document.getElementById('barElapsed'), barPaid=document.getElementById('barPaid');

    // storage helpers
    const num = v=> Number(String(v||'').replace(/[^0-9.-]/g,''))||0;
    const pad = n=> String(n).padStart(2,'0');
    const toKey = d=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-01`;
    const addMonths=(d,n)=>{const x=new Date(d);x.setMonth(x.getMonth()+n);return x};

    const read = k=>{ try{return JSON.parse(localStorage.getItem(k)||'{}')}catch{return{}} };
    const write = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    function getStartMode(){ return startSeg.querySelector('.pill.active').dataset.v }
    function setStartMode(v){ startSeg.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.v===v)) }
    startSeg.addEventListener('click', (e)=>{ if(e.target.classList.contains('pill')){ setStartMode(e.target.dataset.v); build(); }});

    function getMode(){ return modeSeg.querySelector('.pill.active').dataset.v }
    function setMode(v){ modeSeg.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.v===v));
      fieldsFlat.style.display = (v==='flat'||v==='reduction')? 'grid':'none';
      fieldsTier.style.display = (v==='tiered'||v==='reduction')? 'block':'none';
      fieldsRedu.style.display = (v==='reduction')? 'block':'none';
    }
    modeSeg.addEventListener('click', (e)=>{ if(e.target.classList.contains('pill')){ setMode(e.target.dataset.v); build(); }});

    termQuick.addEventListener('click', (e)=>{ const c=e.target.closest('.chip'); if(!c) return; termMonths.value=c.dataset.v; termQuick.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); build(); });

    // ----- reductions events -----
    function renderEventRow(ev={effective:'',amount:'',until:'end',untilDate:'', decision:'×××•× ×”'}){
      const row=document.createElement('div'); row.className='event-row';
      row.innerHTML=`
        <div>
          <label>×ª××¨×™×š ×ª×—×•×œ×”</label>
          <input type="date" data-f="eff" value="${ev.effective}">
        </div>
        <div>
          <label>×¡×›×•× ×—×“×©</label>
          <input type="number" data-f="amt" placeholder="â‚ª" value="${ev.amount}">
        </div>
        <div>
          <label>××©×š</label>
          <div class="seg" data-f="dur">
            <div class="pill ${ev.until==='end'?'active':''}" data-v="end">×¢×“ ×¡×•×£ ×”×ª×§×•×¤×”</div>
            <div class="pill ${ev.until==='date'?'active':''}" data-v="date">×¢×“ ×ª××¨×™×šâ€¦</div>
          </div>
        </div>
        <div>
          <label>×ª××¨×™×š ×¡×™×•×</label>
          <input type="date" data-f="until" ${ev.until==='date'? '' : 'disabled'} value="${ev.untilDate||''}">
        </div>
        <div>
          <label>×¡×•×’ ×”×—×œ×˜×”</label>
          <div class="seg" data-f="dec">
            <div class="pill ${ev.decision==='×××•× ×”'?'active':''}" data-v="×××•× ×”">×”×—×œ×˜×ª ×××•× ×”</div>
            <div class="pill ${ev.decision==='×‘×™×ª ××©×¤×˜'?'active':''}" data-v="×‘×™×ª ××©×¤×˜">×”×—×œ×˜×ª ×‘×™×”"×©</div>
          </div>
        </div>
        <div>
          <button class="event-btn primary" data-act="apply">××©×¨</button>
          <button class="event-btn" data-act="del">××—×§</button>
        </div>`;
      row.addEventListener('click', (e)=>{
        const pill=e.target.closest('.pill'); if(pill && pill.parentElement.dataset.f==='dur'){ row.querySelectorAll('[data-f="dur"] .pill').forEach(p=>p.classList.remove('active')); pill.classList.add('active'); row.querySelector('[data-f="until"]').disabled = pill.dataset.v!=='date'; }
        if(pill && pill.parentElement.dataset.f==='dec'){ row.querySelectorAll('[data-f="dec"] .pill').forEach(p=>p.classList.remove('active')); pill.classList.add('active'); }
        const act=e.target.dataset.act;
        if(act==='apply'){ const ev=collectEvent(row); if(!ev.effective||!ev.amount) return alert('× × ×œ××œ× ×ª××¨×™×š ×ª×—×•×œ×” ×•×¡×›×•×'); addReduction(ev); row.remove(); }
        if(act==='del'){ row.remove(); }
      });
      eventsWrap.appendChild(row);
    }

    document.getElementById('addEvent').addEventListener('click',()=> renderEventRow());

    function collectEvent(row){
      return {
        effective: row.querySelector('[data-f="eff"]').value,
        amount: num(row.querySelector('[data-f="amt"]').value),
        until: row.querySelector('[data-f="dur"] .pill.active').dataset.v, // end | date
        untilDate: row.querySelector('[data-f="until"]').value,
        decision: row.querySelector('[data-f="dec"] .pill.active').dataset.v
      }
    }

    function getEvents(){ return JSON.parse(localStorage.getItem('reductions')||'[]'); }
    function setEvents(arr){ localStorage.setItem('reductions', JSON.stringify(arr)); }
    function addReduction(ev){ const arr=getEvents(); arr.push(ev); setEvents(arr); build(); }

    // ×”×§×“××ª ×ª×©×œ×•××™× â€“ ×ª××¨×™×š ×”×—×œ×˜×”
    function getPrepayApproval(){ return localStorage.getItem(AKEY)||'' }
    function setPrepayApproval(v){ localStorage.setItem(AKEY, v) }

    // paid maps
    const getPaid = ()=> read(PKEY); const setPaid = v=> write(PKEY,v);
    const getPaidDate = ()=> read(DKEY); const setPaidDate=v=> write(DKEY,v);

    function baseAmount(idx){
      if(num(t1m.value)||num(t1a.value)||num(t2a.value)) return (idx < num(t1m.value))? num(t1a.value): num(t2a.value);
      return num(flatAmount.value)||0;
    }

    function build(){
      // save state
      write(SKEY, {orderDate:orderDate.value, start:getStartMode(), term:num(termMonths.value), mode:getMode(), flat:num(flatAmount.value), t1m:num(t1m.value), t1a:num(t1a.value), t2a:num(t2a.value), fillerName:fillerName.value});

      const startRaw = orderDate.value? new Date(orderDate.value): null; const monthsCount = num(termMonths.value);
      const ready = !!(startRaw && monthsCount>0);
      setActionsEnabled(ready);
      if(!ready){ document.getElementById('years').innerHTML=''; rangeKPI.textContent='â€”'; durationKPI.textContent='â€”'; elapsedLeftKPI.textContent='â€”'; expectedPaidKPI.textContent='â€”'; arrearsKPI.textContent='â€”'; totalKPI.textContent='â€”'; return; }
      if(!startRaw || monthsCount<=0){ document.getElementById('years').innerHTML=''; rangeKPI.textContent='â€”'; return; }
      const start = new Date(startRaw); if(getStartMode()==='next') start.setMonth(start.getMonth()+1);

      const reductions = getEvents().sort((a,b)=> new Date(a.effective)-new Date(b.effective));
      const months=[];
      for(let i=0;i<monthsCount;i++){
        const due = addMonths(start, i); let expected = baseAmount(i);
        reductions.forEach(ev=>{
          const effM = new Date(new Date(ev.effective).getFullYear(), new Date(ev.effective).getMonth(),1);
          const dueM = new Date(due.getFullYear(), due.getMonth(),1);
          let inRange = effM <= dueM;
          if(ev.until==='date' && ev.untilDate){ const untilM = new Date(new Date(ev.untilDate).getFullYear(), new Date(ev.untilDate).getMonth(),1); inRange = inRange && (dueM <= untilM); }
          if(inRange) expected = ev.amount;
        });
        const key=toKey(due); const paidMap=getPaid(); const paid= num(paidMap[key]); const paidDate = getPaidDate()[key]||'';
        months.push({idx:i,due,key,expected,paid,paidDate});
      }

      const end = months[months.length-1].due; rangeKPI.textContent = `${start.toLocaleDateString('he-IL')} â†’ ${end.toLocaleDateString('he-IL')}`;
      durationKPI.textContent = `${Math.floor(months.length/12)} ×©× ×™× ×•-${months.length%12} ×—×•×“×©×™×`;
      const todayM = new Date(new Date().getFullYear(), new Date().getMonth(),1);
      const elapsed = months.filter(m=> new Date(m.due.getFullYear(),m.due.getMonth(),1)<=todayM).length; const left=Math.max(0,months.length-elapsed);
      elapsedLeftKPI.textContent = `${elapsed} / ${left}`; barElapsed.style.width = `${(elapsed/months.length)*100}%`;
      const expToDate = months.filter(m=> new Date(m.due.getFullYear(),m.due.getMonth(),1)<=todayM).reduce((s,m)=>s+m.expected,0);
      const paidToDate = months.filter(m=> new Date(m.due.getFullYear(),m.due.getMonth(),1)<=todayM).reduce((s,m)=>s+m.paid,0);
      expectedPaidKPI.textContent = `â‚ª ${fmt(expToDate)} / â‚ª ${fmt(paidToDate)}`; barPaid.style.width = `${Math.min(100,(paidToDate/Math.max(1,expToDate))*100)}%`;

      const yearsDiv = document.getElementById('years'); yearsDiv.innerHTML='';
      const groups = new Map(); months.forEach(m=>{ const y=m.due.getFullYear(); if(!groups.has(y)) groups.set(y,[]); groups.get(y).push(m) });
      const years = Array.from(groups.keys()).sort((a,b)=> a-b); // ××”×™×©×Ÿ ×œ×—×“×©
      const prepayApproval = getPrepayApproval();

      let lateCount=0; let arrears=0;

      years.forEach(y=>{
        const wrap=document.createElement('div'); wrap.className='year';
        wrap.innerHTML = `<div class="year-head"><div><strong>${y}</strong></div><div class="tiny">"××•×¢×“ ×ª×©×œ×•× ×‘×¤×•×¢×œ" ××–×•×”×” ×¢"×™ ×”××™×™×§×•×Ÿ ğŸ“…</div></div>`;
        const row=document.createElement('div'); row.className='months';
        const list=groups.get(y).sort((a,b)=> a.due-b.due);
        for(let m=0;m<12;m++){
          const md=list.find(x=> x.due.getMonth()===m);
          const cell=document.createElement('div'); cell.className='m';
          if(!md){ cell.classList.add('future'); cell.innerHTML=`<div class="line"><span>${HEB_MONTHS[m]}</span><span class="amt">â€”</span></div>`; row.appendChild(cell); continue; }
          const due=md.due; const dueM=new Date(due.getFullYear(), due.getMonth(),1); const todayM2 = todayM;
          const isCurrent = (dueM.getTime()===todayM2.getTime());
          const isFuture = (dueM>todayM2); const isPast = (dueM<todayM2);
          if(isCurrent) cell.classList.add('current'); if(isFuture) cell.classList.add('future'); if(isPast) cell.classList.add('past');

          const endOfMonth = new Date(due.getFullYear(), due.getMonth()+1, 0);
          const lateThreshold = new Date(endOfMonth); lateThreshold.setDate(lateThreshold.getDate()+20);
          let status='ok'; let statusText='×‘×–××Ÿ'; let bgClass='';
          if(md.paid>0 && md.paidDate){
            const payD=new Date(md.paidDate);
            if(payD < new Date(due.getFullYear(), due.getMonth(), 1)){
              if(!prepayApproval || new Date(prepayApproval) > payD){ status='warn'; statusText='×ª×©×œ×•× ×¢×ª×™×“×™ ×œ×œ× ××™×©×•×¨'; bgClass='bg-warn'; }
            }
          }
          if(isPast || isCurrent){
            if(md.paid < md.expected){ status='partial'; statusText='×ª×©×œ×•× ×—×œ×§×™'; bgClass='bg-part'; }
            if(md.paidDate){ const payD=new Date(md.paidDate); if(payD>lateThreshold){ status='late'; statusText='×¤×™×’×•×¨'; bgClass='bg-late'; lateCount++; } }
            if(isPast){ arrears += Math.max(0, md.expected - md.paid); }
          }

          cell.innerHTML = `
            <div class="line"><span>${HEB_MONTHS[m]} ${isCurrent?'<span class="tag now">×—×•×“×© × ×•×›×—×™</span>':''}</span><span class="amt">â‚ª ${fmt(md.expected)}</span></div>
            <div class="paid-row">
              <input type="number" min="0" placeholder="×©×•×œ× ×‘×¤×•×¢×œ" value="${md.paid||''}" data-k="${md.key}">
              <button title="×§×‘×¢ ×ª××¨×™×š ×ª×©×œ×•× ×‘×¤×•×¢×œ" data-date="${md.key}">ğŸ“… ×‘×¤×•×¢×œ</button>
              <button title="×¡×›×•× ××œ×" data-full="${md.key}">ğŸ’¯ ××œ×</button>
            </div>
            <div class="line"><span class="status ${status}">${isFuture?'×˜×¨×':statusText}</span><span class="tiny">${md.paidDate?('×ª×©×œ×•×: '+md.paidDate):''}</span></div>`;
          if(bgClass) cell.classList.add(bgClass);

          cell.querySelector('[data-full]')?.addEventListener('click',()=>{ const p=getPaid(); p[md.key]=md.expected; setPaid(p); build(); });
          cell.querySelector('[data-date]')?.addEventListener('click',()=>{ const d=prompt('×ª××¨×™×š ×ª×©×œ×•× ×‘×¤×•×¢×œ (YYYY-MM-DD)'); if(d!==null){ const pd=getPaidDate(); pd[md.key]=d; setPaidDate(pd); build(); }});
          cell.querySelector('input')?.addEventListener('change', (e)=>{ const p=getPaid(); p[md.key]=num(e.target.value); setPaid(p); build(); });

          row.appendChild(cell);
        }
        wrap.appendChild(row);
        const appr=document.createElement('div'); appr.className='tiny';
        appr.innerHTML = `××™×©×•×¨ ×”×§×“××ª ×ª×©×œ×•××™× (××•×¤×¦×™×•× ×œ×™): <button class="event-btn" id="setPrepay${y}">×§×‘×¢ ×ª××¨×™×š ×”×—×œ×˜×”</button> <span id="apvText${y}">${getPrepayApproval()||'â€”'}</span>`;
        wrap.appendChild(appr);
        wrap.querySelector('#setPrepay'+y).addEventListener('click',()=>{ const d=prompt('×ª××¨×™×š ×”×—×œ×˜×” ×œ××™×©×•×¨ ×”×§×“××ª ×ª×©×œ×•××™× (YYYY-MM-DD)', getPrepayApproval()||''); if(d!==null){ setPrepayApproval(d); document.getElementById('apvText'+y).textContent=d||'â€”'; build(); }});
        document.getElementById('years').appendChild(wrap);
      });

      arrearsKPI.textContent = `â‚ª ${fmt(arrears)} / ${lateCount} ×¤×™×’×•×¨×™×`;
      totalKPI.textContent = `â‚ª ${fmt(months.reduce((s,m)=>s+m.expected,0))}`;
    }

    function fmt(n){ return new Intl.NumberFormat('he-IL').format(Math.round(n||0)); }

    // Export helpers for Google Sheets
    function monthsToRows(months){
      const rows = months.map(m=>[
        HEB_MONTHS[m.due.getMonth()], m.due.getFullYear(), m.key, m.expected, m.paid || '', m.paidDate || '', fillerName.value || '', new Date().toLocaleDateString('he-IL')
      ]);
      return [['×—×•×“×©','×©× ×”','××¤×ª×—','×¦×¤×•×™','×©×•×œ× ×‘×¤×•×¢×œ','×ª××¨×™×š ×ª×©×œ×•× ×‘×¤×•×¢×œ','×©× ×××œ×','×ª××¨×™×š ×™×¦×•×'], ...rows];
    }
    function downloadCSV(rows){
      const csv = rows.map(r=> r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('
');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rehab-export-${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
    }
    function copyTSV(rows){ const tsv = rows.map(r=> r.join('	')).join('
'); navigator.clipboard.writeText(tsv).then(()=> alert('×”×˜×‘×œ×” ×”×•×¢×ª×§×” â€“ ×”×“×‘×§ ×™×©×™×¨×•×ª ×œ-Google Sheets')); }

    exportCSVBtn.addEventListener('click', ()=>{
      const startRaw = orderDate.value? new Date(orderDate.value): null; if(!startRaw){ alert('×—×¡×¨ ×ª××¨×™×š ×¦×•'); return; }
      const start = new Date(startRaw); if(getStartMode()==='next') start.setMonth(start.getMonth()+1);
      const monthsCount = num(termMonths.value)||0; const months=[];
      for(let i=0;i<monthsCount;i++){ const due=addMonths(start,i); const key = `${due.getFullYear()}-${String(due.getMonth()+1).padStart(2,'0')}-01`; const expected = baseAmount(i); const paid = getPaid()[key]||''; const paidDate = getPaidDate()[key]||''; months.push({due,key,expected,paid,paidDate}); }
      downloadCSV(monthsToRows(months));
    });
    copyTSVBtn.addEventListener('click', ()=>{
      const startRaw = orderDate.value? new Date(orderDate.value): null; if(!startRaw){ alert('×—×¡×¨ ×ª××¨×™×š ×¦×•'); return; }
      const start = new Date(startRaw); if(getStartMode()==='next') start.setMonth(start.getMonth()+1);
      const monthsCount = num(termMonths.value)||0; const months=[];
      for(let i=0;i<monthsCount;i++){ const due=addMonths(start,i); const key = `${due.getFullYear()}-${String(due.getMonth()+1).padStart(2,'0')}-01`; const expected = baseAmount(i); const paid = getPaid()[key]||''; const paidDate = getPaidDate()[key]||''; months.push({due,key,expected,paid,paidDate}); }
      copyTSV(monthsToRows(months));
    });

    // "×©×œ×— × ×ª×•× ×™×" â€“ ×™×©×œ×— ×™×©×™×¨×•×ª ×œ-Apps Script (×× ×”×•×’×“×¨ URL), ××—×¨×ª ×™×¦×™×¢ ×œ×”×’×“×™×¨
    sendBtn.addEventListener('click', async ()=>{
      const currentName = localStorage.getItem(SHEET_NAME_KEY)||'';
      const name = prompt('×©× ×’×™×œ×™×•×Ÿ ×—×“×© ×‘×©×™×˜×¡ (×œ×“×•×’××”: ×¦×•_12345)', currentName);
      if(name===null) return; localStorage.setItem(SHEET_NAME_KEY, name);

      const startRaw = orderDate.value? new Date(orderDate.value): null; if(!startRaw){ alert('×—×¡×¨ ×ª××¨×™×š ×¦×•'); return; }
      const start = new Date(startRaw); if(getStartMode()==='next') start.setMonth(start.getMonth()+1);
      const monthsCount = num(termMonths.value)||0; const months=[];
      for(let i=0;i<monthsCount;i++){ const due=addMonths(start,i); const key = `${due.getFullYear()}-${String(due.getMonth()+1).padStart(2,'0')}-01`; const expected = baseAmount(i); const paid = getPaid()[key]||''; const paidDate = getPaidDate()[key]||''; months.push({due,key,expected,paid,paidDate}); }
      const rows = monthsToRows(months);

      let url = localStorage.getItem(WEB_APP_KEY)||'';
      if(!url){
        url = prompt('×”×“×‘×§ ×›××Ÿ ××ª ×”-URL ×©×œ ×”-Web App (Apps Script) ×œ×§×‘×œ×ª × ×ª×•× ×™×', '');
        if(url===null || url.trim()===''){ alert('×œ× ×”×•×’×“×¨ Web App. ××‘×¦×¢ ×”×•×¨×“×ª CSV ×•×”×¢×ª×§×” ×œ×©×™×˜×¡ ×›×—×œ×•×¤×”.');
          downloadCSV(rows); copyTSV(rows); return; }
        localStorage.setItem(WEB_APP_KEY, url.trim());
      }

      try{
        const resp = await fetch(url + '?sheet=' + encodeURIComponent(name), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(rows)});
        const text = await resp.text();
        if(resp.ok && /OK/i.test(text)){ alert('× ×©×œ×— ×œ×’×™×œ×™×•×Ÿ ×‘×”×¦×œ×—×”! ×œ×©×•× ×™×ª: ' + name); }
        else { throw new Error(text||'HTTP '+resp.status); }
      }catch(err){
        console.error(err);
        alert('×©×œ×™×—×” ×™×©×™×¨×” × ×›×©×œ×”: '+ err + '\n××•×¨×™×“ CSV ×•××¢×ª×™×§ ×œ×˜×‘×œ×” ×›×’×™×‘×•×™.');
        downloadCSV(rows); copyTSV(rows);
      }
    }); return; }
      const start = new Date(startRaw); if(getStartMode()==='next') start.setMonth(start.getMonth()+1);
      const monthsCount = num(termMonths.value)||0; const months=[];
      for(let i=0;i<monthsCount;i++){ const due=addMonths(start,i); const key = `${due.getFullYear()}-${String(due.getMonth()+1).padStart(2,'0')}-01`; const expected = baseAmount(i); const paid = getPaid()[key]||''; const paidDate = getPaidDate()[key]||''; months.push({due,key,expected,paid,paidDate}); }
      copyTSV(monthsToRows(months));
    });

    // boot: load state
    (function init(){
      fillDate.value = new Date().toLocaleString('he-IL');
      const s = read(SKEY); if(s.orderDate) orderDate.value = s.orderDate; setStartMode(s.start||'next'); if(s.term) termMonths.value=s.term; setMode(s.mode||'flat'); flatAmount.value=s.flat||''; t1m.value=s.t1m||''; t1a.value=s.t1a||''; t2a.value=s.t2a||''; if(s.fillerName) fillerName.value = s.fillerName;
      document.querySelectorAll('input,select').forEach(el=> el.addEventListener('change', build));
      build();
    })();

    function setActionsEnabled(on){
      [exportCSVBtn, copyTSVBtn, sendBtn].forEach(btn=>{ if(!btn) return; btn.disabled = !on; btn.style.opacity = on? '1' : '.6'; });
    }
  </script>
</body>
</html>
