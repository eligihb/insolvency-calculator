<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>צו שיקום – פריסה חודשית</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0B1D2A; --paper:#F6F7FB; --card:#fff; --ink:#0B2533; --ink2:#4b5b66;
      --accent:#0EA5E9; --green:#22C55E; --amber:#F59E0B; --red:#EF4444; --muted:#E7F1FF;
      --radius:18px; --shadow:0 8px 24px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:"Heebo",system-ui; background:var(--paper); color:var(--ink)}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:auto;padding:18px 14px 110px}
    header{background:var(--bg);color:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:12px}
    header h1{margin:0 0 6px;font-weight:800;font-size:clamp(20px,3vw,28px)}
    header p{margin:0;opacity:.9}

    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:380px 1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 10px;font-size:18px}
    .row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:8px 0}
    .row label{font-weight:600}
    input[type="number"], input[type="date"], select{width:100%;padding:10px;border-radius:12px;border:1px solid #d7dee6;background:#F3F7FE}
    input[type="number"]{direction:ltr;text-align:left}
    .hint{color:var(--ink2);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eef6ff;color:#084c8a;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}

    .tabs{display:flex;gap:6px;margin:8px 0 2px}
    .tab{padding:8px 10px;border-radius:12px;background:#f1f5f9;cursor:pointer;font-weight:700}
    .tab.active{background:var(--accent);color:#fff}
    .tabpanel{display:none;margin-top:8px}
    .tabpanel.active{display:block}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#5b6b76;text-align:right;padding:6px 8px}
    tbody td{background:#fff;padding:10px 8px;vertical-align:middle}
    tbody tr{box-shadow:var(--shadow);border-radius:12px}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}

    .badge{display:inline-block;background:#FFF6CC;color:#8a5a00;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:700}
    .status{font-weight:800}
    .status.ok{color:var(--green)}
    .status.late{color:var(--red)}
    .status.pending{color:#64748B}

    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(min-width:700px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{background:#fff;padding:12px;border-radius:16px;box-shadow:var(--shadow)}
    .kpi .k{color:#6b7c88;font-size:12px}
    .kpi .v{font-size:22px;font-weight:900}

    .dock{position:fixed;inset-inline:0;bottom:0;background:#fff;border-top:1px solid #e6ebf2;box-shadow:0 -8px 24px rgba(2,6,23,.07);padding:10px 14px}
    .dock-inner{max-width:1200px;margin:auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#f1f5f9}
    .btn.warn{background:var(--amber);color:#fff}
    .btn.success{background:var(--green);color:#fff}

    .events{display:flex;flex-direction:column;gap:8px}
    .event{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}
    .event input{background:#fff}

    @media print{
      @page{size:A4 landscape;margin:10mm}
      body{background:#fff}
      .dock, .tabs{display:none!important}
      .wrap{padding:0}
      header{margin-bottom:8px}
      .grid{grid-template-columns:340px 1fr;gap:8px}
      .card{box-shadow:none;border:1px solid #e9eef5}
      tbody tr{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>צו שיקום – הזנת צו ופריסה חודשית</h1>
      <p>המסך הזה מקבל את נתוני ההחלטה (אין חישוב קובע), בונה פריסת חודשים אוטומטית, ומחשב סטטוס/פיגור לפי תשלומים בפועל. <span class="pill">גרסת MVP</span></p>
    </header>

    <div class="grid">
      <!-- צד ימין: פרטי צו + מצב תמחור + אירועים -->
      <section class="card">
        <h2>פרטי צו</h2>
        <div class="row">
          <label>תאריך מתן הצו</label>
          <input type="date" id="orderDate" />
        </div>
        <div class="row">
          <label>תחולת חיוב</label>
          <select id="startMode">
            <option value="next" selected>חודש הבא (ברירת מחדל)</option>
            <option value="immediate">מיידי</option>
          </select>
        </div>
        <div class="row">
          <label>מס' חודשים בתוכנית</label>
          <input type="number" id="termMonths" min="1" step="1" value="60" />
        </div>

        <h2 style="margin-top:14px">מצבי תמחור</h2>
        <div class="tabs" role="tablist">
          <div class="tab active" data-tab="fixed" role="tab">קבוע</div>
          <div class="tab" data-tab="tiered" role="tab">מדורגה</div>
          <div class="tab" data-tab="reductions" role="tab">הפחתה (אירועים)</div>
        </div>

        <!-- קבוע -->
        <div id="panel-fixed" class="tabpanel active">
          <div class="row">
            <label>סכום חודשי קבוע</label>
            <input type="number" id="flatAmount" min="0" step="50" value="0" />
          </div>
          <div class="hint">במצב קבוע נתעלם ממדרגות. אירועי הפחתה (אם מוגדרים) יכולים לדרוס מסכום זה החל מתחולתם.</div>
        </div>

        <!-- מדורגה -->
        <div id="panel-tiered" class="tabpanel">
          <div class="row">
            <label>חודשי מדרגה 1</label>
            <input type="number" id="tier1Months" min="0" step="1" value="10" />
          </div>
          <div class="row">
            <label>סכום חודשי – מדרגה 1</label>
            <input type="number" id="tier1Amount" min="0" step="50" value="1000" />
          </div>
          <div class="row">
            <label>סכום חודשי – מדרגה 2</label>
            <input type="number" id="tier2Amount" min="0" step="50" value="4000" />
          </div>
          <div class="hint">מדרגה 2 תחול אוטומטית על יתרת החודשים (Term − חודשי מדרגה 1). אירועי הפחתה יכולים לדרוס מסכומים אלו מרגע תחולתם.</div>
        </div>

        <!-- אירועי הפחתה -->
        <div id="panel-reductions" class="tabpanel">
          <div class="events" id="events"></div>
          <button class="btn ghost" id="addEventBtn" style="margin-top:6px">➕ הוסף אירוע הפחתה</button>
          <div class="hint">כל אירוע מגדיר סכום חודשי חדש החל מתאריך התחולה ועד סוף התקופה (או עד אירוע מאוחר יותר).</div>
        </div>

      </section>

      <!-- צד שמאל: KPIs + טבלת פריסה -->
      <section class="card">
        <h2>מדדי התקדמות</h2>
        <div class="kpis">
          <div class="kpi"><div class="k">התחלה → סיום</div><div class="v" id="rangeKPI">—</div></div>
          <div class="kpi"><div class="k">משך התוכנית</div><div class="v" id="durationKPI">—</div></div>
          <div class="kpi"><div class="k">עבר / נותר (חוד׳)</div><div class="v" id="elapsedLeftKPI">—</div></div>
          <div class="kpi"><div class="k">צפוי עד היום / שולם עד היום</div><div class="v" id="expectedPaidKPI">—</div></div>
          <div class="kpi"><div class="k">פיגור</div><div class="v" id="arrearsKPI">—</div></div>
          <div class="kpi"><div class="k">סך התוכנית</div><div class="v" id="totalKPI">—</div></div>
        </div>

        <h2 style="margin-top:14px">פריסה חודשית</h2>
        <div style="overflow:auto;max-height:60vh;border:1px solid #e7edf5;border-radius:12px">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th>#</th>
                <th>שנה</th>
                <th>מועד חיוב</th>
                <th>סכום צפוי</th>
                <th>שולם בפועל</th>
                <th>צפוי מצטבר</th>
                <th>שולם מצטבר</th>
                <th>Delta</th>
                <th>סטטוס</th>
                <th>הערה</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <div class="dock">
    <div class="dock-inner">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" id="resetBtn">איפוס</button>
        <button class="btn warn" id="fillDemoBtn">נתוני דוגמה</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="printBtn">הדפסה A4</button>
        <button class="btn success" id="exportBtn">ייצוא JSON</button>
      </div>
    </div>
  </div>

  <script>
    const els = {
      orderDate: document.getElementById('orderDate'),
      startMode: document.getElementById('startMode'),
      termMonths: document.getElementById('termMonths'),
      flatAmount: document.getElementById('flatAmount'),
      tier1Months: document.getElementById('tier1Months'),
      tier1Amount: document.getElementById('tier1Amount'),
      tier2Amount: document.getElementById('tier2Amount'),
      tabs: Array.from(document.querySelectorAll('.tab')),
      panels: {
        fixed: document.getElementById('panel-fixed'),
        tiered: document.getElementById('panel-tiered'),
        reductions: document.getElementById('panel-reductions')
      },
      eventsWrap: document.getElementById('events'),
      addEventBtn: document.getElementById('addEventBtn'),
      scheduleBody: document.getElementById('scheduleBody'),
      rangeKPI: document.getElementById('rangeKPI'),
      durationKPI: document.getElementById('durationKPI'),
      elapsedLeftKPI: document.getElementById('elapsedLeftKPI'),
      expectedPaidKPI: document.getElementById('expectedPaidKPI'),
      arrearsKPI: document.getElementById('arrearsKPI'),
      totalKPI: document.getElementById('totalKPI'),
      printBtn: document.getElementById('printBtn'),
      exportBtn: document.getElementById('exportBtn'),
      resetBtn: document.getElementById('resetBtn'),
      fillDemoBtn: document.getElementById('fillDemoBtn')
    };

    const KEY_STATE = 'rehabOrder.v2.state';
    const KEY_PAID  = 'rehabOrder.v2.paid';

    function num(v){ return Number(String(v||'').replace(/[^\d.-]/g,'')||0); }
    function fmtN(n){ return new Intl.NumberFormat('he-IL').format(Math.round(n||0)); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function addMonths(d, n){ const dt=new Date(d.getTime()); dt.setMonth(dt.getMonth()+n); return dt; }

    function getStartDate(orderDate, mode){
      if(!orderDate) return null;
      const d = new Date(orderDate);
      return (mode==='next') ? addMonths(d,1) : d;
    }

    function readEvents(){
      const blocks = Array.from(els.eventsWrap.querySelectorAll('.event'));
      const list = blocks.map(b=>({
        effective: b.querySelector('input[type="date"]').value,
        amount: num(b.querySelector('input[type="number"]').value)
      })).filter(e=>e.effective);
      // sort by date asc
      return list.sort((a,b)=> new Date(a.effective)-new Date(b.effective));
    }

    function renderEventRow(eff=null, amt=''){
      const row = document.createElement('div');
      row.className='event';
      row.innerHTML = `
        <input type="date" value="${eff?eff:''}"/>
        <input type="number" min="0" step="50" value="${amt}" placeholder="סכום חודשי חדש"/>
        <button class="btn ghost" title="מחק">🗑️</button>
      `;
      row.querySelector('button').addEventListener('click',()=>{ row.remove(); build(); });
      row.addEventListener('input', ()=> build());
      els.eventsWrap.appendChild(row);
    }

    els.addEventBtn.addEventListener('click', ()=>{ renderEventRow(); });

    // tabs
    els.tabs.forEach(t=> t.addEventListener('click', ()=>{
      els.tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const which = t.dataset.tab;
      Object.entries(els.panels).forEach(([k,p])=> p.classList.toggle('active', k===which));
      build();
    }));

    // paid map: { 'YYYY-MM-01': amount }
    function readPaid(){
      try{ return JSON.parse(localStorage.getItem(KEY_PAID))||{} }catch{ return {} }
    }
    function writePaid(map){ localStorage.setItem(KEY_PAID, JSON.stringify(map)); }

    function saveState(){
      const state = {
        orderDate: els.orderDate.value,
        startMode: els.startMode.value,
        termMonths: num(els.termMonths.value),
        flatAmount: num(els.flatAmount.value),
        tier1Months: num(els.tier1Months.value),
        tier1Amount: num(els.tier1Amount.value),
        tier2Amount: num(els.tier2Amount.value),
        activeTab: document.querySelector('.tab.active')?.dataset.tab,
        events: readEvents()
      };
      localStorage.setItem(KEY_STATE, JSON.stringify(state));
    }

    function loadState(){
      const raw = localStorage.getItem(KEY_STATE); if(!raw) return;
      try{
        const s = JSON.parse(raw);
        els.orderDate.value = s.orderDate||'';
        els.startMode.value = s.startMode||'next';
        els.termMonths.value = s.termMonths||60;
        els.flatAmount.value = s.flatAmount||0;
        els.tier1Months.value = s.tier1Months||10;
        els.tier1Amount.value = s.tier1Amount||1000;
        els.tier2Amount.value = s.tier2Amount||4000;
        // events
        els.eventsWrap.innerHTML='';
        (s.events||[]).forEach(ev=> renderEventRow(ev.effective, ev.amount));
        // tab
        const targetTab = s.activeTab||'fixed';
        els.tabs.forEach(x=> x.classList.toggle('active', x.dataset.tab===targetTab));
        Object.entries(els.panels).forEach(([k,p])=> p.classList.toggle('active', k===targetTab));
      }catch{}
    }

    // schedule building
    function build(){
      saveState();
      const paidMap = readPaid();

      const orderDate = els.orderDate.value ? new Date(els.orderDate.value) : null;
      const startMode = els.startMode.value;
      const term = num(els.termMonths.value)||0;
      if(!orderDate || term<=0){ els.scheduleBody.innerHTML=''; updateKPIs([],paidMap); return; }

      const startDate = getStartDate(orderDate, startMode);
      const events = readEvents();
      const activeTab = document.querySelector('.tab.active')?.dataset.tab;

      // base function
      function baseAmount(idx){ // idx = 0..term-1
        if(activeTab==='tiered'){
          const t1m = num(els.tier1Months.value)||0;
          const a1 = num(els.tier1Amount.value)||0;
          const a2 = num(els.tier2Amount.value)||0;
          return (idx < t1m) ? a1 : a2;
        }
        // default fixed
        return num(els.flatAmount.value)||0;
      }

      // schedule array
      const rows = [];
      for(let i=0;i<term;i++){
        const due = addMonths(startDate, i);
        const y = due.getFullYear();
        const m = due.getMonth()+1;
        const key = `${y}-${pad(m)}-01`; // month key
        // expected
        let expected = baseAmount(i);
        // override by latest reduction event <= due
        for(const ev of events){
          const eff = new Date(ev.effective);
          const effMonth = new Date(eff.getFullYear(), eff.getMonth(), 1);
          const dueMonth = new Date(due.getFullYear(), due.getMonth(), 1);
          if(effMonth <= dueMonth){ expected = ev.amount; } else { break; }
        }
        const paid = num(paidMap[key]);
        rows.push({ idx:i+1, year:y, due, key, expected, paid });
      }

      // cumulative + status
      let cumExp=0, cumPaid=0;
      const today = new Date();
      rows.forEach(r=>{
        cumExp += r.expected;
        cumPaid += r.paid;
        r.cumExp = cumExp;
        r.cumPaid = cumPaid;
        const dueMonth = new Date(r.due.getFullYear(), r.due.getMonth(), 1);
        const todayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        if(dueMonth > todayMonth){ r.status = 'pending'; }
        else { r.status = (r.cumPaid >= r.cumExp) ? 'ok' : 'late'; }
        // note badge if event starts exactly on this due month
        r.note = events.some(ev=>{
          const eff = new Date(ev.effective);
          return eff.getFullYear()===r.due.getFullYear() && eff.getMonth()===r.due.getMonth();
        }) ? 'צו מעודכן' : '';
      });

      // render table
      els.scheduleBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.idx}</td>
          <td>${r.year}</td>
          <td>${toISODate(r.due)}</td>
          <td>₪ ${fmtN(r.expected)} ${r.note?`<span class="badge">${r.note}</span>`:''}</td>
          <td>
            <input type="number" min="0" step="50" style="width:120px" value="${r.paid||''}" />
          </td>
          <td>₪ ${fmtN(r.cumExp)}</td>
          <td>₪ ${fmtN(r.cumPaid)}</td>
          <td>${fmtN(r.expected - r.paid)}</td>
          <td class="status ${r.status}">${r.status==='pending'?'טרם הגיע מועד':(r.status==='ok'?'בזמן/עודף':'פיגור')}</td>
          <td>${r.note? 'צו מעודכן':''}</td>
        `;
        const input = tr.querySelector('input');
        input.addEventListener('input', ()=>{
          const v = num(input.value);
          const map = readPaid();
          map[r.key] = v;
          writePaid(map);
          build(); // rebuild to refresh cumulatives & status
        });
        els.scheduleBody.appendChild(tr);
      });

      updateKPIs(rows, readPaid());
    }

    function updateKPIs(rows, paidMap){
      if(!rows.length){
        els.rangeKPI.textContent = '—';
        els.durationKPI.textContent = '—';
        els.elapsedLeftKPI.textContent = '—';
        els.expectedPaidKPI.textContent = '—';
        els.arrearsKPI.textContent = '—';
        els.totalKPI.textContent = '—';
        return;
      }
      const start = rows[0].due, end = rows[rows.length-1].due;
      els.rangeKPI.textContent = `${toISODate(start)} → ${toISODate(end)}`;
      // duration in years & months
      const months = rows.length;
      const years = Math.floor(months/12), remM = months%12;
      els.durationKPI.textContent = `${years} שנים ו-${remM} חודשים`;
      const today = new Date();
      const elapsed = rows.filter(r=> new Date(r.due.getFullYear(), r.due.getMonth(), 1) <= new Date(today.getFullYear(), today.getMonth(), 1)).length;
      const left = Math.max(0, months - elapsed);
      els.elapsedLeftKPI.textContent = `${elapsed} / ${left}`;
      const expectedToDate = rows.slice(0, elapsed).reduce((s,r)=> s+r.expected, 0);
      const paidToDate = rows.slice(0, elapsed).reduce((s,r)=> s+num(paidMap[r.key]), 0);
      els.expectedPaidKPI.textContent = `₪ ${fmtN(expectedToDate)} / ₪ ${fmtN(paidToDate)}`;
      const arrears = Math.max(0, expectedToDate - paidToDate);
      els.arrearsKPI.textContent = `₪ ${fmtN(arrears)}`;
      const total = rows.reduce((s,r)=> s+r.expected, 0);
      els.totalKPI.textContent = `₪ ${fmtN(total)}`;
    }

    // listeners
    ['input','change'].forEach(ev=>document.addEventListener(ev, e=>{
      if(e.target.closest('.event') || e.target.matches('input, select')) build();
    }, true));

    els.printBtn.addEventListener('click', ()=> window.print());
    els.exportBtn.addEventListener('click', ()=>{
      const state = JSON.parse(localStorage.getItem(KEY_STATE)||'{}');
      const paid  = JSON.parse(localStorage.getItem(KEY_PAID)||'{}');
      const blob = new Blob([JSON.stringify({state, paid}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'rehab-order-snapshot.json'});
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });

    els.resetBtn.addEventListener('click', ()=>{
      if(!confirm('לאפס הכל?')) return;
      localStorage.removeItem(KEY_STATE);
      localStorage.removeItem(KEY_PAID);
      els.eventsWrap.innerHTML='';
      initDefaults();
      build();
    });

    els.fillDemoBtn.addEventListener('click', ()=>{
      // demo: order 2020-01-01, next month start, 60 months, tiered 10x1000 -> rest 4000, reductions from 2022-07-01 to 2800
      els.orderDate.value = '2020-01-01';
      els.startMode.value = 'next';
      els.termMonths.value = 60;
      // switch to tiered tab
      document.querySelector('.tab[data-tab="tiered"]').click();
      els.tier1Months.value = 10;
      els.tier1Amount.value = 1000;
      els.tier2Amount.value = 4000;
      // add reduction
      els.eventsWrap.innerHTML='';
      renderEventRow('2022-07-01', 2800);
      build();
    });

    function initDefaults(){
      if(!els.orderDate.value){ els.orderDate.value = toISODate(new Date()); }
      if(!document.querySelector('.event')){ /* no default events */ }
    }

    // boot
    loadState();
    initDefaults();
    build();
  </script>
</body>
</html>
