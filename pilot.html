<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>צו שיקום כלכלי – מחשבון</title>
<style>
  :root{--bg:#f7f9fc;--card:#fff;--accent:#0EA5E9;--red:#EF4444;--green:#16A34A;--blue:#3B82F6;--orange:#F59E0B;--muted:#E8EDF5}
  body{font-family:Heebo,Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:#0B2533}
  h1{text-align:center;margin:0 0 12px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .btn{border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.print{background:var(--orange);color:#fff}
  .btn.small{padding:6px 8px;font-size:13px}
  .wrap{display:grid;grid-template-columns:45% 1fr;gap:12px;align-items:start}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(10,20,30,.06)}
  .acc{border-radius:10px;border:1px solid #e6ebf2;margin-bottom:10px;overflow:hidden}
  .acc .head{padding:10px;background:#f5f8fb;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:900}
  .acc .body{padding:10px;display:none}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{display:block;font-weight:700;margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d7dee6;background:#F3F7FE;font-size:14px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
  .kpi{text-align:center;background:#fff;border-radius:10px;padding:10px;border:1px solid #eef4fb}
  .kpi .k{color:#6b7c88;font-size:12px}
  .kpi .v{font-weight:900;margin-top:6px}
  .years{display:flex;flex-direction:column;gap:12px}
  .year{background:#fff;border-radius:12px;padding:10px;box-shadow:0 3px 12px rgba(0,0,0,.04)}
  .year .title{font-weight:900;margin-bottom:8px}
  .months{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
  .m{border-radius:10px;padding:8px;min-height:138px;background:var(--muted);display:flex;flex-direction:column;gap:6px;justify-content:space-between}
  .m .month{font-weight:900}
  .m .amt{font-weight:800;text-align:left}
  .m .paidRow{display:flex;gap:8px;align-items:center}
  .m input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #d7dee6;background:#fff}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid #e6ebf2}
  /* classes for status colors */
  .m.default{background:#E8EDF5}
  .m.future{background:#DBEAFE}     /* כחול */
  .m.partial{background:#FFE8B0}    /* כתום/צהוב */
  .m.late{background:#FFD6D6}       /* אדום בהיר */
  .m.ok{background:#DAF5DC}         /* ירוק בהיר */
  .m.prepayForbidden{background:#F3E8FF} /* סגול/וורוד קל - הקדמה לא מאושרת */
  .mutedSmall{font-size:12px;color:#64748B}
  @media print{ .toolbar, .acc .head, .btn {display:none!important} }
</style>
</head>
<body>
  <h1>צו שיקום כלכלי – טבלת חישוב</h1>

  <div class="toolbar">
    <div>
      <button class="btn print" id="printBtn">🖨️ הדפס</button>
      <button class="btn primary" id="sendBtn">📤 שלח נתונים</button>
    </div>
    <button class="btn small" id="toggleDetailsTop">📝 פרטי טופס</button>
  </div>

  <div class="wrap">
    <!-- RIGHT: input pane (45% width) -->
    <section class="card" id="rightPane" style="max-height:50vh;overflow:auto">
      <!-- details accordion -->
      <div class="acc" id="accDetails">
        <div class="head">📝 פרטי טופס <span id="accDetailsChevron">▼</span></div>
        <div class="body">
          <div class="grid2">
            <div>
              <label>שם ממלא הטופס</label>
              <input id="fillerName" type="text" placeholder="השם שלך">
            </div>
            <div>
              <label>מס' תיק</label>
              <input id="caseNumber" type="text" placeholder="12345">
            </div>
            <div>
              <label>שם החייב/ת</label>
              <input id="debtorName" type="text" placeholder="שם מלא">
            </div>
            <div>
              <label>תאריך אוטומטי</label>
              <input id="autoDate" type="text" readonly>
            </div>
          </div>
        </div>
      </div>

      <!-- order basic -->
      <div class="acc" id="accOrder">
        <div class="head">📄 פרטי צו <span>▼</span></div>
        <div class="body" style="display:block">
          <div class="grid2">
            <div>
              <label>תאריך מתן הצו</label>
              <input id="orderDate" type="date">
            </div>
            <div>
              <label>תחולת חיוב</label>
              <div style="display:flex;gap:8px">
                <button class="btn small pill active" data-val="next" id="startNext">חודש הבא</button>
                <button class="btn small pill" data-val="immediate" id="startImmediate">מיידי</button>
              </div>
            </div>
            <div>
              <label>משך התוכנית</label>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn small chip active" data-val="36">36</button>
                <button class="btn small chip" data-val="48">48</button>
                <button class="btn small chip" data-val="60">60</button>
                <input id="termMonths" type="number" placeholder="אחר..." style="width:80px;margin-inline-start:8px">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- payment plans (accordion items) -->
      <div class="acc" id="accFixed">
        <div class="head">📌 תוכנית קבועה <span>▼</span></div>
        <div class="body" style="display:block">
          <div class="grid2">
            <div>
              <label>סכום חודשי קבוע</label>
              <input id="flatAmount" type="number" min="0" placeholder="לדוגמה 1800">
            </div>
            <div style="align-self:end">
              <div class="mutedSmall">ברירת מחדל: קבוע</div>
            </div>
          </div>
        </div>
      </div>

      <div class="acc" id="accTier">
        <div class="head">📈 תשלום מדורג <span>▼</span></div>
        <div class="body">
          <div class="grid2">
            <div>
              <label>מדרגה 1 — חודשים</label>
              <input id="t1Months" type="number" min="0">
            </div>
            <div>
              <label>מדרגה 1 — סכום</label>
              <input id="t1Amount" type="number" min="0">
            </div>
            <div>
              <label>מדרגה 2 — חודשים</label>
              <input id="t2Months" type="number" min="0">
            </div>
            <div>
              <label>מדרגה 2 — סכום</label>
              <input id="t2Amount" type="number" min="0">
            </div>
            <div style="grid-column:1 / -1;display:flex;gap:8px;align-items:center">
              <button id="addTier" class="btn small">➕ הוסף מדרגה</button>
              <div class="mutedSmall">אפשר להוסיף מדרגה 3 בלחיצה</div>
            </div>
          </div>
        </div>
      </div>

      <div class="acc" id="accReduce">
        <div class="head">🔻 הפחתת תשלומים <span>▼</span></div>
        <div class="body">
          <div class="grid2">
            <div>
              <label>גורם מחליט</label>
              <select id="decider"><option>בית משפט</option><option>ממונה</option></select>
            </div>
            <div>
              <label>מתאריך</label>
              <input id="redEff" type="date">
            </div>
            <div>
              <label>עד תאריך (אופציונלי)</label>
              <input id="redUntil" type="date">
            </div>
            <div>
              <label>סכום חודשי חדש</label>
              <input id="redAmount" type="number" min="0">
            </div>
            <div style="grid-column:1 / -1;display:flex;gap:8px;align-items:center;margin-top:6px">
              <button id="applyReduce" class="btn small">אשר</button>
              <button id="clearRed" class="btn small">מחק</button>
              <div class="mutedSmall">הפחתה תחול מתאריך ההשפעה; אם לא סומן עד תאריך — תחול עד סוף התקופה</div>
            </div>
          </div>
        </div>
      </div>

      <div class="acc" id="accPrepay">
        <div class="head">⏩ הקדמת תשלומים <span>▼</span></div>
        <div class="body">
          <div class="grid2">
            <div>
              <label>גורם מחליט</label>
              <select id="prepayDecider"><option>בית משפט</option><option>ממונה</option></select>
            </div>
            <div>
              <label>תאריך החלטה (אישור)</label>
              <input id="prepayApproval" type="date">
            </div>
            <div style="grid-column:1 / -1;margin-top:6px" class="mutedSmall">אם קיימת החלטה — אין סימון \"הקדמת תשלומים אסורה\".</div>
          </div>
        </div>
      </div>

    </section>

    <!-- LEFT: KPIs + schedule (takes full remaining width) -->
    <section class="card">
      <div class="kpis">
        <div class="kpi"><div class="k">מתאריך ← עד תאריך</div><div class="v" id="rangeKPI">—</div></div>
        <div class="kpi"><div class="k">משך (חוד׳)</div><div class="v" id="durationKPI">—</div></div>
        <div class="kpi"><div class="k">צפוי עד היום / שולם</div><div class="v" id="expectedPaidKPI">—</div></div>
      </div>

      <h3 style="margin-top:8px">פריסה שנתית (כל שורה = שנה, 12 בלוקים)</h3>
      <div class="years" id="years"></div>
    </section>
  </div>

<script>
/* ====== Utils & state ====== */
const WEBAPP_URL = 'PASTE_YOUR_WEBAPP_URL_HERE'; // <<< החלף כאן את URL מה-Apps Script Deployment
const HEB_MONTHS=['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
const pad=n=>String(n).padStart(2,'0');
const toKey=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-01`;
const addMonths=(d,n)=>{const x=new Date(d.getTime()); x.setMonth(x.getMonth()+n); return x;}
const fmt=n=>new Intl.NumberFormat('he-IL').format(Math.round(Number(n)||0));
let reductions=[]; // array of {effective, until?, amount, decider}
let extraTiers=[]; // for optional tiers added

/* ====== Init UI ====== */
document.getElementById('autoDate').value = new Date().toLocaleString('he-IL');
document.querySelectorAll('.acc .head').forEach(h=>{
  h.addEventListener('click', ()=> {
    const b = h.nextElementSibling;
    b.style.display = (b.style.display==='block') ? 'none' : 'block';
  });
});
// top toggle details
document.getElementById('toggleDetailsTop').addEventListener('click', ()=> {
  const b = document.querySelector('#accDetails .body');
  b.style.display = (b.style.display==='block') ? 'none' : 'block';
});
// pill buttons start mode
document.getElementById('startNext').addEventListener('click', ()=> { document.getElementById('startNext').classList.add('active'); document.getElementById('startImmediate').classList.remove('active'); renderSchedule(); });
document.getElementById('startImmediate').addEventListener('click', ()=> { document.getElementById('startImmediate').classList.add('active'); document.getElementById('startNext').classList.remove('active'); renderSchedule(); });
// chips for months
document.querySelectorAll('.chip').forEach(c=> c.addEventListener('click', ()=> { document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); document.getElementById('termMonths').value=''; renderSchedule(); }));

// add tier button
document.getElementById('addTier').addEventListener('click', ()=>{
  if(extraTiers.length>=1){ alert('ניתן להוסיף מדרגה אחת נוספת (מדרגה 3)'); return; }
  extraTiers.push({months:0,amount:0});
  // append simple inputs for tier3
  const body = document.querySelector('#accTier .body .grid2');
  const div1 = document.createElement('div');
  div1.innerHTML = '<label>מדרגה 3 — חודשים</label><input id="t3Months" type="number" min="0">';
  const div2 = document.createElement('div');
  div2.innerHTML = '<label>מדרגה 3 — סכום</label><input id="t3Amount" type="number" min="0">';
  body.appendChild(div1); body.appendChild(div2);
  document.getElementById('t3Months').addEventListener('input', renderSchedule);
  document.getElementById('t3Amount').addEventListener('input', renderSchedule);
});

// apply reduction
document.getElementById('applyReduce').addEventListener('click', ()=>{
  const eff = document.getElementById('redEff').value;
  const amt = Number(document.getElementById('redAmount').value||0);
  const until = document.getElementById('redUntil').value || null;
  const dec = document.getElementById('decider').value || '';
  if(!eff || !amt){ alert('נא למלא תאריך וסכום להפחתה'); return; }
  reductions.push({effective: eff, until: until, amount: amt, decider: dec});
  reductions.sort((a,b)=> new Date(a.effective)-new Date(b.effective));
  alert('אירוע הפחתה נוספה');
  renderSchedule();
});
document.getElementById('clearRed').addEventListener('click', ()=> { reductions=[]; document.getElementById('redEff').value=''; document.getElementById('redUntil').value=''; document.getElementById('redAmount').value=''; renderSchedule(); });

/* ====== Schedule computation and rendering ====== */
function getStartDate(){
  const od = document.getElementById('orderDate').value;
  if(!od) return null;
  const base = new Date(od);
  const startMode = document.getElementById('startNext').classList.contains('active') ? 'next' : 'immediate';
  return (startMode==='next') ? addMonths(base,1) : base;
}

function computeSchedule(){
  const start = getStartDate();
  const term = document.getElementById('termMonths').value ? Number(document.getElementById('termMonths').value) : Number(document.querySelector('.chip.active')?.dataset?.val || 36);
  if(!start || term<=0) return {schedule:[], start:null, end:null};
  const flat = Number(document.getElementById('flatAmount').value||0);
  const t1m = Number(document.getElementById('t1Months').value||0);
  const t1a = Number(document.getElementById('t1Amount').value||0);
  const t2m = Number(document.getElementById('t2Months').value||0);
  const t2a = Number(document.getElementById('t2Amount').value||0);
  const t3m = document.getElementById('t3Months') ? Number(document.getElementById('t3Months').value||0) : 0;
  const t3a = document.getElementById('t3Amount') ? Number(document.getElementById('t3Amount').value||0) : 0;

  const arr=[];
  for(let i=0;i<term;i++){
    const due = addMonths(start,i);
    let expected=0;
    if(t1m||t2m||t3m){
      // layered: use tiers in order
      let left=i;
      if(i < t1m) expected = t1a;
      else if(i < t1m + t2m) expected = t2a;
      else if(t3m && i < t1m + t2m + t3m) expected = t3a;
      else expected = (t3m? t3a : t2a || t1a || flat);
    } else {
      expected = flat;
    }
    // apply active reductions: last reduction with effective <= due
    let applied = expected;
    for(const ev of reductions){
      const eff = new Date(ev.effective); eff.setDate(1);
      const dueM = new Date(due.getFullYear(), due.getMonth(), 1);
      if(eff <= dueM){
        if(ev.until){
          const untilM = new Date(ev.until); untilM.setDate(1);
          if(dueM <= untilM) applied = ev.amount;
          else {
            // if post-return not specified, keep applied as previous (we assume amount returns to previous)
            // simpler: if beyond until, do nothing (keeps previous expected)
          }
        } else {
          applied = ev.amount;
        }
      }
    }
    arr.push({ due, year: due.getFullYear(), month: due.getMonth()+1, monthName: HEB_MONTHS[due.getMonth()], key: toKey(due), expected: applied, paid:'', paidDate:'', status:'', note:'' });
  }
  return {schedule:arr, start:start, end:addMonths(start, term-1)};
}

function renderSchedule(){
  const {schedule, start, end} = computeSchedule();
  // KPIs
  const yearsDiv = document.getElementById('years'); yearsDiv.innerHTML='';
  if(!schedule.length){ document.getElementById('rangeKPI').textContent='—'; document.getElementById('durationKPI').textContent='—'; document.getElementById('expectedPaidKPI').textContent='—'; return; }
  document.getElementById('rangeKPI').textContent = `${start.toLocaleDateString('he-IL')} ← ${end.toLocaleDateString('he-IL')}`;
  document.getElementById('durationKPI').textContent = `${schedule.length}`;
  const expectedSum = schedule.reduce((s,r)=> s + (Number(r.expected)||0),0);
  document.getElementById('expectedPaidKPI').textContent = `₪ ${fmt(expectedSum)} / ₪ 0`;

  // group by year
  const groups = {};
  schedule.forEach(r=> { (groups[r.year] = groups[r.year]||[]).push(r); });
  const years = Object.keys(groups).map(Number).sort((a,b)=> b-a);

  // today month start
  const today = new Date(); const todayMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  years.forEach(y=>{
    const box = document.createElement('div'); box.className='year';
    const title = document.createElement('div'); title.className='title'; title.textContent = y;
    box.appendChild(title);
    const monthsGrid = document.createElement('div'); monthsGrid.className='months';

    // map months in this year
    const byMonth = new Map(groups[y].map(r=>[r.month, r]));

    // create 12 cells: **from דצמבר..ינואר** so visual shows ינואר at RIGHT (rtl)
    for(let m=12;m>=1;m--){
      const r = byMonth.get(m);
      const cell = document.createElement('div'); cell.className='m default';
      const monthLabel = HEB_MONTHS[m-1];
      if(!r){
        cell.innerHTML = `<div class="month">${monthLabel}</div><div class="amt">—</div><div class="paidRow">—</div><div class="mutedSmall">מחוץ לתקופה</div>`;
        monthsGrid.appendChild(cell); continue;
      }

      // determine status
      const dueStart = new Date(r.due.getFullYear(), r.due.getMonth(), 1);
      const endOfMonth = new Date(r.due.getFullYear(), r.due.getMonth()+1, 0);
      const lateThreshold = new Date(endOfMonth); lateThreshold.setDate(lateThreshold.getDate()+20);

      const paid = r.paid ? Number(r.paid) : 0;
      const paidDate = r.paidDate ? new Date(r.paidDate) : null;

      let status='default', note='';

      // prepay unauthorized: if paidDate exists and paidDate < dueStart and (no prepayApproval or approval > paidDate)
      const prepayApproval = document.getElementById('prepayApproval').value ? new Date(document.getElementById('prepayApproval').value) : null;
      if(paid>0 && paidDate && paidDate < dueStart) {
        if(!prepayApproval || prepayApproval > paidDate) { status='prepayForbidden'; note='הקדמת תשלומים אסורה'; }
      }

      if(status==='prepayForbidden'){
        cell.className='m prepayForbidden';
      } else if(dueStart > todayMonth){
        status='future'; cell.className='m future'; note='תשלום עתידי';
      } else {
        // month has arrived or passed
        if(paid === 0){
          // if today beyond late threshold -> late
          if(new Date() > lateThreshold) { status='late'; cell.className='m late'; note='פיגור'; } else { status='default'; cell.className='m default'; note='טרם שולם'; }
        } else if(paid>0 && paid < r.expected){
          status='partial'; cell.className='m partial'; note='תשלום חלקי';
        } else if(paid >= r.expected){
          status='ok'; cell.className='m ok'; note='שולם';
        } else { cell.className='m default'; }
      }

      // build inner html: 4 שורות
      const paidInputId = 'paid-'+r.key;
      const paidDateId = 'paidDate-'+r.key;
      cell.innerHTML = `
        <div class="month">${monthLabel}</div>
        <div class="amt">לתשלום: ₪ ${fmt(r.expected)}</div>
        <div class="paidRow">
          <label style="display:inline-block;font-size:13px;font-weight:700">שולם</label>
          <input type="number" id="${paidInputId}" placeholder="שולם חלקית" value="${r.paid||''}" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn small" data-full="${r.key}">שולם (מלא)</button>
          <button class="btn small" data-date="${r.key}">📅 בחר תאריך תשלום</button>
          <div class="mutedSmall" id="${paidDateId}">${r.paidDate? (new Date(r.paidDate)).toLocaleDateString('he-IL') : ''}</div>
        </div>
        <div class="mutedSmall">סטטוס: ${note || '—'}</div>
      `;

      // listeners: full pay, choose date, input change
      const fullBtn = cell.querySelector('[data-full]');
      fullBtn.addEventListener('click', ()=>{
        r.paid = r.expected;
        r.paidDate = new Date().toISOString().slice(0,10);
        renderSchedule(); // re-render to update visuals
      });
      const dateBtn = cell.querySelector('[data-date]');
      dateBtn.addEventListener('click', ()=>{
        const dEl = document.createElement('input'); dEl.type='date'; dEl.style.position='fixed'; dEl.style.opacity=0; document.body.appendChild(dEl);
        dEl.addEventListener('change', e=>{
          r.paidDate = e.target.value;
          document.body.removeChild(dEl);
          renderSchedule();
        });
        dEl.showPicker?.();
        dEl.focus();
      });
      const inputEl = cell.querySelector('input[type=number]');
      inputEl.addEventListener('change', e=>{
        r.paid = Number(e.target.value || 0);
        // if equals expected, set paidDate to today
        if(Number(r.paid) >= Number(r.expected)) r.paidDate = new Date().toISOString().slice(0,10);
        renderSchedule();
      });

      monthsGrid.appendChild(cell);
    }

    box.appendChild(monthsGrid); yearsDiv.appendChild(box);
  });

}

/* ====== Send to Sheets (includes schedule) ====== */
document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const {schedule} = computeSchedule();
  // update paid info from rendered inputs (ensure captures)
  // (renderSchedule already stores paid values in schedule objects because inputs call renderSchedule)
  // prepare reductions payload
  const payload = {
    fillerName: document.getElementById('fillerName').value || '',
    caseNumber: document.getElementById('caseNumber').value || '',
    debtorName: document.getElementById('debtorName').value || '',
    autoDate: document.getElementById('autoDate').value || '',
    orderDate: document.getElementById('orderDate').value || '',
    startMode: document.getElementById('startNext').classList.contains('active') ? 'next' : 'immediate',
    termMonths: document.getElementById('termMonths').value || document.querySelector('.chip.active')?.dataset?.val || 36,
    paymentMode: (document.getElementById('t1Months').value || document.getElementById('t2Months').value) ? 'tiered' : 'fixed',
    flatAmount: document.getElementById('flatAmount').value || '',
    t1Months: document.getElementById('t1Months').value || '',
    t1Amount: document.getElementById('t1Amount').value || '',
    t2Months: document.getElementById('t2Months').value || '',
    t2Amount: document.getElementById('t2Amount').value || '',
    reductions: reductions,
    prepayApproval: document.getElementById('prepayApproval').value || '',
    schedule: schedule.map(s=>({
      year: s.year, monthName: s.monthName, key: s.key, expected: s.expected, paid: s.paid||0, paidDate: s.paidDate||'', status: s.status||'', note: s.note||''
    }))
  };

  try{
    await fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    alert('✅ הנתונים נשלחו לשיטס (כולל פריסה)');
  }catch(err){ alert('❌ שגיאה בשליחה: '+ (err.message||err)); }
});

/* triggers */
['orderDate','termMonths','flatAmount','t1Months','t1Amount','t2Months','t2Amount'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', renderSchedule);
});
renderSchedule(); // initial
</script>
</body>
</html>
