const calculate = () => {
    const B2_status = statusEl.value || "";
    const B4_salaryDebtor = parseFloat(salaryDebtorEl.value) || 0;
    const C4_salaryPartner = parseFloat(salaryPartnerEl.value) || 0;
    const B6_otherIncomeDebtor = parseFloat(otherIncomeDebtorEl.value) || 0;
    const C6_otherIncomePartner = parseFloat(otherIncomePartnerEl.value) || 0;
    const debtorAllowanceVal = parseFloat(debtorAllowanceEl.value) || 0;
    const partnerAllowanceVal = parseFloat(partnerAllowanceEl.value) || 0;
    const B7_unusualExpenses = parseFloat(unusualExpensesEl.value) || 0;
    const B8_childcareExpenses = parseFloat(childcareExpensesEl.value) || 0;
    const B9_alimonyExpenses = parseFloat(alimonyExpensesEl.value) || 0;

    const statusData = lookupData[B2_status] || { kids: 0, livingCost: 0 };
    const B3_baseLivingCost = statusData.livingCost;
    const B5_childAllowance = childAllowanceData[statusData.kids] || 0;

    baseLivingCostResultEl.textContent = formatCurrency(B3_baseLivingCost);
    socialSecurityAllowanceEl.textContent = formatCurrency(B5_childAllowance);

    // הערת "150 ש"ח זמני" – תוצג רק אם אין הכנסה לחייב ובתא משפחתי לא-יחידני
    const isSingleFamily = B2_status.includes('יחיד') || B2_status.includes('רווק');
    specialNoteEl.style.display = (!isSingleFamily && B4_salaryDebtor === 0) ? 'block' : 'none';

    // יחס הכנסה של כל צד מתוך סך הכנסות העבודה/אחרות (ללא קצבאות ילדים)
    const totalIncomeForRatio =
        B4_salaryDebtor + B6_otherIncomeDebtor + C4_salaryPartner + C6_otherIncomePartner;

    const B10_debtorRatio = totalIncomeForRatio > 0
        ? (B4_salaryDebtor + B6_otherIncomeDebtor) / totalIncomeForRatio
        : 0;

    const C10_partnerRatio = totalIncomeForRatio > 0
        ? (C4_salaryPartner + C6_otherIncomePartner) / totalIncomeForRatio
        : 0;

    debtorIncomeRatioEl.textContent = `${(B10_debtorRatio * 100).toFixed(1)}%`;
    partnerIncomeRatioEl.textContent = `${(C10_partnerRatio * 100).toFixed(1)}%`;

    // סך הכנסות/הוצאות כוללות לתא
    const totalIncomes = B4_salaryDebtor + C4_salaryPartner + B5_childAllowance +
                         B6_otherIncomeDebtor + C6_otherIncomePartner +
                         debtorAllowanceVal + partnerAllowanceVal;
    totalIncomeResultEl.textContent = formatCurrency(totalIncomes);

    const totalExpenses = B3_baseLivingCost + B7_unusualExpenses + B8_childcareExpenses + B9_alimonyExpenses;
    totalExpensesResultEl.textContent = formatCurrency(totalExpenses);

    let B11_disposableIncome = totalIncomes - totalExpenses;
    if (B11_disposableIncome <= 0) {
        disposableIncomeResultEl.textContent = 'אין הכנסה פנויה';
    } else {
        disposableIncomeResultEl.textContent = formatCurrency(B11_disposableIncome);
    }

    // ברירות מחדל
    let debtorPay = 0;
    let partnerPay = 0;
    const isJointProceeding = jointProceedingEl.checked;

    if (B11_disposableIncome > 0) {
        if (isJointProceeding && !isSingleFamily) {
            // כל אחד לפי יחס הכנסתו מתוך ההכנסה הפנויה
            debtorPay  = roundDownToNearest10(B11_disposableIncome * B10_debtorRatio);
            partnerPay = roundDownToNearest10(B11_disposableIncome * C10_partnerRatio);

            // זהירות: בגלל עיגול למטה ייתכן שסכום שני הצדדים < הכנסה פנויה — זה בסדר ואף עדיף.
        } else {
            // רק החייב/ת משלם/ת את חלקו/ה היחסי
            debtorPay = roundDownToNearest10(B11_disposableIncome * B10_debtorRatio);
            partnerPay = 0;
        }
    }

    // מניעת ערכים שליליים/NaN
    debtorPay  = Math.max(0, debtorPay  || 0);
    partnerPay = Math.max(0, partnerPay || 0);

    debtorPaymentResultEl.textContent  = formatCurrency(debtorPay);
    partnerPaymentResultEl.textContent = formatCurrency(partnerPay);

    // סכום סופי לתא (אם הליך משותף – שניהם, אחרת – רק החייב/ת)
    const finalTotal = isJointProceeding && !isSingleFamily ? (debtorPay + partnerPay) : debtorPay;
    finalPaymentResultEl.textContent = formatCurrency(finalTotal);
};
