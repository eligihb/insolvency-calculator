<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#005f73;--secondary:#0a9396;--bg:#f4f4f4;--panel:#fff;
    --text:#333;--label:#444;--border:#d6dee6;--accent:#ee9b00;--resultbg:#e9f5f5;
    --danger:#ae2012;--blue:#0b74ff;
  }
  *{box-sizing:border-box}
  body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
  .wrap{width:100%;max-width:1000px;background:var(--panel);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);overflow:hidden;display:grid;grid-template-columns:1fr 1fr}
  header{grid-column:1/-1;background:var(--primary);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:1.6em}
  .version{font-size:.85em;opacity:.95;margin-inline-start:.5rem}
  .col-left{padding:20px;background:var(--resultbg);border-left:1px solid var(--border)}
  .col-right{padding:20px;background:#fff}
  .section{display:grid;gap:14px}
  .section h2{grid-column:1/-1;margin:0 0 8px 0;color:var(--primary);border-bottom:2px solid var(--secondary);padding-bottom:6px;font-size:1.25em}

  /* inputs */
  .group{display:flex;flex-direction:column;gap:6px}
  .group label{font-weight:600;color:var(--label)}
  .group input,.group select,.group textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:.98em;background:#f7fbff;
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  .group textarea{min-height:80px;resize:vertical;background:#fff}
  .group input:focus,.group select:focus,.group textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(10,147,150,.18);background:#fff}
  .inline2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .readonly{background:#eef3f7;font-weight:700;color:#203a5b}

  /* ××™ ×‘×”×œ×™×š + ×–×•×’ ×‘×”×œ×™×š */
  .top-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
  .debtor-opts{display:flex;gap:8px}
  .radio-btn{background:#f3f4f6;border:1px solid #cfd8e3;padding:8px 14px;border-radius:18px;cursor:pointer;transition:.2s;color:#1f2937;font-weight:500}
  input[type=radio]{display:none}
  .radio-btn.active{background:#e8f0ff;border-color:#99befc;color:var(--blue)}
  #jointLbl{background:#f8f0f0;border:1px solid #e7b8b8;padding:8px 14px;border-radius:18px;cursor:pointer;font-weight:700;color:#7a0c0c}
  #jointLbl.on{background:#ffdede;border-color:#f19999}

  /* info ? */
  .info{line-height:1;border:none;cursor:pointer;border-radius:50%;width:20px;height:20px;font-size:.85em;font-weight:700;display:inline-flex;align-items:center;justify-content:center;background:#eef6f6;color:#006d77;box-shadow:0 0 0 1px rgba(0,0,0,.06) inset;margin-inline-start:6px}
  .popover{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px 14px;font-size:.97em}

  /* actions (top only) */
  .actions{display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.05)}
  .btn:hover{background:#f8fafc}
  .tip{display:none;background:#fff7d6;border:1px solid #ffe6a8;color:#3b2f00;border-radius:10px;padding:8px 10px;font-size:.9em;margin:0 auto 10px;max-width:560px}

  /* results cards */
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#fff;border:1px solid #dbe6ef;border-radius:12px;padding:12px 14px;text-align:center}
  .card .lbl{display:block;color:#334155;font-weight:700}
  .card .val{display:block;font-weight:800;font-size:1.15em;color:var(--accent);margin-top:4px}
  .card.total .val{color:var(--danger)}
  .card.full{grid-column:1/-1}
  .val.blue{color:var(--blue)}

  /* toggles */
  .toggles{display:flex;gap:10px;flex-wrap:wrap}
  .tgl{padding:8px 12px;border:1px dashed #b6c2cf;border-radius:10px;background:#fff;cursor:pointer}
  .tgl.on{background:#f0faff;border-color:#8ecae6}

  /* report */
  .report-wrap{display:flex;justify-content:center;margin-top:6px}
  .report-toggle{border:none;background:none;color:#0b74ff;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px}
  .report-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center;margin-top:8px}
  .note-toggle{border:none;background:none;color:#8b5cf6;font-weight:700;cursor:pointer}
  .hidden{display:none!important}

  @media(max-width:768px){
    .wrap{grid-template-columns:1fr}
    .col-left{order:1}
    .col-right{order:2;border-left:none}
    .inline2{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
  }

  @media print{ body{padding:0;background:#fff} }
</style>
</head>
<body>
<div class="wrap" id="calcRoot">
  <header>
    <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× <span class="version">| ××¢×•×“×›×Ÿ ×œÖ¾<span id="year"></span></span></h1>
  </header>

  <!-- ×ª×•×¦××•×ª (×©×××œ) -->
  <div class="col-left">
    <div class="actions">
      <button type="button" class="btn" id="shotBtn">ğŸ“¸ ×¦×™×œ×•× ××¡×š</button>
      <button type="button" class="btn" id="emailBtn">âœ‰ï¸ ×©×œ×™×—×ª ××™×™×œ</button>
      <button type="button" class="btn" id="resetBtn">â†º ××™×¤×•×¡</button>
    </div>
    <div id="emailTip" class="tip">×˜×™×¤: ×©××•×¨/×™ ×§×•×“× ××ª ×¦×™×œ×•× ×”××¡×š (PNG), ×•××– ×¦×¨×¤×• ×™×“× ×™×ª ×œ××™×™×œ.</div>

    <div class="section">
      <h2 style="text-align:center">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>
      <div class="cards">
        <div class="card">
          <span class="lbl">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</span>
          <span class="val" id="allowRes">0 â‚ª</span>
        </div>
        <div class="card">
          <span class="lbl">×¡×š ×”×›× ×¡×•×ª</span>
          <span class="val" id="totalIncome">0 â‚ª</span>
        </div>

        <div class="card">
          <span class="lbl">×“××™ ××—×™×™×” ×‘×›×‘×•×“</span>
          <span class="val" id="livingRes">0 â‚ª</span>
        </div>
        <div class="card">
          <span class="lbl">×¡×š ×”×•×¦××•×ª</span>
          <span class="val" id="totalExp">0 â‚ª</span>
        </div>

        <div class="card full">
          <span class="lbl">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</span>
          <span class="val blue" id="dispRes">0 â‚ª</span>
        </div>

        <div class="card">
          <span class="lbl" id="debtorRatioLbl">××—×•×– ×”×›× ×¡×” (×—×™×™×‘)</span>
          <span class="val" id="debtorRatio">0%</span>
        </div>
        <div class="card">
          <span class="lbl" id="partnerRatioLbl">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</span>
          <span class="val" id="partnerRatio">0%</span>
        </div>

        <div class="card">
          <span class="lbl" id="debtorPayLbl">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</span>
          <span class="val" id="debtorPay">0 â‚ª</span>
        </div>
        <div class="card" id="partnerPayCard">
          <span class="lbl" id="partnerPayLbl">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</span>
          <span class="val" id="partnerPay">0 â‚ª</span>
        </div>

        <div class="card total hidden" id="familyPayCard">
          <span class="lbl">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</span>
          <span class="val" id="familyPay">0 â‚ª</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ×”×–× ×” (×™××™×Ÿ) -->
  <div class="col-right">
    <form id="form">
      <!-- ×¡×˜×˜×•×¡ -->
      <div class="section">
        <div class="group">
          <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
          <select id="status">
            <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡ ××©×¤×—×ª×™â€¦</option>
            <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
            <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
            <option value="×–×•×’">×–×•×’</option>
            <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
            <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
          </select>
        </div>

        <!-- ××™ ×‘×”×œ×™×š + ×–×•×’ ×‘×”×œ×™×š -->
        <div class="top-row">
          <div class="group">
            <label>××™ ×‘×”×œ×™×š?</label>
            <div class="debtor-opts">
              <input type="radio" id="debtorM" name="debtor" value="×—×™×™×‘" checked>
              <label class="radio-btn" for="debtorM" id="lblM">×—×™×™×‘</label>
              <input type="radio" id="debtorF" name="debtor" value="×—×™×™×‘×ª">
              <label class="radio-btn" for="debtorF" id="lblF">×—×™×™×‘×ª</label>
            </div>
          </div>
          <label id="jointLbl" for="joint">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?</label>
          <input type="checkbox" id="joint">
        </div>
      </div>

      <div class="section">
        <h2>×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</h2>

        <!-- ×©×›×¨ -->
        <div class="inline2">
          <div class="group">
            <label>×”×›× ×¡×” (×—×™×™×‘)<button type="button" class="info" data-i="deb">?</button></label>
            <input type="number" id="salD" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
          </div>
          <div class="group" id="salPwrap">
            <label>×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)<button type="button" class="info" data-i="par">?</button></label>
            <input type="number" id="salP" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
          </div>
        </div>

        <!-- ×”×›× ×¡×•×ª ××—×¨×•×ª -->
        <div class="inline2">
          <div class="group">
            <label id="othDLbl">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)</label>
            <input type="number" id="othD" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
          </div>
          <div class="group" id="othPwrap">
            <label id="othPLbl">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)</label>
            <input type="number" id="othP" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
          </div>
        </div>

        <!-- ××ª×’×™× -->
        <div class="toggles">
          <button type="button" class="tgl" id="tglAllow">×§×¦×‘××•×ª</button>
          <button type="button" class="tgl" id="tglAlim">××–×•× ×•×ª</button>
        </div>

        <!-- ×§×¦×‘××•×ª -->
        <div id="allowBox" class="hidden">
          <div class="inline2" style="margin-top:8px">
            <div class="group">
              <label id="allDLbl">×§×¦×‘×” (×—×™×™×‘/×ª)</label>
              <input type="number" id="allD" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
            <div class="group" id="allPwrap">
              <label id="allPLbl">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
              <input type="number" id="allP" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
          </div>
        </div>

        <!-- ×—×¨×™×’×•×ª/×¦×”×¨×•× ×™× -->
        <div class="inline2" style="margin-top:6px">
          <div class="group">
            <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label>
            <input type="number" id="expU" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
          </div>
          <div class="group">
            <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
            <input type="number" id="expC" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
          </div>
        </div>

        <!-- ××–×•× ×•×ª -->
        <div id="alimBox" class="hidden">
          <div class="group" style="margin-top:8px">
            <label>×”×•×¦××•×ª ××–×•× ×•×ª</label>
            <input type="number" id="expA" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
          </div>
        </div>

        <!-- ×¤×¨×˜×™ ×“×•"×— -->
        <div class="report-wrap">
          <button type="button" class="report-toggle" id="repToggle">ğŸ“„ ×¤×¨×˜×™ ×“×•×´×—</button>
        </div>
        <div id="repPanel" class="hidden">
          <div class="report-row">
            <div class="group"><label>××¡' ×ª×™×§</label><input type="text" id="caseId" placeholder="12345/25"></div>
            <div class="group"><label>×©× ×¢×•×¨×š/×ª</label><input type="text" id="author" placeholder="×©× ××œ×"></div>
            <div class="group"><label>×ª××¨×™×š</label><input type="text" id="rdate" class="readonly" readonly></div>
            <button type="button" id="noteBtn" class="note-toggle">ğŸ“Œ ×”×¢×¨×”</button>
          </div>
          <div id="noteBox" class="hidden">
            <div class="group" style="margin-top:6px">
              <label>×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</label>
              <textarea id="note" maxlength="500" placeholder="×”×¢×¨×” ×—×•×¤×©×™×ªâ€¦"></textarea>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // ×©× ×” ×•×ª××¨×™×š ×“×•"×—
  document.getElementById('year').textContent = new Date().getFullYear();
  const rdate=document.getElementById('rdate'); rdate.value = new Date().toLocaleDateString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit'});

  // × ×ª×•× ×™×
  const living = {
    "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":4556,"×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":6056,"×–×•×’":6024,"×–×•×’+×™×œ×“":7524,"×–×•×’+ 2 ×™×œ×“×™×":9024,
    "×–×•×’+ 3 ×™×œ×“×™×":10524,"×–×•×’+ 4 ×™×œ×“×™×":12024,"×–×•×’+ 5 ×™×œ×“×™×":13324,"×–×•×’+ 6 ×™×œ×“×™×":14624,
    "×–×•×’+ 7 ×™×œ×“×™×":15924,"×–×•×’+ 8 ×™×œ×“×™×":17224,"×–×•×’+ 9 ×™×œ×“×™×":18524,"×–×•×’+ 10 ×™×œ×“×™×":19824
  };
  const kidsMap = {"×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":0,"×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":1,"×–×•×’":0,"×–×•×’+×™×œ×“":1,"×–×•×’+ 2 ×™×œ×“×™×":2,"×–×•×’+ 3 ×™×œ×“×™×":3,"×–×•×’+ 4 ×™×œ×“×™×":4,"×–×•×’+ 5 ×™×œ×“×™×":5,"×–×•×’+ 6 ×™×œ×“×™×":6,"×–×•×’+ 7 ×™×œ×“×™×":7,"×–×•×’+ 8 ×™×œ×“×™×":8,"×–×•×’+ 9 ×™×œ×“×™×":9,"×–×•×’+ 10 ×™×œ×“×™×":10};
  const childAllow = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

  // ×§×œ×˜
  const status = document.getElementById('status');
  const debtorM=document.getElementById('debtorM'), debtorF=document.getElementById('debtorF');
  const lblM=document.getElementById('lblM'), lblF=document.getElementById('lblF');
  const joint=document.getElementById('joint'), jointLbl=document.getElementById('jointLbl');

  const salD=document.getElementById('salD'), salP=document.getElementById('salP');
  const othD=document.getElementById('othD'), othP=document.getElementById('othP');
  const allD=document.getElementById('allD'), allP=document.getElementById('allP');
  const expU=document.getElementById('expU'), expC=document.getElementById('expC'), expA=document.getElementById('expA');

  // ×ª×•×¦××•×ª
  const allowRes=document.getElementById('allowRes');
  const totalIncome=document.getElementById('totalIncome');
  const livingRes=document.getElementById('livingRes');
  const totalExp=document.getElementById('totalExp');
  const dispRes=document.getElementById('dispRes');
  const debtorRatio=document.getElementById('debtorRatio');
  const partnerRatio=document.getElementById('partnerRatio');
  const debtorPay=document.getElementById('debtorPay');
  const partnerPay=document.getElementById('partnerPay');
  const partnerPayCard=document.getElementById('partnerPayCard');
  const familyPay=document.getElementById('familyPay');
  const familyPayCard=document.getElementById('familyPayCard');

  const debtorRatioLbl=document.getElementById('debtorRatioLbl');
  const partnerRatioLbl=document.getElementById('partnerRatioLbl');
  const debtorPayLbl=document.getElementById('debtorPayLbl');
  const partnerPayLbl=document.getElementById('partnerPayLbl');

  // ×˜×•×’×œ×™×
  const tglAllow=document.getElementById('tglAllow'), allowBox=document.getElementById('allowBox');
  const tglAlim=document.getElementById('tglAlim'), alimBox=document.getElementById('alimBox');

  // ×“×•"×—
  const repToggle=document.getElementById('repToggle'), repPanel=document.getElementById('repPanel');
  const noteBtn=document.getElementById('noteBtn'), noteBox=document.getElementById('noteBox');

  // ×¢×™×¦×•×‘ ×‘×—×™×¨×”
  function updateUI(){
    lblM.classList.toggle('active', debtorM.checked);
    lblF.classList.toggle('active', debtorF.checked);
    jointLbl.classList.toggle('on', joint.checked);

    const st=status.value||'';
    const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');

    // ×‘×Ÿ/×‘×ª ×–×•×’ â€“ ××¦×™×’×™× ×¨×§ ×× ×œ× ×™×—×™×“
    document.getElementById('salPwrap').style.display = isSingle? 'none':'block';
    document.getElementById('othPwrap').style.display = isSingle? 'none':'block';
    document.getElementById('allPwrap').style.display = isSingle? 'none':'block';

    let dTxt=isSingle?'×—×™×™×‘/×ª': (debtorM.checked?'×—×™×™×‘':'×—×™×™×‘×ª');
    let pTxt=isSingle?'×‘×Ÿ/×‘×ª ×–×•×’': (debtorM.checked?'×‘×ª ×–×•×’':'×‘×Ÿ ×–×•×’');
    document.getElementById('othDLbl').textContent=`×”×›× ×¡×•×ª ××—×¨×•×ª (${dTxt})`;
    document.getElementById('othPLbl').textContent=`×”×›× ×¡×•×ª ××—×¨×•×ª (${pTxt})`;
    document.getElementById('allDLbl').textContent=`×§×¦×‘×” (${dTxt})`;
    document.getElementById('allPLbl').textContent=`×§×¦×‘×” (${pTxt})`;
    debtorRatioLbl.textContent=`××—×•×– ×”×›× ×¡×” (${dTxt})`;
    partnerRatioLbl.textContent=`××—×•×– ×”×›× ×¡×” (${pTxt})`;
    debtorPayLbl.textContent=`×ª×©×œ×•× ××•×¦×¢ (${dTxt})`;
    partnerPayLbl.textContent=`×ª×©×œ×•× ××•×¦×¢ (${pTxt})`;

    // ×›×¨×˜×™×¡×™ ×‘×Ÿ/×‘×ª ×–×•×’ ×•×ª×©×œ×•× ××©×¤×—×ª×™
    partnerPayCard.classList.toggle('hidden', !joint.checked);
    familyPayCard.classList.toggle('hidden', !joint.checked);
  }

  const fmt = v => (isNaN(v)?0:v);
  const money = v => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(fmt(v));
  const r10 = n => Math.floor(fmt(n)/10)*10;

  function calc(){
    const st=status.value||'';
    const isJoint = joint.checked;
    const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');

    const dS = +salD.value||0, pS = +salP.value||0;
    const dO = +othD.value||0, pO = +othP.value||0;
    const dA = +allD.value||0, pA = +allP.value||0;
    const eU = +expU.value||0, eC = +expC.value||0, eA = +expA.value||0;

    const kids = kidsMap[st] ?? 0;
    const child = childAllow[kids] ?? 0;
    const liv = living[st] ?? 0;

    allowRes.textContent = money(child);
    livingRes.textContent = money(liv);

    const den = dS+pS+dO+pO;
    const rD = den>0 ? (dS+dO)/den : 0;
    const rP = den>0 ? (pS+pO)/den : 0;
    debtorRatio.textContent = (rD*100).toFixed(1)+'%';
    partnerRatio.textContent = (rP*100).toFixed(1)+'%';

    const tincome = dS+pS+dO+pO+dA+pA+child;
    const texp = liv + eU + eC + eA;
    const disp = tincome - texp;

    totalIncome.textContent = money(tincome);
    totalExp.textContent = money(texp);
    dispRes.textContent = disp<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : money(disp);

    // ×ª×©×œ×•××™× ××•×¦×¢×™× ×œ×›×œ ××—×“ (×—×¦×™ ××”×—×œ×§ ×”×™×—×¡×™)
    const dProp = r10((disp*rD)/2);
    const pProp = r10((disp*rP)/2);
    debtorPay.textContent = money(Math.max(0,dProp));
    partnerPay.textContent = money(Math.max(0,pProp));

    // "×ª×™×§ ××¤×¡" â€“ ×¨×§ ×§×¦×‘××•×ª, ××™×Ÿ ×”×›× ×¡×” ×œ×—×™×™×‘, ×•×œ× ×˜×•×¤×¡ ×¨×™×§
    const onlyAllow = (dS+pS+dO+pO)===0 && (dA+pA+child)>0;
    const formEmpty = tincome===0 && texp===0;

    if(isJoint){
      const half = disp/2;
      const base = Math.max(0, half - pProp);
      const fam = r10(base*rD + pProp);
      familyPay.textContent = money(Math.max(0,fam));
      familyPay.style.color = ''; // ××“×•× ×›×‘×¨ ×‘-css ×©×œ total
      familyPay.style.fontWeight = '800';
    }else{
      // ×× ×œ× ×–×•×’ ×‘×”×œ×™×š â€“ ××™×Ÿ ×›×¨×˜×™×¡ ××©×¤×—×ª×™; "×ª×™×§ ××¤×¡" ×¨×§ ×× ×¢×•××“×™× ×‘×ª× ××™
      if(onlyAllow && !formEmpty && dS===0 && dO===0){
        debtorPay.textContent = '×ª×™×§ ××¤×¡';
        debtorPay.style.color = '#8b0000';
        debtorPay.style.fontWeight = '900';
      }else{
        debtorPay.style.color = ''; debtorPay.style.fontWeight = '800';
      }
    }
  }

  // ×××–×™× ×™×
  document.querySelectorAll('#form input, #form select').forEach(el=>{
    el.addEventListener('input', ()=>{updateUI();calc();});
    el.addEventListener('change', ()=>{updateUI();calc();});
  });
  [debtorM,debtorF,joint,status].forEach(el=> el.addEventListener('change', ()=>{updateUI();calc();}));

  // ×˜×•×’×œ×™×
  tglAllow.addEventListener('click', ()=>{tglAllow.classList.toggle('on');allowBox.classList.toggle('hidden');});
  tglAlim.addEventListener('click', ()=>{tglAlim.classList.toggle('on');alimBox.classList.toggle('hidden');});
  repToggle.addEventListener('click', ()=> repPanel.classList.toggle('hidden'));
  noteBtn.addEventListener('click', ()=> noteBox.classList.toggle('hidden'));

  // tooltips ?
  let pop=null, popBtn=null;
  const infos = {
    deb:'×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.<br>×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ (×Ö¾3 ×—×•×“×©×™×) ×œ×¤×™ ×©×›×¨ ××™× ×™××•× 6,247 â‚ª.',
    par:'×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.<br>×× ×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª â€“ ×ª×©×œ×•× ××“×•×¨×’ ×œ×¤×™ ×©×›×¨ ××™× ×™××•× 6,247 â‚ª.'
  };
  document.addEventListener('click',(e)=>{
    const b=e.target.closest('.info');
    if(b){
      if(popBtn===b){ if(pop){pop.remove();pop=null;popBtn=null;} return; }
      if(pop){pop.remove();pop=null;}
      const key=b.dataset.i;
      pop=document.createElement('div'); pop.className='popover'; pop.innerHTML=infos[key]||'';
      document.body.appendChild(pop);
      const r=b.getBoundingClientRect();
      pop.style.top=(r.bottom+window.scrollY+8)+'px';
      pop.style.right=(window.innerWidth-r.right+8)+'px';
      popBtn=b; return;
    }
    if(pop && !e.target.closest('.popover')){pop.remove();pop=null;popBtn=null;}
  });

  // ×¦×™×œ×•× ××¡×š â€“ ×“×¡×§×˜×•×¤ ×“×£ ××—×“; ××•×‘×™×™×œ ×©× ×™ ×—×œ×§×™×
  function shot(){
    const node=document.getElementById('calcRoot');
    const mobile=window.matchMedia('(max-width:768px)').matches;
    html2canvas(node,{useCORS:true,backgroundColor:'#ffffff',scale:2,scrollY:-window.scrollY,
      windowWidth:document.documentElement.scrollWidth,
      windowHeight:document.documentElement.scrollHeight
    }).then(canvas=>{
      if(!mobile){
        const data=canvas.toDataURL('image/png');
        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!doctype html><html dir="rtl"><head><meta charset="utf-8"><title>×¦×™×œ×•× ××¡×š</title>
          <style>html,body{margin:0} img{display:block;width:100%;height:auto}
          @media print{@page{size:A4;margin:5mm}}</style></head><body><img src="${data}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      }else{
        const half=Math.ceil(canvas.height/2);
        const c1=document.createElement('canvas'); c1.width=canvas.width; c1.height=half;
        const c2=document.createElement('canvas'); c2.width=canvas.width; c2.height=canvas.height-half;
        c1.getContext('2d').drawImage(canvas,0,0,canvas.width,half,0,0,canvas.width,half);
        c2.getContext('2d').drawImage(canvas,0,half,canvas.width,canvas.height-half,0,0,canvas.width,canvas.height-half);
        const d1=c1.toDataURL('image/png'), d2=c2.toDataURL('image/png');
        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!doctype html><html dir="rtl"><head><meta charset="utf-8"><title>×¦×™×œ×•× (××•×‘×™×™×œ)</title>
          <style>html,body{margin:0} img{display:block;width:100%;height:auto}
          @media print{@page{size:A4;margin:5mm} img{page-break-after:always}}</style></head>
          <body><img src="${d1}"><img src="${d2}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      }
    });
  }
  document.getElementById('shotBtn').addEventListener('click', shot);

  function email(){
    const tip=document.getElementById('emailTip'); tip.style.display='block';
    const g=id=>(document.getElementById(id)?.textContent||'').trim();
    const subj=`××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ${document.getElementById('caseId')?.value||'×œ×œ× ××¡×¤×¨ ×ª×™×§'}`;
    const body=[
      '×©×œ×•×,','','××¦×´×‘ ×¦×™×œ×•× ××¡×š (×¦×¨×¤×• ××ª ×”-PNG).','',
      `×¡×š ×”×›× ×¡×•×ª: ${g('totalIncome')}`,`×¡×š ×”×•×¦××•×ª: ${g('totalExp')}`,
      `×”×›× ×¡×” ×¤× ×•×™×”: ${g('dispRes')}`,`××—×•×– ×—×™×™×‘/×ª: ${g('debtorRatio')}`,`××—×•×– ×‘×Ÿ/×‘×ª ×–×•×’: ${g('partnerRatio')}`,
      `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${g('debtorPay')}`,`×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${g('partnerPay')}`,
      `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${g('familyPay')||'-'}`,'','×‘×‘×¨×›×”'
    ].join('\n');
    window.location.href=`mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  }
  document.getElementById('emailBtn').addEventListener('click', email);

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.getElementById('form').reset();
    allowBox.classList.add('hidden'); alimBox.classList.add('hidden');
    tglAllow.classList.remove('on'); tglAlim.classList.remove('on');
    repPanel.classList.add('hidden'); noteBox.classList.add('hidden');
    debtorM.checked=true; joint.checked=false;
    updateUI(); calc();
  });

  // init
  updateUI(); calc();
});
</script>
</body>
</html>
