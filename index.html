<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>

  <!-- Heebo -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- html2canvas ×œ×¦×™×œ×•× ××¡×š -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --panel:#fff;
      --text:#333; --label:#555; --border:#ddd; --accent:#ee9b00;
      --resultbg:#e9f5f5; --danger:#ae2012; --blue:#007bff;
      --chip-bg:#f0f0f0; --chip-border:#ccc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Heebo',sans-serif; background:var(--bg); color:var(--text);
      margin:0; padding:20px; display:flex; justify-content:center; align-items:flex-start;
    }

    /* ×¤×¨×™×¡×ª ×”××—×©×‘×•×Ÿ */
    #captureRoot{width:100%; max-width:1000px}
    .calculator{
      background:var(--panel); border-radius:12px; overflow:hidden;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      display:grid; grid-template-columns:1fr 1fr;
    }
    header{
      grid-column:1 / -1; background:var(--primary); color:#fff; padding:18px 20px;
      display:flex; align-items:center; justify-content:center; gap:10px; text-align:center;
    }
    header h1{margin:0; font-size:1.7rem; font-weight:700}
    .update-tag{font-size:.85rem; opacity:.95; background:rgba(255,255,255,.12);
      padding:4px 8px; border-radius:8px}

    .inputs-col{padding:22px; border-left:1px solid var(--border)}
    .results-col{padding:22px; background:var(--resultbg)}

    .section{display:grid; gap:18px}
    .section h2{margin:0; color:var(--primary); border-bottom:2px solid var(--secondary);
      padding-bottom:8px; font-size:1.25rem}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .group{display:flex; flex-direction:column}
    .group label{color:var(--label); font-weight:500; margin-bottom:6px}

    input,select{
      width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;
      font-size:1rem; background:#fff; transition:.2s border, .2s box-shadow;
    }
    input:focus,select:focus{outline:none; border-color:var(--secondary);
      box-shadow:0 0 0 3px rgba(10,147,150,.2)}

    /* ×¦â€™×™×¤×™×: ×—×™×™×‘/×ª + ×–×•×’ ×‘×”×œ×™×š ×‘×©×•×¨×” ××—×ª */
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      padding:8px 14px; border:1px solid var(--chip-border); border-radius:999px;
      background:var(--chip-bg); cursor:pointer; user-select:none; font-size:.95rem;
      transition:.2s background,.2s color,.2s border;
    }
    .chip.active{background:var(--secondary); color:#fff; border-color:var(--secondary)}
    .chip.danger.active{background:#e84a4a; border-color:#e84a4a; color:#fff}
    .chip input{display:none}

    /* ×ª×•×¦××•×ª */
    .results h3{margin:0 0 16px 0; color:var(--primary); text-align:center}
    .r-line{display:flex; justify-content:space-between; align-items:center; padding:10px 0;
      border-bottom:1px solid #d4e7e7; font-size:1.05rem}
    .r-line:last-child{border-bottom:none}
    .r-grid{display:grid; grid-template-columns:1fr 1fr; gap:18px; text-align:center}
    .r-label{font-weight:500}
    .r-val{font-weight:700; color:var(--accent)}

    .r-disposable{text-align:center}
    .r-disposable .r-val{color:var(--blue); font-size:1.35rem}

    .r-total .r-val{color:var(--danger); font-size:1.35rem}
    .zero-case{color:var(--secondary)!important; font-weight:800; font-size:1.35rem}

    /* ×›×¤×ª×•×¨×™× ×¦×¤×™× â€“ ××•×‘×™×™×œ ×‘×œ×‘×“ */
    .floating-actions{display:none}
    @media (max-width: 768px){
      .calculator{grid-template-columns:1fr}
      .inputs-col{border-left:none}
      .row{grid-template-columns:1fr}
      .floating-actions{
        position:fixed; bottom:12px; right:12px; left:12px; z-index:9999;
        display:flex; gap:10px; justify-content:space-between; align-items:center;
        background:rgba(255,255,255,.9); border:1px solid var(--border); border-radius:14px;
        padding:8px 10px; box-shadow:0 10px 25px rgba(0,0,0,.15); backdrop-filter: blur(6px);
      }
      .fab{
        flex:1; display:flex; align-items:center; justify-content:center; gap:8px;
        padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#fff;
        font-weight:600; cursor:pointer;
      }
      .fab:active{transform:translateY(1px)}
      .hide-on-mobile{display:none!important}
    }

    /* ×”×¡×ª×¨×ª ×”×›×¤×ª×•×¨×™× ×”×¦×¤×™× ×‘×“×¡×§×˜×•×¤ */
    @media (min-width:769px){
      .hide-on-desktop{display:none!important}
    }

    /* ×”×“×¤×¡×”: ×‘×œ×™ ×›×¤×ª×•×¨×™× ×¦×¤×™× ×•×‘×œ×™ ×¨×§×¢ ×ª×›×œ×ª */
    @media print{
      body{padding:0; background:#fff}
      .floating-actions, .hide-in-print{display:none!important}
      .results-col{background:#fff}
      header{padding:12px}
      input,select{border:none!important; box-shadow:none!important}
    }
  </style>
</head>
<body>

<div id="captureRoot">
  <div class="calculator" id="calculator">
    <header class="hide-in-print">
      <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
      <span class="update-tag">××¢×•×“×›×Ÿ ×œÖ¾<span id="yearTag"></span></span>
    </header>

    <!-- ×¢××•×“×ª ×§×œ×˜ -->
    <div class="inputs-col">
      <form id="form">
        <div class="section">
          <h2>×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>

          <div class="group">
            <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
            <select id="status">
              <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡...</option>
              <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
              <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
              <option value="×–×•×’">×–×•×’</option>
              <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
              <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
            </select>
          </div>

          <!-- ×¦â€™×™×¤×™× ×‘×©×•×¨×” ××—×ª -->
          <div class="group">
            <label>××™ ×‘×”×œ×™×š?</label>
            <div class="chips" id="chipsRow">
              <label class="chip" id="chipMale">
                <input type="radio" name="debtor" id="debtorMale" checked>
                ×—×™×™×‘
              </label>
              <label class="chip" id="chipFemale">
                <input type="radio" name="debtor" id="debtorFemale">
                ×—×™×™×‘×ª
              </label>
              <label class="chip danger" id="chipJoint">
                <input type="checkbox" id="jointProceeding">
                ×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š
              </label>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</h2>

          <div class="row">
            <div class="group">
              <label id="salaryDebtorLabel">×”×›× ×¡×” (×—×™×™×‘)</label>
              <input type="number" id="salaryDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
            </div>
            <div class="group" id="salaryPartnerWrap">
              <label id="salaryPartnerLabel">×”×›× ×¡×” (×‘×ª ×–×•×’)</label>
              <input type="number" id="salaryPartner" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label id="otherDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label>
              <input type="number" id="otherIncomeDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
            </div>
            <div class="group" id="otherPartnerWrap">
              <label id="otherPartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)</label>
              <input type="number" id="otherIncomePartner" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label>×§×¦×‘×” (×—×™×™×‘/×ª)</label>
              <input type="number" id="debtorAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
            <div class="group" id="partnerAllowanceWrap">
              <label>×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
              <input type="number" id="partnerAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label>
              <input type="number" id="unusualExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
            </div>
            <div class="group">
              <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
              <input type="number" id="childcareExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
            </div>
          </div>

          <div class="group">
            <label>×”×•×¦××•×ª ××–×•× ×•×ª</label>
            <input type="number" id="alimonyExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
          </div>
        </div>
      </form>
    </div>

    <!-- ×¢××•×“×ª ×ª×•×¦××•×ª -->
    <div class="results-col">
      <div class="results">
        <h3>×ª×•×¦××•×ª ×”×—×™×©×•×‘</h3>

        <div class="r-grid">
          <div>
            <div class="r-label">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div>
            <div class="r-val" id="ssAllow">0 â‚ª</div>
          </div>
          <div>
            <div class="r-label">×¡×š ×”×›× ×¡×•×ª</div>
            <div class="r-val" id="sumIncome">0 â‚ª</div>
          </div>
        </div>

        <div class="r-grid" style="margin-top:10px">
          <div>
            <div class="r-label">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div>
            <div class="r-val" id="livingCost">0 â‚ª</div>
          </div>
          <div>
            <div class="r-label">×¡×š ×”×•×¦××•×ª</div>
            <div class="r-val" id="sumExpenses">0 â‚ª</div>
          </div>
        </div>

        <div class="r-disposable" style="margin:12px 0">
          <div class="r-label">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</div>
          <div class="r-val" id="disposable">0 â‚ª</div>
        </div>

        <div class="r-grid">
          <div>
            <div class="r-label" id="debtorRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘)</div>
            <div class="r-val" id="debtorRatio">0%</div>
          </div>
          <div>
            <div class="r-label" id="partnerRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×ª ×–×•×’)</div>
            <div class="r-val" id="partnerRatio">0%</div>
          </div>
        </div>

        <div class="r-grid" style="margin-top:10px">
          <div>
            <div class="r-label" id="debtorPayLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘)</div>
            <div class="r-val" id="debtorPay">0 â‚ª</div>
          </div>
          <div>
            <div class="r-label" id="partnerPayLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×ª ×–×•×’)</div>
            <div class="r-val" id="partnerPay">0 â‚ª</div>
          </div>
        </div>

        <div class="r-line r-total" style="margin-top:8px">
          <div class="r-label" id="familyPayLabel">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</div>
          <div class="r-val" id="familyPay">0 â‚ª</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ×›×¤×ª×•×¨×™× ×¦×¤×™× â€“ ××•×‘×™×™×œ ×‘×œ×‘×“ -->
<div class="floating-actions hide-on-desktop" id="floatingBar">
  <button class="fab" id="btnShot" title="×¦×™×œ×•× ××¡×š / ×”×“×¤×¡×”">ğŸ“¸ ×¦×™×œ×•×</button>
  <button class="fab" id="btnMail" title="×©×œ×™×—×ª ××™×™×œ">âœ‰ï¸ ××™×™×œ</button>
  <button class="fab" id="btnReset" title="××™×¤×•×¡">â†º ××™×¤×•×¡</button>
</div>

<script>
  // ×©× ×” ×‘×›×•×ª×¨×ª
  document.getElementById('yearTag').textContent = new Date().getFullYear();

  // ===== × ×ª×•× ×™× ×‘×¡×™×¡×™×™× =====
  const lookup = {
    "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“": { kids: 0, livingCost: 4556 },
    "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“": { kids: 1, livingCost: 6056 },
    "×–×•×’": { kids: 0, livingCost: 6024 },
    "×–×•×’+×™×œ×“": { kids: 1, livingCost: 7524 },
    "×–×•×’+ 2 ×™×œ×“×™×": { kids: 2, livingCost: 9024 },
    "×–×•×’+ 3 ×™×œ×“×™×": { kids: 3, livingCost: 10524 },
    "×–×•×’+ 4 ×™×œ×“×™×": { kids: 4, livingCost: 12024 },
    "×–×•×’+ 5 ×™×œ×“×™×": { kids: 5, livingCost: 13324 },
    "×–×•×’+ 6 ×™×œ×“×™×": { kids: 6, livingCost: 14624 },
    "×–×•×’+ 7 ×™×œ×“×™×": { kids: 7, livingCost: 15924 },
    "×–×•×’+ 8 ×™×œ×“×™×": { kids: 8, livingCost: 17224 },
    "×–×•×’+ 9 ×™×œ×“×™×": { kids: 9, livingCost: 18524 },
    "×–×•×’+ 10 ×™×œ×“×™×": { kids: 10, livingCost: 19824 }
  };
  const childAllow = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

  // ===== DOM =====
  const statusEl = document.getElementById('status');
  const debtorMaleEl = document.getElementById('debtorMale');
  const debtorFemaleEl = document.getElementById('debtorFemale');
  const chipMale = document.getElementById('chipMale');
  const chipFemale = document.getElementById('chipFemale');
  const jointEl = document.getElementById('jointProceeding');
  const chipJoint = document.getElementById('chipJoint');

  const salaryDebtorEl = document.getElementById('salaryDebtor');
  const salaryPartnerEl = document.getElementById('salaryPartner');
  const otherDebtorEl = document.getElementById('otherIncomeDebtor');
  const otherPartnerEl = document.getElementById('otherIncomePartner');
  const debtorAllowEl = document.getElementById('debtorAllowance');
  const partnerAllowEl = document.getElementById('partnerAllowance');
  const unusualEl = document.getElementById('unusualExpenses');
  const childcareEl = document.getElementById('childcareExpenses');
  const alimonyEl = document.getElementById('alimonyExpenses');

  const salaryPartnerWrap = document.getElementById('salaryPartnerWrap');
  const otherPartnerWrap = document.getElementById('otherPartnerWrap');
  const partnerAllowanceWrap = document.getElementById('partnerAllowanceWrap');

  const salaryDebtorLabel = document.getElementById('salaryDebtorLabel');
  const salaryPartnerLabel = document.getElementById('salaryPartnerLabel');
  const otherDebtorLabel = document.getElementById('otherDebtorLabel');
  const otherPartnerLabel = document.getElementById('otherPartnerLabel');

  const ssAllow = document.getElementById('ssAllow');
  const sumIncome = document.getElementById('sumIncome');
  const livingCost = document.getElementById('livingCost');
  const sumExpenses = document.getElementById('sumExpenses');
  const disposable = document.getElementById('disposable');
  const debtorRatio = document.getElementById('debtorRatio');
  const partnerRatio = document.getElementById('partnerRatio');
  const debtorPay = document.getElementById('debtorPay');
  const partnerPay = document.getElementById('partnerPay');
  const familyPay = document.getElementById('familyPay');
  const familyPayLabel = document.getElementById('familyPayLabel');

  const btnShot = document.getElementById('btnShot');
  const btnMail = document.getElementById('btnMail');
  const btnReset = document.getElementById('btnReset');

  function fmt(n){return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(+n||0)}
  const round10 = n => Math.floor((+n||0)/10)*10;

  // ===== UI Labels / ×”×¦×’×ª/×”×¡×ª×¨×ª ×‘×Ÿ/×‘×ª ×–×•×’ =====
  function refreshUI(){
    const st = statusEl.value || '';
    const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
    salaryPartnerWrap.style.display = isSingle ? 'none':'flex';
    otherPartnerWrap.style.display = isSingle ? 'none':'flex';
    partnerAllowanceWrap.style.display = isSingle ? 'none':'flex';

    // ×¦â€™×™×¤×™× ×¤×¢×™×œ×™×
    chipMale.classList.toggle('active', debtorMaleEl.checked);
    chipFemale.classList.toggle('active', debtorFemaleEl.checked);
    chipJoint.classList.toggle('active', jointEl.checked);

    const male = debtorMaleEl.checked;
    if(isSingle){
      salaryDebtorLabel.textContent = '×”×›× ×¡×” (×—×™×™×‘/×ª)';
      salaryPartnerLabel.textContent = '×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)';
      otherDebtorLabel.textContent  = '×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)';
      otherPartnerLabel.textContent = '×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)';
    }else{
      salaryDebtorLabel.textContent = male ? '×”×›× ×¡×” (×—×™×™×‘)':'×”×›× ×¡×” (×—×™×™×‘×ª)';
      salaryPartnerLabel.textContent = male ? '×”×›× ×¡×” (×‘×ª ×–×•×’)':'×”×›× ×¡×” (×‘×Ÿ ×–×•×’)';
      otherDebtorLabel.textContent  = male ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)':'×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘×ª)';
      otherPartnerLabel.textContent = male ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)':'×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ ×–×•×’)';
    }

    // ×ª×•×•×™×ª ×¡×•×¤×™×ª
    familyPayLabel.textContent = jointEl.checked && !isSingle ? '×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:' :
                                  (isSingle ? '×ª×©×œ×•× ×—×•×“×©×™ (×—×™×™×‘/×ª):' : '×ª×©×œ×•× ×—×•×“×©×™ (×—×™×™×‘/×ª):');
  }

  // ===== ×—×™×©×•×‘ =====
  function calc(){
    const st = statusEl.value||'';
    const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
    const isJoint = jointEl.checked && !isSingle;

    const sD = +salaryDebtorEl.value||0;
    const sP = +salaryPartnerEl.value||0;
    const oD = +otherDebtorEl.value||0;
    const oP = +otherPartnerEl.value||0;
    const aD = +debtorAllowEl.value||0;
    const aP = +partnerAllowEl.value||0;

    const u  = +unusualEl.value||0;
    const cc = +childcareEl.value||0;
    const al = +alimonyEl.value||0;

    const kids = (lookup[st]?.kids)||0;
    const base = (lookup[st]?.livingCost)||0;
    const childA = childAllow[kids]||0;

    livingCost.textContent = fmt(base);
    ssAllow.textContent = fmt(childA);

    // ×©×™×¢×•×¨ ×™×—×¡ ×”×›× ×¡×”
    const totalIncomeForRatio = sD+oD+sP+oP;
    const rD = totalIncomeForRatio>0 ? (sD+oD)/totalIncomeForRatio : 0;
    const rP = totalIncomeForRatio>0 ? (sP+oP)/totalIncomeForRatio : 0;

    debtorRatio.textContent  = (rD*100).toFixed(1)+'%';
    partnerRatio.textContent = (rP*100).toFixed(1)+'%';

    // ×¡×š ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª
    const incomes = sD+sP+oD+oP + aD+aP + childA;
    const expenses = base + u + cc + al;

    sumIncome.textContent  = fmt(incomes);
    sumExpenses.textContent = fmt(expenses);

    const DI = incomes - expenses;
    disposable.textContent = DI<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmt(DI);

    // ×ª×©×œ×•××™ ××•×¦×¢ × ×¤×¨×“×™× (××—×¦×™×ª ××”×›× ×¡×” ×¤× ×•×™×” ×œ×¤×™ ×™×—×¡)
    const payD = rD>0 ? round10((DI*rD)/2) : 0;
    const payP = rP>0 ? round10((DI*rP)/2) : 0;
    debtorPay.textContent  = fmt(Math.max(0,payD));
    partnerPay.textContent = fmt(Math.max(0,payP));

    // ×ª×©×œ×•× ×¡×•×¤×™ (×œ×¤×™ ×”×“×¨×™×©×” ×œ×–×•×’ ×‘×”×œ×™×š)
    let final = 0;
    if(isSingle){
      final = Math.max(0,payD);
    }else if(isJoint){
      // F = floor10( ((DI/2 - partnerPay) * rD) + partnerPay )
      const mid = (DI/2) - payP;
      final = round10(Math.max(0, (mid * rD) + payP ));
    }else{
      final = Math.max(0,payD);
    }

    // "×ª×™×§ ××¤×¡" â€“ ×× ×™×© ×”×›× ×¡×•×ª ×¨×§ ××§×¦×‘××•×ª ×•×œ×—×™×™×‘ ×”×¢×™×§×¨×™ ××™×Ÿ ×©×•× ×”×›× ×¡×” ××—×¨×ª
    const hasOnlyAllowances = (sD+oD+sP+oP)===0 && (aD+aP)>0;
    familyPay.classList.remove('zero-case');
    if(hasOnlyAllowances && final===0){
      familyPay.textContent = '×ª×™×§ ××¤×¡';
      familyPay.classList.add('zero-case');
    }else{
      familyPay.textContent = fmt(final);
    }
  }

  // ===== ××™×¨×•×¢×™× =====
  [
    statusEl, salaryDebtorEl, salaryPartnerEl, otherDebtorEl, otherPartnerEl,
    debtorAllowEl, partnerAllowEl, unusualEl, childcareEl, alimonyEl
  ].forEach(el => el.addEventListener('input', ()=>{ refreshUI(); calc(); }));

  debtorMaleEl.addEventListener('change', ()=>{ refreshUI(); calc(); });
  debtorFemaleEl.addEventListener('change', ()=>{ refreshUI(); calc(); });
  jointEl.addEventListener('change', ()=>{ refreshUI(); calc(); });

  // ×¦â€™×™×¤×™× × ×™×ª× ×™× ×œ×œ×—×™×¦×”
  chipMale.addEventListener('click', ()=>{ debtorMaleEl.checked=true; refreshUI(); calc(); });
  chipFemale.addEventListener('click', ()=>{ debtorFemaleEl.checked=true; refreshUI(); calc(); });
  chipJoint.addEventListener('click', (e)=>{
    if(e.target.tagName.toLowerCase()!=='input') jointEl.checked=!jointEl.checked;
    refreshUI(); calc();
  });

  // ×”×ª×—×•×œ
  refreshUI(); calc();

  // ===== ×¦×™×œ×•× ××¡×š ××œ× + ×”×“×¤×¡×” =====
  async function shotAndPrint(){
    try{
      const node = document.getElementById('captureRoot');
      // ×’×œ×™×œ×” ×œ×¨××© ×”×“×£ ×›×“×™ ×œ×›×œ×•×œ ×”×›×œ
      window.scrollTo({top:0, behavior:'auto'});
      const canvas = await html2canvas(node,{
        useCORS:true, backgroundColor:'#ffffff', scale:2,
        windowWidth:document.documentElement.scrollWidth,
        windowHeight:document.documentElement.scrollHeight,
        scrollX:0, scrollY:-window.scrollY
      });
      const url = canvas.toDataURL('image/png');
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>×¦×™×œ×•× ××¡×š ×”××—×©×‘×•×Ÿ</title>
        <style>
          html,body{margin:0;padding:0}
          img{width:100%; height:auto; display:block; page-break-inside:avoid}
          @media print{img{width:100%;}}
        </style>
        </head><body>
          <img src="${url}" alt="×¦×™×œ×•× ××¡×š" />
        </body></html>
      `);
      w.document.close(); w.focus();
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 400);
    }catch(e){
      alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¦×™×œ×•× ×”××¡×š');
      console.error(e);
    }
  }
  btnShot?.addEventListener('click', shotAndPrint);

  // ===== ×©×œ×™×—×ª ××™×™×œ =====
  btnMail?.addEventListener('click', ()=>{
    const gt = id => (document.getElementById(id)?.textContent||'').trim();
    const subject = '××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ×ª×§×¦×™×¨ ×ª×•×¦××•×ª';
    const body = [
      '×©×œ×•×,',
      '',
      '××¦×•×¨×£/×ª ×¦×™×œ×•× ××¡×š ×©×œ ×”××—×©×‘×•×Ÿ ×›×§×•×‘×¥ PNG (× × ×œ×¦×¨×£ ×™×“× ×™×ª ×œ××—×¨ ×©××™×¨×”).',
      '',
      `×¡×š ×”×›× ×¡×•×ª: ${gt('sumIncome')}`,
      `×¡×š ×”×•×¦××•×ª: ${gt('sumExpenses')}`,
      `×”×›× ×¡×” ×¤× ×•×™×”: ${gt('disposable')}`,
      `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${gt('debtorRatio')}`,
      `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${gt('partnerRatio')}`,
      `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${gt('debtorPay')}`,
      `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${gt('partnerPay')}`,
      `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${gt('familyPay')}`,
      '',
      '×‘×‘×¨×›×”'
    ].join('\n');
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  // ===== ××™×¤×•×¡ =====
  btnReset?.addEventListener('click', ()=>{
    document.getElementById('form').reset();
    // ×‘×¨×™×¨×ª ××—×“×œ ×¦â€™×™×¤×™×
    debtorMaleEl.checked = true; jointEl.checked = false;
    refreshUI(); calc();
  });
</script>
</body>
</html>
