<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet" />

<!-- html2canvas ×œ×¦×™×œ×•× ××¡×š -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --panel:#fff;
  --text:#333; --label:#555; --border:#dde5ea; --accent:#ee9b00;
  --danger:#ae2012; --blue:#007bff; --muted:#6b7280;
}

*{box-sizing:border-box}
body{
  font-family:'Heebo',sans-serif; background:var(--bg); color:var(--text);
  margin:0; padding:16px; display:flex; justify-content:center; min-height:100vh;
}
.calculator{
  width:100%; max-width:1100px; background:var(--panel); border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08); overflow:hidden; display:grid; grid-template-columns:1fr 1fr;
}
header{
  grid-column:1/-1; background:var(--primary); color:#fff; padding:14px 16px; text-align:center; position:relative;
}
header h1{ margin:0; font-size:1.8rem; line-height:1; }
.year-badge{
  position:absolute; inset-inline-start:16px; inset-block-start:12px;
  font-size:.9rem; color:#e6f4f1; background:rgba(255,255,255,.12);
  padding:6px 10px; border:1px solid rgba(255,255,255,.25); border-radius:10px;
}
@media (max-width:768px){
  header h1{ font-size:1.35rem }
  .year-badge{ font-size:.8rem; inset-block-start:10px }
}

.results-col{ background:#eaf6f6; padding:18px }
.inputs-col { padding:18px; border-inline-start:1px solid var(--border) }

.section-title{
  margin:6px 0 14px; color:var(--primary); font-size:1.2rem; font-weight:700; text-align:center;
}
.result-grid{
  display:grid; grid-template-columns:repeat(2,1fr); gap:14px;
}
.result-card{
  background:#fff; border:1px solid #dbe9ea; border-radius:12px; padding:12px 14px; text-align:center;
}
.result-card .k{ color:var(--muted); font-weight:500 }
.result-card .v{ margin-top:6px; font-weight:700; color:var(--accent); font-size:1.15rem }
.result-wide{ grid-column:1/-1 }
.result-big .v{ font-size:1.35rem; color:#0a58ff }
.result-danger .v{ color:var(--danger) }

.controls-top{
  display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:10px;
}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
  border:1px solid #cfd8e3; border-radius:10px; background:#fff; cursor:pointer;
  font-weight:500;
}
.btn:hover{ background:#f6f8fb }
.btn.primary{ background:#f0faf9; border-color:#b8e0db }
.btn.danger{ background:#fff5f5; border-color:#ffc7c7 }
.btn.reset{ border-color:#a0aec0 }

.row{ display:grid; gap:12px }
.row-2{ grid-template-columns:1fr 1fr }
.row-3{ grid-template-columns:1fr 1fr 1fr }

.input-pair{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
.input-group{ display:flex; flex-direction:column }
.input-group label{
  font-weight:600; color:var(--label); display:flex; gap:8px; align-items:center; margin-bottom:6px;
}
.input-group input, .input-group select, .input-group textarea{
  border:1px solid var(--border); padding:10px 12px; border-radius:10px; font-size:1rem;
  background:#fbfeff; /* ××™× ×™××œ×™×¡×˜×™ ×•×œ× ×—×™×•×•×¨ ××“×™ */
}
.input-group input:focus, .input-group select:focus, .input-group textarea:focus{
  outline:none; border-color:var(--secondary); box-shadow:0 0 0 3px rgba(10,147,150,.18)
}
.input-group textarea{ min-height:78px; resize:vertical }
.small-note{ font-size:.9rem; color:#666 }

.toggles-line{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.chip{ padding:8px 12px; border:1px solid #cfd8e3; border-radius:999px; background:#fff; cursor:pointer; }
.chip.active{ background:#0d9488; color:#fff; border-color:#0d9488 }
.chip.alert  { background:#ffe8e8; border-color:#ffc4c4; color:#b42318 }
.chip.alert.active{ background:#b42318; color:#fff; border-color:#b42318 }

/* ×©×“×•×ª ××•×¡×ª×¨×™× ×‘×¤×ª×™×—×” */
#allowanceFields, #alimonyFields, #reportPanel{ display:none }

.info-btn{
  width:18px;height:18px;border-radius:50%;background:#eef6f6;color:#0d6b6b;
  display:inline-flex; align-items:center; justify-content:center; font-size:.8rem; border:1px solid #d4e7e7; cursor:pointer;
}
.pop{ position:absolute; z-index:1000; max-width:320px; background:#fff7d6; color:#3b2f00; border:1px solid #ffe6a8;
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.15); padding:10px 12px; line-height:1.45 }

.help-row{ display:flex; justify-content:center; margin-top:10px }

.report-trigger{ display:flex; justify-content:center; margin:14px 0 4px }
.report-btn{ background:#fff; border:1px dashed #c8d2de; padding:8px 14px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px }
.report-btn:hover{ background:#f6fbff }

@media (max-width:768px){
  .calculator{ grid-template-columns:1fr } /* ×¢××•×“×” ××—×ª */
  .results-col{ order:2; padding-bottom:80px } /* ××§×•× ×œ×›×¤×ª×•×¨×™ ××•×‘×™×™×œ ×“×‘×™×§×™× */
  .inputs-col{ order:1 }
  .row-2, .row-3, .input-pair{ grid-template-columns:1fr }
  .controls-top{ position:sticky; top:0; background:#eaf6f6; padding:8px 4px; z-index:5 }
  .sticky-mobile{
    position:fixed; left:0; right:0; bottom:0; background:#ffffffcc; backdrop-filter:saturate(1.2) blur(6px);
    border-top:1px solid #dfe7ee; padding:6px 10px; display:flex; gap:8px; justify-content:space-between; z-index:10
  }
  .btn{ flex:1; justify-content:center; padding:10px 8px }
}

/* ×”×“×¤×¡×” / ×¦×™×œ×•× */
@media print{
  body{ background:#fff; padding:0 }
  .controls-top, .sticky-mobile{ display:none!important }
  .calculator{ box-shadow:none }
  /* ×¨×™×¡×•×§ ×œ×¢××•×“×™×: ×‘××•×‘×™×™×œ â€“ ×”×–× ×” ×•××– ×ª×•×¦××•×ª; ×‘×“×¡×§×˜×•×¤ â€“ ×”×›×œ ×‘×¢××•×“ ××—×“, ×× × ×›× ×¡. */
  .inputs-col{ page-break-after:always }
}

/* â€œ×ª×™×§ ××¤×¡â€ */
.zero-case{ color:#c2410c; font-weight:800; font-size:1.05rem }
.hidden{ display:none !important }
</style>
</head>
<body>

<div id="captureRoot" class="calculator">
  <header>
    <span class="year-badge" id="yearBadge"></span>
    <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
  </header>

  <!-- ×¢××•×“×ª ×ª×•×¦××•×ª (×©×××œ) -->
  <div class="results-col">
    <div class="controls-top" id="topActions">
      <button class="btn" id="btnPdf">ğŸ–¨ï¸ PDF</button>
      <button class="btn" id="btnShot">ğŸ“¸ ×¦×™×œ×•×</button>
      <button class="btn" id="btnMail">âœ‰ï¸ ×©×œ×™×—×ª ××™×™×œ</button>
      <button class="btn reset" id="btnReset">â†º ××™×¤×•×¡</button>
    </div>

    <div class="section-title">×ª×•×¦××•×ª ×”×—×™×©×•×‘</div>

    <div class="result-grid" id="resultsGrid">
      <div class="result-card">
        <div class="k">×¡×š ×”×›× ×¡×•×ª</div>
        <div class="v" id="totalIncomeResult">â‚ª 0</div>
      </div>
      <div class="result-card">
        <div class="k">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div>
        <div class="v" id="socialSecurityAllowance">â‚ª 0</div>
      </div>

      <div class="result-card">
        <div class="k">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div>
        <div class="v" id="baseLivingCostResult">â‚ª 0</div>
      </div>
      <div class="result-card">
        <div class="k">×¡×š ×”×•×¦××•×ª</div>
        <div class="v" id="totalExpensesResult">â‚ª 0</div>
      </div>

      <div class="result-card result-wide result-big">
        <div class="k">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</div>
        <div class="v" id="disposableIncomeResult">â‚ª 0</div>
      </div>

      <div class="result-card">
        <div class="k" id="debtorIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª)</div>
        <div class="v" id="debtorIncomeRatio">0.0%</div>
      </div>
      <div class="result-card">
        <div class="k" id="partnerIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</div>
        <div class="v" id="partnerIncomeRatio">0.0%</div>
      </div>

      <div class="result-card">
        <div class="k" id="debtorPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</div>
        <div class="v" id="debtorPaymentResult">â‚ª 0</div>
      </div>
      <div class="result-card">
        <div class="k" id="partnerPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</div>
        <div class="v" id="partnerPaymentResult">â‚ª 0</div>
      </div>

      <div class="result-card result-wide result-danger" id="familyPaymentCard" style="display:none">
        <div class="k">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</div>
        <div class="v" id="finalPaymentResult">â‚ª 0</div>
      </div>

      <div class="result-card result-wide" id="zeroCaseRow" style="display:none">
        <div class="v zero-case">×ª×™×§ ××¤×¡</div>
      </div>
    </div>

    <!-- ×¡×¨×’×œ ×“×‘×™×§ ×‘××•×‘×™×™×œ -->
    <div class="sticky-mobile" id="stickyBar">
      <button class="btn" id="btnPdf_m">ğŸ–¨ï¸ PDF</button>
      <button class="btn" id="btnShot_m">ğŸ“¸ ×¦×™×œ×•×</button>
      <button class="btn" id="btnMail_m">âœ‰ï¸ ××™×™×œ</button>
      <button class="btn reset" id="btnReset_m">â†º ××™×¤×•×¡</button>
    </div>
  </div>

  <!-- ×¢××•×“×ª ×”×–× ×” (×™××™×Ÿ) -->
  <div class="inputs-col">
    <div class="row">
      <div class="input-group">
        <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
        <select id="status">
          <option value="" disabled selected>×‘×—×¨ ×¡×˜×˜×•×¡ ××©×¤×—×ª×™â€¦</option>
          <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
          <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
          <option value="×–×•×’">×–×•×’</option>
          <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
          <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
        </select>
      </div>

      <div class="toggles-line">
        <span>××™ ×‘×”×œ×™×š?</span>
        <button class="chip" id="debtorMaleBtn" aria-pressed="true">×—×™×™×‘</button>
        <button class="chip" id="debtorFemaleBtn" aria-pressed="false">×—×™×™×‘×ª</button>

        <button class="chip alert" id="jointBtn" aria-pressed="false">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?</button>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border); margin:10px 0 12px">

    <div class="section-title">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</div>

    <div class="input-pair">
      <div class="input-group">
        <label>×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="salaryPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
      </div>
      <div class="input-group">
        <label>×”×›× ×¡×” (×—×™×™×‘/×ª) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="salaryDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
      </div>
    </div>

    <div class="input-pair">
      <div class="input-group">
        <label>×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="otherIncomePartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×” ××—×¨×ª">
      </div>
      <div class="input-group">
        <label>×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="otherIncomeDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×” ××—×¨×ª">
      </div>
    </div>

    <div class="help-row">
      <button class="chip" id="btnAllowances">×§×¦×‘××•×ª</button>
      <button class="chip" id="btnAlimony">××–×•× ×•×ª</button>
    </div>

    <!-- ×§×¦×‘××•×ª -->
    <div id="allowanceFields" class="row row-2" style="margin-top:8px">
      <div class="input-group">
        <label>×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="partnerAllowance" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
      </div>
      <div class="input-group">
        <label>×§×¦×‘×” (×—×™×™×‘/×ª) <span class="info-btn" data-info="â€”">?</span></label>
        <input id="debtorAllowance" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
      </div>
    </div>

    <!-- ××–×•× ×•×ª -->
    <div id="alimonyFields" class="row row-2" style="margin-top:8px">
      <div class="input-group">
        <label>×”×•×¦××•×ª ××–×•× ×•×ª <span class="info-btn" data-info="â€”">?</span></label>
        <input id="alimonyExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
      </div>
    </div>

    <div class="input-pair" style="margin-top:8px">
      <div class="input-group">
        <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª <span class="info-btn" data-info="â€”">?</span></label>
        <input id="unusualExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
      </div>
      <div class="input-group">
        <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™× <span class="info-btn" data-info="â€”">?</span></label>
        <input id="childcareExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
      </div>
    </div>

    <!-- ×¤×¨×˜×™ ×“×•"×— -->
    <div class="report-trigger">
      <button class="report-btn" id="reportBtn">ğŸ“Œ ×¤×¨×˜×™ ×“×•×´×—</button>
    </div>
    <div id="reportPanel" class="row row-3" style="margin-top:6px">
      <div class="input-group">
        <label>××¡×³ ×ª×™×§</label>
        <input id="caseId" type="text" placeholder="×œ×“×•×’××”: 12345/25">
      </div>
      <div class="input-group">
        <label>×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label>
        <input id="authorName" type="text" placeholder="×©× ××œ×">
      </div>
      <div class="input-group">
        <label>×ª××¨×™×š</label>
        <input id="reportDate" type="text" readonly>
      </div>
      <div class="input-group" style="grid-column:1/-1">
        <label>×”×¢×¨×”</label>
        <textarea id="reportNote" maxlength="500" placeholder="×”×¢×¨×” ×¢×“ 500 ×ª×•×•×™×"></textarea>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== ×›×œ×™ ×¢×–×¨ ====== */
const fmtILS = (n)=> new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(n||0);
const round10 = (n)=> Math.floor((n||0)/10)*10;

/* ====== ××œ×× ×˜×™× ====== */
const yearBadge = document.getElementById('yearBadge');
yearBadge.textContent = `××¢×•×“×›×Ÿ ×œÖ¾${new Date().getFullYear()}`;

const els = {
  status:document.getElementById('status'),
  salaryDebtor:document.getElementById('salaryDebtor'),
  salaryPartner:document.getElementById('salaryPartner'),
  otherDebtor:document.getElementById('otherIncomeDebtor'),
  otherPartner:document.getElementById('otherIncomePartner'),
  debAllow:document.getElementById('debtorAllowance'),
  partAllow:document.getElementById('partnerAllowance'),
  unusual:document.getElementById('unusualExpenses'),
  childcare:document.getElementById('childcareExpenses'),
  alimony:document.getElementById('alimonyExpenses'),

  resTotalIncome:document.getElementById('totalIncomeResult'),
  resSS:document.getElementById('socialSecurityAllowance'),
  resBase:document.getElementById('baseLivingCostResult'),
  resTotalExp:document.getElementById('totalExpensesResult'),
  resDisp:document.getElementById('disposableIncomeResult'),
  resDebR:document.getElementById('debtorIncomeRatio'),
  resParR:document.getElementById('partnerIncomeRatio'),
  resDebPay:document.getElementById('debtorPaymentResult'),
  resParPay:document.getElementById('partnerPaymentResult'),
  familyCard:document.getElementById('familyPaymentCard'),
  resFinal:document.getElementById('finalPaymentResult'),
  zeroCaseRow:document.getElementById('zeroCaseRow'),

  debtorLbl:document.getElementById('debtorIncomeRatioLabel'),
  partnerLbl:document.getElementById('partnerIncomeRatioLabel'),
  debtorPayLbl:document.getElementById('debtorPaymentLabel'),
  partnerPayLbl:document.getElementById('partnerPaymentLabel'),

  reportBtn:document.getElementById('reportBtn'),
  reportPanel:document.getElementById('reportPanel'),
  reportDate:document.getElementById('reportDate'),
  caseId:document.getElementById('caseId'),
  author:document.getElementById('authorName'),
  note:document.getElementById('reportNote'),

  btnAllowances:document.getElementById('btnAllowances'),
  allowanceFields:document.getElementById('allowanceFields'),
  btnAlimony:document.getElementById('btnAlimony'),
  alimonyFields:document.getElementById('alimonyFields'),

  jointBtn:document.getElementById('jointBtn'),
  debtorMaleBtn:document.getElementById('debtorMaleBtn'),
  debtorFemaleBtn:document.getElementById('debtorFemaleBtn'),
};

/* × ×ª×•× ×™ ×‘×¡×™×¡ */
const lookupData = {
  "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":{kids:0,livingCost:4556},
  "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":{kids:1,livingCost:6056},
  "×–×•×’":{kids:0,livingCost:6024},
  "×–×•×’+×™×œ×“":{kids:1,livingCost:7524},
  "×–×•×’+ 2 ×™×œ×“×™×":{kids:2,livingCost:9024},
  "×–×•×’+ 3 ×™×œ×“×™×":{kids:3,livingCost:10524},
  "×–×•×’+ 4 ×™×œ×“×™×":{kids:4,livingCost:12024},
  "×–×•×’+ 5 ×™×œ×“×™×":{kids:5,livingCost:13324},
  "×–×•×’+ 6 ×™×œ×“×™×":{kids:6,livingCost:14624},
  "×–×•×’+ 7 ×™×œ×“×™×":{kids:7,livingCost:15924},
  "×–×•×’+ 8 ×™×œ×“×™×":{kids:8,livingCost:17224},
  "×–×•×’+ 9 ×™×œ×“×™×":{kids:9,livingCost:18524},
  "×–×•×’+ 10 ×™×œ×“×™×":{kids:10,livingCost:19824}
};
const childAllowance = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

/* ××¦×‘ ×¨×“×™×• â€œ××™ ×‘×”×œ×™×šâ€ */
let debtorGender = '×—×™×™×‘'; // ×‘×¨×™×¨×ª ××—×“×œ
const setGender = (g)=>{
  debtorGender = g;
  els.debtorMaleBtn.classList.toggle('active', g==='×—×™×™×‘');
  els.debtorFemaleBtn.classList.toggle('active', g==='×—×™×™×‘×ª');
  updateLabels();
  calculate();
};
els.debtorMaleBtn.addEventListener('click', ()=> setGender('×—×™×™×‘'));
els.debtorFemaleBtn.addEventListener('click', ()=> setGender('×—×™×™×‘×ª'));

/* ×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š */
let joint = false;
els.jointBtn.addEventListener('click', ()=>{
  joint = !joint;
  els.jointBtn.setAttribute('aria-pressed', String(joint));
  els.jointBtn.classList.toggle('active', joint); // ××“×•× ×¨×§ ×›×©×”×•× ×¤×¢×™×œ
  els.familyCard.style.display = joint ? 'block' : 'none';
  calculate();
});

/* ×¤×ª×™×—×ª ×¤×× ×œ×™× */
const toggleBlock = (btn, block)=>{
  btn.classList.toggle('active');
  block.style.display = btn.classList.contains('active') ? 'grid' : 'none';
};
els.btnAllowances.addEventListener('click', ()=> toggleBlock(els.btnAllowances, els.allowanceFields));
els.btnAlimony.addEventListener('click', ()=> toggleBlock(els.btnAlimony, els.alimonyFields));

/* ×¤×¨×˜×™ ×“×•"×— */
els.reportBtn.addEventListener('click', ()=>{
  const show = els.reportPanel.style.display!=='grid';
  els.reportPanel.style.display = show ? 'grid':'none';
  if(show){
    els.reportDate.value = new Date().toLocaleDateString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit'});
  }
});

/* ×©×™× ×•×™ ×ª×•×•×™×•×ª ×œ×¤×™ ××™×Ÿ */
function updateLabels(){
  const debtorText = debtorGender==='×—×™×™×‘' ? '×—×™×™×‘' : '×—×™×™×‘×ª';
  const partnerText = debtorGender==='×—×™×™×‘' ? '×‘×ª ×–×•×’' : '×‘×Ÿ ×–×•×’';
  els.debtorLbl.textContent  = `××—×•×– ×”×›× ×¡×” (${debtorText})`;
  els.partnerLbl.textContent = `××—×•×– ×”×›× ×¡×” (${partnerText})`;
  els.debtorPayLbl.textContent = `×ª×©×œ×•× ××•×¦×¢ (${debtorText})`;
  els.partnerPayLbl.textContent = `×ª×©×œ×•× ××•×¦×¢ (${partnerText})`;
}

/* ×—×™×©×•×‘ */
function calculate(){
  const status = els.status.value;
  const sData = lookupData[status] || {kids:0,livingCost:0};
  const base = sData.livingCost;
  const kidsAllow = childAllowance[sData.kids] || 0;

  const dSal = parseFloat(els.salaryDebtor.value)||0;
  const pSal = parseFloat(els.salaryPartner.value)||0;
  const dOth = parseFloat(els.otherDebtor.value)||0;
  const pOth = parseFloat(els.otherPartner.value)||0;
  const dAll = parseFloat(els.debAllow.value)||0;
  const pAll = parseFloat(els.partAllow.value)||0;
  const unExp = parseFloat(els.unusual.value)||0;
  const childExp = parseFloat(els.childcare.value)||0;
  const ali = parseFloat(els.alimony.value)||0;

  els.resBase.textContent = fmtILS(base);
  els.resSS.textContent = fmtILS(kidsAllow);

  const totalIncome = dSal+pSal + dOth+pOth + dAll+pAll + kidsAllow;
  els.resTotalIncome.textContent = fmtILS(totalIncome);

  const totalExp = base + unExp + childExp + ali;
  els.resTotalExp.textContent = fmtILS(totalExp);

  const disp = totalIncome - totalExp;
  els.resDisp.textContent = disp<=0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmtILS(disp);

  const sumForRatio = dSal+dOth + pSal+pOth;
  const debRatio = sumForRatio>0 ? (dSal+dOth)/sumForRatio : 0;
  const parRatio = sumForRatio>0 ? (pSal+pOth)/sumForRatio : 0;

  els.resDebR.textContent = (debRatio*100).toFixed(1)+'%';
  els.resParR.textContent  = (parRatio*100).toFixed(1)+'%';

  const debPay = debRatio>0 ? round10((disp*debRatio)/2) : 0;
  const parPay = parRatio>0 ? round10((disp*parRatio)/2) : 0;
  els.resDebPay.textContent = fmtILS(Math.max(0,debPay));
  els.resParPay.textContent = fmtILS(Math.max(0,parPay));

  // ××©×¤×—×ª×™ ×›×©×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š:
  if(joint){
    const fam = round10( Math.max(0, ((disp/2) - parPay)) * debRatio + parPay );
    els.resFinal.textContent = fmtILS(fam);
  }

  // â€œ×ª×™×§ ××¤×¡â€: ×¨×§ ×§×¦×‘××•×ª > 0, ×œ×œ× ×”×›× ×¡×•×ª ×¢×‘×•×“×”/××—×¨×•×ª (×©×œ ×”×—×™×™×‘/×ª)
  const onlyAllowancesForDebtor =
    (dSal===0 && dOth===0) &&
    (dAll>0) &&
    (pSal===0 && pOth===0 && pAll>=0); // ×œ×‘×Ÿ/×‘×ª ×–×•×’ ××™×Ÿ ××©××¢×•×ª ×œ×ª× ××™ ×”×–×”, ×¨×§ ×©×œ× ×™×¤×¨×™×¢

  els.zeroCaseRow.style.display = (onlyAllowancesForDebtor && disp>=0) ? 'block':'none';
}

/* ×××–×™× ×™× ×œ×©×“×•×ª */
[
  'status','salaryDebtor','salaryPartner','otherIncomeDebtor','otherIncomePartner',
  'debtorAllowance','partnerAllowance','unusualExpenses','childcareExpenses','alimonyExpenses'
].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input',calculate);
});

/* ×˜×•×œ-×˜×™×¤×™× â€œ?â€ */
let openPop=null;
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('.info-btn');
  if(btn){
    e.stopPropagation();
    if(openPop) openPop.remove();
    const pop = document.createElement('div');
    pop.className='pop'; pop.innerHTML=(btn.dataset.info||'â€”').replace(/\n/g,'<br>');
    document.body.appendChild(pop);
    const r = btn.getBoundingClientRect();
    pop.style.top = (window.scrollY + r.bottom + 8) + 'px';
    pop.style.right = (window.innerWidth - r.right + 8) + 'px';
    openPop = pop; return;
  }
  if(openPop){ openPop.remove(); openPop=null; }
});

/* ×›×¤×ª×•×¨×™× */
function resetAll(){
  document.querySelectorAll('input[type="number"], input[type="text"], textarea').forEach(el=>el.value='');
  els.status.selectedIndex = 0;
  if(els.btnAllowances.classList.contains('active')) els.btnAllowances.click();
  if(els.btnAlimony.classList.contains('active')) els.btnAlimony.click();
  joint=false; els.jointBtn.classList.remove('active'); els.jointBtn.setAttribute('aria-pressed','false'); els.familyCard.style.display='none';
  setGender('×—×™×™×‘');
  calculate();
}
document.getElementById('btnReset').onclick = resetAll;
document.getElementById('btnReset_m').onclick = resetAll;

/* PDF (×”×“×¤×¡×” ×¨×’×™×œ×”) */
function printPDF(){ window.print(); }
document.getElementById('btnPdf').onclick = printPDF;
document.getElementById('btnPdf_m').onclick = printPDF;

/* ×¦×™×œ×•× (PNG) */
async function doShot(){
  try{
    const node = document.getElementById('captureRoot');
    const canvas = await html2canvas(node,{useCORS:true, allowTaint:true, scale:2, backgroundColor:'#ffffff'});
    const data = canvas.toDataURL('image/png');
    const w = window.open('');
    w.document.write(`<img src="${data}" style="max-width:100%;display:block;margin:0 auto">`);
    w.document.title = '×¦×™×œ×•× ××¡×š ×”××—×©×‘×•×Ÿ';
    // ×œ× ××¤×¢×™×œ ×”×“×¤×¡×” ××•×˜×•', ×›×“×™ ×©×ª×•×›×œ ×œ×‘×—×•×¨ ×™×“× ×™×ª ×× ×œ×”×“×¤×™×¡/×œ×©××•×¨
  }catch(e){ alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¦×™×œ×•× ×”××¡×š'); }
}
document.getElementById('btnShot').onclick = doShot;
document.getElementById('btnShot_m').onclick = doShot;

/* ×©×œ×™×—×ª ××™×™×œ â€“ ×¤×•×ª×— mailto ×¢× ×ª×§×¦×™×¨ (×§×•×‘×¥ ××¦×¨×¤×™× ×™×“× ×™×ª) */
function getTxt(id){ return (document.getElementById(id)?.textContent||'').trim(); }
function composeMail(){
  const subject = '×ª×•×¦××•×ª ××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×';
  const body = [
    '×©×œ×•×,',
    '',
    '××¦×•×¨×£ ×ª×§×¦×™×¨. ×œ×¦×™×¨×•×£ ×§×•×‘×¥ PNG/â€PDF ×™×© ×œ×©××•×¨ ×•×œ×”×•×¡×™×£ ×™×“× ×™×ª.',
    '',
    `×¡×š ×”×›× ×¡×•×ª: ${getTxt('totalIncomeResult')}`,
    `×¡×š ×”×•×¦××•×ª: ${getTxt('totalExpensesResult')}`,
    `×”×›× ×¡×” ×¤× ×•×™×”: ${getTxt('disposableIncomeResult')}`,
    `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${getTxt('debtorIncomeRatio')}`,
    `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerIncomeRatio')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${getTxt('debtorPaymentResult')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerPaymentResult')}`,
    joint ? `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${getTxt('finalPaymentResult')}` : '',
    '',
    '×‘×‘×¨×›×”'
  ].filter(Boolean).join('\n');
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
document.getElementById('btnMail').onclick = composeMail;
document.getElementById('btnMail_m').onclick = composeMail;

/* ××ª×—×•×œ */
setGender('×—×™×™×‘');
calculate();
</script>
</body>
</html>
