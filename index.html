<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#005f73; --secondary:#0a9396; --bg:#f4f6f8; --panel:#ffffff;
  --text:#23323a; --muted:#667b8a; --border:#d9e0e6; --accent:#ee9b00;
  --danger:#ae2012; --blue:#1063ff; --soft:#e9f5f5;
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); font-family:'Heebo',sans-serif; color:var(--text); display:flex; justify-content:center; padding:20px}
#captureRoot{width:100%; max-width:1100px}
.calculator{
  background:var(--panel); border-radius:12px; overflow:hidden;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  display:grid; grid-template-columns:1fr 1fr;
}
header{
  grid-column:1/-1; background:var(--primary); color:#fff; padding:16px 18px; position:relative
}
.h-title{margin:0; text-align:center; font-size:1.8rem; font-weight:800}
.badge{position:absolute; inset-inline-start:18px; inset-block-start:18px; font-size:.9rem; background:rgba(255,255,255,.12); padding:.25rem .6rem; border-radius:999px}

.col{padding:22px}
.col.inputs{border-inline-start:1px solid var(--border)}
.col.results{background:var(--soft); position:relative}

h2.sec{margin:0 0 14px; color:var(--primary); font-size:1.2rem; padding-bottom:6px; border-bottom:2px solid var(--secondary)}
.group{display:grid; gap:12px}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

/* Inputs â€“ stronger visual */
.input{display:flex; flex-direction:column; gap:6px}
.input label{font-weight:600; color:#415563}
.input input,.input select,.input textarea{
  width:100%; padding:11px 12px; border:1.2px solid #cdd7df; border-radius:10px;
  background:linear-gradient(#fff,#fff) padding-box, linear-gradient(135deg,#f4f8fb,#eef3f8) border-box;
  font-size:1rem;
}
.input textarea{min-height:78px; resize:vertical}
.input input:focus,.input select:focus,.input textarea:focus{outline:none; border-color:var(--secondary); box-shadow:0 0 0 3px rgba(10,147,150,.18)}

/* Pills who-in-proceeding */
.pills{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.pill{border:1px solid #d5dde4; background:#f7f9fb; padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:600}
.pill.active{background:var(--secondary); border-color:var(--secondary); color:#fff}
.pill.alert.active{background:#cc3c2f; border-color:#cc3c2f}

/* Results style */
.kv{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #dbe7ea}
.kv:last-child{border-bottom:none}
.kv .k{font-weight:700; color:#2a3b47}
.kv .v{font-weight:800; color:var(--accent)}
.center{text-align:center}
.big{font-size:1.6rem; color:var(--blue); font-weight:900}

/* Desktop actions */
.actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:16px}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #cbd5e1;
  background:#fff; border-radius:10px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.05); font-weight:700
}
.btn:hover{background:#f7fafc}
.btn .ico{font-size:1.05rem}
.btn.reset{border-color:#ffced1; box-shadow:0 3px 10px rgba(172, 27, 27,.07)}
.btn.reset .ico{filter:saturate(1.2)}

/* collapsibles */
.toggle{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#f6f8fb; border:1px solid #dee5eb; border-radius:10px; cursor:pointer}
.fold{display:none}

/* info tip */
.info{width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#eef6f6;border:1px solid #e1ecec;color:#006d77;cursor:pointer;font-weight:800}
.pop{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px 14px;line-height:1.45}

/* FAB mobile only */
.fab-wrap{display:none}
@media (max-width:768px){
  .calculator{grid-template-columns:1fr}
  .col.inputs{order:2; border-inline-start:none}
  .col.results{order:1; padding-bottom:110px} /* ×©×œ× ×™×•×¡×ª×¨ ×¢×´×™ FAB */
  .grid2{grid-template-columns:1fr}
  .actions{display:none} /* ×‘×“×¡×§×˜×•×¤ ×‘×œ×‘×“ */
  .fab-wrap{
    position:sticky; inset-block-end:0; display:flex; justify-content:center; padding:8px;
    background:linear-gradient(to top, rgba(255,255,255,.96), rgba(255,255,255,.6));
    z-index:30;
  }
  .fab{display:flex; gap:8px; background:#fff; border:1px solid #dfe5ec; padding:8px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .fab .btn{padding:8px 10px}
}

/* print page for the generated PNG(s) */
@media print{ body{padding:0; background:#fff} .fab-wrap{display:none!important} }

.zero-case{color:#b00020;background:#ffe6ea;border:1px solid #ffc2cd;padding:4px 10px;border-radius:10px;font-weight:900}
.hidden{display:none!important}
</style>
</head>
<body>
<div id="captureRoot">
  <div class="calculator" id="calc">

    <header>
      <h1 class="h-title">××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
      <span class="badge">××¢×•×“×›×Ÿ ×œ-<span id="year"></span></span>
    </header>

    <!-- ×ª×•×¦××•×ª â€“ ××©×××œ -->
    <div class="col results" id="sectionResults">
      <h2 class="sec center">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

      <div class="kv"><div class="k">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div><div class="v" id="childAllowance">0 â‚ª</div></div>
      <div class="kv"><div class="k">×¡×š ×”×›× ×¡×•×ª</div><div class="v" id="totalIncome">0 â‚ª</div></div>
      <div class="kv"><div class="k">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div><div class="v" id="livingCost">0 â‚ª</div></div>
      <div class="kv"><div class="k">×¡×š ×”×•×¦××•×ª</div><div class="v" id="totalExpenses">0 â‚ª</div></div>

      <div class="center" style="padding:12px 0; scroll-margin-bottom:120px">
        <div>×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™:</div>
        <div id="disposable" class="big">0 â‚ª</div>
      </div>

      <div class="kv"><div class="k" id="debtorRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª)</div><div class="v" id="debtorRatio">0%</div></div>
      <div class="kv"><div class="k" id="partnerRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerRatio">0%</div></div>

      <div class="kv"><div class="k" id="debtorPayLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</div><div class="v" id="debtorPay">0 â‚ª</div></div>
      <div class="kv"><div class="k" id="partnerPayLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerPay">0 â‚ª</div></div>

      <div class="center" style="margin-top:10px">
        <div style="margin-bottom:4px">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:</div>
        <div class="big" id="finalPay">0 â‚ª</div>
        <div id="zeroCaseTag" class="zero-case hidden" style="margin-top:6px">×ª×™×§ ××¤×¡</div>
      </div>

      <!-- ×©×•×¨×ª ×›×¤×ª×•×¨×™× â€“ ×¡×“×¨ ×—×“×© -->
      <div class="actions" id="deskActions">
        <button class="btn" id="btnReport"><span class="ico">ğŸ—‚ï¸</span> ×¤×¨×˜×™ ×“×•×´×—</button>
        <button class="btn" id="btnShot"><span class="ico">ğŸ–¨ï¸</span> ×¦×™×œ×•×/×”×“×¤×¡</button>
        <button class="btn" id="btnMail"><span class="ico">âœ‰ï¸</span> ×©×œ×™×—×ª ××™×™×œ</button>
        <button class="btn reset" id="btnReset"><span class="ico">â†º</span> ××™×¤×•×¡</button>
      </div>

      <!-- ×¤×¨×˜×™ ×“×•"×— + ×”×¢×¨×” × ×—×©×¤×™× ×¨×§ ×‘×œ×—×™×¦×” -->
      <div id="reportPanel" class="fold" style="margin-top:10px">
        <div class="grid2">
          <div class="input"><label for="caseId">××¡' ×ª×™×§</label><input id="caseId" placeholder="12345/25"></div>
          <div class="input"><label for="authorName">×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label><input id="authorName" placeholder="×©× ××œ×"></div>
        </div>
        <div class="row" style="margin-top:10px; align-items:flex-end">
          <div class="input" style="max-width:220px"><label for="calcDate">×ª××¨×™×š</label><input id="calcDate" readonly></div>
          <button class="btn" id="btnNote"><span class="ico">ğŸ“</span> ×”×¢×¨×”</button>
        </div>
        <div id="notePanel" class="fold" style="margin-top:8px">
          <div class="input"><label for="calcNotes">×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</label><textarea id="calcNotes" maxlength="500" placeholder="×”×¢×¨×” ×§×¦×¨×”..."></textarea></div>
          <div class="row" style="justify-content:flex-end; color:var(--muted); font-size:.9rem"><span id="notesCount">0</span>/500</div>
        </div>
      </div>
    </div>

    <!-- ×§×œ×˜×™× â€“ ×œ×™××™×Ÿ -->
    <div class="col inputs" id="sectionInputs">
      <h2 class="sec">×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>

      <!-- ×¡×˜×˜×•×¡ + ××™ ×‘×”×œ×™×š ×‘××•×ª×” ×©×•×¨×” -->
      <div class="grid2">
        <div class="input">
          <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
          <select id="status">
            <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡ ××©×¤×—×ª×™â€¦</option>
            <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
            <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
            <option value="×–×•×’">×–×•×’</option>
            <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
            <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
          </select>
        </div>
        <div class="input">
          <label>××™ ×‘×”×œ×™×š?</label>
          <div class="pills" id="whoRow">
            <div class="pill active" data-role="male" id="pillMale">×—×™×™×‘</div>
            <div class="pill" data-role="female" id="pillFemale">×—×™×™×‘×ª</div>
            <div class="pill alert" data-role="joint" id="pillJoint">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š</div>
          </div>
        </div>
      </div>

      <h2 class="sec">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</h2>

      <div class="grid2">
        <div class="input" id="salaryDebtorWrap">
          <label><span id="salaryDebtorLabel">×”×›× ×¡×” (×—×™×™×‘)</span>
            <span class="info" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨<br>×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×Ö¾3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤×´×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª">?</span>
          </label>
          <input id="salaryDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
        </div>
        <div class="input" id="salaryPartnerWrap">
          <label><span id="salaryPartnerLabel">×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</span>
            <span class="info" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨<br>×‘××§×¨×” ×©×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª ×™×™×§×‘×¢ ×ª×©×œ×•× ××“×•×¨×’ ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª">?</span>
          </label>
          <input id="salaryPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
        </div>
      </div>

      <div class="grid2">
        <div class="input"><label id="otherDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label><input id="otherDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª"></div>
        <div class="input" id="otherPartnerWrap"><label id="otherPartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)</label><input id="otherPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª"></div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="toggle" id="btnAllow">×”×›× ×¡×•×ª ××§×¦×‘××•×ª</button>
        <button class="toggle" id="btnAlimony">×”×•×¦××•×ª ××–×•× ×•×ª</button>
      </div>

      <div class="fold" id="allowFold" style="margin-top:6px">
        <div class="grid2">
          <div class="input"><label id="debtorAllowLabel">×§×¦×‘×” (×—×™×™×‘/×ª)</label><input id="allowDebtor" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”"></div>
          <div class="input" id="allowPartnerWrap"><label id="partnerAllowLabel">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label><input id="allowPartner" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”"></div>
        </div>
      </div>

      <div class="fold" id="alimonyFold" style="margin-top:6px">
        <div class="grid2">
          <div class="input"><label>×”×•×¦××•×ª ××–×•× ×•×ª</label><input id="alimony" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª"></div>
        </div>
      </div>

      <div class="grid2" style="margin-top:6px">
        <div class="input"><label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label><input id="unusual" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª"></div>
        <div class="input"><label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label><input id="childcare" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª"></div>
      </div>
    </div>
  </div>

  <!-- FAB mobile -->
  <div class="fab-wrap">
    <div class="fab">
      <button class="btn" id="btnShotFab"><span class="ico">ğŸ–¨ï¸</span> ×¦×™×œ×•×/×”×“×¤×¡</button>
      <button class="btn" id="btnMailFab"><span class="ico">âœ‰ï¸</span> ××™×™×œ</button>
      <button class="btn reset" id="btnResetFab"><span class="ico">â†º</span> ××™×¤×•×¡</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(+n||0);
const rd10 = n => Math.max(0, Math.floor((+n||0)/10)*10);
$('year').textContent = new Date().getFullYear();
$('calcDate') && ($('calcDate').value = new Date().toLocaleDateString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit'}));

/* ===== Tables ===== */
const living = {"×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":4556,"×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":6056,"×–×•×’":6024,"×–×•×’+×™×œ×“":7524,"×–×•×’+ 2 ×™×œ×“×™×":9024,"×–×•×’+ 3 ×™×œ×“×™×":10524,"×–×•×’+ 4 ×™×œ×“×™×":12024,"×–×•×’+ 5 ×™×œ×“×™×":13324,"×–×•×’+ 6 ×™×œ×“×™×":14624,"×–×•×’+ 7 ×™×œ×“×™×":15924,"×–×•×’+ 8 ×™×œ×“×™×":17224,"×–×•×’+ 9 ×™×œ×“×™×":18524,"×–×•×’+ 10 ×™×œ×“×™×":19824};
const childAll = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

/* ===== Who is in proceeding ===== */
let isMale = true, isJoint = false;
$('pillMale').onclick   = ()=>{isMale=true;  $('pillMale').classList.add('active'); $('pillFemale').classList.remove('active'); calc(); updateLabels();}
$('pillFemale').onclick = ()=>{isMale=false; $('pillFemale').classList.add('active'); $('pillMale').classList.remove('active'); calc(); updateLabels();}
$('pillJoint').onclick  = ()=>{isJoint=!isJoint; $('pillJoint').classList.toggle('active', isJoint); calc(); updateLabels();}

/* ===== Collapsibles ===== */
$('btnAllow').onclick  = ()=>toggle('allowFold');
$('btnAlimony').onclick= ()=>toggle('alimonyFold');
function toggle(id){ const e=$(id); e.style.display = (e.style.display==='block')?'none':'block'; }

/* ===== Tips "?" ===== */
let pop, popBtn;
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('.info');
  if(btn){
    e.stopPropagation();
    if(pop && popBtn===btn){ pop.remove(); pop=null; return; }
    if(pop) pop.remove();
    popBtn=btn; pop=document.createElement('div'); pop.className='pop'; pop.innerHTML=btn.dataset.info; document.body.appendChild(pop);
    const r = btn.getBoundingClientRect(); pop.style.top=(window.scrollY+r.bottom+8)+'px'; pop.style.right=(window.innerWidth-r.right+8)+'px';
  } else if(pop){ pop.remove(); pop=null; }
});

/* ===== Labels update ===== */
function updateLabels(){
  const st = $('status').value||'';
  const single = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
  // show/hide partner fields
  ['salaryPartnerWrap','otherPartnerWrap','allowPartnerWrap'].forEach(id=> { const el=$(id); if(el) el.style.display = single ? 'none':'block'; });
  const debtor = single ? '×—×™×™×‘/×ª' : (isMale?'×—×™×™×‘':'×—×™×™×‘×ª');
  const partner= single ? '×‘×Ÿ/×‘×ª ×–×•×’' : (isMale?'×‘×ª ×–×•×’':'×‘×Ÿ ×–×•×’');
  $('salaryDebtorLabel').textContent=`×”×›× ×¡×” (${debtor})`;
  $('salaryPartnerLabel').textContent=`×”×›× ×¡×” (${partner})`;
  $('otherDebtorLabel').textContent =`×”×›× ×¡×•×ª ××—×¨×•×ª (${debtor})`;
  $('otherPartnerLabel').textContent=`×”×›× ×¡×•×ª ××—×¨×•×ª (${partner})`;
  $('debtorAllowLabel').textContent =`×§×¦×‘×” (${debtor})`;
  $('partnerAllowLabel').textContent=`×§×¦×‘×” (${partner})`;
  $('debtorRatioLabel').textContent =`××—×•×– ×”×›× ×¡×” (${debtor})`;
  $('partnerRatioLabel').textContent=`××—×•×– ×”×›× ×¡×” (${partner})`;
  $('debtorPayLabel').textContent   =`×ª×©×œ×•× ××•×¦×¢ (${debtor})`;
  $('partnerPayLabel').textContent  =`×ª×©×œ×•× ××•×¦×¢ (${partner})`;
}

/* ===== Calc ===== */
['status','salaryDebtor','salaryPartner','otherDebtor','otherPartner','allowDebtor','allowPartner','unusual','childcare','alimony']
.forEach(id=> $(id).addEventListener('input', ()=>{updateLabels(); calc()}));
updateLabels();

function calc(){
  const st = $('status').value||'';
  const kids = (st.match(/\d+/)?.[0]) || (st.includes('×™×œ×“')?1:0);
  const base = living[st] || 0;
  const child = childAll[kids] || 0;

  const SD=+$('salaryDebtor').value||0, SP=+$('salaryPartner').value||0;
  const OD=+$('otherDebtor').value||0, OP=+$('otherPartner').value||0;
  const AD=+$('allowDebtor').value||0, AP=+$('allowPartner').value||0;
  const UN=+$('unusual').value||0, CH=+$('childcare').value||0, AL=+$('alimony').value||0;

  $('childAllowance').textContent = fmt(child);
  $('livingCost').textContent     = fmt(base);

  const incomes = SD+SP+OD+OP+AD+AP+child;
  const expenses= base+UN+CH+AL;
  $('totalIncome').textContent  = fmt(incomes);
  $('totalExpenses').textContent= fmt(expenses);

  const disp = incomes-expenses;
  $('disposable').textContent = disp<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmt(disp);

  const forRatio = (SD+OD+SP+OP)||0;
  const rD = forRatio>0 ? (SD+OD)/forRatio : 0;
  const rP = forRatio>0 ? (SP+OP)/forRatio : 0;
  $('debtorRatio').textContent  = (rD*100).toFixed(1)+'%';
  $('partnerRatio').textContent = (rP*100).toFixed(1)+'%';

  const dPay = rD>0 ? rd10((disp*rD)/2) : 0;
  const pPay = rP>0 ? rd10((disp*rP)/2) : 0;
  $('debtorPay').textContent  = fmt(dPay);
  $('partnerPay').textContent = fmt(pPay);

  // zero-case only allowances and debtor part is zero
  const onlyAllow = (SD+SP+OD+OP)===0 && (AD+AP)>0;
  const zeroCase  = onlyAllow && (SD+OD===0);
  $('zeroCaseTag').classList.toggle('hidden', !zeroCase);

  const single = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
  let final=0;
  if (single || !isJoint){ final = dPay; }
  else {
    const baseHalf = disp/2;
    const afterSub = Math.max(0, baseHalf - pPay);
    final = rd10(afterSub * rD + pPay);
  }
  $('finalPay').textContent = (final===0 && zeroCase) ? '×ª×™×§ ××¤×¡' : fmt(final);
}
calc();

/* ===== Report + note panels ===== */
$('btnReport').onclick = ()=>{ const p=$('reportPanel'); p.style.display=(p.style.display==='block')?'none':'block'; }
$('btnNote').onclick    = ()=>{ const n=$('notePanel');   n.style.display=(n.style.display==='block')?'none':'block'; }
$('calcNotes') && $('calcNotes').addEventListener('input',()=> $('notesCount').textContent=$('calcNotes').value.length);

/* ===== Screenshot / Print (desktop: 1 page, mobile: 2 pages) ===== */
async function grabCanvas(el, scale){
  return await html2canvas(el,{scale, useCORS:true, windowWidth:el.scrollWidth, windowHeight:el.scrollHeight});
}
async function shoot(){
  const isMobile = window.innerWidth<=768;
  const fab  = document.querySelector('.fab-wrap'); if(fab) fab.style.visibility='hidden';

  if(!isMobile){
    const canvas = await grabCanvas(document.getElementById('captureRoot'), 1.25);
    openPrint([canvas]);
  }else{
    const c1 = await grabCanvas(document.getElementById('sectionInputs'), 1.25);
    const c2 = await grabCanvas(document.getElementById('sectionResults'), 1.25);
    openPrint([c1,c2]); // ×©× ×™ ×¢××•×“×™×: ×§×œ×˜ ×•××– ×ª×•×¦××•×ª
  }
  if(fab) fab.style.visibility='';
}
function openPrint(canvasArr){
  // ×©××™×¨×” ×¢×œ ×™×—×¡; ×”×ª×××” ×œ×¢××•×“ A4 ××—×“ ×œ×›×œ ×§× ×‘×¡
  const MAX_W=1050, MAX_H=1450;
  const pages = canvasArr.map(c=>{
    const k=Math.min(1, MAX_W/c.width, MAX_H/c.height);
    const w=Math.round(c.width*k), h=Math.round(c.height*k);
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    out.getContext('2d').drawImage(c,0,0,w,h);
    return out.toDataURL('image/png');
  });
  const w=window.open('','_blank');
  w.document.write(`<html><head><meta charset="utf-8"><title>×¦×™×œ×•× ××¡×š</title>
  <style>
    @page{size:A4 portrait; margin:0}
    html,body{margin:0;background:#fff}
    .pg{height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;page-break-after:always}
    img{max-width:100vw;max-height:100vh;object-fit:contain}
  </style></head><body></body></html>`);
  pages.forEach((src,i)=>{ const div=w.document.createElement('div'); div.className='pg'; div.innerHTML=`<img src="${src}">`; w.document.body.appendChild(div); });
  w.document.close(); w.focus(); setTimeout(()=>w.print(),250);
}

/* ===== Mail ===== */
function sendMail(){
  alert('×˜×™×¤: ×œ××—×¨ ×”×¦×™×œ×•×/×”×“×¤×¡×” ×©××¨×• ××ª ×”-PNG ×•×¦×¨×¤×• ××•×ª×• ×™×“× ×™×ª ×œ××™×™×œ.');
  const t = id => ($(id)?.textContent||'').trim();
  const subject = `××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ${( $('caseId')?.value || '×œ×œ× ××¡×¤×¨ ×ª×™×§')}`;
  const body = [
    '×©×œ×•×,','',
    '××¦×•×¨×£ ×¦×™×œ×•×/PNG ×©×œ ×ª×•×¦××•×ª ×”×—×™×©×•×‘ (× × ×œ×¦×¨×£ ×™×“× ×™×ª).','',
    `×ª×™×§: ${$('caseId')?.value||'-'}`,`×¢×•×¨×š/×ª: ${$('authorName')?.value||'-'}`,`×ª××¨×™×š: ${$('calcDate')?.value||'-'}`,$('calcNotes')?.value?`×”×¢×¨×”: ${$('calcNotes').value}`:'',
    '','×ª×§×¦×™×¨ ×ª×•×¦××•×ª:',
    `×¡×š ×”×›× ×¡×•×ª: ${t('totalIncome')}`,`×¡×š ×”×•×¦××•×ª: ${t('totalExpenses')}`,`×”×›× ×¡×” ×¤× ×•×™×”: ${t('disposable')}`,
    `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${t('debtorRatio')}`,`××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${t('partnerRatio')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${t('debtorPay')}`,`×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${t('partnerPay')}`,
    `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${t('finalPay')}`
  ].filter(Boolean).join('\n');
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

/* ===== Reset ===== */
function resetAll(){
  ['salaryDebtor','salaryPartner','otherDebtor','otherPartner','allowDebtor','allowPartner','unusual','childcare','alimony']
    .forEach(id=> $(id).value='');
  $('status').value='';
  ['allowFold','alimonyFold','reportPanel','notePanel'].forEach(id=> $(id).style.display='none');
  if($('calcNotes')) $('calcNotes').value='';
  if($('notesCount')) $('notesCount').textContent='0';
  isMale=true; isJoint=false;
  $('pillMale').classList.add('active'); $('pillFemale').classList.remove('active'); $('pillJoint').classList.remove('active');
  updateLabels(); calc();
}

/* ===== bind buttons ===== */
['btnShot','btnShotFab'].forEach(id=> $(id).onclick = shoot);
['btnMail','btnMailFab'].forEach(id=> $(id).onclick = sendMail);
['btnReset','btnResetFab'].forEach(id=> $(id).onclick = resetAll);
</script>
</body>
</html>
