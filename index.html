<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#005f73;--secondary:#0a9396;--bg:#f4f4f4;--card:#fff;--text:#333;--label:#555;--border:#ddd;
      --accent:#ee9b00;--resultbg:#e9f5f5;--danger:#ae2012;--blue:#007bff;--muted:#6c757d;--hint:#fff7d6
    }
    body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0}
    .calculator-container{width:100%;max-width:1100px;margin:0 auto;background:var(--card);box-shadow:0 4px 15px rgba(0,0,0,.1);display:grid;grid-template-columns:1fr 1fr;gap:0}
    header{grid-column:1/-1;background:var(--primary);color:#fff;padding:18px 24px;display:flex;align-items:center;gap:10px}
    header h1{margin:0;font-size:1.8rem}
    header .version{font-size:.95rem;font-weight:500;opacity:.9;margin-right:8px}
    .inputs-column{padding:24px;border-left:1px solid var(--border)}
    .results-column{padding:24px;background:var(--resultbg)}
    .form-section{display:grid;gap:18px}
    .form-section h2{grid-column:1/-1;margin:2px 0 8px;color:var(--primary);border-bottom:2px solid var(--secondary);padding-bottom:8px;font-size:1.2rem}
    .input-group{display:flex;flex-direction:column;gap:8px}
    .input-group.inline{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .input-group label{color:var(--label);font-weight:500}
    input,select{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:1rem;transition:.2s}
    input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(10,147,150,.18)}
    .radio-wrap{display:flex;gap:10px}
    .chip{background:#f0f0f0;border:1px solid #ccc;padding:8px 14px;border-radius:20px;cursor:pointer;transition:.2s}
    .chip.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .chip.danger.active{background:var(--danger);border-color:var(--danger)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    /* ×–×•×’ ×©×“×•×ª: ×—×™×™×‘/×ª ××™××™×Ÿ, ×‘×Ÿ/×‘×ª ×–×•×’ ××©×××œ */
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .pair .debtor{grid-column:2}
    .pair .partner{grid-column:1}
    /* ×ª×•×¦××•×ª */
    .results-section h2{margin:0 0 14px;text-align:center}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #d4e7e7}
    .row:last-child{border-bottom:none}
    .row.side{display:grid;grid-template-columns:1fr 1fr;gap:18px;text-align:center}
    .row .label{font-weight:500}
    .row .value{font-weight:700;color:var(--accent)}
    .row .value.big{color:var(--blue);font-size:1.4rem}
    .row.total .value{color:var(--danger);font-size:1.4rem}
    /* ×¢×–×¨×” "?" */
    .help-wrap{position:relative;display:flex;align-items:center;gap:8px}
    .help-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--secondary);color:var(--secondary);font-size:.85rem;cursor:pointer}
    .help-bubble{position:absolute;top:28px;inset-inline-start:0;z-index:5;background:var(--hint);border:1px solid #ffe08a;color:#7a5d00;padding:10px 12px;border-radius:10px;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,.08);display:none}
    .help-wrap.open .help-bubble{display:block}
    /* ××–×•×¨ ×¤×¢×•×œ×•×ª ×•×‘×œ×•×§×™× ××ª×§×¤×œ×™× */
    .actions{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .icon-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #cfd8dc;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .icon-btn:hover{background:#f7f7f7}
    .muted{color:var(--muted);font-size:.9rem}
    .tip{display:none;background:var(--hint);border:1px solid #ffe08a;color:#7a5d00;padding:10px 12px;border-radius:10px;margin:10px 0}
    .collapsible{margin:10px 0}
    .collapsible .hdr{display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600}
    .collapsible .panel{display:none;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px}
    .collapsible.open .panel{display:block}
    .note-text{width:100%;min-height:70px;resize:vertical}
    .char-counter{font-size:.85rem;color:var(--muted);text-align:start;margin-top:6px}
    /* ×”×ª×¨××ª ×©×›×¨ ××™× ×™××•× */
    #special-note{background:#fff7d6;border:1px solid #ffe08a;color:#7a5d00;padding:12px;border-radius:10px;margin-top:16px;display:none}
    /* ×”×“×¤×¡×” */
    .print-only{display:none}
    .no-print{}
    @media print{
      .no-print{display:none !important}
      .print-only{display:block !important}
      body{background:#fff}
      .results-column{background:#fff}
      .calculator-container{box-shadow:none}
    }
    @media (max-width:820px){
      .calculator-container{grid-template-columns:1fr}
      .inputs-column{border-left:none}
      .pair{grid-template-columns:1fr}
      .pair .debtor,.pair .partner{grid-column:auto}
    }
  </style>
</head>
<body>

  <div class="calculator-container">
    <header>
      <span class="version" id="versionTag"></span>
      <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
    </header>

    <!-- ×¢××•×“×” ×©×××œ×™×ª â€“ ×ª×•×¦××•×ª + ×¤×¢×•×œ×•×ª -->
    <div class="results-column">
      <!-- ×¤×¢×•×œ×•×ª + ×‘×œ×•×§×™× ××ª×§×¤×œ×™× -->
      <div class="actions no-print">
        <button id="printBtn" class="icon-btn" type="button">ğŸ–¨ï¸ PDF</button>
        <button id="mailBtn" class="icon-btn" type="button">âœ‰ï¸ ×©×œ×— ××™×™×œ</button>
        <button id="toggleReportBtn" class="icon-btn" type="button">ğŸ“„ ×¤×¨×˜×™ ×”×“×•"×—</button>
        <button id="toggleNoteBtn" class="icon-btn" type="button">ğŸ“ ×”×¢×¨×”</button>
      </div>

      <!-- ×˜×™×¤ ××™×™×œ (××•×¤×™×¢ ×¨×§ ××—×¨×™ ×œ×—×™×¦×”) -->
      <div id="emailTip" class="tip no-print">
        ×˜×™×¤: ×“×¤×“×¤× ×™× ×œ× ×××¤×©×¨×™× ×œ×¦×¨×£ PDF ××•×˜×•××˜×™×ª ×œ××™×™×œ. ××•××œ×¥ ×œ×”×“×¤×™×¡ ×§×•×“× ×œ-PDF ×•××– ×œ×¦×¨×£ ×™×“× ×™×ª ×œ××™×™×œ.
      </div>

      <!-- ×¤×¨×˜×™ ×”×“×•"×— â€“ ××ª×§×¤×œ -->
      <div id="reportBlock" class="collapsible no-print">
        <div class="hdr">ğŸ“„ ×¤×¨×˜×™ ×”×“×•"×—</div>
        <div class="panel">
          <div class="grid-2">
            <div class="input-group">
              <label>××¡â€™ ×ª×™×§</label>
              <input id="caseId" placeholder="×œ×“×•×’××”: 12345/25">
            </div>
            <div class="input-group">
              <label>×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label>
              <input id="preparer" placeholder="×©× ××œ×">
            </div>
          </div>
          <div class="input-group" style="max-width:220px">
            <label>×ª××¨×™×š</label>
            <input id="reportDate" readonly>
          </div>
        </div>
      </div>

      <!-- ×”×¢×¨×” â€“ ××ª×§×¤×œ -->
      <div id="noteBlock" class="collapsible no-print">
        <div class="hdr">ğŸ“ ×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</div>
        <div class="panel">
          <textarea id="noteText" class="note-text" maxlength="500" placeholder="× ×™×ª×Ÿ ×œ×¨×©×•× ×›××Ÿ ×”×‘×—× ×•×ª/×”×‘×”×¨×•×ª ×•×›×•â€™â€¦"></textarea>
          <div class="char-counter"><span id="noteCount">0</span>/500</div>
        </div>
      </div>

      <!-- ×ª×§×¦×™×¨ ×œ×”×“×¤×¡×”/×™×™×¦×•× â€“ × ×‘× ×” ×“×™× ××™×ª ×•××•×¦×’ ×¨×§ ×‘×”×“×¤×¡×” -->
      <div id="exportSummary" class="print-only"></div>

      <!-- ×ª×•×¦××•×ª -->
      <section class="results-section">
        <h2>×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

        <div class="row side">
          <div>
            <div class="label">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™:</div>
            <div class="value" id="socialSecurityAllowance">â‚ª 0</div>
          </div>
          <div>
            <div class="label">×¡×š ×”×›× ×¡×•×ª:</div>
            <div class="value" id="totalIncomeResult">â‚ª 0</div>
          </div>
        </div>

        <div class="row side">
          <div>
            <div class="label" id="livingCostLabel">×“××™ ××—×™×™×” ×‘×›×‘×•×“:</div>
            <div class="value" id="baseLivingCostResult">â‚ª 0</div>
          </div>
          <div>
            <div class="label">×¡×š ×”×•×¦××•×ª:</div>
            <div class="value" id="totalExpensesResult">â‚ª 0</div>
          </div>
        </div>

        <div class="row" style="display:block;text-align:center">
          <div class="label">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™:</div>
          <div class="value big" id="disposableIncomeResult">â‚ª 0</div>
        </div>

        <div class="row side">
          <div>
            <div class="label" id="debtorIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘):</div>
            <div class="value" id="debtorIncomeRatio">0%</div>
          </div>
          <div>
            <div class="label" id="partnerIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×ª ×–×•×’):</div>
            <div class="value" id="partnerIncomeRatio">0%</div>
          </div>
        </div>

        <div class="row side" id="proposedPaymentsDisplay">
          <div>
            <div class="label" id="debtorPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘):</div>
            <div class="value" id="debtorPaymentResult">â‚ª 0</div>
          </div>
          <div>
            <div class="label" id="partnerPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×ª ×–×•×’):</div>
            <div class="value" id="partnerPaymentResult">â‚ª 0</div>
          </div>
        </div>

        <div class="row total" id="finalPaymentDisplay">
          <div class="label">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:</div>
          <div class="value" id="finalPaymentResult">â‚ª 0</div>
        </div>
      </section>

      <!-- ×”×ª×¨××ª ×©×›×¨ ××™× ×™××•× -->
      <div id="special-note">
        <strong>×”×¢×¨×”:</strong> ×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×-3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤"×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 ×©"×—.
      </div>
    </div>

    <!-- ×¢××•×“×” ×™×× ×™×ª â€“ ×§×œ×˜×™× -->
    <div class="inputs-column">
      <form id="calculatorForm">
        <section class="form-section">
          <h2>×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>
          <div class="grid-2">
            <div class="input-group">
              <label class="muted">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
              <select id="status">
                <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡â€¦</option>
                <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
                <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
                <option value="×–×•×’">×–×•×’</option>
                <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
                <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
                <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
              </select>
            </div>

            <div class="input-group">
              <label class="muted">××™ ×‘×”×œ×™×š?</label>
              <div class="radio-wrap">
                <label class="chip" id="chip-m">×—×™×™×‘<input type="radio" name="debtor-gender" id="debtor-male" style="display:none" checked></label>
                <label class="chip" id="chip-f">×—×™×™×‘×ª<input type="radio" name="debtor-gender" id="debtor-female" style="display:none"></label>
                <label class="chip danger" id="chip-both">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?<input type="checkbox" id="jointProceeding" style="display:none"></label>
              </div>
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2>(â‚ª) ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™</h2>

          <!-- ×”×›× ×¡×” -->
          <div class="pair">
            <div class="input-group partner" id="salaryPartnerGroup">
              <label class="help-wrap">
                <span id="salaryPartnerLabel">×”×›× ×¡×” (×‘×ª ×–×•×’)</span>
                <span class="help-icon" data-help="partner-salary">?</span>
                <span class="help-bubble">×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.<br>×‘××§×¨×” ×©×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª ×™×™×§×‘×¢ ×ª×©×œ×•× ××“×•×¨×’ ×œ×¤×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247 ×©"×—.</span>
              </label>
              <input type="number" id="salaryPartner" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
            </div>
            <div class="input-group debtor" id="salaryDebtorGroup">
              <label class="help-wrap">
                <span id="salaryDebtorLabel">×”×›× ×¡×” (×—×™×™×‘)</span>
                <span class="help-icon" data-help="debtor-salary">?</span>
                <span class="help-bubble">×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.<br>×œ×—×™×™×‘/×ª ×©×œ× ×¢×•×‘×“/×ª ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ××”×—×•×“×© ×”-3 ×œ×¤×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× 6,247 ×©"×—.</span>
              </label>
              <input type="number" id="salaryDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
            </div>
          </div>

          <!-- ×”×›× ×¡×•×ª ××—×¨×•×ª -->
          <div class="pair">
            <div class="input-group partner" id="otherIncomePartnerGroup">
              <label id="otherIncomePartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)</label>
              <input type="number" id="otherIncomePartner" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
            </div>
            <div class="input-group debtor" id="otherIncomeDebtorGroup">
              <label id="otherIncomeDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label>
              <input type="number" id="otherIncomeDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
            </div>
          </div>

          <!-- ×§×¦×‘××•×ª (××ª×§×¤×œ ×‘×œ×—×¦×Ÿ) -->
          <div class="input-group">
            <button type="button" id="allowanceButton" class="icon-btn">×”×›× ×¡×•×ª ××§×¦×‘××•×ª</button>
          </div>
          <div id="allowanceFields" style="display:none">
            <div class="pair">
              <div class="input-group partner" id="partnerAllowanceGroup">
                <label id="partnerAllowanceLabel">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
                <input type="number" id="partnerAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”">
              </div>
              <div class="input-group debtor">
                <label id="debtorAllowanceLabel">×§×¦×‘×” (×—×™×™×‘/×ª)</label>
                <input type="number" id="debtorAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”">
              </div>
            </div>
          </div>

          <hr>

          <div class="pair">
            <div class="input-group">
              <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•â€™)</label>
              <input type="number" id="unusualExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
            </div>
            <div class="input-group">
              <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
              <input type="number" id="childcareExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
            </div>
          </div>

          <div class="input-group">
            <button type="button" id="alimonyButton" class="icon-btn">×”×•×¦××•×ª ××–×•× ×•×ª</button>
          </div>
          <div id="alimonyFields" style="display:none">
            <div class="input-group" style="max-width:320px">
              <label for="alimonyExpenses">×”×•×¦××•×ª ××–×•× ×•×ª</label>
              <input type="number" id="alimonyExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
            </div>
          </div>
        </section>
      </form>
    </div>
  </div>

  <script>
    // ====== ×¢×–×¨ ×›×œ×œ×™ ======
    const formatILS = v => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(v||0);
    const round10 = n => Math.floor((n||0)/10)*10;
    const todayStr = ()=> {
      const d=new Date();
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }
    document.getElementById('versionTag').textContent = `×’×¨×¡×” ${new Date().getFullYear()}`;

    // ====== × ×ª×•× ×™ ×‘×¡×™×¡ ======
    const lookupData={
      "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":{kids:0,livingCost:4556},
      "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":{kids:1,livingCost:6056},
      "×–×•×’":{kids:0,livingCost:6024},
      "×–×•×’+×™×œ×“":{kids:1,livingCost:7524},
      "×–×•×’+ 2 ×™×œ×“×™×":{kids:2,livingCost:9024},
      "×–×•×’+ 3 ×™×œ×“×™×":{kids:3,livingCost:10524},
      "×–×•×’+ 4 ×™×œ×“×™×":{kids:4,livingCost:12024},
      "×–×•×’+ 5 ×™×œ×“×™×":{kids:5,livingCost:13324},
      "×–×•×’+ 6 ×™×œ×“×™×":{kids:6,livingCost:14624},
      "×–×•×’+ 7 ×™×œ×“×™×":{kids:7,livingCost:15924},
      "×–×•×’+ 8 ×™×œ×“×™×":{kids:8,livingCost:17224},
      "×–×•×’+ 9 ×™×œ×“×™×":{kids:9,livingCost:18524},
      "×–×•×’+ 10 ×™×œ×“×™×":{kids:10,livingCost:19824}
    };
    const childAllowance={0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

    // ====== DOM ======
    const form = document.getElementById('calculatorForm');
    const statusEl = document.getElementById('status');
    const male = document.getElementById('debtor-male'), female = document.getElementById('debtor-female');
    const chipM = document.getElementById('chip-m'), chipF = document.getElementById('chip-f'), chipBoth = document.getElementById('chip-both');
    const jointEl = document.getElementById('jointProceeding');

    const salaryDebtor = document.getElementById('salaryDebtor');
    const salaryPartner = document.getElementById('salaryPartner');
    const otherDebtor = document.getElementById('otherIncomeDebtor');
    const otherPartner = document.getElementById('otherIncomePartner');
    const debAllow = document.getElementById('debtorAllowance');
    const partAllow = document.getElementById('partnerAllowance');
    const unusual = document.getElementById('unusualExpenses');
    const childcare = document.getElementById('childcareExpenses');
    const alimony = document.getElementById('alimonyExpenses');
    const allowanceBtn = document.getElementById('allowanceButton');
    const allowanceBox = document.getElementById('allowanceFields');
    const alimonyBtn = document.getElementById('alimonyButton');
    const alimonyBox = document.getElementById('alimonyFields');

    const lblSalaryDeb = document.getElementById('salaryDebtorLabel');
    const lblSalaryPar = document.getElementById('salaryPartnerLabel');
    const lblOtherDeb  = document.getElementById('otherIncomeDebtorLabel');
    const lblOtherPar  = document.getElementById('otherIncomePartnerLabel');
    const lblDebRatio  = document.getElementById('debtorIncomeRatioLabel');
    const lblParRatio  = document.getElementById('partnerIncomeRatioLabel');
    const lblDebPay    = document.getElementById('debtorPaymentLabel');
    const lblParPay    = document.getElementById('partnerPaymentLabel');
    const lblDebAllow  = document.getElementById('debtorAllowanceLabel');
    const lblParAllow  = document.getElementById('partnerAllowanceLabel');

    const livingRes = document.getElementById('baseLivingCostResult');
    const btlRes    = document.getElementById('socialSecurityAllowance');
    const totalIncRes = document.getElementById('totalIncomeResult');
    const totalExpRes = document.getElementById('totalExpensesResult');
    const dispRes   = document.getElementById('disposableIncomeResult');
    const debRatioRes = document.getElementById('debtorIncomeRatio');
    const parRatioRes = document.getElementById('partnerIncomeRatio');
    const debPayRes = document.getElementById('debtorPaymentResult');
    const parPayRes = document.getElementById('partnerPaymentResult');
    const finalPayRes = document.getElementById('finalPaymentResult');

    const specialNote = document.getElementById('special-note');
    const proposedBox = document.getElementById('proposedPaymentsDisplay');
    const finalBox = document.getElementById('finalPaymentDisplay');

    // ×¤×¨×˜×™ ×“×•"×— + ×”×¢×¨×”
    const reportBlock = document.getElementById('reportBlock');
    const noteBlock = document.getElementById('noteBlock');
    const toggleReportBtn = document.getElementById('toggleReportBtn');
    const toggleNoteBtn = document.getElementById('toggleNoteBtn');
    const caseId = document.getElementById('caseId');
    const preparer = document.getElementById('preparer');
    const reportDate = document.getElementById('reportDate');
    const noteText = document.getElementById('noteText');
    const noteCount = document.getElementById('noteCount');

    // ×¤×¢×•×œ×•×ª
    const printBtn = document.getElementById('printBtn');
    const mailBtn = document.getElementById('mailBtn');
    const emailTip = document.getElementById('emailTip');
    const exportSummary = document.getElementById('exportSummary');

    // ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ
    reportDate.value = todayStr();

    // ×›×¤×ª×•×¨×™ ×¦'×™×¤
    const syncChips = ()=> {
      chipM.classList.toggle('active', male.checked);
      chipF.classList.toggle('active', female.checked);
      chipBoth.classList.toggle('active', jointEl.checked);
    }
    chipM.addEventListener('click', ()=>{ male.checked=true; syncChips(); updateUI(); calc(); });
    chipF.addEventListener('click', ()=>{ female.checked=true; syncChips(); updateUI(); calc(); });
    chipBoth.addEventListener('click', ()=>{ jointEl.checked=!jointEl.checked; syncChips(); updateUI(); calc(); });

    // ×¢×–×¨×” "?"
    document.querySelectorAll('.help-icon').forEach(icon=>{
      icon.addEventListener('click', e=>{
        const wrap=e.target.closest('.help-wrap');
        wrap.classList.toggle('open');
      });
    });

    // ××ª×§×¤×œ×™×
    toggleReportBtn.addEventListener('click', ()=> reportBlock.classList.toggle('open'));
    toggleNoteBtn.addEventListener('click',   ()=> noteBlock.classList.toggle('open'));
    noteText.addEventListener('input', ()=> noteCount.textContent = noteText.value.length);

    // ×”×¦×’×ª/×”×¡×ª×¨×ª ×§×•×¤×¡××•×ª
    allowanceBtn.addEventListener('click', ()=> allowanceBox.style.display = allowanceBox.style.display==='none'?'block':'none');
    alimonyBtn.addEventListener('click',   ()=> alimonyBox.style.display   = alimonyBox.style.display==='none'?'block':'none');

    // UI ×“×™× ××™
    function updateUI(){
      const status=statusEl.value||'';
      const isSingle = /×™×—×™×“|×¨×•×•×§/.test(status);
      const isMale = male.checked;
      const isJoint = jointEl.checked;

      // ×ª×•×•×™×•×ª
      if(isSingle){
        lblSalaryDeb.textContent='×”×›× ×¡×” (×—×™×™×‘/×ª)';
        lblOtherDeb.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)';
        if(lblDebAllow) lblDebAllow.textContent='×§×¦×‘×” (×—×™×™×‘/×ª)';
        lblSalaryPar.textContent='×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)';
        lblOtherPar.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)';
        if(lblParAllow) lblParAllow.textContent='×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)';
        lblDebRatio.textContent='××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª):';
        lblParRatio.textContent='××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’):';
        lblDebPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª):';
        lblParPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’):';
      }else if(isMale){
        lblSalaryDeb.textContent='×”×›× ×¡×” (×—×™×™×‘)';
        lblOtherDeb.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)';
        if(lblDebAllow) lblDebAllow.textContent='×§×¦×‘×” (×—×™×™×‘)';
        lblSalaryPar.textContent='×”×›× ×¡×” (×‘×ª ×–×•×’)';
        lblOtherPar.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)';
        if(lblParAllow) lblParAllow.textContent='×§×¦×‘×” (×‘×ª ×–×•×’)';
        lblDebRatio.textContent='××—×•×– ×”×›× ×¡×” (×—×™×™×‘):';
        lblParRatio.textContent='××—×•×– ×”×›× ×¡×” (×‘×ª ×–×•×’):';
        lblDebPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘):';
        lblParPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×‘×ª ×–×•×’):';
      }else{
        lblSalaryDeb.textContent='×”×›× ×¡×” (×—×™×™×‘×ª)';
        lblOtherDeb.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘×ª)';
        if(lblDebAllow) lblDebAllow.textContent='×§×¦×‘×” (×—×™×™×‘×ª)';
        lblSalaryPar.textContent='×”×›× ×¡×” (×‘×Ÿ ×–×•×’)';
        lblOtherPar.textContent='×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ ×–×•×’)';
        if(lblParAllow) lblParAllow.textContent='×§×¦×‘×” (×‘×Ÿ ×–×•×’)';
        lblDebRatio.textContent='××—×•×– ×”×›× ×¡×” (×—×™×™×‘×ª):';
        lblParRatio.textContent='××—×•×– ×”×›× ×¡×” (×‘×Ÿ ×–×•×’):';
        lblDebPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘×ª):';
        lblParPay.textContent='×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ ×–×•×’):';
      }

      // ×”×¡×ª×¨×ª ×©×“×•×ª ×‘×Ÿ/×‘×ª ×–×•×’ ×‘×™×—×™×“/×”
      document.getElementById('salaryPartnerGroup').style.display = isSingle?'none':'flex';
      document.getElementById('otherIncomePartnerGroup').style.display = isSingle?'none':'flex';
      const partnerAllowanceGroup = document.getElementById('partnerAllowanceGroup');
      if(partnerAllowanceGroup) partnerAllowanceGroup.style.display = isSingle?'none':'flex';

      // ×ª×¦×•×’×ª ×ª×©×œ×•××™×
      if(isJoint){
        proposedBox.style.display='grid';
        finalBox.style.display='block';
        finalBox.querySelector('.label').textContent='×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:';
      }else{
        proposedBox.style.display='none';
        finalBox.style.display='block';
        finalBox.querySelector('.label').textContent='×ª×©×œ×•× ×—×•×“×©×™ (×—×™×™×‘/×ª):';
      }
    }

    // ×—×™×©×•×‘
    function calc(){
      const status=statusEl.value||'';
      const sData=lookupData[status]||{kids:0,livingCost:0};
      const baseLiving=sData.livingCost;
      const btl=childAllowance[sData.kids]||0;

      const dSalary=+salaryDebtor.value||0;
      const pSalary=+salaryPartner.value||0;
      const dOther=+otherDebtor.value||0;
      const pOther=+otherPartner.value||0;
      const dAll=+debAllow.value||0;
      const pAll=+partAllow.value||0;
      const expUnu=+unusual.value||0;
      const expChild=+childcare.value||0;
      const expAli=+alimony.value||0;

      livingRes.textContent = formatILS(baseLiving);
      btlRes.textContent    = formatILS(btl);

      const totalForRatio = dSalary+dOther+pSalary+pOther;
      const dRatio = totalForRatio? (dSalary+dOther)/totalForRatio : 0;
      const pRatio = totalForRatio? (pSalary+pOther)/totalForRatio : 0;

      debRatioRes.textContent=(dRatio*100).toFixed(1)+'%';
      parRatioRes.textContent=(pRatio*100).toFixed(1)+'%';

      const totalIncome = dSalary+pSalary+btl+dOther+pOther+dAll+pAll;
      const totalExp = baseLiving + expUnu + expChild + expAli;
      totalIncRes.textContent=formatILS(totalIncome);
      totalExpRes.textContent=formatILS(totalExp);

      const disposable = totalIncome-totalExp;
      dispRes.textContent = disposable<0? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : formatILS(disposable);

      // ×ª×©×œ×•××™× ××•×¦×¢×™× ×‘×¡×™×¡×™×™× (×—×¦×™ ××”×”×›× ×¡×” ×”×¤× ×•×™×” * ×™×—×¡)
      const baseDeb = dRatio>0? round10((disposable*dRatio)/2) : 0;
      const basePar = pRatio>0? round10((disposable*pRatio)/2) : 0;
      debPayRes.textContent = formatILS(Math.max(0,baseDeb));
      parPayRes.textContent = formatILS(Math.max(0,basePar));

      // ×¡×•×¤×™
      const isSingle = /×™×—×™×“|×¨×•×•×§/.test(status);
      const isJoint = jointEl.checked;
      let final=0;

      if(isSingle){
        final = Math.max(0,baseDeb);
      }else if(isJoint){
        // × ×•×¡×—×” ×”××‘×•×§×©×ª:
        // (×”×›× ×¡×” ×¤× ×•×™×” / 2 - ×ª×©×œ×•× ×—×•×“×©×™ ×©×œ ×‘×Ÿ/×‘×ª ×”×–×•×’) * ×™×—×¡ ×—×™×™×‘  + ×ª×©×œ×•× ×—×•×“×©×™ ×©×œ ×‘×Ÿ/×‘×ª ×”×–×•×’
        const partnerPay = basePar;
        const base = (disposable/2) - partnerPay;
        final = round10(Math.max(0, base) * dRatio + partnerPay);
      }else{
        final = Math.max(0,baseDeb);
      }
      finalPayRes.textContent = formatILS(final);

      // ×”×¢×¨×”: ×œ×”×¦×™×’ ×¨×§ ×›×©×œ× ×¢×•×‘×“ ×•×™×© ××©×¤×—×” (×œ× ×™×—×™×“/×¨×•×•×§)
      specialNote.style.display = (dSalary===0 && !isSingle)? 'block':'none';
    }

    // ×××–×™× ×™× ×œ×§×œ×˜×™×
    form.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('input', ()=>{ updateUI(); calc(); });
      el.addEventListener('change',()=>{ updateUI(); calc(); });
    });
    updateUI(); calc(); syncChips();

    // ====== ×™×‘×•× × ×ª×•× ×™× ×œ×¡×™×›×•× ×™×™×¦×•× ======
    function gatherInputs(){
      const status=statusEl.value||'-';
      const who = male.checked?'×—×™×™×‘':(female.checked?'×—×™×™×‘×ª':'×—×™×™×‘/×ª');
      const both = jointEl.checked?'×›×Ÿ':'×œ×';

      const get = id => document.getElementById(id).value||'';
      const asCurrency = v => formatILS(+v||0);

      return {
        status, who, both,
        salaryDeb: asCurrency(get('salaryDebtor')),
        salaryPar: asCurrency(get('salaryPartner')),
        otherDeb:  asCurrency(get('otherIncomeDebtor')),
        otherPar:  asCurrency(get('otherIncomePartner')),
        allDeb:    asCurrency(get('debtorAllowance')),
        allPar:    asCurrency(get('partnerAllowance')),
        expUnu:    asCurrency(get('unusualExpenses')),
        expChild:  asCurrency(get('childcareExpenses')),
        expAli:    asCurrency(get('alimonyExpenses'))
      };
    }
    function gatherResults(){
      const txt = id => document.getElementById(id).textContent.trim();
      return {
        living: txt('baseLivingCostResult'),
        btl:    txt('socialSecurityAllowance'),
        totInc: txt('totalIncomeResult'),
        totExp: txt('totalExpensesResult'),
        disp:   txt('disposableIncomeResult'),
        rDeb:   txt('debtorIncomeRatio'),
        rPar:   txt('partnerIncomeRatio'),
        payDeb: txt('debtorPaymentResult'),
        payPar: txt('partnerPaymentResult'),
        final:  txt('finalPaymentResult')
      };
    }
    function buildSummaryHTML(){
      const inputs = gatherInputs();
      const res = gatherResults();
      const note = noteText.value? `<div style="margin-top:8px"><strong>×”×¢×¨×”:</strong> ${escapeHtml(noteText.value)}</div>` : '';
      const meta = `
        <h2 style="margin:0 0 8px">×¤×¨×˜×™ ×”×“×•"×—</h2>
        <div><strong>××¡â€™ ×ª×™×§:</strong> ${escapeHtml(caseId.value||'-')}</div>
        <div><strong>×©× ×¢×•×¨×š/×ª:</strong> ${escapeHtml(preparer.value||'-')}</div>
        <div><strong>×ª××¨×™×š:</strong> ${escapeHtml(reportDate.value||todayStr())}</div>
        ${note}
        <hr style="margin:12px 0">
      `;
      const inputsHtml = `
        <h3 style="margin:0 0 6px">×§×œ×˜×™× (×¢××•×“×” ×™×× ×™×ª)</h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.95rem">
          ${tr('×¡×˜×˜×•×¡ ××©×¤×—×ª×™',inputs.status)}
          ${tr('××™ ×‘×”×œ×™×š',inputs.who)}
          ${tr('×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?',inputs.both)}
          ${tr('×”×›× ×¡×” (×—×™×™×‘/×ª)',inputs.salaryDeb)}
          ${tr('×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)',inputs.salaryPar)}
          ${tr('×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)',inputs.otherDeb)}
          ${tr('×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)',inputs.otherPar)}
          ${tr('×§×¦×‘×” (×—×™×™×‘/×ª)',inputs.allDeb)}
          ${tr('×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)',inputs.allPar)}
          ${tr('×”×•×¦××•×ª ×—×¨×™×’×•×ª',inputs.expUnu)}
          ${tr('×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×',inputs.expChild)}
          ${tr('×”×•×¦××•×ª ××–×•× ×•×ª',inputs.expAli)}
        </table>
        <hr style="margin:12px 0">
      `;
      const resultsHtml = `
        <h3 style="margin:0 0 6px">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.95rem">
          ${tr('×“××™ ××—×™×™×” ×‘×›×‘×•×“',res.living)}
          ${tr('×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™',res.btl)}
          ${tr('×¡×š ×”×›× ×¡×•×ª',res.totInc)}
          ${tr('×¡×š ×”×•×¦××•×ª',res.totExp)}
          ${tr('×”×›× ×¡×” ×¤× ×•×™×”',res.disp)}
          ${tr('××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª)',res.rDeb)}
          ${tr('××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)',res.rPar)}
          ${tr('×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)',res.payDeb)}
          ${tr('×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)',res.payPar)}
          ${tr('<strong>×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ×”××©×¤×—×ª×™</strong>',`<strong>${res.final}</strong>`)}
        </table>
      `;
      return `<div style="padding:8px 4px">${meta}${inputsHtml}${resultsHtml}</div>`;
      function tr(k,v){
        return `<tr>
          <td style="border:1px solid #e3e7ea;padding:6px 8px;background:#fafbfc;width:45%">${k}</td>
          <td style="border:1px solid #e3e7ea;padding:6px 8px">${v}</td>
        </tr>`;
      }
      function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    }
    function buildSummaryText(){
      const inputs=gatherInputs(), res=gatherResults();
      const lines=[
        `×¤×¨×˜×™ ×”×“×•"×—`,
        `××¡â€™ ×ª×™×§: ${caseId.value||'-'}`,
        `×©× ×¢×•×¨×š/×ª: ${preparer.value||'-'}`,
        `×ª××¨×™×š: ${reportDate.value||todayStr()}`,
        noteText.value?`×”×¢×¨×”: ${noteText.value}`:null,
        ``,
        `×§×œ×˜×™× (×¢××•×“×” ×™×× ×™×ª):`,
        `×¡×˜×˜×•×¡ ××©×¤×—×ª×™: ${inputs.status}`,
        `××™ ×‘×”×œ×™×š: ${inputs.who}`,
        `×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?: ${inputs.both}`,
        `×”×›× ×¡×” (×—×™×™×‘/×ª): ${inputs.salaryDeb}`,
        `×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${inputs.salaryPar}`,
        `×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª): ${inputs.otherDeb}`,
        `×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’): ${inputs.otherPar}`,
        `×§×¦×‘×” (×—×™×™×‘/×ª): ${inputs.allDeb}`,
        `×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’): ${inputs.allPar}`,
        `×”×•×¦××•×ª ×—×¨×™×’×•×ª: ${inputs.expUnu}`,
        `×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×: ${inputs.expChild}`,
        `×”×•×¦××•×ª ××–×•× ×•×ª: ${inputs.expAli}`,
        ``,
        `×ª×•×¦××•×ª ×”×—×™×©×•×‘:`,
        `×“××™ ××—×™×™×” ×‘×›×‘×•×“: ${res.living}`,
        `×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™: ${res.btl}`,
        `×¡×š ×”×›× ×¡×•×ª: ${res.totInc}`,
        `×¡×š ×”×•×¦××•×ª: ${res.totExp}`,
        `×”×›× ×¡×” ×¤× ×•×™×”: ${res.disp}`,
        `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${res.rDeb}`,
        `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${res.rPar}`,
        `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${res.payDeb}`,
        `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${res.payPar}`,
        `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ×”××©×¤×—×ª×™: ${res.final}`
      ].filter(Boolean);
      return lines.join('\n');
    }

    // ====== ×”×“×¤×¡×” ======
    printBtn.addEventListener('click', ()=>{
      // ×œ×¤×ª×•×— ××ª ×¤×¨×˜×™ ×”×“×•"×— ×‘×”×“×¤×¡×” + ×œ×”×–×™×Ÿ ×ª×§×¦×™×¨
      exportSummary.innerHTML = buildSummaryHTML();
      window.print();
    });

    // ====== ××™×™×œ ======
    mailBtn.addEventListener('click', ()=>{
      emailTip.style.display='block'; // ×”×˜×™×¤ ××•×¤×™×¢ ×¨×§ ××—×¨×™ ×œ×—×™×¦×”
      const subject = `×“×•"×— ×—×™×©×•×‘ ×¦×• ×ª×©×œ×•××™× â€“ ×ª×™×§ ${caseId.value||'-'} â€“ ${reportDate.value||todayStr()}`;
      const body = buildSummaryText();
      const href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = href;
    });

    // ×˜×¨×™×’×¨ ×¨××©×•× ×™
    updateUI(); calc();

  </script>
</body>
</html>

