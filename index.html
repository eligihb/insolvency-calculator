<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>מחשבון צו תשלומים</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --panel:#fff;
    --text:#222; --muted:#6b7280; --border:#d9e1e6; --accent:#ee9b00; --danger:#b91c1c;
    --card:#eef6f6; --card2:#e9f5f5; --blue:#0b62ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Heebo',sans-serif;color:var(--text);display:flex;justify-content:center}
  .calc{width:100%;max-width:1100px;background:var(--panel);border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  header{background:var(--primary);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;justify-content:center;position:relative}
  header h1{margin:0;font-size:1.8rem}
  .chip-year{position:absolute;right:18px;top:12px;background:#0b7;opacity:.9;color:#fff;border-radius:999px;padding:6px 10px;font-size:.85rem}
  .grid{display:grid;grid-template-columns:1fr 1fr}
  .left{background:var(--card2);padding:20px}
  .right{border-inline-start:1px solid var(--border);padding:20px}
  h2.sec{margin:6px 0 14px;color:var(--primary);font-size:1.25rem}
  /* כפתורי פעולה עליונים */
  .top-actions{display:flex;gap:10px;margin-bottom:14px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{background:#f8fafc}
  .btn-danger{border-color:#f4cccc;background:#fff}
  /* שורת סטטוס + מי בהליך */
  .row-inline{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  select,input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
  select:focus,input:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(10,147,150,.20)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
  .chip.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
  .chip-joint{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
  .chip-joint.active{background:#ffeded;color:#a10000;border-color:#ffb3b3}
  /* זוגות שדות – החייב תמיד בימין */
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pair .debtor{grid-column:2}
  .pair .partner{grid-column:1}
  /* בלוקי תוצאה */
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
  .card .title{color:var(--muted);margin-bottom:8px}
  .card .val{font-weight:700;color:var(--accent)}
  .strip{border-top:2px solid #cfe9e9;margin:10px 0}
  .big{font-size:1.4rem}
  .blue{color:var(--blue)}
  /* הגבלות הדפסה */
  @media print{
    .top-actions{display:none}
    .chip-year{display:none}
    body{background:#fff}
  }
  /* מובייל: הישאר רספונסיבי, אבל לא נוגעים עכשיו בעומק */
  @media(max-width:900px){
    .grid{grid-template-columns:1fr}
    .right{border-inline-start:none;border-top:1px solid var(--border)}
  }
</style>
</head>
<body>
<div class="calc" id="calcRoot">
  <header>
    <div class="chip-year" id="verChip">2025׳ מעודכן</div>
    <h1>מחשבון צו תשלומים</h1>
  </header>

  <div class="grid">
    <!-- תוצאות – משמאל -->
    <section class="left">
      <div class="top-actions">
        <button class="btn" id="btnReset">♻️ איפוס</button>
        <button class="btn" id="btnEmail">✉️ שלח במייל</button>
        <button class="btn" id="btnSnap">📸 צילום מסך</button>
      </div>

      <h2 class="sec">תוצאות החישוב</h2>

      <div class="cards">
        <div class="card">
          <div class="title">סך הכנסות</div>
          <div class="val big" id="totalIncome">₪ 0</div>
        </div>
        <div class="card">
          <div class="title">קצבת ביטוח לאומי</div>
          <div class="val big" id="nlAllowance">₪ 0</div>
        </div>

        <div class="card">
          <div class="title">סך הוצאות</div>
          <div class="val big" id="totalExp">₪ 0</div>
        </div>
        <div class="card">
          <div class="title">דמי מחייה בכבוד</div>
          <div class="val big" id="livingCost">₪ 0</div>
        </div>

        <div class="card" style="grid-column:1 / -1">
          <div class="title">הכנסה פנויה לתא המשפחתי</div>
          <div class="val big blue" id="freeIncome">₪ 0</div>
        </div>

        <div class="card">
          <div class="title" id="debtorRatioLabel">אחוז הכנסה (חייב)</div>
          <div class="val" id="debtorRatio">0%</div>
        </div>
        <div class="card">
          <div class="title" id="partnerRatioLabel">אחוז הכנסה (בת זוג)</div>
          <div class="val" id="partnerRatio">0%</div>
        </div>

        <div class="card">
          <div class="title" id="debtorPayLabel">תשלום מוצע (חייב)</div>
          <div class="val" id="debtorPay">₪ 0</div>
        </div>
        <div class="card">
          <div class="title" id="partnerPayLabel">תשלום מוצע (בת זוג)</div>
          <div class="val" id="partnerPay">₪ 0</div>
        </div>

        <div class="card" style="grid-column:1 / -1">
          <div class="title">תשלום חודשי לתא משפחתי</div>
          <div class="val big" id="finalPay">₪ 0</div>
        </div>
      </div>
    </section>

    <!-- קלטים – מימין -->
    <section class="right">
      <div class="row-inline" style="margin-bottom:10px">
        <select id="status">
          <option value="" disabled selected>סטטוס משפחתי — בחר סטטוס...</option>
          <option value="יחיד/נשוי חי בנפרד">יחיד/נשוי חי בנפרד</option>
          <option value="רווק/גרוש/אלמן + ילד">רווק/גרוש/אלמן + ילד</option>
          <option value="זוג">זוג</option>
          <option value="זוג+ילד">זוג+ילד</option>
          <option value="זוג+ 2 ילדים">זוג+ 2 ילדים</option>
          <option value="זוג+ 3 ילדים">זוג+ 3 ילדים</option>
          <option value="זוג+ 4 ילדים">זוג+ 4 ילדים</option>
          <option value="זוג+ 5 ילדים">זוג+ 5 ילדים</option>
          <option value="זוג+ 6 ילדים">זוג+ 6 ילדים</option>
          <option value="זוג+ 7 ילדים">זוג+ 7 ילדים</option>
          <option value="זוג+ 8 ילדים">זוג+ 8 ילדים</option>
          <option value="זוג+ 9 ילדים">זוג+ 9 ילדים</option>
          <option value="זוג+ 10 ילדים">זוג+ 10 ילדים</option>
        </select>

        <div class="chips" id="whoRow">
          <button type="button" class="chip" data-g="m">חייב</button>
          <button type="button" class="chip" data-g="f">חייבת</button>
          <button type="button" class="chip-joint" id="btnJoint">שני בני הזוג בהליך?</button>
        </div>
      </div>

      <h2 class="sec">(₪) הכנסות והוצאות התא המשפחתי</h2>

      <div class="pair" style="margin-bottom:8px">
        <div class="partner">
          <label>הכנסה (בת/בן זוג)</label>
          <input type="number" id="incPartner" placeholder="הזן הכנסה">
        </div>
        <div class="debtor">
          <label id="incDebtorLabel">הכנסה (חייב)</label>
          <input type="number" id="incDebtor" placeholder="הזן הכנסה">
        </div>
      </div>

      <div class="pair" style="margin-bottom:8px">
        <div class="partner">
          <label>הכנסות אחרות (בת/בן זוג)</label>
          <input type="number" id="othPartner" placeholder="הזן הכנסות אחרות">
        </div>
        <div class="debtor">
          <label id="othDebtorLabel">הכנסות אחרות (חייב)</label>
          <input type="number" id="othDebtor" placeholder="הזן הכנסות אחרות">
        </div>
      </div>

      <div class="pair" style="margin-bottom:8px">
        <div class="partner">
          <label>קצבה (בן/בת זוג)</label>
          <input type="number" id="allowPartner" placeholder="הזן קצבה">
        </div>
        <div class="debtor">
          <label>קצבה (חייב/ת)</label>
          <input type="number" id="allowDebtor" placeholder="הזן קצבה">
        </div>
      </div>

      <div class="pair" style="margin-bottom:8px">
        <div class="partner">
          <label>הוצאות חריגות (רפואיות וכו')</label>
          <input type="number" id="expUnusual" placeholder="הזן הוצאות">
        </div>
        <div class="debtor">
          <label>הוצאות טיפול וצהרונים</label>
          <input type="number" id="expChildcare" placeholder="הזן הוצאות">
        </div>
      </div>

      <div class="pair">
        <div class="partner" style="grid-column:1 / -1">
          <label>הוצאות מזונות</label>
          <input type="number" id="expAlimony" placeholder="הזן הוצאות מזונות">
        </div>
      </div>

      <div style="margin-top:12px">
        <a href="#" id="reportMetaLink" style="color:var(--secondary);text-decoration:none">פרטי דו״ח ▾</a>
        <div id="reportMeta" style="display:none;margin-top:8px;gap:8px" class="pair">
          <div class="partner">
            <input type="text" id="caseId" placeholder="מס' תיק">
          </div>
          <div class="debtor">
            <input type="text" id="authorName" placeholder="שם עורך/ת החישוב">
          </div>
          <div class="partner" style="grid-column:1 / -1">
            <input type="text" id="note" placeholder="הערה (רשות)">
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- html2canvas לצילום מסך -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  // שנה לשבב
  document.getElementById('verChip').textContent = new Date().getFullYear() + '׳ מעודכן';

  // נתוני בסיס
  const livingTable = {
    "יחיד/נשוי חי בנפרד":4556,
    "רווק/גרוש/אלמן + ילד":6056,
    "זוג":6024,"זוג+ילד":7524,"זוג+ 2 ילדים":9024,"זוג+ 3 ילדים":10524,"זוג+ 4 ילדים":12024,
    "זוג+ 5 ילדים":13324,"זוג+ 6 ילדים":14624,"זוג+ 7 ילדים":15924,"זוג+ 8 ילדים":17224,"זוג+ 9 ילדים":18524,"זוג+ 10 ילדים":19824
  };
  const childAllowance = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};
  const kidsCountFromStatus = (s)=>{
    if(!s) return 0;
    if(s.includes('יחיד')) return 0;
    if(s.includes('+ 10')) return 10;
    const m = s.match(/(\d+)\s?ילד/); return m? +m[1] : (s.includes('זוג')?0:0);
  };

  // אלמנטים
  const statusEl = document.getElementById('status');
  const btnsWho = document.querySelectorAll('.chip[data-g]');
  const btnJoint = document.getElementById('btnJoint');

  const incDebtor = document.getElementById('incDebtor');
  const incPartner = document.getElementById('incPartner');
  const othDebtor = document.getElementById('othDebtor');
  const othPartner = document.getElementById('othPartner');
  const allowDebtor = document.getElementById('allowDebtor');
  const allowPartner = document.getElementById('allowPartner');
  const expUnusual = document.getElementById('expUnusual');
  const expChildcare = document.getElementById('expChildcare');
  const expAlimony = document.getElementById('expAlimony');

  const totalIncome = document.getElementById('totalIncome');
  const nlAllowance = document.getElementById('nlAllowance');
  const totalExp = document.getElementById('totalExp');
  const livingCost = document.getElementById('livingCost');
  const freeIncome = document.getElementById('freeIncome');
  const debtorRatio = document.getElementById('debtorRatio');
  const partnerRatio = document.getElementById('partnerRatio');
  const debtorPay = document.getElementById('debtorPay');
  const partnerPay = document.getElementById('partnerPay');
  const finalPay = document.getElementById('finalPay');

  const incDebtorLabel = document.getElementById('incDebtorLabel');
  const othDebtorLabel = document.getElementById('othDebtorLabel');
  const debtorRatioLabel = document.getElementById('debtorRatioLabel');
  const partnerRatioLabel = document.getElementById('partnerRatioLabel');
  const debtorPayLabel   = document.getElementById('debtorPayLabel');
  const partnerPayLabel  = document.getElementById('partnerPayLabel');

  let who = 'm'; // m/f
  let joint = false;

  // עזרה: פורמט כספי
  const fmt = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(Math.max(0, Math.floor(n)));

  function refreshLabels(){
    const single = statusEl.value.includes('יחיד') || statusEl.value.includes('רווק');
    const debtorTxt = (who==='m' ? 'חייב' : 'חייבת');
    incDebtorLabel.textContent = single ? 'הכנסה (חייב/ת)' : `הכנסה (${debtorTxt})`;
    othDebtorLabel.textContent = single ? 'הכנסות אחרות (חייב/ת)' : `הכנסות אחרות (${debtorTxt})`;

    debtorRatioLabel.textContent = `אחוז הכנסה (${debtorTxt})`;
    partnerRatioLabel.textContent = `אחוז הכנסה (${who==='m'?'בת זוג':'בן זוג'})`;
    debtorPayLabel.textContent   = `תשלום מוצע (${debtorTxt})`;
    partnerPayLabel.textContent  = `תשלום מוצע (${who==='m'?'בת זוג':'בן זוג'})`;
  }

  function calc(){
    const stat = statusEl.value || '';
    const kids = kidsCountFromStatus(stat);
    const base = livingTable[stat] || 0;
    const child = childAllowance[kids] || 0;

    livingCost.textContent = fmt(base);
    nlAllowance.textContent = fmt(child);

    const dInc = +incDebtor.value||0, pInc = +incPartner.value||0;
    const dOth = +othDebtor.value||0,  pOth = +othPartner.value||0;
    const dAlw = +allowDebtor.value||0, pAlw = +allowPartner.value||0;
    const eUn  = +expUnusual.value||0, eCh  = +expChildcare.value||0, eAl = +expAlimony.value||0;

    const incomes = dInc+pInc+dOth+pOth+dAlw+pAlw+child;
    totalIncome.textContent = fmt(incomes);

    const expenses = base + eUn + eCh + eAl;
    totalExp.textContent = fmt(expenses);

    const free = incomes - expenses;
    freeIncome.textContent = free>0 ? fmt(free) : 'אין הכנסה פנויה';

    const totForRatio = (dInc+dOth) + (pInc+pOth);
    const rD = totForRatio>0 ? (dInc+dOth)/totForRatio : 0;
    const rP = totForRatio>0 ? (pInc+pOth)/totForRatio : 0;
    debtorRatio.textContent  = (rD*100).toFixed(1)+'%';
    partnerRatio.textContent = (rP*100).toFixed(1)+'%';

    const dPay = rD>0 ? Math.floor(((free*rD)/2)/10)*10 : 0;
    const pPay = rP>0 ? Math.floor(((free*rP)/2)/10)*10 : 0;
    debtorPay.textContent  = fmt(dPay);
    partnerPay.textContent = fmt(pPay);

    // נוסחת שני בני זוג בהליך (כשכפתור דולק): (DI/2 - partnerPay) * rD + partnerPay
    let final = dPay;
    if(joint){
      const half = free/2;
      const part = Math.max(0, half - pPay);
      final = Math.floor(((part * rD) + pPay)/10)*10;
    }
    // "תיק אפס" – רק אם יש הכנסה מקצבאות בלבד ולחייב אין הכנסות כלל
    const onlyAllowances = (dInc+dOth+pInc+pOth)===0 && (dAlw+pAlw+child)>0;
    if(onlyAllowances && dInc===0 && dOth===0){
      finalPay.innerHTML = '<span style="color:#a10000;font-weight:700">תיק אפס</span>';
    }else{
      finalPay.textContent = fmt(final);
    }
  }

  // אירועים
  statusEl.addEventListener('change', ()=>{ refreshLabels(); calc(); });

  btnsWho.forEach(b=>{
    b.addEventListener('click', ()=>{
      btnsWho.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      who = b.dataset.g;
      refreshLabels(); calc();
    });
  });
  // ברירת מחדל: חייב מסומן
  document.querySelector('.chip[data-g="m"]').classList.add('active');

  btnJoint.addEventListener('click', ()=>{
    joint = !joint;
    btnJoint.classList.toggle('active', joint);
    calc();
  });

  [incDebtor,incPartner,othDebtor,othPartner,allowDebtor,allowPartner,expUnusual,expChildcare,expAlimony]
    .forEach(el=>el.addEventListener('input', calc));

  // פרטי דו"ח – פתיחה/סגירה
  const link = document.getElementById('reportMetaLink');
  const meta = document.getElementById('reportMeta');
  link.addEventListener('click', (e)=>{e.preventDefault(); meta.style.display = (meta.style.display==='none'||!meta.style.display)?'grid':'none';});

  // איפוס
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('calcRoot').querySelectorAll('input').forEach(i=>i.value='');
    statusEl.selectedIndex = 0;
    joint=false; btnJoint.classList.remove('active');
    btnsWho.forEach(x=>x.classList.remove('active'));
    document.querySelector('.chip[data-g="m"]').classList.add('active'); who='m';
    refreshLabels(); calc();
  });

  // צילום מסך – PNG בלשונית חדשה
  document.getElementById('btnSnap').addEventListener('click', async ()=>{
    try{
      const node = document.querySelector('.calc');
      const canvas = await html2canvas(node,{scale:2,background:'#ffffff',useCORS:true});
      const url = canvas.toDataURL('image/png');
      const w = window.open('about:blank','_blank');
      w.document.write('<title>צילום מסך המחשבון</title>');
      w.document.write('<img style="width:100%;height:auto;display:block" src="'+url+'"/>');
      w.document.close();
    }catch(e){
      alert('שגיאה בצילום המסך');
    }
  });

  // מייל – מייצר תקציר ופותח mailto
  document.getElementById('btnEmail').addEventListener('click', ()=>{
    const gt = id => (document.getElementById(id)?.textContent||'').trim();
    const subject = 'מחשבון צו תשלומים – ' + (document.getElementById('caseId').value||'ללא מס\' תיק');
    const body = [
      'תקציר תוצאות:',
      'סך הכנסות: ' + gt('totalIncome'),
      'סך הוצאות: ' + gt('totalExp'),
      'הכנסה פנויה: ' + gt('freeIncome'),
      gt('debtorRatioLabel') + ': ' + gt('debtorRatio'),
      gt('partnerRatioLabel') + ': ' + gt('partnerRatio'),
      gt('debtorPayLabel')   + ': ' + gt('debtorPay'),
      gt('partnerPayLabel')  + ': ' + gt('partnerPay'),
      'תשלום חודשי לתא משפחתי: ' + gt('finalPay'),
      '',
      'פרטי דו״ח:',
      'מס\' תיק: ' + (document.getElementById('caseId').value||'-'),
      'שם עורך/ת: ' + (document.getElementById('authorName').value||'-'),
      'הערה: ' + (document.getElementById('note').value||'-'),
      '',
      'הערה: נא לצרף ידנית את קובץ ה-PNG מהכפתור "צילום מסך".'
    ].join('\n');
    window.location.href = 'mailto:?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
  });

  // INIT
  refreshLabels(); calc();
})();
</script>
</body>
</html>
