<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --panel:#fff;
  --text:#333; --label:#555; --border:#ddd; --accent:#ee9b00;
  --resultbg:#e9f5f5; --danger:#ae2012; --blue:#0b72ff;
  --chip-bg:#f0f0f0; --chip-border:#cfcfcf; --chip-red:#e84a4a;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:'Heebo',sans-serif; background:var(--bg); color:var(--text);
  display:flex; justify-content:center; padding:18px;
}
#captureRoot{width:100%; max-width:1000px}
.calculator{
  background:#fff; border-radius:12px; overflow:hidden;
  box-shadow:0 4px 15px rgba(0,0,0,.1);
  display:grid; grid-template-columns:1fr 1fr;
}
header{
  grid-column:1 / -1; background:var(--primary); color:#fff;
  display:flex; gap:10px; justify-content:center; align-items:center;
  padding:14px 18px;
}
header h1{margin:0; font-size:1.6rem}
.update-tag{font-size:.9rem; background:rgba(255,255,255,.15); padding:4px 8px; border-radius:8px}

.inputs{padding:20px; border-left:1px solid var(--border)}
.results{padding:20px; background:var(--resultbg)}

h2.sec{margin:0 0 12px 0; color:var(--primary); border-bottom:2px solid var(--secondary); padding-bottom:6px; font-size:1.2rem}

.row2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.group{display:flex; flex-direction:column}
label{color:var(--label); font-weight:500; margin-bottom:6px}
input,select,textarea{
  width:100%; border:1px solid var(--border); border-radius:8px; padding:10px; font-size:1rem; background:#fff;
}
input:focus,select:focus,textarea:focus{outline:none; border-color:var(--secondary); box-shadow:0 0 0 3px rgba(10,147,150,.18)}
textarea{min-height:90px; resize:vertical}

/* chips */
.chips{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.chip{
  padding:8px 14px; border:1px solid var(--chip-border); border-radius:999px;
  background:var(--chip-bg); cursor:pointer; user-select:none; transition:.2s;
}
.chip input{display:none}
.chip.active{background:var(--secondary); color:#fff; border-color:var(--secondary)}
.chip.red.active{background:var(--chip-red); border-color:var(--chip-red); color:#fff}

/* collapses */
.collapse{border:1px solid var(--border); border-radius:10px; overflow:hidden}
.c-head{background:#fafafa; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer}
.c-body{display:none; padding:12px}
.collapse.open .c-body{display:block}

/* results */
.r-grid{display:grid; grid-template-columns:1fr 1fr; gap:16px; text-align:center}
.r-box .lbl{font-weight:500}
.r-box .val{font-weight:700; color:var(--accent)}
.r-mid{text-align:center; margin:10px 0}
.r-mid .val{color:var(--blue); font-size:1.3rem; font-weight:800}
.r-total{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-top:1px solid #d4e7e7}
.r-total .val{color:var(--danger); font-size:1.3rem; font-weight:800}
.zero-case{color:var(--secondary)!important}

/* action bar (desktop) */
.actions{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
.btn{border:1px solid #cbd5e1; background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px}
.btn:hover{background:#f8fafc}

/* mobile sticky */
.fab-wrap{display:none}
@media (max-width:768px){
  .calculator{grid-template-columns:1fr}
  .inputs{border-left:none}
  .row2{grid-template-columns:1fr}
  .actions{display:none}        /* ××™×Ÿ ×¡×¨×’×œ ×‘×“×¡×§×˜×•×¤ ×‘××•×‘×™×™×œ */
  .fab-wrap{display:flex; position:fixed; right:12px; left:12px; bottom:12px; gap:8px; z-index:9999;
    background:rgba(255,255,255,.92); border:1px solid var(--border); border-radius:14px; padding:8px 10px; box-shadow:0 10px 25px rgba(0,0,0,.15)}
  .fab{flex:1; border:1px solid #cbd5e1; border-radius:10px; background:#fff; padding:10px 12px; font-weight:700; cursor:pointer}
}
@media print{
  .btn,.fab-wrap{display:none!important}
  header{padding:10px}
  .results{background:#fff}
  input,select,textarea{border:none!important; box-shadow:none!important}
}
</style>
</head>
<body>

<div id="captureRoot">
  <div class="calculator" id="calculator">
    <header>
      <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
      <span class="update-tag">××¢×•×“×›×Ÿ ×œÖ¾<span id="yearTag"></span></span>
    </header>

    <!-- ×§×œ×˜ -->
    <div class="inputs">
      <h2 class="sec">×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>

      <!-- ×©×•×¨×ª ×¢×œ: ×¡×˜×˜×•×¡ + ××™ ×‘×”×œ×™×š -->
      <div class="row2" style="align-items:end">
        <div class="group">
          <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
          <select id="status">
            <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡...</option>
            <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
            <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
            <option value="×–×•×’">×–×•×’</option>
            <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
            <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
          </select>
        </div>

        <div class="group">
          <label>××™ ×‘×”×œ×™×š?</label>
          <div class="chips" id="chips">
            <label class="chip" id="chipMale"><input type="radio" name="debtor" id="debtorMale" checked>×—×™×™×‘</label>
            <label class="chip" id="chipFemale"><input type="radio" name="debtor" id="debtorFemale">×—×™×™×‘×ª</label>
            <label class="chip red" id="chipJoint"><input type="checkbox" id="jointProceeding">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š</label>
          </div>
        </div>
      </div>

      <h2 class="sec">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª (â‚ª)</h2>

      <div class="row2">
        <div class="group"><label id="salaryDebtorLabel">×”×›× ×¡×” (×—×™×™×‘)</label><input type="number" id="salaryDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×”"></div>
        <div class="group" id="salaryPartnerWrap"><label id="salaryPartnerLabel">×”×›× ×¡×” (×‘×ª ×–×•×’)</label><input type="number" id="salaryPartner" placeholder="×”×–×Ÿ ×”×›× ×¡×”"></div>
      </div>

      <div class="row2">
        <div class="group"><label id="otherDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label><input type="number" id="otherIncomeDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª"></div>
        <div class="group" id="otherPartnerWrap"><label id="otherPartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)</label><input type="number" id="otherIncomePartner" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª"></div>
      </div>

      <div class="collapse" id="collAllow">
        <div class="c-head" data-toggle="#collAllow"><span>×”×›× ×¡×•×ª ××§×¦×‘××•×ª</span><span>â–¼</span></div>
        <div class="c-body">
          <div class="row2">
            <div class="group"><label>×§×¦×‘×” (×—×™×™×‘/×ª)</label><input type="number" id="debtorAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”"></div>
            <div class="group" id="partnerAllowanceWrap"><label>×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label><input type="number" id="partnerAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”"></div>
          </div>
        </div>
      </div>

      <div class="collapse" id="collAlimony">
        <div class="c-head" data-toggle="#collAlimony"><span>×”×•×¦××•×ª ××–×•× ×•×ª</span><span>â–¼</span></div>
        <div class="c-body">
          <div class="group"><label>×”×•×¦××•×ª ××–×•× ×•×ª</label><input type="number" id="alimonyExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª"></div>
        </div>
      </div>

      <div class="row2">
        <div class="group"><label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label><input type="number" id="unusualExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª"></div>
        <div class="group"><label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label><input type="number" id="childcareExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª"></div>
      </div>
    </div>

    <!-- ×ª×•×¦××•×ª -->
    <div class="results">
      <!-- ×¡×¨×’×œ ×—××™×©×™×™×” ×‘×“×¡×§×˜×•×¤ -->
      <div class="actions">
        <button class="btn" id="btnShotDesk">ğŸ“¸ ×¦×™×œ×•× (PNG)</button>
        <button class="btn" id="btnPrintDesk">ğŸ–¨ï¸ ×”×“×¤×¡×”</button>
        <button class="btn" id="btnMailDesk">âœ‰ï¸ ×©×œ×— ××™×™×œ</button>
        <button class="btn" id="btnResetDesk">â†º ××™×¤×•×¡</button>
        <button class="btn" id="btnReportDesk">ğŸ“„ ×¤×¨×˜×™ ×“×•×´×—</button>
      </div>

      <!-- ×¤× ×œ ×¤×¨×˜×™ ×“×•×´×— (× ×¡×’×¨ ×›×‘×¨×™×¨×ª ××—×“×œ) -->
      <div class="collapse" id="reportPanel" style="display:none;margin-bottom:10px">
        <div class="c-head">
          <span>×¤×¨×˜×™ ×“×•×´×—</span>
          <button class="btn" id="btnToggleNote" style="margin:0">ğŸ—’ï¸ ×”×¢×¨×”</button>
        </div>
        <div class="c-body">
          <div class="row2">
            <div class="group"><label>××¡×³ ×ª×™×§</label><input type="text" id="caseId" placeholder="×œ×“×•×’××”: 12345/25"></div>
            <div class="group"><label>×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label><input type="text" id="authorName" placeholder="×©× ××œ×"></div>
          </div>
          <div class="row2">
            <div class="group"><label>×ª××¨×™×š</label><input type="text" id="calcDate" readonly></div>
          </div>
          <div class="collapse" id="notePanel" style="margin-top:10px">
            <div class="c-head" data-toggle="#notePanel"><span>×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</span><span>â–¼</span></div>
            <div class="c-body">
              <textarea id="calcNotes" maxlength="500" placeholder="×”×¢×¨×” ×§×¦×¨×”..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <h2 class="sec" style="margin-top:0">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

      <div class="r-grid">
        <div class="r-box"><div class="lbl">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div><div class="val" id="ssAllow">0 â‚ª</div></div>
        <div class="r-box"><div class="lbl">×¡×š ×”×›× ×¡×•×ª</div><div class="val" id="sumIncome">0 â‚ª</div></div>
      </div>

      <div class="r-grid" style="margin-top:10px">
        <div class="r-box"><div class="lbl">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div><div class="val" id="livingCost">0 â‚ª</div></div>
        <div class="r-box"><div class="lbl">×¡×š ×”×•×¦××•×ª</div><div class="val" id="sumExpenses">0 â‚ª</div></div>
      </div>

      <div class="r-mid">
        <div class="lbl">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</div>
        <div class="val" id="disposable">0 â‚ª</div>
      </div>

      <div class="r-grid">
        <div class="r-box"><div class="lbl" id="debtorRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘)</div><div class="val" id="debtorRatio">0%</div></div>
        <div class="r-box"><div class="lbl" id="partnerRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×ª ×–×•×’)</div><div class="val" id="partnerRatio">0%</div></div>
      </div>

      <div class="r-grid" style="margin-top:10px">
        <div class="r-box"><div class="lbl" id="debtorPayLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘)</div><div class="val" id="debtorPay">0 â‚ª</div></div>
        <div class="r-box"><div class="lbl" id="partnerPayLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×ª ×–×•×’)</div><div class="val" id="partnerPay">0 â‚ª</div></div>
      </div>

      <div class="r-total" style="margin-top:6px">
        <div class="lbl" id="familyPayLabel">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</div>
        <div class="val" id="familyPay">0 â‚ª</div>
      </div>
    </div>
  </div>
</div>

<!-- ××•×‘×™×™×œ: ×›×¤×ª×•×¨×™× ×¦×¤×™× -->
<div class="fab-wrap">
  <button class="fab" id="btnShot">ğŸ“¸ ×¦×™×œ×•×</button>
  <button class="fab" id="btnMail">âœ‰ï¸ ××™×™×œ</button>
  <button class="fab" id="btnReset">â†º ××™×¤×•×¡</button>
</div>

<script>
/* === ×™×™×‘×•× ×©× ×” ×•×ª××¨×™×š === */
document.getElementById('yearTag').textContent = new Date().getFullYear();
document.getElementById('calcDate').value = new Date().toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'});

/* === × ×ª×•× ×™× ×§×‘×•×¢×™× === */
const lookup = {
  "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“": { kids:0, livingCost:4556 },
  "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“": { kids:1, livingCost:6056 },
  "×–×•×’": { kids:0, livingCost:6024 },
  "×–×•×’+×™×œ×“": { kids:1, livingCost:7524 },
  "×–×•×’+ 2 ×™×œ×“×™×": { kids:2, livingCost:9024 },
  "×–×•×’+ 3 ×™×œ×“×™×": { kids:3, livingCost:10524 },
  "×–×•×’+ 4 ×™×œ×“×™×": { kids:4, livingCost:12024 },
  "×–×•×’+ 5 ×™×œ×“×™×": { kids:5, livingCost:13324 },
  "×–×•×’+ 6 ×™×œ×“×™×": { kids:6, livingCost:14624 },
  "×–×•×’+ 7 ×™×œ×“×™×": { kids:7, livingCost:15924 },
  "×–×•×’+ 8 ×™×œ×“×™×": { kids:8, livingCost:17224 },
  "×–×•×’+ 9 ×™×œ×“×™×": { kids:9, livingCost:18524 },
  "×–×•×’+ 10 ×™×œ×“×™×": { kids:10, livingCost:19824 }
};
const childAllow = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};
const fmt = n=>new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(+n||0);
const r10 = n=>Math.floor((+n||0)/10)*10;

/* === DOM ×§×™×¦×•×¨×™ ×“×¨×š === */
const $ = id=>document.getElementById(id);
const statusEl = $('status');
const chipMale=$('chipMale'), chipFemale=$('chipFemale'), chipJoint=$('chipJoint');
const debtorMale=$('debtorMale'), debtorFemale=$('debtorFemale'), jointEl=$('jointProceeding');

const salaryDebtor=$('salaryDebtor'), salaryPartner=$('salaryPartner');
const otherDebtor=$('otherIncomeDebtor'), otherPartner=$('otherIncomePartner');
const debtorAllowance=$('debtorAllowance'), partnerAllowance=$('partnerAllowance');
const unusual=$('unusualExpenses'), childcare=$('childcareExpenses'), alimony=$('alimonyExpenses');

const salaryPartnerWrap=$('salaryPartnerWrap'), otherPartnerWrap=$('otherPartnerWrap'), partnerAllowanceWrap=$('partnerAllowanceWrap');

const salaryDebtorLabel=$('salaryDebtorLabel'), salaryPartnerLabel=$('salaryPartnerLabel');
const otherDebtorLabel=$('otherDebtorLabel'), otherPartnerLabel=$('otherPartnerLabel');

const ssAllow=$('ssAllow'), sumIncome=$('sumIncome'), livingCost=$('livingCost'), sumExpenses=$('sumExpenses'),
      disposable=$('disposable'), debtorRatio=$('debtorRatio'), partnerRatio=$('partnerRatio'),
      debtorPay=$('debtorPay'), partnerPay=$('partnerPay'), familyPay=$('familyPay');

/* === ×¦×³×™×¤×™× â€“ ×‘×—×™×¨×” ×•×¢×™×¦×•×‘ === */
function refreshChips(){
  chipMale.classList.toggle('active', debtorMale.checked);
  chipFemale.classList.toggle('active', debtorFemale.checked);
  chipJoint.classList.toggle('active', jointEl.checked);
}
chipMale.addEventListener('click', ()=>{debtorMale.checked=true; debtorFemale.checked=false; refreshChips(); updateLabels(); calc();});
chipFemale.addEventListener('click', ()=>{debtorFemale.checked=true; debtorMale.checked=false; refreshChips(); updateLabels(); calc();});
chipJoint.addEventListener('click', ()=>{jointEl.checked=!jointEl.checked; refreshChips(); updateLabels(); calc();});

/* === ×ª×•×•×™×•×ª ×“×™× ××™×•×ª ×•×”×¡×ª×¨×•×ª === */
function updateLabels(){
  const st = statusEl.value||'';
  const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
  const male = debtorMale.checked;

  salaryPartnerWrap.style.display = isSingle ? 'none' : '';
  otherPartnerWrap.style.display  = isSingle ? 'none' : '';
  partnerAllowanceWrap.style.display = isSingle ? 'none' : '';

  salaryDebtorLabel.textContent = isSingle ? '×”×›× ×¡×” (×—×™×™×‘/×ª)' : male ? '×”×›× ×¡×” (×—×™×™×‘)' : '×”×›× ×¡×” (×—×™×™×‘×ª)';
  salaryPartnerLabel.textContent = isSingle ? '×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)' : male ? '×”×›× ×¡×” (×‘×ª ×–×•×’)' : '×”×›× ×¡×” (×‘×Ÿ ×–×•×’)';
  otherDebtorLabel.textContent   = isSingle ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)' : male ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)' : '×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘×ª)';
  otherPartnerLabel.textContent  = isSingle ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)' : male ? '×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×ª ×–×•×’)' : '×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ ×–×•×’)';

  $('debtorRatioLabel').textContent = `××—×•×– ×”×›× ×¡×” (${isSingle?'×—×™×™×‘/×ª':(male?'×—×™×™×‘':'×—×™×™×‘×ª')})`;
  $('partnerRatioLabel').textContent= `××—×•×– ×”×›× ×¡×” (${isSingle?'×‘×Ÿ/×‘×ª ×–×•×’':(male?'×‘×ª ×–×•×’':'×‘×Ÿ ×–×•×’')})`;
  $('debtorPayLabel').textContent   = `×ª×©×œ×•× ××•×¦×¢ (${isSingle?'×—×™×™×‘/×ª':(male?'×—×™×™×‘':'×—×™×™×‘×ª')})`;
  $('partnerPayLabel').textContent  = `×ª×©×œ×•× ××•×¦×¢ (${isSingle?'×‘×Ÿ/×‘×ª ×–×•×’':(male?'×‘×ª ×–×•×’':'×‘×Ÿ ×–×•×’')})`;
}

/* === ×—×™×©×•×‘ === */
function calc(){
  const st = statusEl.value||'';
  const data = lookup[st] || {kids:0,livingCost:0};
  const kids = data.kids, baseLC=data.livingCost;

  const sD=+salaryDebtor.value||0, sP=+salaryPartner.value||0;
  const oD=+otherDebtor.value||0,  oP=+otherPartner.value||0;
  const aD=+debtorAllowance.value||0, aP=+partnerAllowance.value||0;
  const un=+unusual.value||0, ch=+childcare.value||0, al=+alimony.value||0;

  const childA = childAllow[kids]||0;

  livingCost.textContent = fmt(baseLC);
  ssAllow.textContent = fmt(childA);

  const totalIncome = sD+sP+oD+oP+aD+aP+childA;
  sumIncome.textContent = fmt(totalIncome);

  const totalExp = baseLC+un+ch+al;
  sumExpenses.textContent = fmt(totalExp);

  const disp = totalIncome-totalExp;
  disposable.textContent = disp<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmt(disp);

  const totalForRatio = sD+oD+sP+oP;
  const rDeb = totalForRatio>0 ? (sD+oD)/totalForRatio : 0;
  const rPar = totalForRatio>0 ? (sP+oP)/totalForRatio : 0;
  debtorRatio.textContent = (rDeb*100).toFixed(1)+'%';
  partnerRatio.textContent = (rPar*100).toFixed(1)+'%';

  const propDeb = r10((disp * rDeb)/2);
  const propPar = r10((disp * rPar)/2);
  debtorPay.textContent = fmt(Math.max(0,propDeb));
  partnerPay.textContent= fmt(Math.max(0,propPar));

  const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');
  const isJoint = jointEl.checked && !isSingle;

  // "×ª×™×§ ××¤×¡" â€“ ×¨×§ ×× ×™×© ×”×›× ×¡×•×ª ××š ×•×¨×§ ××§×¦×‘××•×ª ×•×œ×—×™×™×‘ ××™×Ÿ ×”×›× ×¡×”/×”×›× ×¡×•×ª ××—×¨×•×ª
  const wagesAndOther = sD+sP+oD+oP;
  const allowancesOnly = (aD+aP+childA) > 0 && wagesAndOther === 0;

  let family = 0;
  if(isJoint){
    // × ×•×¡×—×”: (×“×™×¡×¤ / 2 - ×ª×©×œ×•× ×‘×ª/×‘×Ÿ ×–×•×’) * ×™×—×¡ ×—×™×™×‘  +  ×ª×©×œ×•× ×‘×ª/×‘×Ÿ ×–×•×’
    const baseHalf = Math.max(0, disp/2 - propPar);
    const debtorPort = r10(baseHalf * rDeb);
    family = Math.max(0, debtorPort + propPar);
  }else{
    family = Math.max(0, propDeb);
  }

  const famEl = familyPay;
  famEl.classList.remove('zero-case');
  if (allowancesOnly && sD+oD===0){  // ×¨×§ ×§×¦×‘××•×ª ×•×œ×—×™×™×‘ ××™×Ÿ ×”×›× ×¡×”
    famEl.textContent = '×ª×™×§ ××¤×¡';
    famEl.classList.add('zero-case');
  } else {
    famEl.textContent = fmt(family);
  }
}

/* === ××ª×§×¤×œ×™× === */
document.querySelectorAll('.c-head').forEach(h=>{
  h.addEventListener('click', e=>{
    const host = h.parentElement;
    if (host.id==='reportPanel' || h.id==='btnToggleNote') return; // ×× ×•×”×œ ×™×“× ×™×ª
    host.classList.toggle('open');
  });
});

/* === ××™×¨×•×¢×™× === */
document.querySelectorAll('input,select,textarea').forEach(el=>{
  el.addEventListener('input', ()=>{ updateLabels(); calc(); });
});
statusEl.addEventListener('change', ()=>{ updateLabels(); calc(); });

/* === ×¤×¨×˜×™ ×“×•×´×— / ×”×¢×¨×” === */
$('btnReportDesk').addEventListener('click', ()=>{
  const p = $('reportPanel');
  p.style.display = p.style.display==='none'?'block':'none';
  p.classList.add('open');
});
$('btnToggleNote').addEventListener('click', ()=>{
  $('notePanel').classList.toggle('open');
});

/* === ××™×¤×•×¡ === */
function doReset(){
  $('form').reset();
  $('collAllow').classList.remove('open');
  $('collAlimony').classList.remove('open');
  $('reportPanel').style.display='none';
  $('notePanel').classList.remove('open');
  debtorMale.checked=true; debtorFemale.checked=false; jointEl.checked=false;
  refreshChips(); updateLabels(); calc();
}
$('btnResetDesk').addEventListener('click', doReset);
$('btnReset').addEventListener('click', doReset);

/* === ×¦×™×œ×•× ×¢××•×“ ××—×“ (PNG) === */
async function shotOnePage(){
  const root = $('captureRoot');
  // ××¡×ª×™×¨×™× ×›×¤×ª×•×¨×™× ×¦×¤×™× ×‘×¦×™×œ×•×
  document.querySelector('.fab-wrap').style.visibility='hidden';
  const canvas = await html2canvas(root, {scale:1.3, useCORS:true, windowWidth:root.scrollWidth, windowHeight:root.scrollHeight});
  document.querySelector('.fab-wrap').style.visibility='';

  // ×”×ª×××” ×œ×¢××•×“ ××—×“: ×’×•×‘×” ×™×¢×“ ~ 1400px
  const MAX_H = 1400;
  const ratio = Math.min(1, MAX_H / canvas.height);
  const w = Math.round(canvas.width * ratio);
  const h = Math.round(canvas.height * ratio);
  const out = document.createElement('canvas');
  out.width = w; out.height = h;
  out.getContext('2d').drawImage(canvas, 0, 0, w, h);
  const url = out.toDataURL('image/png');

  const win = window.open('','_blank');
  win.document.write(`
    <html dir="rtl"><head><meta charset="utf-8">
    <title>×¦×™×œ×•× ××¡×š ×”××—×©×‘×•×Ÿ</title>
    <style>
      @page{size:A4 portrait; margin:8mm}
      body{margin:0; display:flex; justify-content:center; align-items:flex-start}
      img{width:100%; height:auto; max-height:98vh; page-break-inside:avoid}
    </style>
    </head><body>
      <img src="${url}" alt="capture">
      <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  win.document.close();
}
$('btnShotDesk').addEventListener('click', shotOnePage);
$('btnShot').addEventListener('click', shotOnePage);

/* === ×”×“×¤×¡×” ×¨×’×™×œ×” ×©×œ ×”×“×£ (×œ××™ ×©××¢×“×™×£) === */
$('btnPrintDesk').addEventListener('click', ()=>window.print());

/* === ××™×™×œ (mailto) ×¢× ×ª×§×¦×™×¨ â€“ ×œ×¦×¨×£ ×™×“× ×™×ª ××ª ×”-PNG ×©× ×©××¨) === */
function mailSummary(){
  const get = id=> (document.getElementById(id)?.textContent||'').trim();
  const subject = '××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ×ª×§×¦×™×¨';
  const body = [
    '××¦×•×¨×£ ×ª×§×¦×™×¨. × × ×œ×¦×¨×£ ×™×“× ×™×ª ××ª ×§×•×‘×¥ ×”-PNG ××”×›×¤×ª×•×¨ "×¦×™×œ×•×".',
    '',
    '×¡×™×›×•× ×ª×•×¦××•×ª:',
    `×¡×š ×”×›× ×¡×•×ª: ${get('sumIncome')}`,
    `×¡×š ×”×•×¦××•×ª: ${get('sumExpenses')}`,
    `×”×›× ×¡×” ×¤× ×•×™×”: ${get('disposable')}`,
    `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${get('debtorRatio')}`,
    `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${get('partnerRatio')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${get('debtorPay')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${get('partnerPay')}`,
    `×ª×©×œ×•× ×—×•×“×©×™: ${get('familyPay')}`
  ].join('\n');
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
$('btnMailDesk').addEventListener('click', mailSummary);
$('btnMail').addEventListener('click', mailSummary);

/* === ××ª×—×•×œ === */
refreshChips(); updateLabels(); calc();
</script>
</body>
</html>
