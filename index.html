<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>מחשבון חדלות פירעון</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary-color:#005f73;--secondary-color:#0a9396;--background-color:#f4f4f4;--container-bg:#fff;
    --text-color:#333;--label-color:#444;--border-color:#d6dee6;--accent-color:#ee9b00;--result-bg:#e9f5f5;
    --danger-color:#ae2012;--blue-color:#0b74ff;--muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{font-family:'Heebo',sans-serif;background:var(--background-color);color:var(--text-color);margin:0;padding:16px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
  .calculator-container{width:100%;max-width:1000px;background:var(--container-bg);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);overflow:hidden;display:grid;grid-template-columns:1fr 1fr}
  header{grid-column:1/-1;background:var(--primary-color);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:1.6em;line-height:1.2}
  .version{font-size:.8em;opacity:.95;margin-inline-start:.5rem;white-space:nowrap}
  /* קומפקטיזציה קלה בדסקטופ */
  @media(min-width:769px){
    header h1{font-size:1.5em}
    .inputs-column,.results-column{padding:18px}
  }

  .inputs-column{padding:22px;border-left:1px solid var(--border-color);background:#fff}
  .results-column{padding:22px;background:var(--result-bg)}
  .form-section{display:grid;gap:14px}
  .form-section h2{grid-column:1/-1;margin:0 0 6px 0;color:var(--primary-color);border-bottom:2px solid var(--secondary-color);padding-bottom:6px;font-size:1.25em}

  /* שדות */
  .input-group{display:flex;flex-direction:column;width:100%}
  .input-group label{font-weight:500;margin-bottom:6px;color:var(--label-color);display:flex;align-items:center;gap:.5rem;min-height:24px}
  .input-group input,.input-group select,.input-group textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.98em;background:#f7fbff;
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  .input-group textarea{min-height:80px;resize:vertical;background:#fff}
  .input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(10,147,150,.18);background:#fff}
  .input-group input.readonly-display{background:#eef3f7;font-weight:600;color:#1f3a5b}

  /* זוגות שדות – החייב/ת תמיד בשמאל, בן/בת זוג בימין */
  .input-pair-inline{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
  .input-group.debtor  {grid-column:1}
  .input-group.partner {grid-column:2}

  /* כפתורי בחירה “מי בהליך” ו”שני בני הזוג” */
  .top-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
  .debtor-selection-options{display:flex;gap:8px;flex-wrap:nowrap}
  .radio-button-label{background:#f3f4f6;border:1px solid #cfd8e3;padding:8px 14px;border-radius:18px;cursor:pointer;transition:background-color .2s,border-color .2s;color:#1f2937;font-weight:500}
  .radio-button-label.checked{background:#e8f0ff;color:#0b74ff;border-color:#99befc}
  .radio-button-input{display:none}
  #jointProceedingLabel{background:#fff2f2;border:1px solid #f3b4b4;padding:8px 14px;border-radius:18px;cursor:pointer;transition:background-color .2s,border-color .2s;font-weight:600;color:#8b0000}
  #jointProceedingLabel.checked{background:#ffdddd;border-color:#f19999}
  #jointProceeding{display:none}

  /* אייקון "?" */
  .info-btn{line-height:1;border:none;cursor:pointer;border-radius:50%;width:20px;height:20px;font-size:.85em;font-weight:700;display:inline-flex;align-items:center;justify-content:center;background:#eef6f6;color:#006d77;box-shadow:0 0 0 1px rgba(0,0,0,.06) inset}
  .info-btn:hover{background:#e1f0f0}
  .info-popover{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px 14px;font-size:.97em;direction:rtl;line-height:1.45}

  /* תוצאות */
  .results-section{padding:0}
  .results-section h2{margin:6px 0 14px 0;color:var(--primary-color);font-size:1.25em;text-align:center}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#fff;border:1px solid #dbe6ef;border-radius:10px;padding:10px 12px;text-align:center}
  .card .label{display:block;color:#334155;font-weight:600}
  .card .value{display:block;font-weight:800;font-size:1.15em;color:var(--accent-color);margin-top:4px}
  .card.total .value{color:var(--danger-color)}
  .disposable .value{color:var(--blue-color)}
  .hidden{display:none!important}

  /* פס פעולות עליון (דסקטופ) */
  .actions-bar{display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .action-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #cbd5e1;background:#ffffff;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.05)}
  .action-btn:hover{background:#f8fafc}
  .action-btn .ico{font-size:1.05em}
  .email-tip{display:none;background:#fff7d6;border:1px solid #ffe6a8;color:#3b2f00;border-radius:10px;padding:8px 10px;font-size:.9em;margin:0 auto 10px;max-width:560px}

  /* מתגי “קצבאות / מזונות” */
  .toggles-row{display:flex;gap:10px;flex-wrap:wrap}
  .toggle-btn{padding:8px 12px;border:1px dashed #b6c2cf;border-radius:10px;background:#fff;cursor:pointer}
  .toggle-btn.active{background:#f0faff;border-color:#8ecae6}

  /* פרטי דו"ח */
  .report-wrap{display:flex;justify-content:center;margin-top:8px}
  .report-toggle{border:none;background:none;color:#0b74ff;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px}
  .report-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center}
  .note-toggle{border:none;background:none;color:#8b5cf6;font-weight:700;cursor:pointer}
  .note-area{margin-top:6px}

  /* מובייל */
  @media(max-width:768px){
    .calculator-container{grid-template-columns:1fr}
    .inputs-column{border-left:none}
    .input-pair-inline{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
    .actions-sticky{position:sticky;bottom:0;z-index:30;background:#ffffffea;backdrop-filter:blur(4px);padding:8px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:space-between}
    .actions-bar{display:none}
    .results-column{padding-bottom:86px} /* שלא יסתיר את התשלום */
  }

  /* הדפסה לתמונה: החלון שנפתח משתמש בסטייל שלו; כאן רק למניעת גלילה אלמנטים */
  @media print{
    body{padding:0;background:#fff}
  }
</style>
</head>
<body>

<div class="calculator-container" id="calcRoot">
  <header>
    <h1>מחשבון צו תשלומים <span class="version">| מעודכן ל־<span id="currentYear"></span></span></h1>
  </header>

  <!-- עמודת קלט (שמאל) -->
  <div class="inputs-column">
    <form id="calculatorForm">

      <!-- סטטוס משפחתי – שורה נפרדת -->
      <section class="form-section">
        <div class="input-group">
          <label for="status">סטטוס משפחתי</label>
          <select id="status">
            <option value="" selected disabled>בחר סטטוס משפחתי…</option>
            <option value="יחיד/נשוי חי בנפרד">יחיד/נשוי חי בנפרד</option>
            <option value="רווק/גרוש/אלמן + ילד">רווק/גרוש/אלמן + ילד</option>
            <option value="זוג">זוג</option>
            <option value="זוג+ילד">זוג+ילד</option>
            <option value="זוג+ 2 ילדים">זוג+ 2 ילדים</option>
            <option value="זוג+ 3 ילדים">זוג+ 3 ילדים</option>
            <option value="זוג+ 4 ילדים">זוג+ 4 ילדים</option>
            <option value="זוג+ 5 ילדים">זוג+ 5 ילדים</option>
            <option value="זוג+ 6 ילדים">זוג+ 6 ילדים</option>
            <option value="זוג+ 7 ילדים">זוג+ 7 ילדים</option>
            <option value="זוג+ 8 ילדים">זוג+ 8 ילדים</option>
            <option value="זוג+ 9 ילדים">זוג+ 9 ילדים</option>
            <option value="זוג+ 10 ילדים">זוג+ 10 ילדים</option>
          </select>
        </div>
      </section>

      <!-- מי בהליך + שני בני הזוג בהליך -->
      <section class="form-section">
        <div class="top-row">
          <div class="debtor-selection-group" id="debtor-selection">
            <label style="margin-bottom:8px;">מי בהליך?</label>
            <div class="debtor-selection-options">
              <input class="radio-button-input" type="radio" id="debtor-male" name="debtor-gender" value="חייב" checked>
              <label class="radio-button-label" for="debtor-male">חייב</label>
              <input class="radio-button-input" type="radio" id="debtor-female" name="debtor-gender" value="חייבת">
              <label class="radio-button-label" for="debtor-female">חייבת</label>
            </div>
          </div>
          <label for="jointProceeding" id="jointProceedingLabel">שני בני הזוג בהליך?</label>
          <input type="checkbox" id="jointProceeding">
        </div>
      </section>

      <section class="form-section">
        <h2>הכנסות והוצאות התא המשפחתי (₪)</h2>

        <!-- שכר -->
        <div class="input-pair-inline" id="pair-salary">
          <div class="input-group debtor" id="salaryDebtorGroup">
            <label id="salaryDebtorLabel">
              <span class="label-text">הכנסה (חייב)</span>
              <button type="button" class="info-btn" aria-label="מידע על השדה"
                data-info='ממוצע נטו תלושי שכר<br>לחייב שלא עובד יקבע תשלום זמני של 150 ₪ ותשלום עתידי החל מ־3 חודשים קדימה עפ״י הכנסה רעיונית של שכר מינימום בסך 6,247 ₪'>?</button>
            </label>
            <input type="number" id="salaryDebtor" placeholder="הזן הכנסה" value="">
          </div>
          <div class="input-group partner" id="salaryPartnerGroup">
            <label id="salaryPartnerLabel">
              <span class="label-text">הכנסה (בת זוג)</span>
              <button type="button" class="info-btn" aria-label="מידע על השדה"
                data-info='ממוצע נטו תלושי שכר.<br>במקרה שבן/בת הזוג לא עובד/ת ייקבע תשלום מדורג לפי שכר מינימום 6,247 ₪'>?</button>
            </label>
            <input type="number" id="salaryPartner" placeholder="הזן הכנסה" value="">
          </div>
        </div>

        <!-- הכנסות אחרות -->
        <div class="input-pair-inline" id="pair-otherIncome">
          <div class="input-group debtor" id="otherIncomeDebtorGroup">
            <label id="otherIncomeDebtorLabel">הכנסות אחרות (חייב)</label>
            <input type="number" id="otherIncomeDebtor" placeholder="הזן הכנסות אחרות" value="">
          </div>
          <div class="input-group partner" id="otherIncomePartnerGroup">
            <label id="otherIncomePartnerLabel">הכנסות אחרות (בן/בת זוג)</label>
            <input type="number" id="otherIncomePartner" placeholder="הזן הכנסות אחרות" value="">
          </div>
        </div>

        <!-- מתגי קצבאות+מזונות Side by side -->
        <div class="toggles-row">
          <button type="button" id="allowanceButton" class="toggle-btn">קצבאות</button>
          <button type="button" id="alimonyButton"   class="toggle-btn">מזונות</button>
        </div>

        <!-- קצבאות (סגור ברירת מחדל) -->
        <div id="allowanceFields" class="hidden">
          <div class="input-pair-inline" id="pair-allowances" style="margin-top:8px">
            <div class="input-group debtor">
              <label for="debtorAllowance" id="debtorAllowanceLabel">קצבה (חייב/ת)</label>
              <input type="number" id="debtorAllowance" placeholder="הזן קצבה" value="">
            </div>
            <div class="input-group partner" id="partnerAllowanceGroup">
              <label for="partnerAllowance" id="partnerAllowanceLabel">קצבה (בן/בת זוג)</label>
              <input type="number" id="partnerAllowance" placeholder="הזן קצבה" value="">
            </div>
          </div>
        </div>

        <!-- הוצאות חריגות/צהרונים -->
        <div class="input-pair-inline" style="margin-top:6px">
          <div class="input-group">
            <label>הוצאות חריגות (רפואיות וכו')</label>
            <input type="number" id="unusualExpenses" placeholder="הזן הוצאות" value="">
          </div>
          <div class="input-group">
            <label>הוצאות טיפול וצהרונים</label>
            <input type="number" id="childcareExpenses" placeholder="הזן הוצאות" value="">
          </div>
        </div>

        <!-- מזונות (סגור ברירת מחדל) -->
        <div id="alimonyFields" class="hidden">
          <div class="input-pair-inline" style="margin-top:8px">
            <div class="input-group">
              <label for="alimonyExpenses">הוצאות מזונות</label>
              <input type="number" id="alimonyExpenses" placeholder="הזן הוצאות מזונות" value="">
            </div>
          </div>
        </div>

        <!-- פרטי דו"ח – מתחת למזונות באמצע -->
        <div class="report-wrap">
          <button type="button" id="reportToggle" class="report-toggle">📄 פרטי דו״ח</button>
        </div>
        <div id="reportPanel" class="hidden">
          <div class="report-row" style="margin-top:8px">
            <div class="input-group"><label for="caseId">מס' תיק</label><input type="text" id="caseId" placeholder="לדוגמה: 12345/25"></div>
            <div class="input-group"><label for="authorName">שם עורך/ת</label><input type="text" id="authorName" placeholder="שם מלא"></div>
            <div class="input-group"><label for="calcDate">תאריך</label><input type="text" id="calcDate" class="readonly-display" readonly></div>
            <button type="button" id="noteToggle" class="note-toggle" title="הערה">📌 הערה</button>
          </div>
          <div id="noteArea" class="note-area hidden">
            <div class="input-group">
              <label for="calcNotes">הערה (עד 500 תווים)</label>
              <textarea id="calcNotes" maxlength="500" placeholder="הערה חופשית…"></textarea>
            </div>
          </div>
        </div>

      </section>
    </form>
  </div>

  <!-- עמודת תוצאות (ימין) -->
  <div class="results-column">

    <!-- פס פעולות (דסקטופ) -->
    <div class="actions-bar">
      <button type="button" class="action-btn" id="shotBtn"><span class="ico">📸</span> צילום מסך</button>
      <button type="button" class="action-btn" id="emailBtn"><span class="ico">✉️</span> שלח במייל</button>
      <button type="button" class="action-btn" id="resetBtn"><span class="ico">↺</span> איפוס</button>
    </div>
    <div id="emailTip" class="email-tip">
      טיפ: שמור/י קודם את צילום המסך (כפתור “צילום מסך”), ואז צרפו ידנית את ה־PNG להודעת המייל שנפתחת.
    </div>

    <section class="results-section">
      <h2>תוצאות החישוב</h2>

      <div class="cards">
        <div class="card">
          <span class="label">קצבת ביטוח לאומי</span>
          <span class="value" id="socialSecurityAllowance">0 ₪</span>
        </div>
        <div class="card">
          <span class="label">סך הכנסות</span>
          <span class="value" id="totalIncomeResult">0 ₪</span>
        </div>

        <div class="card">
          <span class="label" id="livingCostLabel">דמי מחייה בכבוד</span>
          <span class="value" id="baseLivingCostResult">0 ₪</span>
        </div>
        <div class="card">
          <span class="label">סך הוצאות</span>
          <span class="value" id="totalExpensesResult">0 ₪</span>
        </div>

        <div class="card disposable">
          <span class="label">הכנסה פנויה לתא המשפחתי</span>
          <span class="value" id="disposableIncomeResult">0 ₪</span>
        </div>
        <div class="card">
          <span class="label" id="debtorIncomeRatioLabel">אחוז הכנסה (חייב)</span>
          <span class="value" id="debtorIncomeRatio">0%</span>
        </div>

        <div class="card">
          <span class="label" id="partnerIncomeRatioLabel">אחוז הכנסה (בן/בת זוג)</span>
          <span class="value" id="partnerIncomeRatio">0%</span>
        </div>
        <div class="card">
          <span class="label" id="debtorPaymentLabel">תשלום מוצע (חייב/ת)</span>
          <span class="value" id="debtorPaymentResult">0 ₪</span>
        </div>

        <div class="card" id="partnerPaymentCard">
          <span class="label" id="partnerPaymentLabel">תשלום מוצע (בן/בת זוג)</span>
          <span class="value" id="partnerPaymentResult">0 ₪</span>
        </div>
        <div class="card total" id="finalPaymentCard">
          <span class="label" id="finalPaymentLabel">תשלום חודשי לתא משפחתי</span>
          <span class="value" id="finalPaymentResult">0 ₪</span>
        </div>
      </div>
    </section>

    <!-- פס פעולות דביק (מובייל) -->
    <div class="actions-sticky">
      <button type="button" class="action-btn" id="shotBtn_m"><span class="ico">📸</span> צילום</button>
      <button type="button" class="action-btn" id="emailBtn_m"><span class="ico">✉️</span> מייל</button>
      <button type="button" class="action-btn" id="resetBtn_m"><span class="ico">↺</span> איפוס</button>
    </div>
  </div>
</div>

<!-- html2canvas לצילום -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // שנה בכותרת + תאריך דו"ח
  const currentYearEl = document.getElementById('currentYear');
  if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
  const calcDateEl = document.getElementById('calcDate');
  if(calcDateEl){ const now = new Date(); calcDateEl.value = now.toLocaleDateString('he-IL', {year:'numeric', month:'2-digit', day:'2-digit'}); }

  // נתוני בסיס
  const lookupData = {
    "יחיד/נשוי חי בנפרד": { kids: 0, livingCost: 4556 },
    "רווק/גרוש/אלמן + ילד": { kids: 1, livingCost: 6056 }, "זוג": { kids: 0, livingCost: 6024 },
    "זוג+ילד": { kids: 1, livingCost: 7524 }, "זוג+ 2 ילדים": { kids: 2, livingCost: 9024 },
    "זוג+ 3 ילדים": { kids: 3, livingCost: 10524 }, "זוג+ 4 ילדים": { kids: 4, livingCost: 12024 },
    "זוג+ 5 ילדים": { kids: 5, livingCost: 13324 }, "זוג+ 6 ילדים": { kids: 6, livingCost: 14624 },
    "זוג+ 7 ילדים": { kids: 7, livingCost: 15924 }, "זוג+ 8 ילדים": { kids: 8, livingCost: 17224 },
    "זוג+ 9 ילדים": { kids: 9, livingCost: 18524 }, "זוג+ 10 ילדים": { kids: 10, livingCost: 19824 }
  };
  const childAllowanceData = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

  // DOM refs
  const form = document.getElementById('calculatorForm');
  const inputs = form.querySelectorAll('input, select');

  const statusEl = document.getElementById('status');
  const debtorMaleEl = document.getElementById('debtor-male');
  const debtorFemaleEl = document.getElementById('debtor-female');
  const jointProceedingEl = document.getElementById('jointProceeding');
  const jointProceedingLabelEl = document.getElementById('jointProceedingLabel');

  const salaryDebtorEl = document.getElementById('salaryDebtor');
  const salaryPartnerEl = document.getElementById('salaryPartner');
  const otherIncomeDebtorEl = document.getElementById('otherIncomeDebtor');
  const otherIncomePartnerEl = document.getElementById('otherIncomePartner');
  const debtorAllowanceEl = document.getElementById('debtorAllowance');
  const partnerAllowanceEl = document.getElementById('partnerAllowance');
  const unusualExpensesEl = document.getElementById('unusualExpenses');
  const childcareExpensesEl = document.getElementById('childcareExpenses');
  const alimonyExpensesEl = document.getElementById('alimonyExpenses');

  const salaryDebtorLabelTextEl  = document.querySelector('#salaryDebtorLabel .label-text');
  const salaryPartnerLabelTextEl = document.querySelector('#salaryPartnerLabel .label-text');
  const otherIncomeDebtorLabelEl = document.getElementById('otherIncomeDebtorLabel');
  const otherIncomePartnerLabelEl = document.getElementById('otherIncomePartnerLabel');
  const debtorIncomeRatioLabelEl = document.getElementById('debtorIncomeRatioLabel');
  const partnerIncomeRatioLabelEl = document.getElementById('partnerIncomeRatioLabel');
  const debtorPaymentLabelEl = document.getElementById('debtorPaymentLabel');
  const partnerPaymentLabelEl = document.getElementById('partnerPaymentLabel');
  const debtorAllowanceLabelEl = document.getElementById('debtorAllowanceLabel');
  const partnerAllowanceLabelEl = document.getElementById('partnerAllowanceLabel');

  const baseLivingCostResultEl = document.getElementById('baseLivingCostResult');
  const socialSecurityAllowanceEl = document.getElementById('socialSecurityAllowance');
  const disposableIncomeResultEl = document.getElementById('disposableIncomeResult');
  const debtorIncomeRatioEl = document.getElementById('debtorIncomeRatio');
  const partnerIncomeRatioEl = document.getElementById('partnerIncomeRatio');
  const debtorPaymentResultEl = document.getElementById('debtorPaymentResult');
  const partnerPaymentResultEl = document.getElementById('partnerPaymentResult');
  const finalPaymentResultEl = document.getElementById('finalPaymentResult');
  const finalPaymentLabelEl = document.getElementById('finalPaymentLabel');

  const partnerPaymentCard = document.getElementById('partnerPaymentCard');
  const finalPaymentCard = document.getElementById('finalPaymentCard');

  const allowanceBtn = document.getElementById('allowanceButton');
  const allowanceFields = document.getElementById('allowanceFields');
  const alimonyBtn = document.getElementById('alimonyButton');
  const alimonyFields = document.getElementById('alimonyFields');

  const reportToggle = document.getElementById('reportToggle');
  const reportPanel = document.getElementById('reportPanel');
  const noteToggle = document.getElementById('noteToggle');
  const noteArea = document.getElementById('noteArea');

  // פעולות
  const shotBtns = [document.getElementById('shotBtn'), document.getElementById('shotBtn_m')];
  const emailBtns = [document.getElementById('emailBtn'), document.getElementById('emailBtn_m')];
  const resetBtns = [document.getElementById('resetBtn'), document.getElementById('resetBtn_m')];
  const emailTip = document.getElementById('emailTip');

  const formatCurrency = (v)=> (typeof v!=='number'||isNaN(v)) ? '0 ₪' :
    new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(v);
  const round10 = (n)=> Math.floor(n/10)*10;

  function updateLabelsAndUI(){
    const status = statusEl.value || '';
    const isSingle = status.includes('יחיד') || status.includes('רווק');
    const isMaleDebtor = debtorMaleEl.checked;
    const isJoint = jointProceedingEl.checked;

    // צבע לכפתורי “מי בהליך”
    document.querySelectorAll('.radio-button-label').forEach(l=>l.classList.remove('checked'));
    if(debtorMaleEl.checked) document.querySelector('label[for="debtor-male"]').classList.add('checked');
    if(debtorFemaleEl.checked) document.querySelector('label[for="debtor-female"]').classList.add('checked');
    jointProceedingLabelEl.classList.toggle('checked', isJoint);

    // תוויות
    let debtorText, partnerText;
    if(isSingle){ debtorText='חייב/ת'; partnerText='בן/בת זוג'; }
    else if(isMaleDebtor){ debtorText='חייב'; partnerText='בת זוג'; }
    else{ debtorText='חייבת'; partnerText='בן זוג'; }

    if (salaryDebtorLabelTextEl)  salaryDebtorLabelTextEl.textContent  = isSingle ? 'הכנסה (חייב/ת)' : (isMaleDebtor?'הכנסה (חייב)':'הכנסה (חייבת)');
    if (salaryPartnerLabelTextEl) salaryPartnerLabelTextEl.textContent = isSingle ? 'הכנסה (בן/בת זוג)' : (isMaleDebtor?'הכנסה (בת זוג)':'הכנסה (בן זוג)');
    otherIncomeDebtorLabelEl.textContent  = `הכנסות אחרות (${debtorText})`;
    otherIncomePartnerLabelEl.textContent = `הכנסות אחרות (${partnerText})`;
    debtorIncomeRatioLabelEl.textContent  = `אחוז הכנסה (${debtorText})`;
    partnerIncomeRatioLabelEl.textContent = `אחוז הכנסה (${partnerText})`;
    debtorPaymentLabelEl.textContent      = `תשלום מוצע (${debtorText})`;
    partnerPaymentLabelEl.textContent     = `תשלום מוצע (${partnerText})`;
    if (debtorAllowanceLabelEl)  debtorAllowanceLabelEl.textContent  = `קצבה (${debtorText})`;
    if (partnerAllowanceLabelEl) partnerAllowanceLabelEl.textContent = `קצבה (${partnerText})`;

    // הצגת קלפים בהתאם למצב "שני בני הזוג"
    partnerPaymentCard.classList.toggle('hidden', !isJoint);
    finalPaymentCard.classList.toggle('hidden', !isJoint);
    finalPaymentLabelEl.textContent = isJoint ? 'תשלום חודשי לתא משפחתי' : 'תשלום חודשי (חייב/ת)';
  }

  function calculate(){
    const status = statusEl.value || '';
    const isJoint = jointProceedingEl.checked;
    const isSingle = status.includes('יחיד') || status.includes('רווק');

    const salD = parseFloat(salaryDebtorEl.value)||0;
    const salP = parseFloat(salaryPartnerEl.value)||0;
    const othD = parseFloat(otherIncomeDebtorEl.value)||0;
    const othP = parseFloat(otherIncomePartnerEl.value)||0;
    const allD = parseFloat(debtorAllowanceEl.value)||0;
    const allP = parseFloat(partnerAllowanceEl.value)||0;
    const expU = parseFloat(unusualExpensesEl.value)||0;
    const expC = parseFloat(childcareExpensesEl.value)||0;
    const expA = parseFloat(alimonyExpensesEl.value)||0;

    const stData = lookupData[status] || {kids:0,livingCost:0};
    const baseLiving = stData.livingCost;
    const childAll   = childAllowanceData[stData.kids] || 0;

    baseLivingCostResultEl.textContent = formatCurrency(baseLiving);
    socialSecurityAllowanceEl.textContent = formatCurrency(childAll);

    const ratioDen = salD + salP + othD + othP;
    const ratioD = ratioDen>0 ? (salD+othD)/ratioDen : 0;
    const ratioP = ratioDen>0 ? (salP+othP)/ratioDen : 0;

    debtorIncomeRatioEl.textContent  = (ratioD*100).toFixed(1)+'%';
    partnerIncomeRatioEl.textContent = (ratioP*100).toFixed(1)+'%';

    const totalIncome = salD+salP+othD+othP+allD+allP+childAll;
    const totalExpenses = baseLiving + expU + expC + expA;
    const disposable = totalIncome - totalExpenses;

    document.getElementById('totalIncomeResult').textContent = formatCurrency(totalIncome);
    document.getElementById('totalExpensesResult').textContent = formatCurrency(totalExpenses);
    disposableIncomeResultEl.textContent = disposable<0 ? 'אין הכנסה פנויה' : formatCurrency(disposable);

    // תשלומים מוצעים (כל אחד חצי מהחלק היחסי)
    const debtorProposal = ratioD>0 ? round10((disposable*ratioD)/2) : 0;
    const partnerProposal= ratioP>0 ? round10((disposable*ratioP)/2) : 0;
    debtorPaymentResultEl.textContent  = formatCurrency(Math.max(0,debtorProposal));
    partnerPaymentResultEl.textContent = formatCurrency(Math.max(0,partnerProposal));

    // "תיק אפס" – אך ורק הכנסות מקצבאות, ולחייב אין שום הכנסה; אם טופס ריק => 0 ₪
    const incomesOnlyAllowances = (salD+salP+othD+othP)===0 && (allD+allP+childAll)>0;
    const formEmpty = totalIncome===0 && totalExpenses===0;
    let finalPayment = 0;
    let finalText = '';
    let finalIsCaseZero = false;

    if (isJoint){
      // נוסחה המעודכנת: (דיספ/2 - תשלום בן/בת זוג) * יחס חייב + תשלום בן/בת זוג
      const half = disposable/2;
      const base = Math.max(0, half - partnerProposal);
      finalPayment = round10(base * ratioD + partnerProposal);
      finalText = formatCurrency(Math.max(0,finalPayment));
    } else {
      // יחיד/ה – מציגים את תשלום החייב/ת
      finalPayment = Math.max(0,debtorProposal);
      if (incomesOnlyAllowances && !formEmpty && salD===0 && othD===0){
        finalIsCaseZero = true;
        finalText = 'תיק אפס';
      } else {
        finalText = formatCurrency(finalPayment);
      }
    }

    finalPaymentResultEl.textContent = finalText;
    finalPaymentResultEl.style.color = finalIsCaseZero ? '#8b0000' : (isJoint ? 'var(--danger-color)' : 'var(--danger-color)');
    finalPaymentResultEl.style.fontWeight = finalIsCaseZero ? '900' : '700';
  }

  // פופאבר "?"
  let currentPopover=null,currentBtn=null;
  function closePopover(){ if(currentPopover){ currentPopover.remove(); currentPopover=null; if(currentBtn) currentBtn.setAttribute('aria-expanded','false'); currentBtn=null; } }
  function openPopover(btn){
    const raw = btn.getAttribute('data-info') || '';
    if(!raw) return;
    if(currentBtn===btn){ closePopover(); return; }
    closePopover();
    const pop=document.createElement('div'); pop.className='info-popover'; pop.innerHTML = raw;
    document.body.appendChild(pop);
    const rect=btn.getBoundingClientRect();
    const top=rect.bottom+window.scrollY+8;
    const right=(window.innerWidth-rect.right)+8;
    pop.style.top=top+'px'; pop.style.right=right+'px';
    currentPopover=pop; currentBtn=btn; btn.setAttribute('aria-expanded','true');
  }
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.info-btn');
    if(btn){ openPopover(btn); return; }
    if(currentPopover && !e.target.closest('.info-popover')) closePopover();
  });
  window.addEventListener('scroll',closePopover,{passive:true});
  window.addEventListener('resize',closePopover);

  // טוגלים
  allowanceBtn.addEventListener('click', ()=>{
    allowanceBtn.classList.toggle('active');
    allowanceFields.classList.toggle('hidden');
  });
  alimonyBtn.addEventListener('click', ()=>{
    alimonyBtn.classList.toggle('active');
    alimonyFields.classList.toggle('hidden');
  });
  reportToggle.addEventListener('click', ()=> reportPanel.classList.toggle('hidden'));
  noteToggle.addEventListener('click', ()=> noteArea.classList.toggle('hidden'));

  // עדכונים
  inputs.forEach(el=> el.addEventListener('input', ()=>{ updateLabelsAndUI(); calculate(); }));
  [statusEl, debtorMaleEl, debtorFemaleEl, jointProceedingEl].forEach(el=> el.addEventListener('change', ()=>{ updateLabelsAndUI(); calculate(); }));

  // כפתורי פעולות
  function doShot(){
    const node=document.getElementById('calcRoot');
    const isMobile = window.matchMedia('(max-width: 768px)').matches;

    html2canvas(node,{
      useCORS:true,backgroundColor:'#ffffff',
      scale:2,
      scrollY:-window.scrollY,
      windowWidth:document.documentElement.scrollWidth,
      windowHeight:document.documentElement.scrollHeight
    }).then(canvas=>{
      if(!isMobile){
        // דסקטופ – תמונה אחת, עמוד אחד
        const data=canvas.toDataURL('image/png');
        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="utf-8"><title>צילום מחשבון</title>
          <style>html,body{margin:0;padding:0} img{display:block;width:100%;height:auto;page-break-after:always}
          @media print{ @page{size:A4; margin:5mm} img{width:100%;height:auto} }</style></head>
          <body><img src="${data}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      } else {
        // מובייל – מפצלים לשני דפים
        const halfH = Math.ceil(canvas.height/2);
        const can1 = document.createElement('canvas'); can1.width=canvas.width; can1.height=halfH;
        const can2 = document.createElement('canvas'); can2.width=canvas.width; can2.height=canvas.height-halfH;
        const ctx1=can1.getContext('2d'); const ctx2=can2.getContext('2d');
        ctx1.drawImage(canvas,0,0,canvas.width,halfH,0,0,canvas.width,halfH);
        ctx2.drawImage(canvas,0,halfH,canvas.width,canvas.height-halfH,0,0,canvas.width,canvas.height-halfH);
        const data1=can1.toDataURL('image/png'); const data2=can2.toDataURL('image/png');

        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="utf-8"><title>צילום מחשבון (מובייל)</title>
          <style>html,body{margin:0;padding:0} img{display:block;width:100%;height:auto}
          @media print{ @page{size:A4; margin:5mm} img{page-break-after:always} }</style></head>
          <body><img src="${data1}"><img src="${data2}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      }
    });
  }
  function doEmail(){
    emailTip.style.display='block';
    const getTxt = id => (document.getElementById(id)?.textContent || '').trim();
    const caseId = (document.getElementById('caseId')?.value || '').trim();
    const author = (document.getElementById('authorName')?.value || '').trim();
    const dateStr= (document.getElementById('calcDate')?.value || '').trim();
    const notes  = (document.getElementById('calcNotes')?.value || '').trim();

    const subject=`מחשבון צו תשלומים – ${caseId?('תיק '+caseId):'ללא מספר תיק'}`;
    const lines = [
      'שלום,','',
      'מצורף צילום מסך של תוצאות החישוב (נא לצרף את קובץ ה-PNG שנשמר/הודפס).','',
      'פרטי דו״ח:',
      `מס׳ תיק: ${caseId || '-'}`,
      `עורך/ת: ${author || '-'}`,
      `תאריך: ${dateStr || '-'}`,
      notes? `הערה: ${notes}` : '',
      '',
      'תקציר תוצאות:',
      `סך הכנסות: ${getTxt('totalIncomeResult')}`,
      `סך הוצאות: ${getTxt('totalExpensesResult')}`,
      `הכנסה פנויה: ${getTxt('disposableIncomeResult')}`,
      `אחוז הכנסה (חייב/ת): ${getTxt('debtorIncomeRatio')}`,
      `אחוז הכנסה (בן/בת זוג): ${getTxt('partnerIncomeRatio')}`,
      `תשלום מוצע (חייב/ת): ${getTxt('debtorPaymentResult')}`,
      `תשלום מוצע (בן/בת זוג): ${getTxt('partnerPaymentResult')}`,
      `תשלום חודשי לתא משפחתי: ${getTxt('finalPaymentResult')}`,
      '', 'בברכה'
    ].filter(Boolean).join('\n');

    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(lines)}`;
  }
  function doReset(){
    form.reset();
    // לנקות מצבים
    allowanceFields.classList.add('hidden');
    alimonyFields.classList.add('hidden');
    allowanceBtn.classList.remove('active');
    alimonyBtn.classList.remove('active');
    reportPanel.classList.add('hidden');
    noteArea.classList.add('hidden');
    document.getElementById('debtor-male').checked = true;
    updateLabelsAndUI(); calculate();
  }

  shotBtns.forEach(b=> b && b.addEventListener('click', doShot));
  emailBtns.forEach(b=> b && b.addEventListener('click', doEmail));
  resetBtns.forEach(b=> b && b.addEventListener('click', doReset));

  // Init
  updateLabelsAndUI();
  calculate();
});
</script>
</body>
</html>
