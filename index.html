<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מחשבון חדלות פירעון</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#005f73;--secondary:#0a9396;--bg:#f4f4f4;--card:#fff;--text:#333;--label:#555;--border:#ddd;
      --accent:#ee9b00;--resultbg:#e9f5f5;--danger:#ae2012;--blue:#007bff;--muted:#6c757d;--hint:#fff7d6
    }
    body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0}
    .calculator-container{width:100%;max-width:1100px;margin:0 auto;background:var(--card);box-shadow:0 4px 15px rgba(0,0,0,.1);display:grid;grid-template-columns:1fr 1fr;gap:0}
    header{grid-column:1/-1;background:var(--primary);color:#fff;padding:18px 24px;display:flex;align-items:center;gap:10px}
    header h1{margin:0;font-size:1.8rem}
    header .version{font-size:.95rem;font-weight:500;opacity:.9;margin-right:8px}
    .inputs-column{padding:24px;border-left:1px solid var(--border)}
    .results-column{padding:24px;background:var(--resultbg)}
    .form-section{display:grid;gap:18px}
    .form-section h2{grid-column:1/-1;margin:2px 0 8px;color:var(--primary);border-bottom:2px solid var(--secondary);padding-bottom:8px;font-size:1.2rem}
    .input-group{display:flex;flex-direction:column;gap:8px}
    .input-group.inline{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .input-group label{color:var(--label);font-weight:500}
    input,select{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:1rem;transition:.2s}
    input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(10,147,150,.18)}
    .radio-wrap{display:flex;gap:10px}
    .chip{background:#f0f0f0;border:1px solid #ccc;padding:8px 14px;border-radius:20px;cursor:pointer;transition:.2s}
    .chip.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .chip.danger.active{background:var(--danger);border-color:var(--danger)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    /* זוג שדות: חייב/ת מימין, בן/בת זוג משמאל */
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .pair .debtor{grid-column:2}
    .pair .partner{grid-column:1}
    /* תוצאות */
    .results-section h2{margin:0 0 14px;text-align:center}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #d4e7e7}
    .row:last-child{border-bottom:none}
    .row.side{display:grid;grid-template-columns:1fr 1fr;gap:18px;text-align:center}
    .row .label{font-weight:500}
    .row .value{font-weight:700;color:var(--accent)}
    .row .value.big{color:var(--blue);font-size:1.4rem}
    .row.total .value{color:var(--danger);font-size:1.4rem}
    /* עזרה "?" */
    .help-wrap{position:relative;display:flex;align-items:center;gap:8px}
    .help-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--secondary);color:var(--secondary);font-size:.85rem;cursor:pointer}
    .help-bubble{position:absolute;top:28px;inset-inline-start:0;z-index:5;background:var(--hint);border:1px solid #ffe08a;color:#7a5d00;padding:10px 12px;border-radius:10px;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,.08);display:none}
    .help-wrap.open .help-bubble{display:block}
    /* אזור פעולות ובלוקים מתקפלים */
    .actions{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .icon-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #cfd8dc;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .icon-btn:hover{background:#f7f7f7}
    .muted{color:var(--muted);font-size:.9rem}
    .tip{display:none;background:var(--hint);border:1px solid #ffe08a;color:#7a5d00;padding:10px 12px;border-radius:10px;margin:10px 0}
    .collapsible{margin:10px 0}
    .collapsible .hdr{display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600}
    .collapsible .panel{display:none;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px}
    .collapsible.open .panel{display:block}
    .note-text{width:100%;min-height:70px;resize:vertical}
    .char-counter{font-size:.85rem;color:var(--muted);text-align:start;margin-top:6px}
    /* התראת שכר מינימום */
    #special-note{background:#fff7d6;border:1px solid #ffe08a;color:#7a5d00;padding:12px;border-radius:10px;margin-top:16px;display:none}
    /* הדפסה */
    .print-only{display:none}
    .no-print{}
    @media print{
      .no-print{display:none !important}
      .print-only{display:block !important}
      body{background:#fff}
      .results-column{background:#fff}
      .calculator-container{box-shadow:none}
    }
    @media (max-width:820px){
      .calculator-container{grid-template-columns:1fr}
      .inputs-column{border-left:none}
      .pair{grid-template-columns:1fr}
      .pair .debtor,.pair .partner{grid-column:auto}
    }
  </style>
</head>
<body>

  <div class="calculator-container">
    <header>
      <span class="version" id="versionTag"></span>
      <h1>מחשבון צו תשלומים</h1>
    </header>

    <!-- עמודה שמאלית – תוצאות + פעולות -->
    <div class="results-column">
      <!-- פעולות + בלוקים מתקפלים -->
      <div class="actions no-print">
        <button id="printBtn" class="icon-btn" type="button">🖨️ PDF</button>
        <button id="mailBtn" class="icon-btn" type="button">✉️ שלח מייל</button>
        <button id="toggleReportBtn" class="icon-btn" type="button">📄 פרטי הדו"ח</button>
        <button id="toggleNoteBtn" class="icon-btn" type="button">📝 הערה</button>
      </div>

      <!-- טיפ מייל (מופיע רק אחרי לחיצה) -->
      <div id="emailTip" class="tip no-print">
        טיפ: דפדפנים לא מאפשרים לצרף PDF אוטומטית למייל. מומלץ להדפיס קודם ל-PDF ואז לצרף ידנית למייל.
      </div>

      <!-- פרטי הדו"ח – מתקפל -->
      <div id="reportBlock" class="collapsible no-print">
        <div class="hdr">📄 פרטי הדו"ח</div>
        <div class="panel">
          <div class="grid-2">
            <div class="input-group">
              <label>מס’ תיק</label>
              <input id="caseId" placeholder="לדוגמה: 12345/25">
            </div>
            <div class="input-group">
              <label>שם עורך/ת החישוב</label>
              <input id="preparer" placeholder="שם מלא">
            </div>
          </div>
          <div class="input-group" style="max-width:220px">
            <label>תאריך</label>
            <input id="reportDate" readonly>
          </div>
        </div>
      </div>

      <!-- הערה – מתקפל -->
      <div id="noteBlock" class="collapsible no-print">
        <div class="hdr">📝 הערה (עד 500 תווים)</div>
        <div class="panel">
          <textarea id="noteText" class="note-text" maxlength="500" placeholder="ניתן לרשום כאן הבחנות/הבהרות וכו’…"></textarea>
          <div class="char-counter"><span id="noteCount">0</span>/500</div>
        </div>
      </div>

      <!-- תקציר להדפסה/ייצוא – נבנה דינמית ומוצג רק בהדפסה -->
      <div id="exportSummary" class="print-only"></div>

      <!-- תוצאות -->
      <section class="results-section">
        <h2>תוצאות החישוב</h2>

        <div class="row side">
          <div>
            <div class="label">קצבת ביטוח לאומי:</div>
            <div class="value" id="socialSecurityAllowance">₪ 0</div>
          </div>
          <div>
            <div class="label">סך הכנסות:</div>
            <div class="value" id="totalIncomeResult">₪ 0</div>
          </div>
        </div>

        <div class="row side">
          <div>
            <div class="label" id="livingCostLabel">דמי מחייה בכבוד:</div>
            <div class="value" id="baseLivingCostResult">₪ 0</div>
          </div>
          <div>
            <div class="label">סך הוצאות:</div>
            <div class="value" id="totalExpensesResult">₪ 0</div>
          </div>
        </div>

        <div class="row" style="display:block;text-align:center">
          <div class="label">הכנסה פנויה לתא המשפחתי:</div>
          <div class="value big" id="disposableIncomeResult">₪ 0</div>
        </div>

        <div class="row side">
          <div>
            <div class="label" id="debtorIncomeRatioLabel">אחוז הכנסה (חייב):</div>
            <div class="value" id="debtorIncomeRatio">0%</div>
          </div>
          <div>
            <div class="label" id="partnerIncomeRatioLabel">אחוז הכנסה (בת זוג):</div>
            <div class="value" id="partnerIncomeRatio">0%</div>
          </div>
        </div>

        <div class="row side" id="proposedPaymentsDisplay">
          <div>
            <div class="label" id="debtorPaymentLabel">תשלום מוצע (חייב):</div>
            <div class="value" id="debtorPaymentResult">₪ 0</div>
          </div>
          <div>
            <div class="label" id="partnerPaymentLabel">תשלום מוצע (בת זוג):</div>
            <div class="value" id="partnerPaymentResult">₪ 0</div>
          </div>
        </div>

        <div class="row total" id="finalPaymentDisplay">
          <div class="label">תשלום חודשי לתא משפחתי:</div>
          <div class="value" id="finalPaymentResult">₪ 0</div>
        </div>
      </section>

      <!-- התראת שכר מינימום -->
      <div id="special-note">
        <strong>הערה:</strong> לחייב שלא עובד יקבע תשלום זמני של 150 ₪ ותשלום עתידי החל מ-3 חודשים קדימה עפ"י הכנסה רעיונית של שכר מינימום בסך 6,247.67 ש"ח.
      </div>
    </div>

    <!-- עמודה ימנית – קלטים -->
    <div class="inputs-column">
      <form id="calculatorForm">
        <section class="form-section">
          <h2>פרטי התא המשפחתי</h2>
          <div class="grid-2">
            <div class="input-group">
              <label class="muted">סטטוס משפחתי</label>
              <select id="status">
                <option value="" selected disabled>בחר סטטוס…</option>
                <option value="יחיד/נשוי חי בנפרד">יחיד/נשוי חי בנפרד</option>
                <option value="רווק/גרוש/אלמן + ילד">רווק/גרוש/אלמן + ילד</option>
                <option value="זוג">זוג</option>
                <option value="זוג+ילד">זוג+ילד</option>
                <option value="זוג+ 2 ילדים">זוג+ 2 ילדים</option>
                <option value="זוג+ 3 ילדים">זוג+ 3 ילדים</option>
                <option value="זוג+ 4 ילדים">זוג+ 4 ילדים</option>
                <option value="זוג+ 5 ילדים">זוג+ 5 ילדים</option>
                <option value="זוג+ 6 ילדים">זוג+ 6 ילדים</option>
                <option value="זוג+ 7 ילדים">זוג+ 7 ילדים</option>
                <option value="זוג+ 8 ילדים">זוג+ 8 ילדים</option>
                <option value="זוג+ 9 ילדים">זוג+ 9 ילדים</option>
                <option value="זוג+ 10 ילדים">זוג+ 10 ילדים</option>
              </select>
            </div>

            <div class="input-group">
              <label class="muted">מי בהליך?</label>
              <div class="radio-wrap">
                <label class="chip" id="chip-m">חייב<input type="radio" name="debtor-gender" id="debtor-male" style="display:none" checked></label>
                <label class="chip" id="chip-f">חייבת<input type="radio" name="debtor-gender" id="debtor-female" style="display:none"></label>
                <label class="chip danger" id="chip-both">שני בני הזוג בהליך?<input type="checkbox" id="jointProceeding" style="display:none"></label>
              </div>
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2>(₪) הכנסות והוצאות התא המשפחתי</h2>

          <!-- הכנסה -->
          <div class="pair">
            <div class="input-group partner" id="salaryPartnerGroup">
              <label class="help-wrap">
                <span id="salaryPartnerLabel">הכנסה (בת זוג)</span>
                <span class="help-icon" data-help="partner-salary">?</span>
                <span class="help-bubble">ממוצע נטו תלושי שכר.<br>במקרה שבן/בת הזוג לא עובד/ת ייקבע תשלום מדורג לפי הכנסה רעיונית של שכר מינימום בסך 6,247 ש"ח.</span>
              </label>
              <input type="number" id="salaryPartner" placeholder="הזן הכנסה">
            </div>
            <div class="input-group debtor" id="salaryDebtorGroup">
              <label class="help-wrap">
                <span id="salaryDebtorLabel">הכנסה (חייב)</span>
                <span class="help-icon" data-help="debtor-salary">?</span>
                <span class="help-bubble">ממוצע נטו תלושי שכר.<br>לחייב/ת שלא עובד/ת יקבע תשלום זמני 150 ₪ ותשלום עתידי מהחודש ה-3 לפי הכנסה רעיונית של שכר מינימום 6,247 ש"ח.</span>
              </label>
              <input type="number" id="salaryDebtor" placeholder="הזן הכנסה">
            </div>
          </div>

          <!-- הכנסות אחרות -->
          <div class="pair">
            <div class="input-group partner" id="otherIncomePartnerGroup">
              <label id="otherIncomePartnerLabel">הכנסות אחרות (בת זוג)</label>
              <input type="number" id="otherIncomePartner" placeholder="הזן הכנסות אחרות">
            </div>
            <div class="input-group debtor" id="otherIncomeDebtorGroup">
              <label id="otherIncomeDebtorLabel">הכנסות אחרות (חייב)</label>
              <input type="number" id="otherIncomeDebtor" placeholder="הזן הכנסות אחרות">
            </div>
          </div>

          <!-- קצבאות (מתקפל בלחצן) -->
          <div class="input-group">
            <button type="button" id="allowanceButton" class="icon-btn">הכנסות מקצבאות</button>
          </div>
          <div id="allowanceFields" style="display:none">
            <div class="pair">
              <div class="input-group partner" id="partnerAllowanceGroup">
                <label id="partnerAllowanceLabel">קצבה (בן/בת זוג)</label>
                <input type="number" id="partnerAllowance" placeholder="הזן קצבה">
              </div>
              <div class="input-group debtor">
                <label id="debtorAllowanceLabel">קצבה (חייב/ת)</label>
                <input type="number" id="debtorAllowance" placeholder="הזן קצבה">
              </div>
            </div>
          </div>

          <hr>

          <div class="pair">
            <div class="input-group">
              <label>הוצאות חריגות (רפואיות וכו’)</label>
              <input type="number" id="unusualExpenses" placeholder="הזן הוצאות">
            </div>
            <div class="input-group">
              <label>הוצאות טיפול וצהרונים</label>
              <input type="number" id="childcareExpenses" placeholder="הזן הוצאות">
            </div>
          </div>

          <div class="input-group">
            <button type="button" id="alimonyButton" class="icon-btn">הוצאות מזונות</button>
          </div>
          <div id="alimonyFields" style="display:none">
            <div class="input-group" style="max-width:320px">
              <label for="alimonyExpenses">הוצאות מזונות</label>
              <input type="number" id="alimonyExpenses" placeholder="הזן הוצאות מזונות">
            </div>
          </div>
        </section>
      </form>
    </div>
  </div>

  <script>
    // ====== עזר כללי ======
    const formatILS = v => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(v||0);
    const round10 = n => Math.floor((n||0)/10)*10;
    const todayStr = ()=> {
      const d=new Date();
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }
    document.getElementById('versionTag').textContent = `גרסה ${new Date().getFullYear()}`;

    // ====== נתוני בסיס ======
    const lookupData={
      "יחיד/נשוי חי בנפרד":{kids:0,livingCost:4556},
      "רווק/גרוש/אלמן + ילד":{kids:1,livingCost:6056},
      "זוג":{kids:0,livingCost:6024},
      "זוג+ילד":{kids:1,livingCost:7524},
      "זוג+ 2 ילדים":{kids:2,livingCost:9024},
      "זוג+ 3 ילדים":{kids:3,livingCost:10524},
      "זוג+ 4 ילדים":{kids:4,livingCost:12024},
      "זוג+ 5 ילדים":{kids:5,livingCost:13324},
      "זוג+ 6 ילדים":{kids:6,livingCost:14624},
      "זוג+ 7 ילדים":{kids:7,livingCost:15924},
      "זוג+ 8 ילדים":{kids:8,livingCost:17224},
      "זוג+ 9 ילדים":{kids:9,livingCost:18524},
      "זוג+ 10 ילדים":{kids:10,livingCost:19824}
    };
    const childAllowance={0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

    // ====== DOM ======
    const form = document.getElementById('calculatorForm');
    const statusEl = document.getElementById('status');
    const male = document.getElementById('debtor-male'), female = document.getElementById('debtor-female');
    const chipM = document.getElementById('chip-m'), chipF = document.getElementById('chip-f'), chipBoth = document.getElementById('chip-both');
    const jointEl = document.getElementById('jointProceeding');

    const salaryDebtor = document.getElementById('salaryDebtor');
    const salaryPartner = document.getElementById('salaryPartner');
    const otherDebtor = document.getElementById('otherIncomeDebtor');
    const otherPartner = document.getElementById('otherIncomePartner');
    const debAllow = document.getElementById('debtorAllowance');
    const partAllow = document.getElementById('partnerAllowance');
    const unusual = document.getElementById('unusualExpenses');
    const childcare = document.getElementById('childcareExpenses');
    const alimony = document.getElementById('alimonyExpenses');
    const allowanceBtn = document.getElementById('allowanceButton');
    const allowanceBox = document.getElementById('allowanceFields');
    const alimonyBtn = document.getElementById('alimonyButton');
    const alimonyBox = document.getElementById('alimonyFields');

    const lblSalaryDeb = document.getElementById('salaryDebtorLabel');
    const lblSalaryPar = document.getElementById('salaryPartnerLabel');
    const lblOtherDeb  = document.getElementById('otherIncomeDebtorLabel');
    const lblOtherPar  = document.getElementById('otherIncomePartnerLabel');
    const lblDebRatio  = document.getElementById('debtorIncomeRatioLabel');
    const lblParRatio  = document.getElementById('partnerIncomeRatioLabel');
    const lblDebPay    = document.getElementById('debtorPaymentLabel');
    const lblParPay    = document.getElementById('partnerPaymentLabel');
    const lblDebAllow  = document.getElementById('debtorAllowanceLabel');
    const lblParAllow  = document.getElementById('partnerAllowanceLabel');

    const livingRes = document.getElementById('baseLivingCostResult');
    const btlRes    = document.getElementById('socialSecurityAllowance');
    const totalIncRes = document.getElementById('totalIncomeResult');
    const totalExpRes = document.getElementById('totalExpensesResult');
    const dispRes   = document.getElementById('disposableIncomeResult');
    const debRatioRes = document.getElementById('debtorIncomeRatio');
    const parRatioRes = document.getElementById('partnerIncomeRatio');
    const debPayRes = document.getElementById('debtorPaymentResult');
    const parPayRes = document.getElementById('partnerPaymentResult');
    const finalPayRes = document.getElementById('finalPaymentResult');

    const specialNote = document.getElementById('special-note');
    const proposedBox = document.getElementById('proposedPaymentsDisplay');
    const finalBox = document.getElementById('finalPaymentDisplay');

    // פרטי דו"ח + הערה
    const reportBlock = document.getElementById('reportBlock');
    const noteBlock = document.getElementById('noteBlock');
    const toggleReportBtn = document.getElementById('toggleReportBtn');
    const toggleNoteBtn = document.getElementById('toggleNoteBtn');
    const caseId = document.getElementById('caseId');
    const preparer = document.getElementById('preparer');
    const reportDate = document.getElementById('reportDate');
    const noteText = document.getElementById('noteText');
    const noteCount = document.getElementById('noteCount');

    // פעולות
    const printBtn = document.getElementById('printBtn');
    const mailBtn = document.getElementById('mailBtn');
    const emailTip = document.getElementById('emailTip');
    const exportSummary = document.getElementById('exportSummary');

    // תאריך ברירת מחדל
    reportDate.value = todayStr();

    // כפתורי צ'יפ
    const syncChips = ()=> {
      chipM.classList.toggle('active', male.checked);
      chipF.classList.toggle('active', female.checked);
      chipBoth.classList.toggle('active', jointEl.checked);
    }
    chipM.addEventListener('click', ()=>{ male.checked=true; syncChips(); updateUI(); calc(); });
    chipF.addEventListener('click', ()=>{ female.checked=true; syncChips(); updateUI(); calc(); });
    chipBoth.addEventListener('click', ()=>{ jointEl.checked=!jointEl.checked; syncChips(); updateUI(); calc(); });

    // עזרה "?"
    document.querySelectorAll('.help-icon').forEach(icon=>{
      icon.addEventListener('click', e=>{
        const wrap=e.target.closest('.help-wrap');
        wrap.classList.toggle('open');
      });
    });

    // מתקפלים
    toggleReportBtn.addEventListener('click', ()=> reportBlock.classList.toggle('open'));
    toggleNoteBtn.addEventListener('click',   ()=> noteBlock.classList.toggle('open'));
    noteText.addEventListener('input', ()=> noteCount.textContent = noteText.value.length);

    // הצגת/הסתרת קופסאות
    allowanceBtn.addEventListener('click', ()=> allowanceBox.style.display = allowanceBox.style.display==='none'?'block':'none');
    alimonyBtn.addEventListener('click',   ()=> alimonyBox.style.display   = alimonyBox.style.display==='none'?'block':'none');

    // UI דינמי
    function updateUI(){
      const status=statusEl.value||'';
      const isSingle = /יחיד|רווק/.test(status);
      const isMale = male.checked;
      const isJoint = jointEl.checked;

      // תוויות
      if(isSingle){
        lblSalaryDeb.textContent='הכנסה (חייב/ת)';
        lblOtherDeb.textContent='הכנסות אחרות (חייב/ת)';
        if(lblDebAllow) lblDebAllow.textContent='קצבה (חייב/ת)';
        lblSalaryPar.textContent='הכנסה (בן/בת זוג)';
        lblOtherPar.textContent='הכנסות אחרות (בן/בת זוג)';
        if(lblParAllow) lblParAllow.textContent='קצבה (בן/בת זוג)';
        lblDebRatio.textContent='אחוז הכנסה (חייב/ת):';
        lblParRatio.textContent='אחוז הכנסה (בן/בת זוג):';
        lblDebPay.textContent='תשלום מוצע (חייב/ת):';
        lblParPay.textContent='תשלום מוצע (בן/בת זוג):';
      }else if(isMale){
        lblSalaryDeb.textContent='הכנסה (חייב)';
        lblOtherDeb.textContent='הכנסות אחרות (חייב)';
        if(lblDebAllow) lblDebAllow.textContent='קצבה (חייב)';
        lblSalaryPar.textContent='הכנסה (בת זוג)';
        lblOtherPar.textContent='הכנסות אחרות (בת זוג)';
        if(lblParAllow) lblParAllow.textContent='קצבה (בת זוג)';
        lblDebRatio.textContent='אחוז הכנסה (חייב):';
        lblParRatio.textContent='אחוז הכנסה (בת זוג):';
        lblDebPay.textContent='תשלום מוצע (חייב):';
        lblParPay.textContent='תשלום מוצע (בת זוג):';
      }else{
        lblSalaryDeb.textContent='הכנסה (חייבת)';
        lblOtherDeb.textContent='הכנסות אחרות (חייבת)';
        if(lblDebAllow) lblDebAllow.textContent='קצבה (חייבת)';
        lblSalaryPar.textContent='הכנסה (בן זוג)';
        lblOtherPar.textContent='הכנסות אחרות (בן זוג)';
        if(lblParAllow) lblParAllow.textContent='קצבה (בן זוג)';
        lblDebRatio.textContent='אחוז הכנסה (חייבת):';
        lblParRatio.textContent='אחוז הכנסה (בן זוג):';
        lblDebPay.textContent='תשלום מוצע (חייבת):';
        lblParPay.textContent='תשלום מוצע (בן זוג):';
      }

      // הסתרת שדות בן/בת זוג ביחיד/ה
      document.getElementById('salaryPartnerGroup').style.display = isSingle?'none':'flex';
      document.getElementById('otherIncomePartnerGroup').style.display = isSingle?'none':'flex';
      const partnerAllowanceGroup = document.getElementById('partnerAllowanceGroup');
      if(partnerAllowanceGroup) partnerAllowanceGroup.style.display = isSingle?'none':'flex';

      // תצוגת תשלומים
      if(isJoint){
        proposedBox.style.display='grid';
        finalBox.style.display='block';
        finalBox.querySelector('.label').textContent='תשלום חודשי לתא משפחתי:';
      }else{
        proposedBox.style.display='none';
        finalBox.style.display='block';
        finalBox.querySelector('.label').textContent='תשלום חודשי (חייב/ת):';
      }
    }

    // חישוב
    function calc(){
      const status=statusEl.value||'';
      const sData=lookupData[status]||{kids:0,livingCost:0};
      const baseLiving=sData.livingCost;
      const btl=childAllowance[sData.kids]||0;

      const dSalary=+salaryDebtor.value||0;
      const pSalary=+salaryPartner.value||0;
      const dOther=+otherDebtor.value||0;
      const pOther=+otherPartner.value||0;
      const dAll=+debAllow.value||0;
      const pAll=+partAllow.value||0;
      const expUnu=+unusual.value||0;
      const expChild=+childcare.value||0;
      const expAli=+alimony.value||0;

      livingRes.textContent = formatILS(baseLiving);
      btlRes.textContent    = formatILS(btl);

      const totalForRatio = dSalary+dOther+pSalary+pOther;
      const dRatio = totalForRatio? (dSalary+dOther)/totalForRatio : 0;
      const pRatio = totalForRatio? (pSalary+pOther)/totalForRatio : 0;

      debRatioRes.textContent=(dRatio*100).toFixed(1)+'%';
      parRatioRes.textContent=(pRatio*100).toFixed(1)+'%';

      const totalIncome = dSalary+pSalary+btl+dOther+pOther+dAll+pAll;
      const totalExp = baseLiving + expUnu + expChild + expAli;
      totalIncRes.textContent=formatILS(totalIncome);
      totalExpRes.textContent=formatILS(totalExp);

      const disposable = totalIncome-totalExp;
      dispRes.textContent = disposable<0? 'אין הכנסה פנויה' : formatILS(disposable);

      // תשלומים מוצעים בסיסיים (חצי מההכנסה הפנויה * יחס)
      const baseDeb = dRatio>0? round10((disposable*dRatio)/2) : 0;
      const basePar = pRatio>0? round10((disposable*pRatio)/2) : 0;
      debPayRes.textContent = formatILS(Math.max(0,baseDeb));
      parPayRes.textContent = formatILS(Math.max(0,basePar));

      // סופי
      const isSingle = /יחיד|רווק/.test(status);
      const isJoint = jointEl.checked;
      let final=0;

      if(isSingle){
        final = Math.max(0,baseDeb);
      }else if(isJoint){
        // נוסחה המבוקשת:
        // (הכנסה פנויה / 2 - תשלום חודשי של בן/בת הזוג) * יחס חייב  + תשלום חודשי של בן/בת הזוג
        const partnerPay = basePar;
        const base = (disposable/2) - partnerPay;
        final = round10(Math.max(0, base) * dRatio + partnerPay);
      }else{
        final = Math.max(0,baseDeb);
      }
      finalPayRes.textContent = formatILS(final);

      // הערה: להציג רק כשלא עובד ויש משפחה (לא יחיד/רווק)
      specialNote.style.display = (dSalary===0 && !isSingle)? 'block':'none';
    }

    // מאזינים לקלטים
    form.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('input', ()=>{ updateUI(); calc(); });
      el.addEventListener('change',()=>{ updateUI(); calc(); });
    });
    updateUI(); calc(); syncChips();

    // ====== יבוא נתונים לסיכום ייצוא ======
    function gatherInputs(){
      const status=statusEl.value||'-';
      const who = male.checked?'חייב':(female.checked?'חייבת':'חייב/ת');
      const both = jointEl.checked?'כן':'לא';

      const get = id => document.getElementById(id).value||'';
      const asCurrency = v => formatILS(+v||0);

      return {
        status, who, both,
        salaryDeb: asCurrency(get('salaryDebtor')),
        salaryPar: asCurrency(get('salaryPartner')),
        otherDeb:  asCurrency(get('otherIncomeDebtor')),
        otherPar:  asCurrency(get('otherIncomePartner')),
        allDeb:    asCurrency(get('debtorAllowance')),
        allPar:    asCurrency(get('partnerAllowance')),
        expUnu:    asCurrency(get('unusualExpenses')),
        expChild:  asCurrency(get('childcareExpenses')),
        expAli:    asCurrency(get('alimonyExpenses'))
      };
    }
    function gatherResults(){
      const txt = id => document.getElementById(id).textContent.trim();
      return {
        living: txt('baseLivingCostResult'),
        btl:    txt('socialSecurityAllowance'),
        totInc: txt('totalIncomeResult'),
        totExp: txt('totalExpensesResult'),
        disp:   txt('disposableIncomeResult'),
        rDeb:   txt('debtorIncomeRatio'),
        rPar:   txt('partnerIncomeRatio'),
        payDeb: txt('debtorPaymentResult'),
        payPar: txt('partnerPaymentResult'),
        final:  txt('finalPaymentResult')
      };
    }
    function buildSummaryHTML(){
      const inputs = gatherInputs();
      const res = gatherResults();
      const note = noteText.value? `<div style="margin-top:8px"><strong>הערה:</strong> ${escapeHtml(noteText.value)}</div>` : '';
      const meta = `
        <h2 style="margin:0 0 8px">פרטי הדו"ח</h2>
        <div><strong>מס’ תיק:</strong> ${escapeHtml(caseId.value||'-')}</div>
        <div><strong>שם עורך/ת:</strong> ${escapeHtml(preparer.value||'-')}</div>
        <div><strong>תאריך:</strong> ${escapeHtml(reportDate.value||todayStr())}</div>
        ${note}
        <hr style="margin:12px 0">
      `;
      const inputsHtml = `
        <h3 style="margin:0 0 6px">קלטים (עמודה ימנית)</h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.95rem">
          ${tr('סטטוס משפחתי',inputs.status)}
          ${tr('מי בהליך',inputs.who)}
          ${tr('שני בני הזוג בהליך?',inputs.both)}
          ${tr('הכנסה (חייב/ת)',inputs.salaryDeb)}
          ${tr('הכנסה (בן/בת זוג)',inputs.salaryPar)}
          ${tr('הכנסות אחרות (חייב/ת)',inputs.otherDeb)}
          ${tr('הכנסות אחרות (בן/בת זוג)',inputs.otherPar)}
          ${tr('קצבה (חייב/ת)',inputs.allDeb)}
          ${tr('קצבה (בן/בת זוג)',inputs.allPar)}
          ${tr('הוצאות חריגות',inputs.expUnu)}
          ${tr('הוצאות טיפול וצהרונים',inputs.expChild)}
          ${tr('הוצאות מזונות',inputs.expAli)}
        </table>
        <hr style="margin:12px 0">
      `;
      const resultsHtml = `
        <h3 style="margin:0 0 6px">תוצאות החישוב</h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.95rem">
          ${tr('דמי מחייה בכבוד',res.living)}
          ${tr('קצבת ביטוח לאומי',res.btl)}
          ${tr('סך הכנסות',res.totInc)}
          ${tr('סך הוצאות',res.totExp)}
          ${tr('הכנסה פנויה',res.disp)}
          ${tr('אחוז הכנסה (חייב/ת)',res.rDeb)}
          ${tr('אחוז הכנסה (בן/בת זוג)',res.rPar)}
          ${tr('תשלום מוצע (חייב/ת)',res.payDeb)}
          ${tr('תשלום מוצע (בן/בת זוג)',res.payPar)}
          ${tr('<strong>תשלום חודשי לתא המשפחתי</strong>',`<strong>${res.final}</strong>`)}
        </table>
      `;
      return `<div style="padding:8px 4px">${meta}${inputsHtml}${resultsHtml}</div>`;
      function tr(k,v){
        return `<tr>
          <td style="border:1px solid #e3e7ea;padding:6px 8px;background:#fafbfc;width:45%">${k}</td>
          <td style="border:1px solid #e3e7ea;padding:6px 8px">${v}</td>
        </tr>`;
      }
      function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    }
    function buildSummaryText(){
      const inputs=gatherInputs(), res=gatherResults();
      const lines=[
        `פרטי הדו"ח`,
        `מס’ תיק: ${caseId.value||'-'}`,
        `שם עורך/ת: ${preparer.value||'-'}`,
        `תאריך: ${reportDate.value||todayStr()}`,
        noteText.value?`הערה: ${noteText.value}`:null,
        ``,
        `קלטים (עמודה ימנית):`,
        `סטטוס משפחתי: ${inputs.status}`,
        `מי בהליך: ${inputs.who}`,
        `שני בני הזוג בהליך?: ${inputs.both}`,
        `הכנסה (חייב/ת): ${inputs.salaryDeb}`,
        `הכנסה (בן/בת זוג): ${inputs.salaryPar}`,
        `הכנסות אחרות (חייב/ת): ${inputs.otherDeb}`,
        `הכנסות אחרות (בן/בת זוג): ${inputs.otherPar}`,
        `קצבה (חייב/ת): ${inputs.allDeb}`,
        `קצבה (בן/בת זוג): ${inputs.allPar}`,
        `הוצאות חריגות: ${inputs.expUnu}`,
        `הוצאות טיפול וצהרונים: ${inputs.expChild}`,
        `הוצאות מזונות: ${inputs.expAli}`,
        ``,
        `תוצאות החישוב:`,
        `דמי מחייה בכבוד: ${res.living}`,
        `קצבת ביטוח לאומי: ${res.btl}`,
        `סך הכנסות: ${res.totInc}`,
        `סך הוצאות: ${res.totExp}`,
        `הכנסה פנויה: ${res.disp}`,
        `אחוז הכנסה (חייב/ת): ${res.rDeb}`,
        `אחוז הכנסה (בן/בת זוג): ${res.rPar}`,
        `תשלום מוצע (חייב/ת): ${res.payDeb}`,
        `תשלום מוצע (בן/בת זוג): ${res.payPar}`,
        `תשלום חודשי לתא המשפחתי: ${res.final}`
      ].filter(Boolean);
      return lines.join('\n');
    }

    // ====== הדפסה ======
    printBtn.addEventListener('click', ()=>{
      // לפתוח את פרטי הדו"ח בהדפסה + להזין תקציר
      exportSummary.innerHTML = buildSummaryHTML();
      window.print();
    });

    // ====== מייל ======
    mailBtn.addEventListener('click', ()=>{
      emailTip.style.display='block'; // הטיפ מופיע רק אחרי לחיצה
      const subject = `דו"ח חישוב צו תשלומים – תיק ${caseId.value||'-'} – ${reportDate.value||todayStr()}`;
      const body = buildSummaryText();
      const href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = href;
    });

    // טריגר ראשוני
    updateUI(); calc();

  </script>
</body>
</html>

