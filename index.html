<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --panel:#fff;
  --text:#333; --muted:#666; --border:#d9e0e6; --accent:#ee9b00;
  --danger:#ae2012; --blue:#0b68ff; --soft:#e9f5f5;
}
*{box-sizing:border-box}
body{
  font-family:'Heebo',sans-serif; background:var(--bg); color:var(--text);
  margin:0; padding:20px; display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
}
#captureRoot{width:100%; max-width:1100px}
.calculator{
  background:var(--panel); border-radius:12px; overflow:hidden;
  box-shadow:0 4px 16px rgba(0,0,0,.08);
  display:grid; grid-template-columns:1fr 1fr;
}
header{
  grid-column:1/-1; background:var(--primary); color:#fff; padding:18px 20px;
  display:flex; align-items:center; justify-content:space-between;
}
.h-title{font-size:1.7rem; margin:0; font-weight:700}
.badge{font-size:.85rem; background:rgba(255,255,255,.12); padding:.25rem .6rem; border-radius:999px}

.col{padding:22px}
.col.inputs{border-left:1px solid var(--border)}
.col.results{background:var(--soft); position:relative}

h2.sec{margin:0 0 14px; color:var(--primary); font-size:1.2rem; padding-bottom:6px; border-bottom:2px solid var(--secondary)}
.group{display:grid; gap:12px}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

.input{display:flex; flex-direction:column; gap:6px}
.input label{font-weight:500; color:#455a64; display:flex; gap:.5rem; align-items:center}
.input input,.input select,.input textarea{
  width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:1rem;
}
.input textarea{min-height:80px; resize:vertical}
.input input:focus,.input select:focus,.input textarea:focus{outline:none; border-color:var(--secondary); box-shadow:0 0 0 3px rgba(10,147,150,.18)}

.grid2{display:grid; grid-template-columns:1fr 1fr; gap:14px}

/* Pills */
.pills{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.pill{
  border:1px solid #d5dde4; background:#f7f9fb; color:#223; padding:8px 14px; border-radius:999px;
  cursor:pointer; transition:.2s; user-select:none; font-weight:500;
}
.pill.active{background:var(--secondary); border-color:var(--secondary); color:#fff}
.pill.alert.active{background:#cc3c2f; border-color:#cc3c2f}

/* side-by-side results */
.kv{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #dbe7ea}
.kv:last-child{border-bottom:none}
.kv .k{font-weight:600; color:#2a3b47}
.kv .v{font-weight:700; color:var(--accent)}
.center{ text-align:center }
.big{font-size:1.6rem; color:var(--blue); font-weight:800}

/* action bar (desktop) */
.actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:16px}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #cbd5e1;
  background:#fff; border-radius:10px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.05); font-weight:600;
}
.btn:hover{background:#f7fafc}
.btn .ico{font-size:1.1rem}
.btn.reset{border-color:#f1c6c6}

/* collapsible */
.toggle{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#f6f8fb; border:1px solid #dee5eb; border-radius:10px; cursor:pointer}
.fold{display:none}

/* info "?" */
.info{width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#eef6f6;border:1px solid #e1ecec;color:#006d77;cursor:pointer;font-weight:800}
.pop{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px 14px;line-height:1.45}

/* sticky FAB (mobile only) */
.fab-wrap{display:none}
@media (max-width: 768px){
  .calculator{grid-template-columns:1fr}
  .col.inputs{border-left:none}
  .fab-wrap{
    position:sticky; inset-block-end:0; display:flex; justify-content:center; padding:8px;
    background:linear-gradient(to top, rgba(255,255,255,.95), rgba(255,255,255,.6));
    z-index:30;
  }
  .fab{
    display:flex; gap:8px; background:#ffffff; border:1px solid #dfe5ec; padding:8px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.08)
  }
  .fab .btn{padding:8px 10px}
  /* ×œ× ××¦×™×’×™× ××ª ×©×•×¨×ª ×”×›×¤×ª×•×¨×™× ×”×§×‘×•×¢×” ×‘××•×‘×™×™×œ */
  .actions{display:none}
  /* ×›×“×™ ×©×”-FAB ×œ× ×™×¡×ª×™×¨ ××ª ×”×¡×›×•× ×”×¡×•×¤×™ */
  .col.results{padding-bottom:92px}
}

/* print â€“ × ×©×ª××© ×‘×ª××•× ×ª ×”×¦×™×œ×•× ×‘×¢××•×“ ××—×“ (×“×¨×š ×—×œ×•×Ÿ ×—×“×©) */
@media print{
  body{padding:0; background:#fff}
  .fab-wrap{display:none!important}
}

/* â€œ×ª×™×§ ××¤×¡â€ */
.zero-case{
  color:#b00020; background:#ffe6ea; border:1px solid #ffc2cd; padding:4px 10px; border-radius:10px; font-weight:800
}
.hidden{display:none!important}
</style>
</head>
<body>
<div id="captureRoot">
  <div class="calculator" id="calc">
    <header>
      <h1 class="h-title">××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
      <span class="badge" id="badgeYear">××¢×•×“×›×Ÿ ×œ-<span id="year"></span></span>
    </header>

    <!-- ×ª×•×¦××•×ª (×©×××œ) -->
    <div class="col results">
      <h2 class="sec center">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

      <div class="kv"><div class="k">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div><div class="v" id="childAllowance">0 â‚ª</div></div>
      <div class="kv"><div class="k">×¡×š ×”×›× ×¡×•×ª</div><div class="v" id="totalIncome">0 â‚ª</div></div>
      <div class="kv"><div class="k">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div><div class="v" id="livingCost">0 â‚ª</div></div>
      <div class="kv"><div class="k">×¡×š ×”×•×¦××•×ª</div><div class="v" id="totalExpenses">0 â‚ª</div></div>

      <div class="center" style="padding:12px 0">
        <div>×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™:</div>
        <div id="disposable" class="big">0 â‚ª</div>
      </div>

      <div class="kv"><div class="k" id="debtorRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª)</div><div class="v" id="debtorRatio">0%</div></div>
      <div class="kv"><div class="k" id="partnerRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerRatio">0%</div></div>

      <div class="kv"><div class="k" id="debtorPayLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</div><div class="v" id="debtorPay">0 â‚ª</div></div>
      <div class="kv"><div class="k" id="partnerPayLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerPay">0 â‚ª</div></div>

      <div class="center" style="margin-top:10px">
        <div style="margin-bottom:4px">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:</div>
        <div class="big" id="finalPay">0 â‚ª</div>
        <div id="zeroCaseTag" class="zero-case hidden" style="margin-top:6px">×ª×™×§ ××¤×¡</div>
      </div>

      <!-- ×©×•×¨×ª ×›×¤×ª×•×¨×™× (×“×¡×§×˜×•×¤) -->
      <div class="actions" id="deskActions">
        <button class="btn" id="btnShot"><span class="ico">ğŸ–¨ï¸</span> ×¦×™×œ×•×/×”×“×¤×¡</button>
        <button class="btn" id="btnMail"><span class="ico">âœ‰ï¸</span> ×©×œ×™×—×ª ××™×™×œ</button>
        <button class="btn reset" id="btnReset"><span class="ico">â†º</span> ××™×¤×•×¡</button>
        <button class="btn" id="btnReport"><span class="ico">ğŸ—‚ï¸</span> ×¤×¨×˜×™ ×“×•×´×—</button>
      </div>

      <!-- ×¤×¨×˜×™ ×“×•"×— + ×”×¢×¨×” -->
      <div id="reportPanel" class="fold" style="margin-top:10px">
        <div class="grid2">
          <div class="input">
            <label for="caseId">××¡' ×ª×™×§</label>
            <input id="caseId" placeholder="12345/25">
          </div>
          <div class="input">
            <label for="authorName">×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label>
            <input id="authorName" placeholder="×©× ××œ×">
          </div>
        </div>
        <div class="row" style="margin-top:10px; align-items:flex-end">
          <div class="input" style="max-width:220px">
            <label for="calcDate">×ª××¨×™×š</label>
            <input id="calcDate" class="readonly" readonly>
          </div>
          <button class="btn" id="btnNote" title="×”×•×¡×£ ×”×¢×¨×”"><span class="ico">ğŸ“</span> ×”×¢×¨×”</button>
        </div>

        <div id="notePanel" class="fold" style="margin-top:8px">
          <div class="input">
            <label for="calcNotes">×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</label>
            <textarea id="calcNotes" maxlength="500" placeholder="×”×¢×¨×” ×§×¦×¨×”..."></textarea>
          </div>
          <div class="row" style="justify-content:flex-end; color:var(--muted); font-size:.9rem">
            <span id="notesCount">0</span>/500
          </div>
        </div>
      </div>
    </div>

    <!-- ×§×œ×˜×™× (×™××™×Ÿ) -->
    <div class="col inputs">
      <h2 class="sec">×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>

      <div class="group">
        <div class="grid2">
          <div class="input">
            <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
            <select id="status">
              <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡...</option>
              <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
              <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
              <option value="×–×•×’">×–×•×’</option>
              <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
              <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
              <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
            </select>
          </div>

          <div class="input">
            <label>××™ ×‘×”×œ×™×š?</label>
            <div class="pills" id="whoRow">
              <div class="pill active" data-role="male" id="pillMale">×—×™×™×‘</div>
              <div class="pill" data-role="female" id="pillFemale">×—×™×™×‘×ª</div>
              <div class="pill alert" data-role="joint" id="pillJoint">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š</div>
            </div>
          </div>
        </div>

        <h2 class="sec">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</h2>

        <div class="grid2">
          <div class="input" id="salaryDebtorWrap">
            <label><span id="salaryDebtorLabel">×”×›× ×¡×” (×—×™×™×‘)</span>
              <span class="info" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨<br>×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×Ö¾3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤×´×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª">?</span>
            </label>
            <input id="salaryDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
          </div>
          <div class="input" id="salaryPartnerWrap">
            <label><span id="salaryPartnerLabel">×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</span>
              <span class="info" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨<br>×‘××§×¨×” ×©×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª ×™×™×§×‘×¢ ×ª×©×œ×•× ××“×•×¨×’ ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª">?</span>
            </label>
            <input id="salaryPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
          </div>
        </div>

        <div class="grid2">
          <div class="input">
            <label id="otherDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label>
            <input id="otherDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
          </div>
          <div class="input" id="otherPartnerWrap">
            <label id="otherPartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)</label>
            <input id="otherPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª">
          </div>
        </div>

        <div class="row">
          <button type="button" class="toggle" id="btnAllow">×”×›× ×¡×•×ª ××§×¦×‘××•×ª</button>
          <button type="button" class="toggle" id="btnAlimony">×”×•×¦××•×ª ××–×•× ×•×ª</button>
        </div>

        <div class="fold" id="allowFold" style="margin-top:6px">
          <div class="grid2">
            <div class="input">
              <label id="debtorAllowLabel">×§×¦×‘×” (×—×™×™×‘/×ª)</label>
              <input id="allowDebtor" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
            <div class="input" id="allowPartnerWrap">
              <label id="partnerAllowLabel">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
              <input id="allowPartner" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
            </div>
          </div>
        </div>

        <div class="fold" id="alimonyFold" style="margin-top:6px">
          <div class="grid2">
            <div class="input">
              <label>×”×•×¦××•×ª ××–×•× ×•×ª</label>
              <input id="alimony" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:6px">
          <div class="input">
            <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label>
            <input id="unusual" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
          </div>
          <div class="input">
            <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
            <input id="childcare" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAB (××•×‘×™×™×œ ×‘×œ×‘×“) -->
  <div class="fab-wrap">
    <div class="fab">
      <button class="btn" id="btnShotFab"><span class="ico">ğŸ–¨ï¸</span> ×¦×™×œ×•×/×”×“×¤×¡</button>
      <button class="btn" id="btnMailFab"><span class="ico">âœ‰ï¸</span> ××™×™×œ</button>
      <button class="btn reset" id="btnResetFab"><span class="ico">â†º</span> ××™×¤×•×¡</button>
    </div>
  </div>
</div>

<!-- html2canvas ×œ×¦×™×œ×•× ×”××¡×š -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ========= ×¢×–×¨ ========= */
const fmt = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(+n||0);
const rd10 = n => Math.max(0, Math.floor((+n||0)/10)*10);

const els = id => document.getElementById(id);

function setYear(){
  els('year').textContent = new Date().getFullYear();
  els('calcDate').value = new Date().toLocaleDateString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit'});
}
setYear();

/* ========= × ×ª×•× ×™ ×˜×‘×œ××•×ª ========= */
const living = {
  "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":4556, "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":6056, "×–×•×’":6024,
  "×–×•×’+×™×œ×“":7524, "×–×•×’+ 2 ×™×œ×“×™×":9024, "×–×•×’+ 3 ×™×œ×“×™×":10524, "×–×•×’+ 4 ×™×œ×“×™×":12024,
  "×–×•×’+ 5 ×™×œ×“×™×":13324, "×–×•×’+ 6 ×™×œ×“×™×":14624, "×–×•×’+ 7 ×™×œ×“×™×":15924, "×–×•×’+ 8 ×™×œ×“×™×":17224,
  "×–×•×’+ 9 ×™×œ×“×™×":18524, "×–×•×’+ 10 ×™×œ×“×™×":19824
};
const childAll = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

/* ========= ×‘×—×™×¨×” ××™ ×‘×”×œ×™×š ========= */
let isMale = true, isJoint = false;
els('pillMale').onclick = ()=>{ isMale = true;  els('pillMale').classList.add('active'); els('pillFemale').classList.remove('active'); updateLabels(); calc(); }
els('pillFemale').onclick = ()=>{ isMale = false; els('pillFemale').classList.add('active'); els('pillMale').classList.remove('active'); updateLabels(); calc(); }
els('pillJoint').onclick = ()=>{ isJoint = !isJoint; els('pillJoint').classList.toggle('active', isJoint); updateLabels(); calc(); }

/* ========= ×ª×™×‘×•×ª ××ª×§×¤×œ×•×ª ========= */
els('btnAllow').onclick  = ()=> toggleFold('allowFold');
els('btnAlimony').onclick= ()=> toggleFold('alimonyFold');
function toggleFold(id){
  const e = els(id); e.style.display = (e.style.display==='block')?'none':'block';
}

/* ========= ×¤×•×¤××‘×¨ "?" ========= */
let pop, popBtn;
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.info');
  if(btn){
    e.stopPropagation();
    if(pop && popBtn===btn){ pop.remove(); pop=null; return; }
    if(pop) pop.remove();
    popBtn = btn;
    pop = document.createElement('div');
    pop.className='pop'; pop.innerHTML = btn.dataset.info;
    document.body.appendChild(pop);
    const r = btn.getBoundingClientRect();
    pop.style.top = (window.scrollY + r.bottom + 8) + 'px';
    pop.style.right= (window.innerWidth - r.right + 8) + 'px';
  } else if(pop){
    pop.remove(); pop=null;
  }
});

/* ========= ×¢×“×›×•×Ÿ ×ª×•×•×™×•×ª ========= */
function updateLabels(){
  const st = els('status').value || '';
  const single = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');

  // ×‘×Ÿ/×‘×ª ×–×•×’ â€“ ×”×¡×ª×¨×” ×›×©×™×—×™×“
  ['salaryPartnerWrap','otherPartnerWrap','allowPartnerWrap'].forEach(id=>{
    const el = els(id); if(el) el.style.display = single ? 'none':'block';
  });

  const debtor = single ? '×—×™×™×‘/×ª' : (isMale ? '×—×™×™×‘' : '×—×™×™×‘×ª');
  const partner= single ? '×‘×Ÿ/×‘×ª ×–×•×’' : (isMale ? '×‘×ª ×–×•×’' : '×‘×Ÿ ×–×•×’');

  els('salaryDebtorLabel').textContent = `×”×›× ×¡×” (${debtor})`;
  els('salaryPartnerLabel').textContent= `×”×›× ×¡×” (${partner})`;
  els('otherDebtorLabel').textContent  = `×”×›× ×¡×•×ª ××—×¨×•×ª (${debtor})`;
  els('otherPartnerLabel').textContent = `×”×›× ×¡×•×ª ××—×¨×•×ª (${partner})`;
  els('debtorAllowLabel').textContent  = `×§×¦×‘×” (${debtor})`;
  els('partnerAllowLabel').textContent = `×§×¦×‘×” (${partner})`;

  els('debtorRatioLabel').textContent  = `××—×•×– ×”×›× ×¡×” (${debtor})`;
  els('partnerRatioLabel').textContent = `××—×•×– ×”×›× ×¡×” (${partner})`;
  els('debtorPayLabel').textContent    = `×ª×©×œ×•× ××•×¦×¢ (${debtor})`;
  els('partnerPayLabel').textContent   = `×ª×©×œ×•× ××•×¦×¢ (${partner})`;
}

/* ========= ×—×™×©×•×‘ ========= */
['status','salaryDebtor','salaryPartner','otherDebtor','otherPartner','allowDebtor','allowPartner','unusual','childcare','alimony']
.forEach(id=> els(id).addEventListener('input', ()=>{updateLabels(); calc()}));
updateLabels();

function calc(){
  const st = els('status').value || '';
  const kids = (st.match(/\d+/)?.[0]) || (st.includes('×™×œ×“')?1:0);
  const base = living[st] || 0;
  const child = childAll[kids] || 0;

  const SD = +els('salaryDebtor').value   || 0;
  const SP = +els('salaryPartner').value  || 0;
  const OD = +els('otherDebtor').value    || 0;
  const OP = +els('otherPartner').value   || 0;
  const AD = +els('allowDebtor').value    || 0;
  const AP = +els('allowPartner').value   || 0;
  const UN = +els('unusual').value        || 0;
  const CH = +els('childcare').value      || 0;
  const AL = +els('alimony').value        || 0;

  els('childAllowance').textContent = fmt(child);
  els('livingCost').textContent     = fmt(base);

  // ×¡×š ×”×›× ×¡×•×ª/×”×•×¦××•×ª
  const incomes = SD+SP+OD+OP+AD+AP+child;
  const expenses= base+UN+CH+AL;

  els('totalIncome').textContent = fmt(incomes);
  els('totalExpenses').textContent= fmt(expenses);

  const disp = incomes - expenses;
  els('disposable').textContent = disp<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmt(disp);

  // ×™×—×¡ ×”×›× ×¡×•×ª
  const forRatio = (SD+OD+SP+OP) || 0;
  const rDebtor  = forRatio>0 ? (SD+OD)/forRatio : 0;
  const rPartner = forRatio>0 ? (SP+OP)/forRatio : 0;

  els('debtorRatio').textContent  = (rDebtor*100).toFixed(1)+'%';
  els('partnerRatio').textContent = (rPartner*100).toFixed(1)+'%';

  // ×ª×©×œ×•××™× ××•×¦×¢×™× ×¤×¨×˜× ×™×™× (×—×¦×™ ××”×¤× ×•×™ ×œ×¤×™ ×”×™×—×¡)
  const dPay = rDebtor  >0 ? rd10((disp * rDebtor)/2)  : 0;
  const pPay = rPartner >0 ? rd10((disp * rPartner)/2) : 0;
  els('debtorPay').textContent  = fmt(dPay);
  els('partnerPay').textContent = fmt(pPay);

  // â€œ×ª×™×§ ××¤×¡â€ â€“ ×¨×§ ×× ×™×© ×”×›× ×¡×•×ª ××§×¦×‘××•×ª ×‘×œ×‘×“ ×•×œ×—×™×™×‘ ××™×Ÿ ×”×›× ×¡×”
  const nonAllow = SD+SP+OD+OP;
  const onlyAllow = (nonAllow===0) && ((AD+AP)>0);
  const zeroCase = onlyAllow && (SD+OD===0);
  els('zeroCaseTag').classList.toggle('hidden', !zeroCase);

  // ×ª×©×œ×•× ×¡×•×¤×™
  let final = 0;
  const single = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');

  if (single || !isJoint){
    final = dPay; // ×—×™×™×‘/×ª ×‘×œ×‘×“
  } else {
    // ×œ×¤×™ ×”×“×¨×™×©×”: (disp/2 - pPay) * rDebtor + pPay
    const baseHalf = disp/2;
    const afterSub = Math.max(0, baseHalf - pPay);
    final = rd10( afterSub * rDebtor + pPay );
  }

  // ×× â€œ×ª×™×§ ××¤×¡â€ â€“ ××—×œ×™×£ ××¤×¡ (××š ×œ× ××—×œ×™×£ ×¢×¨×›×™× ××—×¨×™×)
  if (final===0 && zeroCase){
    els('finalPay').textContent = '×ª×™×§ ××¤×¡';
  } else {
    els('finalPay').textContent = fmt(final);
  }
}

/* ========= ×¦×™×œ×•×/×”×“×¤×¡ ×‘×¢××•×“ ××—×“ ========= */
async function shot(){
  const root = document.getElementById('captureRoot');
  const fab  = document.querySelector('.fab-wrap');
  const prev = fab ? fab.style.visibility : '';
  if (fab) fab.style.visibility='hidden';

  const scale = (window.innerWidth<=768) ? 1.2 : 1.3;
  const canvas = await html2canvas(root, {
    scale, useCORS:true, windowWidth:root.scrollWidth, windowHeight:root.scrollHeight
  });

  if (fab) fab.style.visibility = prev;

  // ×”×ª×××” ×œ×¢××•×“ ××—×“ â€“ ×©××™×¨×ª ×™×—×¡
  const MAX_W = 1050, MAX_H = 1450;
  const k = Math.min(1, MAX_W/canvas.width, MAX_H/canvas.height);
  const W = Math.round(canvas.width*k), H = Math.round(canvas.height*k);

  const out = document.createElement('canvas'); out.width=W; out.height=H;
  out.getContext('2d').drawImage(canvas,0,0,W,H);
  const data = out.toDataURL('image/png');

  const w = window.open('','_blank');
  w.document.write(`
    <html><head><meta charset="utf-8">
    <title>×¦×™×œ×•× ××¡×š ×”××—×©×‘×•×Ÿ</title>
    <style>
      @page{size:A4 portrait; margin:0}
      html,body{margin:0}
      img{width:100vw; height:100vh; object-fit:contain; display:block}
    </style></head>
    <body><img src="${data}" alt="capture"></body></html>
  `);
  w.document.close(); w.focus(); setTimeout(()=>w.print(),250);
}

/* ========= ××™×™×œ (mailto) ========= */
function sendMail(){
  alert('×˜×™×¤: ×œ××—×¨ ×”×¦×™×œ×•×/×”×“×¤×¡×” ×©××¨×• ××ª ×”-PNG ×•×¦×¨×¤×• ××•×ª×• ×™×“× ×™×ª ×œ××™×™×œ.');
  const t = id => (els(id)?.textContent || '').trim();
  const caseId=(els('caseId')?.value||'').trim();
  const author=(els('authorName')?.value||'').trim();
  const date  =(els('calcDate')?.value||'').trim();
  const notes =(els('calcNotes')?.value||'').trim();

  const subject = `××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ${caseId?('×ª×™×§ '+caseId):'×œ×œ× ××¡×¤×¨ ×ª×™×§'}`;
  const body = [
    '×©×œ×•×,','',
    '××¦×•×¨×£/×ª ×¦×™×œ×•×/PNG ×©×œ ×ª×•×¦××•×ª ×”×—×™×©×•×‘ (× × ×œ×¦×¨×£ ×™×“× ×™×ª).','',
    '×¤×¨×˜×™ ××˜×:',
    `×ª×™×§: ${caseId||'-'}`,`×¢×•×¨×š/×ª: ${author||'-'}`,`×ª××¨×™×š: ${date||'-'}`,
    notes?`×”×¢×¨×”: ${notes}`:'',
    '','×ª×§×¦×™×¨ ×ª×•×¦××•×ª:',
    `×¡×š ×”×›× ×¡×•×ª: ${t('totalIncome')}`,`×¡×š ×”×•×¦××•×ª: ${t('totalExpenses')}`,
    `×”×›× ×¡×” ×¤× ×•×™×”: ${t('disposable')}`,
    `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${t('debtorRatio')}`,`××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${t('partnerRatio')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${t('debtorPay')}`,`×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${t('partnerPay')}`,
    `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${t('finalPay')}`,'','×‘×‘×¨×›×”'
  ].filter(Boolean).join('\n');

  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

/* ========= ××™×¤×•×¡ ========= */
function resetAll(){
  ['salaryDebtor','salaryPartner','otherDebtor','otherPartner','allowDebtor','allowPartner','unusual','childcare','alimony']
    .forEach(id=> els(id).value='');
  els('status').value='';
  // ××ª×§×¤×œ×™×
  ['allowFold','alimonyFold','reportPanel','notePanel'].forEach(id=> els(id).style.display='none');
  // ×”×¢×¨×”
  if (els('calcNotes')) els('calcNotes').value='';
  if (els('notesCount')) els('notesCount').textContent='0';
  // ×‘×¨×™×¨×ª ××—×“×œ: ×—×™×™×‘, ×œ×œ× ××©×•×ª×£
  isMale=true; isJoint=false;
  els('pillMale').classList.add('active');
  els('pillFemale').classList.remove('active');
  els('pillJoint').classList.remove('active');
  updateLabels(); calc();
}

/* ========= ×¤×¨×˜×™ ×“×•"×—/×”×¢×¨×” ========= */
els('btnReport').onclick = ()=>{
  const p = els('reportPanel');
  p.style.display = (p.style.display==='block')?'none':'block';
};
els('btnNote').onclick = ()=>{
  const p = els('notePanel');
  p.style.display = (p.style.display==='block')?'none':'block';
};
els('calcNotes').addEventListener('input',()=>{ els('notesCount').textContent = els('calcNotes').value.length; });

/* ========= ×—×™×‘×•×¨×™ ×›×¤×ª×•×¨×™× ========= */
['btnShot','btnShotFab'].forEach(id=> els(id).onclick = shot);
['btnMail','btnMailFab'].forEach(id=> els(id).onclick = sendMail);
['btnReset','btnResetFab'].forEach(id=> els(id).onclick = resetAll);

/* ×”×ª×—×œ×” */
calc();
</script>
</body>
</html>
