<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --primary:#005f73; --secondary:#0a9396; --bg:#f4f7f9; --panel:#fff;
  --text:#1f2937; --label:#4b5563; --border:#dbe3ea; --accent:#ee9b00;
  --danger:#ae2012; --blue:#0a58ff; --muted:#6b7280;
}
*{box-sizing:border-box}
body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px;display:flex;justify-content:center;min-height:100vh}
.calculator{width:100%;max-width:1100px;background:var(--panel);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden;display:grid;grid-template-columns:1fr 1fr}
header{grid-column:1/-1;background:var(--primary);color:#fff;padding:14px 16px;text-align:center;position:relative}
header h1{margin:0;font-size:1.8rem;line-height:1}
.year-badge{position:absolute;inset-inline-start:16px;inset-block-start:10px;font-size:.9rem;color:#e6f4f1;background:rgba(255,255,255,.12);padding:6px 10px;border:1px solid rgba(255,255,255,.25);border-radius:10px}
@media (max-width:768px){header h1{font-size:1.32rem}.year-badge{font-size:.8rem}}

.results-col{background:#eaf6f6;padding:18px}
.inputs-col{padding:18px;border-inline-start:1px solid var(--border)}
.section-title{margin:6px 0 14px;color:var(--primary);font-size:1.18rem;font-weight:700;text-align:center}

.controls-top{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #cfd8e3;border-radius:10px;background:#fff;cursor:pointer;font-weight:500}
.btn:hover{background:#f6f8fb}
.btn.reset{border-color:#a0aec0}

.result-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.result-card{background:#fff;border:1px solid #dbe9ea;border-radius:12px;padding:12px 14px;text-align:center}
.result-card .k{color:var(--muted);font-weight:500}
.result-card .v{margin-top:6px;font-weight:700;color:var(--accent);font-size:1.15rem}
.result-wide{grid-column:1/-1}
.result-big .v{font-size:1.35rem;color:var(--blue)}
.result-danger .v{color:var(--danger)}
.zero-case{color:#c2410c;font-weight:800;font-size:1.05rem}

.row{display:grid;gap:12px}
.row-2{grid-template-columns:1fr 1fr}
.row-3{grid-template-columns:1fr 1fr 1fr}
.input-pair{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.input-group{display:flex;flex-direction:column}
.input-group label{font-weight:600;color:var(--label);display:flex;gap:8px;align-items:center;margin-bottom:6px}
.input-group input,.input-group select,.input-group textarea{
  border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-size:1rem;background:#fbfeff
}
.input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(10,147,150,.18)}
.input-group textarea{min-height:78px;resize:vertical}
.readonly{background:#f2f6ff;border-color:#cfe0ff;color:#1f3a8a;font-weight:600}

.toggles-line{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.chip{padding:8px 12px;border:1px solid #cfd8e3;border-radius:999px;background:#fff;cursor:pointer}
.chip.active{background:#0d9488;color:#fff;border-color:#0d9488}
.chip.alert{background:#ffe8e8;border-color:#ffc4c4;color:#b42318}
.chip.alert.active{background:#b42318;color:#fff;border-color:#b42318}

.info-btn{width:18px;height:18px;border-radius:50%;background:#eef6f6;color:#0d6b6b;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem;border:1px solid #d4e7e7;cursor:pointer}
.pop{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:10px 12px;line-height:1.45}

.report-trigger{display:flex;justify-content:center;margin:14px 0 6px}
.report-btn{background:#fff;border:1px dashed #c8d2de;padding:8px 14px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.report-btn:hover{background:#f6fbff}
#reportPanel{display:none}
.note-toggle{margin-inline-start:auto;display:inline-flex;align-items:center;gap:6px;cursor:pointer;color:#0d6b6b}

.sticky-mobile{display:none} /* ××•×¡×ª×¨ ×‘×“×¡×§×˜×•×¤ */
@media (max-width:768px){
  .calculator{grid-template-columns:1fr}
  .results-col{order:2;padding-bottom:80px}
  .inputs-col{order:1}
  .row-2,.row-3,.input-pair{grid-template-columns:1fr}
  .sticky-mobile{
    position:fixed;left:0;right:0;bottom:0;background:#ffffffcc;backdrop-filter:saturate(1.2) blur(6px);
    border-top:1px solid #dfe7ee;padding:6px 10px;display:flex;gap:8px;justify-content:space-between;z-index:10
  }
  .btn{flex:1;justify-content:center;padding:10px 8px}
}

/* ×”×“×¤×¡×” */
@media print{
  body{background:#fff;padding:0}
  .controls-top,.sticky-mobile{display:none!important}
  .calculator{box-shadow:none}
}
</style>
</head>
<body>

<div id="captureRoot" class="calculator">
  <header>
    <span class="year-badge" id="yearBadge"></span>
    <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
  </header>

  <!-- ×ª×•×¦××•×ª (×©×××œ) -->
  <div class="results-col">
    <div class="controls-top">
      <button class="btn" id="btnPdf">ğŸ–¨ï¸ PDF</button>
      <button class="btn" id="btnShot">ğŸ“¸ ×¦×™×œ×•×</button>
      <button class="btn" id="btnMail">âœ‰ï¸ ×©×œ×™×—×ª ××™×™×œ</button>
      <button class="btn reset" id="btnReset">â†º ××™×¤×•×¡</button>
    </div>

    <div class="section-title">×ª×•×¦××•×ª ×”×—×™×©×•×‘</div>

    <div class="result-grid">
      <div class="result-card"><div class="k">×¡×š ×”×›× ×¡×•×ª</div><div class="v" id="totalIncomeResult">â‚ª 0</div></div>
      <div class="result-card"><div class="k">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</div><div class="v" id="socialSecurityAllowance">â‚ª 0</div></div>

      <div class="result-card"><div class="k">×“××™ ××—×™×™×” ×‘×›×‘×•×“</div><div class="v" id="baseLivingCostResult">â‚ª 0</div></div>
      <div class="result-card"><div class="k">×¡×š ×”×•×¦××•×ª</div><div class="v" id="totalExpensesResult">â‚ª 0</div></div>

      <div class="result-card result-wide result-big">
        <div class="k">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</div>
        <div class="v" id="disposableIncomeResult">××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”</div>
      </div>

      <div class="result-card"><div class="k" id="debtorIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª)</div><div class="v" id="debtorIncomeRatio">0.0%</div></div>
      <div class="result-card"><div class="k" id="partnerIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerIncomeRatio">0.0%</div></div>

      <div class="result-card"><div class="k" id="debtorPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</div><div class="v" id="debtorPaymentResult">â‚ª 0</div></div>
      <div class="result-card"><div class="k" id="partnerPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</div><div class="v" id="partnerPaymentResult">â‚ª 0</div></div>

      <div class="result-card result-wide result-danger" id="familyPaymentCard" style="display:none">
        <div class="k">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</div>
        <div class="v" id="finalPaymentResult">â‚ª 0</div>
      </div>

      <div class="result-card result-wide" id="zeroCaseRow" style="display:none">
        <div class="v zero-case">×ª×™×§ ××¤×¡</div>
      </div>
    </div>

    <!-- ×¡×¨×’×œ ××•×‘×™×™×œ ×“×‘×™×§ (××•×¤×™×¢ ×¨×§ ×‘× ×™×™×“) -->
    <div class="sticky-mobile">
      <button class="btn" id="btnPdf_m">ğŸ–¨ï¸ PDF</button>
      <button class="btn" id="btnShot_m">ğŸ“¸ ×¦×™×œ×•×</button>
      <button class="btn" id="btnMail_m">âœ‰ï¸ ××™×™×œ</button>
      <button class="btn reset" id="btnReset_m">â†º ××™×¤×•×¡</button>
    </div>
  </div>

  <!-- ×”×–× ×” (×™××™×Ÿ) -->
  <div class="inputs-col">

    <!-- ×¨×§ select ×‘×œ×™ ×©×•×¨×ª ×›×•×ª×¨×ª ××™×•×ª×¨×ª -->
    <div class="row" style="margin-bottom:6px">
      <div class="input-group">
        <select id="status" aria-label="×¡×˜×˜×•×¡ ××©×¤×—×ª×™">
          <option value="" disabled selected>×‘×—×¨ ×¡×˜×˜×•×¡ ××©×¤×—×ª×™â€¦</option>
          <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
          <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
          <option value="×–×•×’">×–×•×’</option>
          <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
          <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
        </select>
      </div>

      <div class="toggles-line">
        <span>××™ ×‘×”×œ×™×š?</span>
        <button class="chip" id="debtorMaleBtn" aria-pressed="true">×—×™×™×‘</button>
        <button class="chip" id="debtorFemaleBtn" aria-pressed="false">×—×™×™×‘×ª</button>
        <button class="chip alert" id="jointBtn" aria-pressed="false">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?</button>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:10px 0 12px">

    <div class="section-title">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</div>

    <div class="input-pair">
      <div class="input-group">
        <label>×”×›× ×¡×” (×—×™×™×‘/×ª) <span class="info-btn" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨">?</span></label>
        <input id="salaryDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
      </div>
      <div class="input-group">
        <label>×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨">?</span></label>
        <input id="salaryPartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×”">
      </div>
    </div>

    <div class="input-pair">
      <div class="input-group">
        <label>×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª) <span class="info-btn" data-info="×œ×“×•×’××”: ×¤×¨×™×œ× ×¡/×©×›×™×¨×•×ª">?</span></label>
        <input id="otherIncomeDebtor" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×” ××—×¨×ª">
      </div>
      <div class="input-group">
        <label>×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="×œ×“×•×’××”: ×¤×¨×™×œ× ×¡/×©×›×™×¨×•×ª">?</span></label>
        <input id="otherIncomePartner" type="number" placeholder="×”×–×Ÿ ×”×›× ×¡×” ××—×¨×ª">
      </div>
    </div>

    <div class="row" style="justify-items:center">
      <div class="toggles-line">
        <button class="chip" id="btnAllowances">×§×¦×‘××•×ª</button>
        <button class="chip" id="btnAlimony">××–×•× ×•×ª</button>
      </div>
    </div>

    <!-- ×§×¦×‘××•×ª -->
    <div id="allowanceFields" class="row row-2" style="margin-top:8px;display:none">
      <div class="input-group">
        <label>×§×¦×‘×” (×—×™×™×‘/×ª) <span class="info-btn" data-info="×§×¦×‘××•×ª ×§×™×™××•×ª">?</span></label>
        <input id="debtorAllowance" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
      </div>
      <div class="input-group">
        <label>×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’) <span class="info-btn" data-info="×§×¦×‘××•×ª ×§×™×™××•×ª">?</span></label>
        <input id="partnerAllowance" type="number" placeholder="×”×–×Ÿ ×§×¦×‘×”">
      </div>
    </div>

    <!-- ××–×•× ×•×ª -->
    <div id="alimonyFields" class="row row-2" style="margin-top:8px;display:none">
      <div class="input-group">
        <label>×”×•×¦××•×ª ××–×•× ×•×ª <span class="info-btn" data-info="××–×•× ×•×ª ×‘×ª×©×œ×•× ×—×•×“×©×™">?</span></label>
        <input id="alimonyExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª">
      </div>
    </div>

    <div class="input-pair" style="margin-top:8px">
      <div class="input-group">
        <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª <span class="info-btn" data-info="×¨×¤×•××™, × ×¡×™×¢×” ×•×›×“×³">?</span></label>
        <input id="unusualExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
      </div>
      <div class="input-group">
        <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™× <span class="info-btn" data-info="×¦×”×¨×•× ×™×/×˜×™×¤×•×œ">?</span></label>
        <input id="childcareExpenses" type="number" placeholder="×”×–×Ÿ ×”×•×¦××•×ª">
      </div>
    </div>

    <!-- ×¤×¨×˜×™ ×“×•"×— -->
    <div class="report-trigger">
      <button class="report-btn" id="reportBtn">ğŸ“Œ ×¤×¨×˜×™ ×“×•×´×—</button>
    </div>
    <div id="reportPanel" class="row row-3" style="margin-top:6px">
      <div class="input-group">
        <label>××¡×³ ×ª×™×§</label>
        <input id="caseId" type="text" placeholder="×œ×“×•×’××”: 12345/25">
      </div>
      <div class="input-group">
        <label>×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label>
        <input id="authorName" type="text" placeholder="×©× ××œ×">
      </div>
      <div class="input-group">
        <label>×ª××¨×™×š</label>
        <input id="reportDate" type="text" class="readonly" readonly>
      </div>
      <div class="input-group" style="grid-column:1/-1;display:none" id="noteRow">
        <label>×”×¢×¨×”</label>
        <textarea id="reportNote" maxlength="500" placeholder="×”×¢×¨×” ×¢×“ 500 ×ª×•×•×™×"></textarea>
      </div>
      <div class="note-toggle" id="noteToggle" style="grid-column:1/-1">ğŸ“Œ ×¤×ª×—/×™ ×©×“×” ×”×¢×¨×”</div>
    </div>
  </div>
</div>

<script>
/* year */
document.getElementById('yearBadge').textContent = `××¢×•×“×›×Ÿ ×œÖ¾${new Date().getFullYear()}`;

/* helpers */
const fmt = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(n||0);
const r10 = n => Math.floor((n||0)/10)*10;

/* elements */
const E = id => document.getElementById(id);
const els = {
  status: E('status'),
  salaryD: E('salaryDebtor'), salaryP: E('salaryPartner'),
  otherD: E('otherIncomeDebtor'), otherP: E('otherIncomePartner'),
  allowD: E('debtorAllowance'), allowP: E('partnerAllowance'),
  unusual: E('unusualExpenses'), child: E('childcareExpenses'), alimony: E('alimonyExpenses'),

  tIncome: E('totalIncomeResult'), tExp: E('totalExpensesResult'),
  base: E('baseLivingCostResult'), kidsA: E('socialSecurityAllowance'),
  disp: E('disposableIncomeResult'),
  rDeb: E('debtorIncomeRatio'), rPar: E('partnerIncomeRatio'),
  payDeb: E('debtorPaymentResult'), payPar: E('partnerPaymentResult'),
  famCard: E('familyPaymentCard'), payFam: E('finalPaymentResult'),
  zeroRow: E('zeroCaseRow'),

  lblRD: E('debtorIncomeRatioLabel'), lblRP: E('partnerIncomeRatioLabel'),
  lblPD: E('debtorPaymentLabel'), lblPP: E('partnerPaymentLabel'),

  btnAllow: E('btnAllowances'), boxAllow: E('allowanceFields'),
  btnAlim: E('btnAlimony'), boxAlim: E('alimonyFields'),

  male: E('debtorMaleBtn'), female: E('debtorFemaleBtn'), joint: E('jointBtn'),

  reportBtn: E('reportBtn'), reportPanel: E('reportPanel'),
  reportDate: E('reportDate'), noteToggle: E('noteToggle'), noteRow: E('noteRow'),
};

const lookup = {
  "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“":{kids:0, living:4556},
  "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“":{kids:1, living:6056},
  "×–×•×’":{kids:0, living:6024},
  "×–×•×’+×™×œ×“":{kids:1, living:7524},
  "×–×•×’+ 2 ×™×œ×“×™×":{kids:2, living:9024},
  "×–×•×’+ 3 ×™×œ×“×™×":{kids:3, living:10524},
  "×–×•×’+ 4 ×™×œ×“×™×":{kids:4, living:12024},
  "×–×•×’+ 5 ×™×œ×“×™×":{kids:5, living:13324},
  "×–×•×’+ 6 ×™×œ×“×™×":{kids:6, living:14624},
  "×–×•×’+ 7 ×™×œ×“×™×":{kids:7, living:15924},
  "×–×•×’+ 8 ×™×œ×“×™×":{kids:8, living:17224},
  "×–×•×’+ 9 ×™×œ×“×™×":{kids:9, living:18524},
  "×–×•×’+ 10 ×™×œ×“×™×":{kids:10, living:19824},
};
const kidsMap = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

let gender='×—×™×™×‘', joint=false;
function setGender(g){
  gender=g;
  els.male.classList.toggle('active', g==='×—×™×™×‘');
  els.female.classList.toggle('active', g==='×—×™×™×‘×ª');
  const d = (gender==='×—×™×™×‘')?'×—×™×™×‘':'×—×™×™×‘×ª';
  const p = (gender==='×—×™×™×‘')?'×‘×ª ×–×•×’':'×‘×Ÿ ×–×•×’';
  els.lblRD.textContent=`××—×•×– ×”×›× ×¡×” (${d})`;
  els.lblRP.textContent=`××—×•×– ×”×›× ×¡×” (${p})`;
  els.lblPD.textContent=`×ª×©×œ×•× ××•×¦×¢ (${d})`;
  els.lblPP.textContent=`×ª×©×œ×•× ××•×¦×¢ (${p})`;
  calc();
}
els.male.onclick=()=>setGender('×—×™×™×‘');
els.female.onclick=()=>setGender('×—×™×™×‘×ª');

els.joint.onclick=()=>{
  joint=!joint;
  els.joint.classList.toggle('active', joint);
  els.joint.setAttribute('aria-pressed', String(joint));
  els.famCard.style.display = joint ? 'block' : 'none';
  calc();
};

els.btnAllow.onclick=()=>{ els.btnAllow.classList.toggle('active'); els.boxAllow.style.display = els.btnAllow.classList.contains('active')?'grid':'none'; };
els.btnAlim.onclick =()=>{ els.btnAlim.classList.toggle('active'); els.boxAlim.style.display  = els.btnAlim.classList.contains('active')?'grid':'none'; };

els.reportBtn.onclick=()=>{
  const show = els.reportPanel.style.display!=='grid';
  els.reportPanel.style.display = show?'grid':'none';
  if(show){ els.reportDate.value = new Date().toLocaleDateString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit'}); }
};
els.noteToggle.onclick=()=>{
  const on = els.noteRow.style.display!=='block';
  els.noteRow.style.display = on?'block':'none';
};

/* ×˜×•×œ×˜×™×¤×™× */
let pop=null;
document.addEventListener('click',e=>{
  const b = e.target.closest('.info-btn');
  if(b){
    e.stopPropagation();
    if(pop) pop.remove();
    pop=document.createElement('div'); pop.className='pop'; pop.innerHTML=(b.dataset.info||'â€”').replace(/\n/g,'<br>');
    document.body.appendChild(pop);
    const r=b.getBoundingClientRect(); pop.style.top=(window.scrollY+r.bottom+8)+'px'; pop.style.right=(window.innerWidth-r.right+8)+'px';
    return;
  }
  if(pop){ pop.remove(); pop=null; }
});

/* ×—×™×©×•×‘ */
function calc(){
  const s = lookup[els.status.value] || {kids:0,living:0};
  const base = s.living, kids = kidsMap[s.kids]||0;

  const dS=+els.salaryD.value||0, pS=+els.salaryP.value||0;
  const dO=+els.otherD.value||0,  pO=+els.otherP.value||0;
  const dA=+els.allowD.value||0,  pA=+els.allowP.value||0;
  const un=+els.unusual.value||0, ch=+els.child.value||0, al=+els.alimony.value||0;

  els.base.textContent = fmt(base);
  els.kidsA.textContent = fmt(kids);

  const totalIncome = dS+pS + dO+pO + dA+pA + kids;
  els.tIncome.textContent = fmt(totalIncome);

  const totalExp = base + un + ch + al;
  els.tExp.textContent = fmt(totalExp);

  const disp = totalIncome - totalExp;
  els.disp.textContent = disp<=0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : fmt(disp);

  const sumForRatio = dS+dO + pS+pO;
  const rD = sumForRatio>0 ? (dS+dO)/sumForRatio : 0;
  const rP = sumForRatio>0 ? (pS+pO)/sumForRatio : 0;
  els.rDeb.textContent = (rD*100).toFixed(1)+'%';
  els.rPar.textContent = (rP*100).toFixed(1)+'%';

  const payD = r10((disp*rD)/2);
  const payP = r10((disp*rP)/2);
  els.payDeb.textContent = fmt(Math.max(0,payD));
  els.payPar.textContent = fmt(Math.max(0,payP));

  if(joint){
    const fam = r10( Math.max(0, (disp/2) - payP ) * rD + payP );
    els.payFam.textContent = fmt(fam);
  }

  // "×ª×™×§ ××¤×¡" â€“ ×”×›× ×¡×•×ª ×”×—×™×™×‘ ×¨×§ ××§×¦×‘××•×ª (×œ×œ× ×©×›×¨/××—×¨×•×ª), ×•×™×© ×§×¦×‘××•×ª
  const zeroCase = (dS===0 && dO===0 && dA>0);
  els.zeroRow.style.display = zeroCase ? 'block':'none';
}

/* ×××–×™× ×™× */
[
  'status','salaryDebtor','salaryPartner','otherIncomeDebtor','otherIncomePartner',
  'debtorAllowance','partnerAllowance','unusualExpenses','childcareExpenses','alimonyExpenses'
].forEach(id=>E(id).addEventListener('input',calc));

/* PDF / ×¦×™×œ×•× / ××™×™×œ / ××™×¤×•×¡ */
function doPrint(){ window.print(); }
function doShot(){
  html2canvas(E('captureRoot'),{useCORS:true,allowTaint:true,scale:2,backgroundColor:'#ffffff'})
    .then(cv=>{
      const data=cv.toDataURL('image/png');
      const w=window.open('','_blank'); w.document.write(`<img src="${data}" style="max-width:100%;display:block;margin:0 auto">`); w.document.title='×¦×™×œ×•× ××¡×š ×”××—×©×‘×•×Ÿ';
    })
    .catch(()=>alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¦×™×œ×•× ×”××¡×š'));
}
function getTxt(id){return (E(id)?.textContent||'').trim();}
function doMail(){
  const subject='×ª×•×¦××•×ª ××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×';
  const body=[
    '×©×œ×•×,','',
    '×ª×§×¦×™×¨ ×”×ª×•×¦××•×ª (×œ×¦×¨×£ ×™×“× ×™×ª ××ª ×”-PNG/â€PDF ×©× ×©××¨):','',
    `×¡×š ×”×›× ×¡×•×ª: ${getTxt('totalIncomeResult')}`,
    `×¡×š ×”×•×¦××•×ª: ${getTxt('totalExpensesResult')}`,
    `×”×›× ×¡×” ×¤× ×•×™×”: ${getTxt('disposableIncomeResult')}`,
    `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${getTxt('debtorIncomeRatio')}`,
    `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerIncomeRatio')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${getTxt('debtorPaymentResult')}`,
    `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerPaymentResult')}`,
    (els.famCard.style.display!=='none')?`×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${getTxt('finalPaymentResult')}`:'',
    '','×‘×‘×¨×›×”'
  ].filter(Boolean).join('\n');
  window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
function doReset(){
  document.querySelectorAll('input[type="number"],input[type="text"],textarea').forEach(i=>i.value='');
  E('status').selectedIndex=0;
  if(els.btnAllow.classList.contains('active')) els.btnAllow.click();
  if(els.btnAlim.classList.contains('active')) els.btnAlim.click();
  joint=false; els.joint.classList.remove('active'); els.joint.setAttribute('aria-pressed','false'); els.famCard.style.display='none';
  setGender('×—×™×™×‘'); calc();
}

E('btnPdf').onclick=doPrint; E('btnPdf_m')?.addEventListener('click',doPrint);
E('btnShot').onclick=doShot;  E('btnShot_m')?.addEventListener('click',doShot);
E('btnMail').onclick=doMail;  E('btnMail_m')?.addEventListener('click',doMail);
E('btnReset').onclick=doReset; E('btnReset_m')?.addEventListener('click',doReset);

/* init */
setGender('×—×™×™×‘'); calc();
</script>
</body>
</html>
