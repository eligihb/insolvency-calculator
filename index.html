<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary-color:#005f73;--secondary-color:#0a9396;--background-color:#f4f4f4;--container-bg:#fff;
    --text-color:#333;--label-color:#444;--border-color:#d6dee6;--accent-color:#ee9b00;--result-bg:#e9f5f5;
    --danger-color:#ae2012;--blue-color:#0b74ff;--muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{font-family:'Heebo',sans-serif;background:var(--background-color);color:var(--text-color);margin:0;padding:16px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
  .calculator-container{width:100%;max-width:1000px;background:var(--container-bg);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);overflow:hidden;display:grid;grid-template-columns:1fr 1fr}
  header{grid-column:1/-1;background:var(--primary-color);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:1.6em;line-height:1.2}
  .version{font-size:.8em;opacity:.95;margin-inline-start:.5rem;white-space:nowrap}
  /* ×§×•××¤×§×˜×™×–×¦×™×” ×§×œ×” ×‘×“×¡×§×˜×•×¤ */
  @media(min-width:769px){
    header h1{font-size:1.5em}
    .inputs-column,.results-column{padding:18px}
  }

  .inputs-column{padding:22px;border-left:1px solid var(--border-color);background:#fff}
  .results-column{padding:22px;background:var(--result-bg)}
  .form-section{display:grid;gap:14px}
  .form-section h2{grid-column:1/-1;margin:0 0 6px 0;color:var(--primary-color);border-bottom:2px solid var(--secondary-color);padding-bottom:6px;font-size:1.25em}

  /* ×©×“×•×ª */
  .input-group{display:flex;flex-direction:column;width:100%}
  .input-group label{font-weight:500;margin-bottom:6px;color:var(--label-color);display:flex;align-items:center;gap:.5rem;min-height:24px}
  .input-group input,.input-group select,.input-group textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.98em;background:#f7fbff;
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  .input-group textarea{min-height:80px;resize:vertical;background:#fff}
  .input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(10,147,150,.18);background:#fff}
  .input-group input.readonly-display{background:#eef3f7;font-weight:600;color:#1f3a5b}

  /* ×–×•×’×•×ª ×©×“×•×ª â€“ ×”×—×™×™×‘/×ª ×ª××™×“ ×‘×©×××œ, ×‘×Ÿ/×‘×ª ×–×•×’ ×‘×™××™×Ÿ */
  .input-pair-inline{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start}
  .input-group.debtor  {grid-column:1}
  .input-group.partner {grid-column:2}

  /* ×›×¤×ª×•×¨×™ ×‘×—×™×¨×” â€œ××™ ×‘×”×œ×™×šâ€ ×•â€×©× ×™ ×‘× ×™ ×”×–×•×’â€ */
  .top-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
  .debtor-selection-options{display:flex;gap:8px;flex-wrap:nowrap}
  .radio-button-label{background:#f3f4f6;border:1px solid #cfd8e3;padding:8px 14px;border-radius:18px;cursor:pointer;transition:background-color .2s,border-color .2s;color:#1f2937;font-weight:500}
  .radio-button-label.checked{background:#e8f0ff;color:#0b74ff;border-color:#99befc}
  .radio-button-input{display:none}
  #jointProceedingLabel{background:#fff2f2;border:1px solid #f3b4b4;padding:8px 14px;border-radius:18px;cursor:pointer;transition:background-color .2s,border-color .2s;font-weight:600;color:#8b0000}
  #jointProceedingLabel.checked{background:#ffdddd;border-color:#f19999}
  #jointProceeding{display:none}

  /* ××™×™×§×•×Ÿ "?" */
  .info-btn{line-height:1;border:none;cursor:pointer;border-radius:50%;width:20px;height:20px;font-size:.85em;font-weight:700;display:inline-flex;align-items:center;justify-content:center;background:#eef6f6;color:#006d77;box-shadow:0 0 0 1px rgba(0,0,0,.06) inset}
  .info-btn:hover{background:#e1f0f0}
  .info-popover{position:absolute;z-index:1000;max-width:320px;background:#fff7d6;color:#3b2f00;border:1px solid #ffe6a8;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px 14px;font-size:.97em;direction:rtl;line-height:1.45}

  /* ×ª×•×¦××•×ª */
  .results-section{padding:0}
  .results-section h2{margin:6px 0 14px 0;color:var(--primary-color);font-size:1.25em;text-align:center}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#fff;border:1px solid #dbe6ef;border-radius:10px;padding:10px 12px;text-align:center}
  .card .label{display:block;color:#334155;font-weight:600}
  .card .value{display:block;font-weight:800;font-size:1.15em;color:var(--accent-color);margin-top:4px}
  .card.total .value{color:var(--danger-color)}
  .disposable .value{color:var(--blue-color)}
  .hidden{display:none!important}

  /* ×¤×¡ ×¤×¢×•×œ×•×ª ×¢×œ×™×•×Ÿ (×“×¡×§×˜×•×¤) */
  .actions-bar{display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .action-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #cbd5e1;background:#ffffff;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.05)}
  .action-btn:hover{background:#f8fafc}
  .action-btn .ico{font-size:1.05em}
  .email-tip{display:none;background:#fff7d6;border:1px solid #ffe6a8;color:#3b2f00;border-radius:10px;padding:8px 10px;font-size:.9em;margin:0 auto 10px;max-width:560px}

  /* ××ª×’×™ â€œ×§×¦×‘××•×ª / ××–×•× ×•×ªâ€ */
  .toggles-row{display:flex;gap:10px;flex-wrap:wrap}
  .toggle-btn{padding:8px 12px;border:1px dashed #b6c2cf;border-radius:10px;background:#fff;cursor:pointer}
  .toggle-btn.active{background:#f0faff;border-color:#8ecae6}

  /* ×¤×¨×˜×™ ×“×•"×— */
  .report-wrap{display:flex;justify-content:center;margin-top:8px}
  .report-toggle{border:none;background:none;color:#0b74ff;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px}
  .report-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center}
  .note-toggle{border:none;background:none;color:#8b5cf6;font-weight:700;cursor:pointer}
  .note-area{margin-top:6px}

  /* ××•×‘×™×™×œ */
  @media(max-width:768px){
    .calculator-container{grid-template-columns:1fr}
    .inputs-column{border-left:none}
    .input-pair-inline{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
    .actions-sticky{position:sticky;bottom:0;z-index:30;background:#ffffffea;backdrop-filter:blur(4px);padding:8px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:space-between}
    .actions-bar{display:none}
    .results-column{padding-bottom:86px} /* ×©×œ× ×™×¡×ª×™×¨ ××ª ×”×ª×©×œ×•× */
  }

  /* ×”×“×¤×¡×” ×œ×ª××•× ×”: ×”×—×œ×•×Ÿ ×©× ×¤×ª×— ××©×ª××© ×‘×¡×˜×™×™×œ ×©×œ×•; ×›××Ÿ ×¨×§ ×œ×× ×™×¢×ª ×’×œ×™×œ×” ××œ×× ×˜×™× */
  @media print{
    body{padding:0;background:#fff}
  }
</style>
</head>
<body>

<div class="calculator-container" id="calcRoot">
  <header>
    <h1>××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× <span class="version">| ××¢×•×“×›×Ÿ ×œÖ¾<span id="currentYear"></span></span></h1>
  </header>

  <!-- ×¢××•×“×ª ×§×œ×˜ (×©×××œ) -->
  <div class="inputs-column">
    <form id="calculatorForm">

      <!-- ×¡×˜×˜×•×¡ ××©×¤×—×ª×™ â€“ ×©×•×¨×” × ×¤×¨×“×ª -->
      <section class="form-section">
        <div class="input-group">
          <label for="status">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
          <select id="status">
            <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡ ××©×¤×—×ª×™â€¦</option>
            <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
            <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
            <option value="×–×•×’">×–×•×’</option>
            <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
            <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
            <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
          </select>
        </div>
      </section>

      <!-- ××™ ×‘×”×œ×™×š + ×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š -->
      <section class="form-section">
        <div class="top-row">
          <div class="debtor-selection-group" id="debtor-selection">
            <label style="margin-bottom:8px;">××™ ×‘×”×œ×™×š?</label>
            <div class="debtor-selection-options">
              <input class="radio-button-input" type="radio" id="debtor-male" name="debtor-gender" value="×—×™×™×‘" checked>
              <label class="radio-button-label" for="debtor-male">×—×™×™×‘</label>
              <input class="radio-button-input" type="radio" id="debtor-female" name="debtor-gender" value="×—×™×™×‘×ª">
              <label class="radio-button-label" for="debtor-female">×—×™×™×‘×ª</label>
            </div>
          </div>
          <label for="jointProceeding" id="jointProceedingLabel">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?</label>
          <input type="checkbox" id="jointProceeding">
        </div>
      </section>

      <section class="form-section">
        <h2>×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™ (â‚ª)</h2>

        <!-- ×©×›×¨ -->
        <div class="input-pair-inline" id="pair-salary">
          <div class="input-group debtor" id="salaryDebtorGroup">
            <label id="salaryDebtorLabel">
              <span class="label-text">×”×›× ×¡×” (×—×™×™×‘)</span>
              <button type="button" class="info-btn" aria-label="××™×“×¢ ×¢×œ ×”×©×“×”"
                data-info='×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨<br>×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×Ö¾3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤×´×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247 â‚ª'>?</button>
            </label>
            <input type="number" id="salaryDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×”" value="">
          </div>
          <div class="input-group partner" id="salaryPartnerGroup">
            <label id="salaryPartnerLabel">
              <span class="label-text">×”×›× ×¡×” (×‘×ª ×–×•×’)</span>
              <button type="button" class="info-btn" aria-label="××™×“×¢ ×¢×œ ×”×©×“×”"
                data-info='×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.<br>×‘××§×¨×” ×©×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª ×™×™×§×‘×¢ ×ª×©×œ×•× ××“×•×¨×’ ×œ×¤×™ ×©×›×¨ ××™× ×™××•× 6,247 â‚ª'>?</button>
            </label>
            <input type="number" id="salaryPartner" placeholder="×”×–×Ÿ ×”×›× ×¡×”" value="">
          </div>
        </div>

        <!-- ×”×›× ×¡×•×ª ××—×¨×•×ª -->
        <div class="input-pair-inline" id="pair-otherIncome">
          <div class="input-group debtor" id="otherIncomeDebtorGroup">
            <label id="otherIncomeDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘)</label>
            <input type="number" id="otherIncomeDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª" value="">
          </div>
          <div class="input-group partner" id="otherIncomePartnerGroup">
            <label id="otherIncomePartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)</label>
            <input type="number" id="otherIncomePartner" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª" value="">
          </div>
        </div>

        <!-- ××ª×’×™ ×§×¦×‘××•×ª+××–×•× ×•×ª Side by side -->
        <div class="toggles-row">
          <button type="button" id="allowanceButton" class="toggle-btn">×§×¦×‘××•×ª</button>
          <button type="button" id="alimonyButton"   class="toggle-btn">××–×•× ×•×ª</button>
        </div>

        <!-- ×§×¦×‘××•×ª (×¡×’×•×¨ ×‘×¨×™×¨×ª ××—×“×œ) -->
        <div id="allowanceFields" class="hidden">
          <div class="input-pair-inline" id="pair-allowances" style="margin-top:8px">
            <div class="input-group debtor">
              <label for="debtorAllowance" id="debtorAllowanceLabel">×§×¦×‘×” (×—×™×™×‘/×ª)</label>
              <input type="number" id="debtorAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”" value="">
            </div>
            <div class="input-group partner" id="partnerAllowanceGroup">
              <label for="partnerAllowance" id="partnerAllowanceLabel">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
              <input type="number" id="partnerAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”" value="">
            </div>
          </div>
        </div>

        <!-- ×”×•×¦××•×ª ×—×¨×™×’×•×ª/×¦×”×¨×•× ×™× -->
        <div class="input-pair-inline" style="margin-top:6px">
          <div class="input-group">
            <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label>
            <input type="number" id="unusualExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª" value="">
          </div>
          <div class="input-group">
            <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
            <input type="number" id="childcareExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª" value="">
          </div>
        </div>

        <!-- ××–×•× ×•×ª (×¡×’×•×¨ ×‘×¨×™×¨×ª ××—×“×œ) -->
        <div id="alimonyFields" class="hidden">
          <div class="input-pair-inline" style="margin-top:8px">
            <div class="input-group">
              <label for="alimonyExpenses">×”×•×¦××•×ª ××–×•× ×•×ª</label>
              <input type="number" id="alimonyExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª" value="">
            </div>
          </div>
        </div>

        <!-- ×¤×¨×˜×™ ×“×•"×— â€“ ××ª×—×ª ×œ××–×•× ×•×ª ×‘×××¦×¢ -->
        <div class="report-wrap">
          <button type="button" id="reportToggle" class="report-toggle">ğŸ“„ ×¤×¨×˜×™ ×“×•×´×—</button>
        </div>
        <div id="reportPanel" class="hidden">
          <div class="report-row" style="margin-top:8px">
            <div class="input-group"><label for="caseId">××¡' ×ª×™×§</label><input type="text" id="caseId" placeholder="×œ×“×•×’××”: 12345/25"></div>
            <div class="input-group"><label for="authorName">×©× ×¢×•×¨×š/×ª</label><input type="text" id="authorName" placeholder="×©× ××œ×"></div>
            <div class="input-group"><label for="calcDate">×ª××¨×™×š</label><input type="text" id="calcDate" class="readonly-display" readonly></div>
            <button type="button" id="noteToggle" class="note-toggle" title="×”×¢×¨×”">ğŸ“Œ ×”×¢×¨×”</button>
          </div>
          <div id="noteArea" class="note-area hidden">
            <div class="input-group">
              <label for="calcNotes">×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</label>
              <textarea id="calcNotes" maxlength="500" placeholder="×”×¢×¨×” ×—×•×¤×©×™×ªâ€¦"></textarea>
            </div>
          </div>
        </div>

      </section>
    </form>
  </div>

  <!-- ×¢××•×“×ª ×ª×•×¦××•×ª (×™××™×Ÿ) -->
  <div class="results-column">

    <!-- ×¤×¡ ×¤×¢×•×œ×•×ª (×“×¡×§×˜×•×¤) -->
    <div class="actions-bar">
      <button type="button" class="action-btn" id="shotBtn"><span class="ico">ğŸ“¸</span> ×¦×™×œ×•× ××¡×š</button>
      <button type="button" class="action-btn" id="emailBtn"><span class="ico">âœ‰ï¸</span> ×©×œ×— ×‘××™×™×œ</button>
      <button type="button" class="action-btn" id="resetBtn"><span class="ico">â†º</span> ××™×¤×•×¡</button>
    </div>
    <div id="emailTip" class="email-tip">
      ×˜×™×¤: ×©××•×¨/×™ ×§×•×“× ××ª ×¦×™×œ×•× ×”××¡×š (×›×¤×ª×•×¨ â€œ×¦×™×œ×•× ××¡×šâ€), ×•××– ×¦×¨×¤×• ×™×“× ×™×ª ××ª ×”Ö¾PNG ×œ×”×•×“×¢×ª ×”××™×™×œ ×©× ×¤×ª×—×ª.
    </div>

    <section class="results-section">
      <h2>×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

      <div class="cards">
        <div class="card">
          <span class="label">×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™</span>
          <span class="value" id="socialSecurityAllowance">0 â‚ª</span>
        </div>
        <div class="card">
          <span class="label">×¡×š ×”×›× ×¡×•×ª</span>
          <span class="value" id="totalIncomeResult">0 â‚ª</span>
        </div>

        <div class="card">
          <span class="label" id="livingCostLabel">×“××™ ××—×™×™×” ×‘×›×‘×•×“</span>
          <span class="value" id="baseLivingCostResult">0 â‚ª</span>
        </div>
        <div class="card">
          <span class="label">×¡×š ×”×•×¦××•×ª</span>
          <span class="value" id="totalExpensesResult">0 â‚ª</span>
        </div>

        <div class="card disposable">
          <span class="label">×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™</span>
          <span class="value" id="disposableIncomeResult">0 â‚ª</span>
        </div>
        <div class="card">
          <span class="label" id="debtorIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘)</span>
          <span class="value" id="debtorIncomeRatio">0%</span>
        </div>

        <div class="card">
          <span class="label" id="partnerIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)</span>
          <span class="value" id="partnerIncomeRatio">0%</span>
        </div>
        <div class="card">
          <span class="label" id="debtorPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª)</span>
          <span class="value" id="debtorPaymentResult">0 â‚ª</span>
        </div>

        <div class="card" id="partnerPaymentCard">
          <span class="label" id="partnerPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’)</span>
          <span class="value" id="partnerPaymentResult">0 â‚ª</span>
        </div>
        <div class="card total" id="finalPaymentCard">
          <span class="label" id="finalPaymentLabel">×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™</span>
          <span class="value" id="finalPaymentResult">0 â‚ª</span>
        </div>
      </div>
    </section>

    <!-- ×¤×¡ ×¤×¢×•×œ×•×ª ×“×‘×™×§ (××•×‘×™×™×œ) -->
    <div class="actions-sticky">
      <button type="button" class="action-btn" id="shotBtn_m"><span class="ico">ğŸ“¸</span> ×¦×™×œ×•×</button>
      <button type="button" class="action-btn" id="emailBtn_m"><span class="ico">âœ‰ï¸</span> ××™×™×œ</button>
      <button type="button" class="action-btn" id="resetBtn_m"><span class="ico">â†º</span> ××™×¤×•×¡</button>
    </div>
  </div>
</div>

<!-- html2canvas ×œ×¦×™×œ×•× -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ×©× ×” ×‘×›×•×ª×¨×ª + ×ª××¨×™×š ×“×•"×—
  const currentYearEl = document.getElementById('currentYear');
  if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
  const calcDateEl = document.getElementById('calcDate');
  if(calcDateEl){ const now = new Date(); calcDateEl.value = now.toLocaleDateString('he-IL', {year:'numeric', month:'2-digit', day:'2-digit'}); }

  // × ×ª×•× ×™ ×‘×¡×™×¡
  const lookupData = {
    "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“": { kids: 0, livingCost: 4556 },
    "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“": { kids: 1, livingCost: 6056 }, "×–×•×’": { kids: 0, livingCost: 6024 },
    "×–×•×’+×™×œ×“": { kids: 1, livingCost: 7524 }, "×–×•×’+ 2 ×™×œ×“×™×": { kids: 2, livingCost: 9024 },
    "×–×•×’+ 3 ×™×œ×“×™×": { kids: 3, livingCost: 10524 }, "×–×•×’+ 4 ×™×œ×“×™×": { kids: 4, livingCost: 12024 },
    "×–×•×’+ 5 ×™×œ×“×™×": { kids: 5, livingCost: 13324 }, "×–×•×’+ 6 ×™×œ×“×™×": { kids: 6, livingCost: 14624 },
    "×–×•×’+ 7 ×™×œ×“×™×": { kids: 7, livingCost: 15924 }, "×–×•×’+ 8 ×™×œ×“×™×": { kids: 8, livingCost: 17224 },
    "×–×•×’+ 9 ×™×œ×“×™×": { kids: 9, livingCost: 18524 }, "×–×•×’+ 10 ×™×œ×“×™×": { kids: 10, livingCost: 19824 }
  };
  const childAllowanceData = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

  // DOM refs
  const form = document.getElementById('calculatorForm');
  const inputs = form.querySelectorAll('input, select');

  const statusEl = document.getElementById('status');
  const debtorMaleEl = document.getElementById('debtor-male');
  const debtorFemaleEl = document.getElementById('debtor-female');
  const jointProceedingEl = document.getElementById('jointProceeding');
  const jointProceedingLabelEl = document.getElementById('jointProceedingLabel');

  const salaryDebtorEl = document.getElementById('salaryDebtor');
  const salaryPartnerEl = document.getElementById('salaryPartner');
  const otherIncomeDebtorEl = document.getElementById('otherIncomeDebtor');
  const otherIncomePartnerEl = document.getElementById('otherIncomePartner');
  const debtorAllowanceEl = document.getElementById('debtorAllowance');
  const partnerAllowanceEl = document.getElementById('partnerAllowance');
  const unusualExpensesEl = document.getElementById('unusualExpenses');
  const childcareExpensesEl = document.getElementById('childcareExpenses');
  const alimonyExpensesEl = document.getElementById('alimonyExpenses');

  const salaryDebtorLabelTextEl  = document.querySelector('#salaryDebtorLabel .label-text');
  const salaryPartnerLabelTextEl = document.querySelector('#salaryPartnerLabel .label-text');
  const otherIncomeDebtorLabelEl = document.getElementById('otherIncomeDebtorLabel');
  const otherIncomePartnerLabelEl = document.getElementById('otherIncomePartnerLabel');
  const debtorIncomeRatioLabelEl = document.getElementById('debtorIncomeRatioLabel');
  const partnerIncomeRatioLabelEl = document.getElementById('partnerIncomeRatioLabel');
  const debtorPaymentLabelEl = document.getElementById('debtorPaymentLabel');
  const partnerPaymentLabelEl = document.getElementById('partnerPaymentLabel');
  const debtorAllowanceLabelEl = document.getElementById('debtorAllowanceLabel');
  const partnerAllowanceLabelEl = document.getElementById('partnerAllowanceLabel');

  const baseLivingCostResultEl = document.getElementById('baseLivingCostResult');
  const socialSecurityAllowanceEl = document.getElementById('socialSecurityAllowance');
  const disposableIncomeResultEl = document.getElementById('disposableIncomeResult');
  const debtorIncomeRatioEl = document.getElementById('debtorIncomeRatio');
  const partnerIncomeRatioEl = document.getElementById('partnerIncomeRatio');
  const debtorPaymentResultEl = document.getElementById('debtorPaymentResult');
  const partnerPaymentResultEl = document.getElementById('partnerPaymentResult');
  const finalPaymentResultEl = document.getElementById('finalPaymentResult');
  const finalPaymentLabelEl = document.getElementById('finalPaymentLabel');

  const partnerPaymentCard = document.getElementById('partnerPaymentCard');
  const finalPaymentCard = document.getElementById('finalPaymentCard');

  const allowanceBtn = document.getElementById('allowanceButton');
  const allowanceFields = document.getElementById('allowanceFields');
  const alimonyBtn = document.getElementById('alimonyButton');
  const alimonyFields = document.getElementById('alimonyFields');

  const reportToggle = document.getElementById('reportToggle');
  const reportPanel = document.getElementById('reportPanel');
  const noteToggle = document.getElementById('noteToggle');
  const noteArea = document.getElementById('noteArea');

  // ×¤×¢×•×œ×•×ª
  const shotBtns = [document.getElementById('shotBtn'), document.getElementById('shotBtn_m')];
  const emailBtns = [document.getElementById('emailBtn'), document.getElementById('emailBtn_m')];
  const resetBtns = [document.getElementById('resetBtn'), document.getElementById('resetBtn_m')];
  const emailTip = document.getElementById('emailTip');

  const formatCurrency = (v)=> (typeof v!=='number'||isNaN(v)) ? '0 â‚ª' :
    new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(v);
  const round10 = (n)=> Math.floor(n/10)*10;

  function updateLabelsAndUI(){
    const status = statusEl.value || '';
    const isSingle = status.includes('×™×—×™×“') || status.includes('×¨×•×•×§');
    const isMaleDebtor = debtorMaleEl.checked;
    const isJoint = jointProceedingEl.checked;

    // ×¦×‘×¢ ×œ×›×¤×ª×•×¨×™ â€œ××™ ×‘×”×œ×™×šâ€
    document.querySelectorAll('.radio-button-label').forEach(l=>l.classList.remove('checked'));
    if(debtorMaleEl.checked) document.querySelector('label[for="debtor-male"]').classList.add('checked');
    if(debtorFemaleEl.checked) document.querySelector('label[for="debtor-female"]').classList.add('checked');
    jointProceedingLabelEl.classList.toggle('checked', isJoint);

    // ×ª×•×•×™×•×ª
    let debtorText, partnerText;
    if(isSingle){ debtorText='×—×™×™×‘/×ª'; partnerText='×‘×Ÿ/×‘×ª ×–×•×’'; }
    else if(isMaleDebtor){ debtorText='×—×™×™×‘'; partnerText='×‘×ª ×–×•×’'; }
    else{ debtorText='×—×™×™×‘×ª'; partnerText='×‘×Ÿ ×–×•×’'; }

    if (salaryDebtorLabelTextEl)  salaryDebtorLabelTextEl.textContent  = isSingle ? '×”×›× ×¡×” (×—×™×™×‘/×ª)' : (isMaleDebtor?'×”×›× ×¡×” (×—×™×™×‘)':'×”×›× ×¡×” (×—×™×™×‘×ª)');
    if (salaryPartnerLabelTextEl) salaryPartnerLabelTextEl.textContent = isSingle ? '×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)' : (isMaleDebtor?'×”×›× ×¡×” (×‘×ª ×–×•×’)':'×”×›× ×¡×” (×‘×Ÿ ×–×•×’)');
    otherIncomeDebtorLabelEl.textContent  = `×”×›× ×¡×•×ª ××—×¨×•×ª (${debtorText})`;
    otherIncomePartnerLabelEl.textContent = `×”×›× ×¡×•×ª ××—×¨×•×ª (${partnerText})`;
    debtorIncomeRatioLabelEl.textContent  = `××—×•×– ×”×›× ×¡×” (${debtorText})`;
    partnerIncomeRatioLabelEl.textContent = `××—×•×– ×”×›× ×¡×” (${partnerText})`;
    debtorPaymentLabelEl.textContent      = `×ª×©×œ×•× ××•×¦×¢ (${debtorText})`;
    partnerPaymentLabelEl.textContent     = `×ª×©×œ×•× ××•×¦×¢ (${partnerText})`;
    if (debtorAllowanceLabelEl)  debtorAllowanceLabelEl.textContent  = `×§×¦×‘×” (${debtorText})`;
    if (partnerAllowanceLabelEl) partnerAllowanceLabelEl.textContent = `×§×¦×‘×” (${partnerText})`;

    // ×”×¦×’×ª ×§×œ×¤×™× ×‘×”×ª×× ×œ××¦×‘ "×©× ×™ ×‘× ×™ ×”×–×•×’"
    partnerPaymentCard.classList.toggle('hidden', !isJoint);
    finalPaymentCard.classList.toggle('hidden', !isJoint);
    finalPaymentLabelEl.textContent = isJoint ? '×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™' : '×ª×©×œ×•× ×—×•×“×©×™ (×—×™×™×‘/×ª)';
  }

  function calculate(){
    const status = statusEl.value || '';
    const isJoint = jointProceedingEl.checked;
    const isSingle = status.includes('×™×—×™×“') || status.includes('×¨×•×•×§');

    const salD = parseFloat(salaryDebtorEl.value)||0;
    const salP = parseFloat(salaryPartnerEl.value)||0;
    const othD = parseFloat(otherIncomeDebtorEl.value)||0;
    const othP = parseFloat(otherIncomePartnerEl.value)||0;
    const allD = parseFloat(debtorAllowanceEl.value)||0;
    const allP = parseFloat(partnerAllowanceEl.value)||0;
    const expU = parseFloat(unusualExpensesEl.value)||0;
    const expC = parseFloat(childcareExpensesEl.value)||0;
    const expA = parseFloat(alimonyExpensesEl.value)||0;

    const stData = lookupData[status] || {kids:0,livingCost:0};
    const baseLiving = stData.livingCost;
    const childAll   = childAllowanceData[stData.kids] || 0;

    baseLivingCostResultEl.textContent = formatCurrency(baseLiving);
    socialSecurityAllowanceEl.textContent = formatCurrency(childAll);

    const ratioDen = salD + salP + othD + othP;
    const ratioD = ratioDen>0 ? (salD+othD)/ratioDen : 0;
    const ratioP = ratioDen>0 ? (salP+othP)/ratioDen : 0;

    debtorIncomeRatioEl.textContent  = (ratioD*100).toFixed(1)+'%';
    partnerIncomeRatioEl.textContent = (ratioP*100).toFixed(1)+'%';

    const totalIncome = salD+salP+othD+othP+allD+allP+childAll;
    const totalExpenses = baseLiving + expU + expC + expA;
    const disposable = totalIncome - totalExpenses;

    document.getElementById('totalIncomeResult').textContent = formatCurrency(totalIncome);
    document.getElementById('totalExpensesResult').textContent = formatCurrency(totalExpenses);
    disposableIncomeResultEl.textContent = disposable<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : formatCurrency(disposable);

    // ×ª×©×œ×•××™× ××•×¦×¢×™× (×›×œ ××—×“ ×—×¦×™ ××”×—×œ×§ ×”×™×—×¡×™)
    const debtorProposal = ratioD>0 ? round10((disposable*ratioD)/2) : 0;
    const partnerProposal= ratioP>0 ? round10((disposable*ratioP)/2) : 0;
    debtorPaymentResultEl.textContent  = formatCurrency(Math.max(0,debtorProposal));
    partnerPaymentResultEl.textContent = formatCurrency(Math.max(0,partnerProposal));

    // "×ª×™×§ ××¤×¡" â€“ ××š ×•×¨×§ ×”×›× ×¡×•×ª ××§×¦×‘××•×ª, ×•×œ×—×™×™×‘ ××™×Ÿ ×©×•× ×”×›× ×¡×”; ×× ×˜×•×¤×¡ ×¨×™×§ => 0 â‚ª
    const incomesOnlyAllowances = (salD+salP+othD+othP)===0 && (allD+allP+childAll)>0;
    const formEmpty = totalIncome===0 && totalExpenses===0;
    let finalPayment = 0;
    let finalText = '';
    let finalIsCaseZero = false;

    if (isJoint){
      // × ×•×¡×—×” ×”××¢×•×“×›× ×ª: (×“×™×¡×¤/2 - ×ª×©×œ×•× ×‘×Ÿ/×‘×ª ×–×•×’) * ×™×—×¡ ×—×™×™×‘ + ×ª×©×œ×•× ×‘×Ÿ/×‘×ª ×–×•×’
      const half = disposable/2;
      const base = Math.max(0, half - partnerProposal);
      finalPayment = round10(base * ratioD + partnerProposal);
      finalText = formatCurrency(Math.max(0,finalPayment));
    } else {
      // ×™×—×™×“/×” â€“ ××¦×™×’×™× ××ª ×ª×©×œ×•× ×”×—×™×™×‘/×ª
      finalPayment = Math.max(0,debtorProposal);
      if (incomesOnlyAllowances && !formEmpty && salD===0 && othD===0){
        finalIsCaseZero = true;
        finalText = '×ª×™×§ ××¤×¡';
      } else {
        finalText = formatCurrency(finalPayment);
      }
    }

    finalPaymentResultEl.textContent = finalText;
    finalPaymentResultEl.style.color = finalIsCaseZero ? '#8b0000' : (isJoint ? 'var(--danger-color)' : 'var(--danger-color)');
    finalPaymentResultEl.style.fontWeight = finalIsCaseZero ? '900' : '700';
  }

  // ×¤×•×¤××‘×¨ "?"
  let currentPopover=null,currentBtn=null;
  function closePopover(){ if(currentPopover){ currentPopover.remove(); currentPopover=null; if(currentBtn) currentBtn.setAttribute('aria-expanded','false'); currentBtn=null; } }
  function openPopover(btn){
    const raw = btn.getAttribute('data-info') || '';
    if(!raw) return;
    if(currentBtn===btn){ closePopover(); return; }
    closePopover();
    const pop=document.createElement('div'); pop.className='info-popover'; pop.innerHTML = raw;
    document.body.appendChild(pop);
    const rect=btn.getBoundingClientRect();
    const top=rect.bottom+window.scrollY+8;
    const right=(window.innerWidth-rect.right)+8;
    pop.style.top=top+'px'; pop.style.right=right+'px';
    currentPopover=pop; currentBtn=btn; btn.setAttribute('aria-expanded','true');
  }
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.info-btn');
    if(btn){ openPopover(btn); return; }
    if(currentPopover && !e.target.closest('.info-popover')) closePopover();
  });
  window.addEventListener('scroll',closePopover,{passive:true});
  window.addEventListener('resize',closePopover);

  // ×˜×•×’×œ×™×
  allowanceBtn.addEventListener('click', ()=>{
    allowanceBtn.classList.toggle('active');
    allowanceFields.classList.toggle('hidden');
  });
  alimonyBtn.addEventListener('click', ()=>{
    alimonyBtn.classList.toggle('active');
    alimonyFields.classList.toggle('hidden');
  });
  reportToggle.addEventListener('click', ()=> reportPanel.classList.toggle('hidden'));
  noteToggle.addEventListener('click', ()=> noteArea.classList.toggle('hidden'));

  // ×¢×“×›×•× ×™×
  inputs.forEach(el=> el.addEventListener('input', ()=>{ updateLabelsAndUI(); calculate(); }));
  [statusEl, debtorMaleEl, debtorFemaleEl, jointProceedingEl].forEach(el=> el.addEventListener('change', ()=>{ updateLabelsAndUI(); calculate(); }));

  // ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª
  function doShot(){
    const node=document.getElementById('calcRoot');
    const isMobile = window.matchMedia('(max-width: 768px)').matches;

    html2canvas(node,{
      useCORS:true,backgroundColor:'#ffffff',
      scale:2,
      scrollY:-window.scrollY,
      windowWidth:document.documentElement.scrollWidth,
      windowHeight:document.documentElement.scrollHeight
    }).then(canvas=>{
      if(!isMobile){
        // ×“×¡×§×˜×•×¤ â€“ ×ª××•× ×” ××—×ª, ×¢××•×“ ××—×“
        const data=canvas.toDataURL('image/png');
        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="utf-8"><title>×¦×™×œ×•× ××—×©×‘×•×Ÿ</title>
          <style>html,body{margin:0;padding:0} img{display:block;width:100%;height:auto;page-break-after:always}
          @media print{ @page{size:A4; margin:5mm} img{width:100%;height:auto} }</style></head>
          <body><img src="${data}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      } else {
        // ××•×‘×™×™×œ â€“ ××¤×¦×œ×™× ×œ×©× ×™ ×“×¤×™×
        const halfH = Math.ceil(canvas.height/2);
        const can1 = document.createElement('canvas'); can1.width=canvas.width; can1.height=halfH;
        const can2 = document.createElement('canvas'); can2.width=canvas.width; can2.height=canvas.height-halfH;
        const ctx1=can1.getContext('2d'); const ctx2=can2.getContext('2d');
        ctx1.drawImage(canvas,0,0,canvas.width,halfH,0,0,canvas.width,halfH);
        ctx2.drawImage(canvas,0,halfH,canvas.width,canvas.height-halfH,0,0,canvas.width,canvas.height-halfH);
        const data1=can1.toDataURL('image/png'); const data2=can2.toDataURL('image/png');

        const w=window.open('','_blank','noopener,noreferrer');
        w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="utf-8"><title>×¦×™×œ×•× ××—×©×‘×•×Ÿ (××•×‘×™×™×œ)</title>
          <style>html,body{margin:0;padding:0} img{display:block;width:100%;height:auto}
          @media print{ @page{size:A4; margin:5mm} img{page-break-after:always} }</style></head>
          <body><img src="${data1}"><img src="${data2}"></body></html>`);
        w.document.close(); w.focus(); w.print();
      }
    });
  }
  function doEmail(){
    emailTip.style.display='block';
    const getTxt = id => (document.getElementById(id)?.textContent || '').trim();
    const caseId = (document.getElementById('caseId')?.value || '').trim();
    const author = (document.getElementById('authorName')?.value || '').trim();
    const dateStr= (document.getElementById('calcDate')?.value || '').trim();
    const notes  = (document.getElementById('calcNotes')?.value || '').trim();

    const subject=`××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™× â€“ ${caseId?('×ª×™×§ '+caseId):'×œ×œ× ××¡×¤×¨ ×ª×™×§'}`;
    const lines = [
      '×©×œ×•×,','',
      '××¦×•×¨×£ ×¦×™×œ×•× ××¡×š ×©×œ ×ª×•×¦××•×ª ×”×—×™×©×•×‘ (× × ×œ×¦×¨×£ ××ª ×§×•×‘×¥ ×”-PNG ×©× ×©××¨/×”×•×“×¤×¡).','',
      '×¤×¨×˜×™ ×“×•×´×—:',
      `××¡×³ ×ª×™×§: ${caseId || '-'}`,
      `×¢×•×¨×š/×ª: ${author || '-'}`,
      `×ª××¨×™×š: ${dateStr || '-'}`,
      notes? `×”×¢×¨×”: ${notes}` : '',
      '',
      '×ª×§×¦×™×¨ ×ª×•×¦××•×ª:',
      `×¡×š ×”×›× ×¡×•×ª: ${getTxt('totalIncomeResult')}`,
      `×¡×š ×”×•×¦××•×ª: ${getTxt('totalExpensesResult')}`,
      `×”×›× ×¡×” ×¤× ×•×™×”: ${getTxt('disposableIncomeResult')}`,
      `××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª): ${getTxt('debtorIncomeRatio')}`,
      `××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerIncomeRatio')}`,
      `×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª): ${getTxt('debtorPaymentResult')}`,
      `×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’): ${getTxt('partnerPaymentResult')}`,
      `×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™: ${getTxt('finalPaymentResult')}`,
      '', '×‘×‘×¨×›×”'
    ].filter(Boolean).join('\n');

    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(lines)}`;
  }
  function doReset(){
    form.reset();
    // ×œ× ×§×•×ª ××¦×‘×™×
    allowanceFields.classList.add('hidden');
    alimonyFields.classList.add('hidden');
    allowanceBtn.classList.remove('active');
    alimonyBtn.classList.remove('active');
    reportPanel.classList.add('hidden');
    noteArea.classList.add('hidden');
    document.getElementById('debtor-male').checked = true;
    updateLabelsAndUI(); calculate();
  }

  shotBtns.forEach(b=> b && b.addEventListener('click', doShot));
  emailBtns.forEach(b=> b && b.addEventListener('click', doEmail));
  resetBtns.forEach(b=> b && b.addEventListener('click', doReset));

  // Init
  updateLabelsAndUI();
  calculate();
});
</script>
</body>
</html>
