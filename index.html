<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>××—×©×‘×•×Ÿ ×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#005f73; --secondary:#0a9396; --bg:#f4f4f4; --card:#fff;
      --text:#333; --label:#555; --border:#ddd; --accent:#ee9b00;
      --result-bg:#e9f5f5; --danger:#ae2012; --info:#fff3cd; --info-border:#ffe8a6; --blue:#007bff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Heebo',sans-serif}
    header{background:var(--primary);color:#fff;padding:18px 20px;text-align:center}
    header h1{margin:0;font-size:1.9rem;display:inline-flex;gap:.75rem;align-items:baseline}
    header .version{font-size:.95rem;opacity:.9;background:rgba(255,255,255,.15);padding:2px 8px;border-radius:12px}

    .calculator{max-width:1100px;margin:20px auto;display:grid;grid-template-columns:1fr 1fr;gap:0;box-shadow:0 4px 14px rgba(0,0,0,.07);border-radius:12px;overflow:hidden}
    .left,.right{padding:22px}
    .left{background:var(--result-bg)}
    .right{background:var(--card);border-inline-start:1px solid var(--border)}

    h2.title{margin:0 0 12px;color:var(--primary);border-bottom:2px solid var(--secondary);padding-bottom:8px;font-size:1.25rem}

    /* ×›×¤×ª×•×¨×™ ×“×•"×— + ××ª×§×¤×œ×™× */
    .report-bar{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn:hover{border-color:var(--secondary)}
    .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .chip.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}

    .collapse{border:1px solid var(--border);background:#fff;border-radius:10px;margin:6px 0;overflow:hidden}
    .collapse-toggle{display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;background:#fafafa;border:0;cursor:pointer;text-align:right}
    .collapse-content{display:none;padding:12px}
    .collapse.open .collapse-content{display:block}

    .inline-fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .input{display:flex;flex-direction:column;gap:6px}
    label{color:var(--label);font-weight:500}
    input[type="text"],input[type="number"],select,textarea{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:1rem
    }
    textarea{min-height:70px;resize:vertical}
    .muted{font-size:.85rem;color:#666}

    /* ×ª×•×¦××•×ª */
    .result-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #d4e7e7}
    .result-row:last-child{border-bottom:none}
    .result-row .value{font-weight:700;color:var(--accent)}
    .result-row .value.big{color:var(--blue);font-size:1.35rem}
    .result-row.total .value{color:var(--danger);font-size:1.35rem}

    /* ×–×•×’×•×ª ×©×“×•×ª */
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:8px 0 14px}
    .pair .input.debtor{grid-column:1}   /* ×—×™×™×‘/×ª ××©×××œ */
    .pair .input.partner{grid-column:2}  /* ×‘×Ÿ/×‘×ª ×–×•×’ ××™××™×Ÿ */

    /* ×˜×•×œ×˜×™×¤×™× */
    .help-wrap{position:relative;display:inline-block}
    .help{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;border:1px solid var(--border);cursor:pointer;background:#fff;margin-inline-start:6px}
    .tooltip{position:absolute;inset-inline-start:0;top:28px;min-width:220px;max-width:300px;background:var(--info);border:1px solid var(--info-border);color:#5b4c00;padding:10px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.08);display:none;z-index:10}
    .tooltip.show{display:block}

    .note{background:var(--info);border:1px solid var(--info-border);color:#5b4c00;border-radius:10px;padding:12px;margin-top:10px}

    @media print{
      .report-bar,.chip,.collapse-toggle,.help,.note-tip{display:none !important}
      .collapse-content{display:block !important}
      header{position:static}
      .calculator{box-shadow:none}
    }

    @media (max-width:900px){
      .calculator{grid-template-columns:1fr}
      .right{border-inline-start:none;border-top:1px solid var(--border)}
      .pair{grid-template-columns:1fr}
      .pair .input.debtor,.pair .input.partner{grid-column:auto}
    }
  </style>
</head>
<body>
  <header>
    <h1><span class="version">×’×¨×¡×” 2025</span> ××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</h1>
  </header>

  <div class="calculator">
    <!-- LEFT -->
    <section class="left">
      <div class="report-bar">
        <button id="btnPrint" class="btn">ğŸ–¨ï¸ ×”×“×¤×¡/×¦×™×œ×•×</button>
        <button id="btnMail" class="btn">âœ‰ï¸ ×©×œ×— ××™×™×œ</button>
        <span id="mailTip" class="note-tip" style="display:none;color:#5b4c00;background:var(--info);border:1px solid var(--info-border);padding:6px 10px;border-radius:10px">
          ×©××•×¨/×”×“×¤×¡ ×œ-PDF ×•××– ×¦×¨×£ ×œ×§×•×‘×¥ ×”××™×™×œ.
        </span>
      </div>

      <div class="collapse" id="reportCollapse">
        <button class="collapse-toggle" type="button">ğŸ“„ ×¤×¨×˜×™ ×”×“×•"×—</button>
        <div class="collapse-content">
          <div class="inline-fields">
            <div class="input">
              <label>××¡×³ ×ª×™×§</label>
              <input type="text" id="caseNo" placeholder="×œ××©×œ: 12345/25" />
            </div>
            <div class="input">
              <label>×©× ×¢×•×¨×š/×ª ×”×—×™×©×•×‘</label>
              <input type="text" id="authorName" placeholder="×©× ××œ×" />
            </div>
          </div>
          <div class="input" style="max-width:220px">
            <label>×ª××¨×™×š</label>
            <input type="text" id="reportDate" readonly />
          </div>
        </div>
      </div>

      <div class="collapse" id="noteCollapse">
        <button class="collapse-toggle" type="button">ğŸ“ ×”×•×¡×¤×ª ×”×¢×¨×” (×¢×“ 500 ×ª×•×•×™×)</button>
        <div class="collapse-content">
          <div class="input">
            <textarea id="userNote" maxlength="500" placeholder="×¨×©×•×/×™ ×›××Ÿ ×”×¢×¨×•×ª ×œ×‘×™×¦×•×¢/×”×‘×”×¨×•×ª..."></textarea>
            <div class="muted"><span id="noteCount">0</span>/500</div>
          </div>
        </div>
      </div>

      <h2 class="title">×ª×•×¦××•×ª ×”×—×™×©×•×‘</h2>

      <div class="result-row">
        <div>×§×¦×‘×ª ×‘×™×˜×•×— ×œ××•××™:</div><div class="value" id="socialSecurityAllowance">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div>×¡×š ×”×›× ×¡×•×ª:</div><div class="value" id="totalIncomeResult">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div id="livingCostLabel">×“××™ ××—×™×™×” ×‘×›×‘×•×“:</div><div class="value" id="baseLivingCostResult">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div>×¡×š ×”×•×¦××•×ª:</div><div class="value" id="totalExpensesResult">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div>×”×›× ×¡×” ×¤× ×•×™×” ×œ×ª× ×”××©×¤×—×ª×™:</div><div class="value big" id="disposableIncomeResult">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div id="debtorIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×—×™×™×‘/×ª):</div><div class="value" id="debtorIncomeRatio">0%</div>
      </div>
      <div class="result-row">
        <div id="partnerIncomeRatioLabel">××—×•×– ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’):</div><div class="value" id="partnerIncomeRatio">0%</div>
      </div>
      <div class="result-row">
        <div id="debtorPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×—×™×™×‘/×ª):</div><div class="value" id="debtorPaymentResult">0 â‚ª</div>
      </div>
      <div class="result-row">
        <div id="partnerPaymentLabel">×ª×©×œ×•× ××•×¦×¢ (×‘×Ÿ/×‘×ª ×–×•×’):</div><div class="value" id="partnerPaymentResult">0 â‚ª</div>
      </div>
      <div class="result-row total">
        <div>×ª×©×œ×•× ×—×•×“×©×™ ×œ×ª× ××©×¤×—×ª×™:</div><div class="value" id="finalPaymentResult">0 â‚ª</div>
      </div>

      <div class="note">
        <strong>×”×¢×¨×”:</strong> ×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×-3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤"×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š <strong>6,247.67 â‚ª</strong>.
      </div>
    </section>

    <!-- RIGHT -->
    <section class="right">
      <h2 class="title">×¤×¨×˜×™ ×”×ª× ×”××©×¤×—×ª×™</h2>

      <div class="input" style="max-width:420px">
        <label class="muted">×¡×˜×˜×•×¡ ××©×¤×—×ª×™</label>
        <select id="status">
          <option value="" selected disabled>×‘×—×¨ ×¡×˜×˜×•×¡...</option>
          <option value="×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“">×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“</option>
          <option value="×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“">×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“</option>
          <option value="×–×•×’">×–×•×’</option>
          <option value="×–×•×’+×™×œ×“">×–×•×’+×™×œ×“</option>
          <option value="×–×•×’+ 2 ×™×œ×“×™×">×–×•×’+ 2 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 3 ×™×œ×“×™×">×–×•×’+ 3 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 4 ×™×œ×“×™×">×–×•×’+ 4 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 5 ×™×œ×“×™×">×–×•×’+ 5 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 6 ×™×œ×“×™×">×–×•×’+ 6 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 7 ×™×œ×“×™×">×–×•×’+ 7 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 8 ×™×œ×“×™×">×–×•×’+ 8 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 9 ×™×œ×“×™×">×–×•×’+ 9 ×™×œ×“×™×</option>
          <option value="×–×•×’+ 10 ×™×œ×“×™×">×–×•×’+ 10 ×™×œ×“×™×</option>
        </select>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px">
        <span class="chip active" id="chipDebtor">×—×™×™×‘</span>
        <span class="chip" id="chipDebtorF">×—×™×™×‘×ª</span>
        <span class="chip" id="chipJoint">×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘×”×œ×™×š?</span>
      </div>

      <h2 class="title">(â‚ª) ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×”×ª× ×”××©×¤×—×ª×™</h2>

      <!-- ×©×›×¨ -->
      <div class="pair">
        <div class="input debtor" id="salaryDebtorGroup">
          <label id="salaryDebtorLabel">
            ×”×›× ×¡×” (×—×™×™×‘/×ª)
            <span class="help-wrap">
              <span class="help" data-tip="tipDebtor">?</span>
              <span class="tooltip" id="tipDebtor">
                <strong>×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.</strong><br>
                ×œ×—×™×™×‘ ×©×œ× ×¢×•×‘×“ ×™×§×‘×¢ ×ª×©×œ×•× ×–×× ×™ ×©×œ 150 â‚ª ×•×ª×©×œ×•× ×¢×ª×™×“×™ ×”×—×œ ×-3 ×—×•×“×©×™× ×§×“×™××” ×¢×¤×´×™ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª.
              </span>
            </span>
          </label>
          <input type="number" id="salaryDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×”" />
        </div>
        <div class="input partner" id="salaryPartnerGroup">
          <label id="salaryPartnerLabel">
            ×”×›× ×¡×” (×‘×Ÿ/×‘×ª ×–×•×’)
            <span class="help-wrap">
              <span class="help" data-tip="tipPartner">?</span>
              <span class="tooltip" id="tipPartner">
                <strong>×××•×¦×¢ × ×˜×• ×ª×œ×•×©×™ ×©×›×¨.</strong><br>
                ×‘××§×¨×” ×©×‘×Ÿ/×‘×ª ×”×–×•×’ ×œ× ×¢×•×‘×“/×ª ×™×™×§×‘×¢ ×ª×©×œ×•× ××“×•×¨×’ ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×›× ×¡×” ×¨×¢×™×•× ×™×ª ×©×œ ×©×›×¨ ××™× ×™××•× ×‘×¡×š 6,247.67 â‚ª.
              </span>
            </span>
          </label>
          <input type="number" id="salaryPartner" placeholder="×”×–×Ÿ ×”×›× ×¡×”" />
        </div>
      </div>

      <!-- ×”×›× ×¡×•×ª ××—×¨×•×ª -->
      <div class="pair">
        <div class="input debtor" id="otherIncomeDebtorGroup">
          <label id="otherIncomeDebtorLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×—×™×™×‘/×ª)</label>
          <input type="number" id="otherIncomeDebtor" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª" />
        </div>
        <div class="input partner" id="otherIncomePartnerGroup">
          <label id="otherIncomePartnerLabel">×”×›× ×¡×•×ª ××—×¨×•×ª (×‘×Ÿ/×‘×ª ×–×•×’)</label>
          <input type="number" id="otherIncomePartner" placeholder="×”×–×Ÿ ×”×›× ×¡×•×ª ××—×¨×•×ª" />
        </div>
      </div>

      <!-- ×§×¦×‘××•×ª -->
      <div class="pair">
        <div class="input debtor">
          <label id="debtorAllowanceLabel">×§×¦×‘×” (×—×™×™×‘/×ª)</label>
          <input type="number" id="debtorAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”" />
        </div>
        <div class="input partner" id="partnerAllowanceGroup">
          <label id="partnerAllowanceLabel">×§×¦×‘×” (×‘×Ÿ/×‘×ª ×–×•×’)</label>
          <input type="number" id="partnerAllowance" placeholder="×”×–×Ÿ ×§×¦×‘×”" />
        </div>
      </div>

      <!-- ×”×•×¦××•×ª -->
      <div class="pair">
        <div class="input">
          <label>×”×•×¦××•×ª ×—×¨×™×’×•×ª (×¨×¤×•××™×•×ª ×•×›×•')</label>
          <input type="number" id="unusualExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª" />
        </div>
        <div class="input">
          <label>×”×•×¦××•×ª ×˜×™×¤×•×œ ×•×¦×”×¨×•× ×™×</label>
          <input type="number" id="childcareExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª" />
        </div>
      </div>

      <div class="input">
        <label>×”×•×¦××•×ª ××–×•× ×•×ª</label>
        <input type="number" id="alimonyExpenses" placeholder="×”×–×Ÿ ×”×•×¦××•×ª ××–×•× ×•×ª" />
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // × ×ª×•× ×™×
      const lookupData = {
        "×™×—×™×“/× ×©×•×™ ×—×™ ×‘× ×¤×¨×“": { kids: 0, livingCost: 4556 },
        "×¨×•×•×§/×’×¨×•×©/××œ××Ÿ + ×™×œ×“": { kids: 1, livingCost: 6056 },
        "×–×•×’": { kids: 0, livingCost: 6024 },
        "×–×•×’+×™×œ×“": { kids: 1, livingCost: 7524 },
        "×–×•×’+ 2 ×™×œ×“×™×": { kids: 2, livingCost: 9024 },
        "×–×•×’+ 3 ×™×œ×“×™×": { kids: 3, livingCost: 10524 },
        "×–×•×’+ 4 ×™×œ×“×™×": { kids: 4, livingCost: 12024 },
        "×–×•×’+ 5 ×™×œ×“×™×": { kids: 5, livingCost: 13324 },
        "×–×•×’+ 6 ×™×œ×“×™×": { kids: 6, livingCost: 14624 },
        "×–×•×’+ 7 ×™×œ×“×™×": { kids: 7, livingCost: 15924 },
        "×–×•×’+ 8 ×™×œ×“×™×": { kids: 8, livingCost: 17224 },
        "×–×•×’+ 9 ×™×œ×“×™×": { kids: 9, livingCost: 18524 },
        "×–×•×’+ 10 ×™×œ×“×™×": { kids: 10, livingCost: 19824 }
      };
      const childAllowanceData = {0:0,1:169,2:383,3:597,4:811,5:980,6:1149,7:1318,8:1487,9:1656,10:1825};

      // ××œ×× ×˜×™×
      const statusEl = document.getElementById('status');
      const chipDebtor = document.getElementById('chipDebtor');
      const chipDebtorF = document.getElementById('chipDebtorF');
      const chipJoint = document.getElementById('chipJoint');

      const salaryDebtorEl = document.getElementById('salaryDebtor');
      const salaryPartnerEl = document.getElementById('salaryPartner');
      const otherIncomeDebtorEl = document.getElementById('otherIncomeDebtor');
      const otherIncomePartnerEl = document.getElementById('otherIncomePartner');
      const debtorAllowanceEl = document.getElementById('debtorAllowance');
      const partnerAllowanceEl = document.getElementById('partnerAllowance');
      const unusualExpensesEl = document.getElementById('unusualExpenses');
      const childcareExpensesEl = document.getElementById('childcareExpenses');
      const alimonyExpensesEl = document.getElementById('alimonyExpenses');

      const salaryDebtorGroup = document.getElementById('salaryDebtorGroup');
      const salaryPartnerGroup = document.getElementById('salaryPartnerGroup');
      const otherIncomeDebtorGroup = document.getElementById('otherIncomeDebtorGroup');
      const otherIncomePartnerGroup = document.getElementById('otherIncomePartnerGroup');
      const partnerAllowanceGroup = document.getElementById('partnerAllowanceGroup');

      const salaryDebtorLabelEl = document.getElementById('salaryDebtorLabel');
      const salaryPartnerLabelEl = document.getElementById('salaryPartnerLabel');
      const otherIncomeDebtorLabelEl = document.getElementById('otherIncomeDebtorLabel');
      const otherIncomePartnerLabelEl = document.getElementById('otherIncomePartnerLabel');
      const debtorAllowanceLabelEl = document.getElementById('debtorAllowanceLabel');
      const partnerAllowanceLabelEl = document.getElementById('partnerAllowanceLabel');

      const socialSecurityAllowanceEl = document.getElementById('socialSecurityAllowance');
      const totalIncomeResultEl = document.getElementById('totalIncomeResult');
      const baseLivingCostResultEl = document.getElementById('baseLivingCostResult');
      const totalExpensesResultEl = document.getElementById('totalExpensesResult');
      const disposableIncomeResultEl = document.getElementById('disposableIncomeResult');
      const debtorIncomeRatioEl = document.getElementById('debtorIncomeRatio');
      const partnerIncomeRatioEl = document.getElementById('partnerIncomeRatio');
      const debtorPaymentResultEl = document.getElementById('debtorPaymentResult');
      const partnerPaymentResultEl = document.getElementById('partnerPaymentResult');
      const finalPaymentResultEl = document.getElementById('finalPaymentResult');
      const debtorIncomeRatioLabelEl = document.getElementById('debtorIncomeRatioLabel');
      const partnerIncomeRatioLabelEl = document.getElementById('partnerIncomeRatioLabel');
      const debtorPaymentLabelEl = document.getElementById('debtorPaymentLabel');
      const partnerPaymentLabelEl = document.getElementById('partnerPaymentLabel');

      const btnPrint = document.getElementById('btnPrint');
      const btnMail = document.getElementById('btnMail');
      const mailTip = document.getElementById('mailTip');

      const noteCollapse = document.getElementById('noteCollapse');
      const reportCollapse = document.getElementById('reportCollapse');
      const userNoteEl = document.getElementById('userNote');
      const noteCountEl = document.getElementById('noteCount');
      const reportDateEl = document.getElementById('reportDate');

      // ××¦×‘
      let isMaleDebtor = true;
      let isJointProceeding = false;

      // utils
      const formatCurrency = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',minimumFractionDigits:0}).format(Number(n)||0);
      const round10 = n => Math.floor((Number(n)||0)/10)*10;

      // init date
      const today = new Date();
      reportDateEl.value = today.toLocaleDateString('he-IL');

      // collapse toggles
      document.querySelectorAll('.collapse-toggle').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          btn.parentElement.classList.toggle('open');
        });
      });

      // tooltip toggles
      document.querySelectorAll('.help').forEach(h=>{
        h.addEventListener('click', ()=>{
          const id = h.getAttribute('data-tip');
          const tip = document.getElementById(id);
          tip.classList.toggle('show');
        });
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.classList.contains('help')){
          document.querySelectorAll('.tooltip').forEach(t=>t.classList.remove('show'));
        }
      }, true);

      // mail tip
      btnMail.addEventListener('click', ()=>{ mailTip.style.display='inline-block'; setTimeout(()=>mailTip.style.display='none', 3500); });

      // print
      btnPrint.addEventListener('click', ()=>window.print());

      // chips
      function setDebtorGender(male){
        isMaleDebtor = male;
        chipDebtor.classList.toggle('active', male);
        chipDebtorF.classList.toggle('active', !male);
        updateLabelsAndUI();
        calculate();
      }
      chipDebtor.addEventListener('click', ()=>setDebtorGender(true));
      chipDebtorF.addEventListener('click', ()=>setDebtorGender(false));
      chipJoint.addEventListener('click', ()=>{
        isJointProceeding = !isJointProceeding;
        chipJoint.classList.toggle('active', isJointProceeding);
        updateLabelsAndUI();
        calculate();
      });

      // note counter
      userNoteEl.addEventListener('input', ()=>{noteCountEl.textContent = userNoteEl.value.length});

      // UI + labels
      function updateLabelsAndUI(){
        const status = statusEl.value || '';
        const isSingle = status.includes('×™×—×™×“') || status.includes('×¨×•×•×§');

        // ×”×¦×’×ª/×”×¡×ª×¨×ª ×©×“×•×ª ×‘×Ÿ/×‘×ª ×–×•×’
        const showPartner = !isSingle;
        [salaryPartnerGroup,otherIncomePartnerGroup,partnerAllowanceGroup].forEach(g=>{
          g.style.display = showPartner ? 'flex' : 'none';
        });

        // ×˜×§×¡×˜×™×
        const debtorText  = isSingle ? '×—×™×™×‘/×ª' : (isMaleDebtor ? '×—×™×™×‘' : '×—×™×™×‘×ª');
        const partnerText = isSingle ? '×‘×Ÿ/×‘×ª ×–×•×’' : (isMaleDebtor ? '×‘×ª ×–×•×’' : '×‘×Ÿ ×–×•×’');

        salaryDebtorLabelEl.textContent = `×”×›× ×¡×” (${debtorText})`;
        salaryPartnerLabelEl.textContent = `×”×›× ×¡×” (${partnerText})`;
        otherIncomeDebtorLabelEl.textContent = `×”×›× ×¡×•×ª ××—×¨×•×ª (${debtorText})`;
        otherIncomePartnerLabelEl.textContent = `×”×›× ×¡×•×ª ××—×¨×•×ª (${partnerText})`;
        debtorAllowanceLabelEl.textContent = `×§×¦×‘×” (${debtorText})`;
        partnerAllowanceLabelEl.textContent = `×§×¦×‘×” (${partnerText})`;

        debtorIncomeRatioLabelEl.textContent = `××—×•×– ×”×›× ×¡×” (${debtorText}):`;
        partnerIncomeRatioLabelEl.textContent = `××—×•×– ×”×›× ×¡×” (${partnerText}):`;
        debtorPaymentLabelEl.textContent    = `×ª×©×œ×•× ××•×¦×¢ (${debtorText}):`;
        partnerPaymentLabelEl.textContent   = `×ª×©×œ×•× ××•×¦×¢ (${partnerText}):`;
      }

      // ×—×™×©×•×‘
      function calculate(){
        const st = statusEl.value || '';
        const kids = (lookupData[st]||{kids:0}).kids;
        const living = (lookupData[st]||{livingCost:0}).livingCost;

        const sd = +salaryDebtorEl.value || 0;
        const sp = +salaryPartnerEl.value || 0;
        const oid = +otherIncomeDebtorEl.value || 0;
        const oip = +otherIncomePartnerEl.value || 0;
        const ad = +debtorAllowanceEl.value || 0;
        const ap = +partnerAllowanceEl.value || 0;

        const ue = +unusualExpensesEl.value || 0;
        const ce = +childcareExpensesEl.value || 0;
        const al = +alimonyExpensesEl.value || 0;

        const childAllow = childAllowanceData[kids] || 0;

        baseLivingCostResultEl.textContent = formatCurrency(living);
        socialSecurityAllowanceEl.textContent = formatCurrency(childAllow);

        // ×™×—×¡×™ ×”×›× ×¡×” (×©×›×¨+××—×¨×•×ª ×‘×œ×‘×“)
        const ratioBase = sd + oid + sp + oip;
        const rDebtor = ratioBase>0 ? (sd+oid)/ratioBase : 0;
        const rPartner= ratioBase>0 ? (sp+oip)/ratioBase : 0;

        debtorIncomeRatioEl.textContent = (rDebtor*100).toFixed(1)+'%';
        partnerIncomeRatioEl.textContent = (rPartner*100).toFixed(1)+'%';

        const totalIncome = sd+sp+oid+oip+ad+ap+childAllow;
        totalIncomeResultEl.textContent = formatCurrency(totalIncome);

        const totalExpenses = living+ue+ce+al;
        totalExpensesResultEl.textContent = formatCurrency(totalExpenses);

        const disposable = totalIncome - totalExpenses;
        disposableIncomeResultEl.textContent = disposable<0 ? '××™×Ÿ ×”×›× ×¡×” ×¤× ×•×™×”' : formatCurrency(disposable);

        // ×ª×©×œ×•××™× ××•×¦×¢×™× ×œ×¤×™ ×™×—×¡/2
        const payDebtor  = rDebtor  >0 ? round10((Math.max(disposable,0)*rDebtor)/2)  : 0;
        const payPartner = rPartner >0 ? round10((Math.max(disposable,0)*rPartner)/2) : 0;

        debtorPaymentResultEl.textContent  = formatCurrency(Math.max(0,payDebtor));
        partnerPaymentResultEl.textContent = formatCurrency(Math.max(0,payPartner));

        const isSingle = st.includes('×™×—×™×“') || st.includes('×¨×•×•×§');

        // × ×•×¡×—×” ××¢×•×“×›× ×ª ×œ×–×•×’ ×‘×”×œ×™×š:
        // final = round10( ((DI/2 - partnerPay) * rDebtor) + partnerPay )
        let final = 0;
        if(isSingle){
          final = Math.max(0,payDebtor);
        }else if(isJointProceeding){
          const baseHalf = Math.max(disposable,0)/2;
          const afterMinusPartner = Math.max(baseHalf - Math.max(0,payPartner), 0);
          final = round10(afterMinusPartner * rDebtor + Math.max(0,payPartner));
        }else{
          final = Math.max(0,payDebtor);
        }
        finalPaymentResultEl.textContent = formatCurrency(final);
      }

      // ××™×¨×•×¢×™×
      document.querySelectorAll('input,select').forEach(el=>{
        el.addEventListener('input', ()=>{updateLabelsAndUI();calculate();});
        el.addEventListener('change', ()=>{updateLabelsAndUI();calculate();});
      });
      statusEl.addEventListener('change', ()=>{updateLabelsAndUI();calculate();});

      // ×”×ª×—×œ×”
      updateLabelsAndUI();
      calculate();
    });
  </script>
</body>
</html>
